<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Final del Certamen - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: #f9fafb; 
        }
        .hidden { display: none !important; }
        .loading-overlay { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.8); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .spinner { 
            border: 4px solid rgba(255,255,255,0.3); 
            border-top: 4px solid #38bdf8; 
            border-radius: 50%; 
            width: 40px; height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .ranking-card {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border-left: 4px solid #38bdf8;
            transition: all 0.3s ease;
        }
        .ranking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .ranking-card.position-1 {
            border-left-color: #ffd700;
            background: linear-gradient(135deg, #1f2937 0%, #2d1b0e 100%);
        }
        .ranking-card.position-2 {
            border-left-color: #c0c0c0;
            background: linear-gradient(135deg, #1f2937 0%, #1a1a1a 100%);
        }
        .ranking-card.position-3 {
            border-left-color: #cd7f32;
            background: linear-gradient(135deg, #1f2937 0%, #2d1f1a 100%);
        }
        
        .medal {
            font-size: 2rem;
            margin-right: 0.5rem;
        }
        
        .score-evolution {
            background-color: #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        
        .gala-score {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .tab-btn {
            transition: all 0.2s ease;
        }
        .tab-btn.active {
            background-color: #0ea5e9 !important;
        }
        .ranking-content {
            transition: opacity 0.3s ease;
        }
        
        .public-favorite {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #1f2937 0%, #064e3b 100%);
        }
        
        /* OPTIMIZACI√ìN M√ìVIL */
        @media (max-width: 768px) {
            .container { 
                padding: 0.5rem; 
                max-width: 100%;
            }
            
            header h1 { 
                font-size: 1.75rem; 
                margin-bottom: 0.5rem;
            }
            
            section {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .grid-cols-2,
            .grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .ranking-card {
                padding: 0.75rem;
            }
            
            .medal {
                font-size: 1.5rem;
            }
            
            .score-evolution {
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0.25rem;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            section {
                padding: 0.75rem !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto max-w-7xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <a id="back-to-panel-link" href="#" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Panel del Evento</a>
            <img src="https://i.imgur.com/rqkZi9P.png" alt="VYTMUSIC Logo" class="mx-auto mb-4 bg-white rounded-full" style="max-width: 100px;">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">üèÜ Reporte Final del Certamen</h1>
            <p id="event-name-display" class="text-xl text-gray-300 mt-2"></p>
            <p class="text-gray-400 mt-1">Resultados completos de todas las galas</p>
        </header>

        <div id="message-container" class="mb-4"></div>

        <!-- Filtros -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-4">üîç Filtros de Reporte</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="include-secret" class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="include-secret" checked class="text-sky-600 focus:ring-sky-600">
                        <span class="font-semibold text-gray-300">Incluir Jurado Secreto</span>
                    </label>
                    <p class="text-xs text-gray-400 mt-1">Para resultados finales oficiales</p>
                </div>
                <div>
                    <label for="voting-mode-filter" class="block text-sm font-medium text-gray-300 mb-2">Tipo de Votaci√≥n</label>
                    <select id="voting-mode-filter" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white">
                        <option value="all">Todos los votos</option>
                        <option value="individual">Solo individuales</option>
                        <option value="collaborative">Solo colaborativos</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="update-report-btn" class="w-full py-3 px-6 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition-colors">
                        üîÑ Actualizar Reporte
                    </button>
                </div>
            </div>
        </section>

        <!-- Podio de Ganadores -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üèÜ Podio Final del Certamen</h2>
                <button id="toggle-edit-btn" class="px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors">
                    ‚úèÔ∏è Modo Edici√≥n
                </button>
            </div>
            
            <!-- Premiaci√≥n Oficial -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-center mb-4 text-yellow-300">üéñÔ∏è Premiaci√≥n Oficial</h3>
                
                <!-- Modo Vista Normal -->
                <div id="podium-view" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Primer Premio: Mejor Jurado -->
                    <div id="primer-premio" class="ranking-card position-1 p-6 rounded-lg text-center">
                        <div class="medal">ü•á</div>
                        <h4 class="text-xl font-bold text-yellow-300 mb-2">PRIMER PREMIO</h4>
                        <p class="text-sm text-yellow-200 mb-3">Mejor Cantante (Jurados)</p>
                        <div id="primer-premio-content">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Segundo Premio: Segundo Mejor Jurado -->
                    <div id="segundo-premio" class="ranking-card position-2 p-6 rounded-lg text-center">
                        <div class="medal">ü•à</div>
                        <h4 class="text-xl font-bold text-gray-300 mb-2">SEGUNDO PREMIO</h4>
                        <p class="text-sm text-gray-200 mb-3">Segundo Mejor (Jurados)</p>
                        <div id="segundo-premio-content">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Tercer Premio: Elegido por el P√∫blico -->
                    <div id="tercer-premio" class="ranking-card position-3 p-6 rounded-lg text-center">
                        <div class="medal">ü•â</div>
                        <h4 class="text-xl font-bold text-orange-300 mb-2">TERCER PREMIO</h4>
                        <p class="text-sm text-orange-200 mb-3">Elegido por el P√∫blico</p>
                        <div id="tercer-premio-content">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Modo Edici√≥n -->
                <div id="podium-edit" class="hidden space-y-6">
                    <div class="bg-yellow-800 p-4 rounded-lg">
                        <h4 class="font-bold text-yellow-200 mb-2">‚ö†Ô∏è Modo de Edici√≥n Activado</h4>
                        <p class="text-yellow-100 text-sm">
                            Puedes modificar manualmente los ganadores por criterios adicionales como calidad de grabaci√≥n, 
                            mejoras en el momento, o cualquier otra consideraci√≥n del certamen.
                        </p>
                    </div>
                    
                    <!-- Editor de Primer Premio -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-bold text-yellow-300 mb-3">ü•á PRIMER PREMIO - Mejor Cantante</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="primer-select" class="block text-sm font-medium text-gray-300 mb-2">Seleccionar Ganador:</label>
                                <select id="primer-select" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white">
                                    <!-- Se llenar√° din√°micamente -->
                                </select>
                            </div>
                            <div>
                                <label for="primer-razon" class="block text-sm font-medium text-gray-300 mb-2">Raz√≥n del Cambio (opcional):</label>
                                <input type="text" id="primer-razon" placeholder="Ej: Mejora excepcional en el momento" 
                                       class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Editor de Segundo Premio -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-bold text-gray-300 mb-3">ü•à SEGUNDO PREMIO - Segundo Mejor</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="segundo-select" class="block text-sm font-medium text-gray-300 mb-2">Seleccionar Ganador:</label>
                                <select id="segundo-select" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white">
                                    <!-- Se llenar√° din√°micamente -->
                                </select>
                            </div>
                            <div>
                                <label for="segundo-razon" class="block text-sm font-medium text-gray-300 mb-2">Raz√≥n del Cambio (opcional):</label>
                                <input type="text" id="segundo-razon" placeholder="Ej: Consistencia en todas las galas" 
                                       class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Editor de Tercer Premio -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-bold text-orange-300 mb-3">ü•â TERCER PREMIO - Elegido por el P√∫blico</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="tercero-select" class="block text-sm font-medium text-gray-300 mb-2">Seleccionar Ganador:</label>
                                <select id="tercero-select" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white">
                                    <!-- Se llenar√° din√°micamente con ranking p√∫blico -->
                                </select>
                            </div>
                            <div>
                                <label for="tercero-razon" class="block text-sm font-medium text-gray-300 mb-2">Raz√≥n del Cambio (opcional):</label>
                                <input type="text" id="tercero-razon" placeholder="Ej: Calidad de grabaci√≥n, 2do lugar por el p√∫blico" 
                                       class="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="flex gap-4 justify-center">
                        <button id="save-changes-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                            üíæ Guardar Cambios
                        </button>
                        <button id="reset-original-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                            üîÑ Restaurar Original
                        </button>
                        <button id="cancel-edit-btn" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Historial de Cambios -->
            <div id="changes-history" class="hidden bg-gray-700 p-4 rounded-lg mt-4">
                <h4 class="font-bold text-sky-300 mb-3">üìù Historial de Cambios Editoriales</h4>
                <div id="changes-list" class="space-y-2">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
            
            <!-- Comparaci√≥n Visual -->
            <div class="bg-gray-700 p-4 rounded-lg">
                <h4 class="font-bold text-sky-300 mb-3 text-center">üìä Comparaci√≥n de Resultados</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">üé≠ Top 3 Jurados:</h5>
                        <div id="jury-top3" class="space-y-1">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">üë• Top 3 P√∫blico:</h5>
                        <div id="public-top3" class="space-y-1">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ranking Completo -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-6">üìä Rankings Completos</h2>
            
            <!-- Tabs para alternar entre rankings -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button id="tab-jurados" class="tab-btn active px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">
                    üé≠ Ranking Jurados
                </button>
                <button id="tab-publico" class="tab-btn px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">
                    üë• Ranking P√∫blico
                </button>
                <button id="tab-combinado" class="tab-btn px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">
                    üìà Vista Combinada
                </button>
            </div>
            
            <!-- Ranking de Jurados -->
            <div id="ranking-jurados" class="ranking-content">
                <h3 class="text-lg font-bold text-sky-300 mb-4">üé≠ Ranking seg√∫n Jurados Profesionales</h3>
                <div id="jury-ranking" class="space-y-4">
                    <p class="text-center text-gray-400">Cargando ranking de jurados...</p>
                </div>
            </div>
            
            <!-- Ranking del P√∫blico -->
            <div id="ranking-publico" class="ranking-content hidden">
                <h3 class="text-lg font-bold text-green-300 mb-4">üë• Ranking seg√∫n Votaci√≥n del P√∫blico</h3>
                <div id="public-ranking" class="space-y-4">
                    <p class="text-center text-gray-400">Cargando ranking del p√∫blico...</p>
                </div>
            </div>
            
            <!-- Vista Combinada -->
            <div id="ranking-combinado" class="ranking-content hidden">
                <h3 class="text-lg font-bold text-purple-300 mb-4">üìà Comparaci√≥n Jurados vs P√∫blico</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left">Artista</th>
                                <th class="p-3 text-center">Pos. Jurados</th>
                                <th class="p-3 text-center">Ptos. Jurados</th>
                                <th class="p-3 text-center">Pos. P√∫blico</th>
                                <th class="p-3 text-center">Votos P√∫blico</th>
                                <th class="p-3 text-center">Diferencia</th>
                            </tr>
                        </thead>
                        <tbody id="combined-ranking-table" class="divide-y divide-gray-600">
                            <!-- Se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Estad√≠sticas Generales -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-6">üìà Estad√≠sticas del Certamen</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-sky-400" id="total-artists">0</p>
                    <p class="text-gray-400">Artistas Participantes</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-green-400" id="total-galas">0</p>
                    <p class="text-gray-400">Galas Realizadas</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-yellow-400" id="total-votes">0</p>
                    <p class="text-gray-400">Votos Totales</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-2xl font-bold text-purple-400" id="avg-score">0</p>
                    <p class="text-gray-400">Promedio General</p>
                </div>
            </div>
            
            <!-- Gr√°fico de Evoluci√≥n -->
            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-bold mb-4 text-center">Evoluci√≥n de Top 5 por Gala</h3>
                <canvas id="evolutionChart" class="w-full" style="max-height: 400px;"></canvas>
            </div>
        </section>

        <!-- Detalle por Galas -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-6">üé≠ Detalle por Galas</h2>
            <div id="gala-details" class="space-y-4">
                <p class="text-center text-gray-400">Cargando detalles de galas...</p>
            </div>
        </section>

        <!-- Exportar Resultados -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold mb-4">üíæ Exportar Resultados</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="export-csv-btn" class="py-3 px-6 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors">
                    üìä Exportar CSV
                </button>
                <button id="print-report-btn" class="py-3 px-6 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                    üñ®Ô∏è Imprimir Reporte
                </button>
                <button id="share-results-btn" class="py-3 px-6 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">
                    üîó Compartir Resultados
                </button>
                <button id="clear-global-data-btn" class="py-3 px-6 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                    üßπ Limpiar Datos Globales
                </button>
            </div>
        </section>
    </div>

    <!-- SCRIPT DE GESTI√ìN DE ARTISTAS GLOBALES -->
    <script src="./global-artists-manager.js"></script>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, getDoc, query, orderBy, where, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // INICIALIZAR GESTOR DE ARTISTAS GLOBALES
        const globalArtistsManager = new GlobalArtistsManager();

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        const eventName = urlParams.get('eventName') || 'Evento';
        
        if (!eventId) {
            document.body.innerHTML = '<p class="text-center text-red-500">Error: No se ha especificado un evento.</p>';
            throw new Error('Event ID missing');
        }

        // Configurar enlace de regreso
        document.getElementById('back-to-panel-link').href = `panel_evento_mejorado.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;

        // Variables globales
        let allVotes = [];
        let allPublicVotes = [];
        let allArtists = [];
        let allGalas = [];
        let juryRanking = [];
        let publicRanking = [];
        let evolutionChart = null;
        let isEditMode = false;
        let editorialChanges = [];
        let customWinners = {
            primer: null,
            segundo: null,
            tercero: null
        };

        // Elementos del DOM
        const ui = {
            eventNameDisplay: document.getElementById('event-name-display'),
            loadingOverlay: document.getElementById('loading-overlay'),
            messageContainer: document.getElementById('message-container'),
            includeSecret: document.getElementById('include-secret'),
            votingModeFilter: document.getElementById('voting-mode-filter'),
            updateReportBtn: document.getElementById('update-report-btn'),
            
            // Podio y Edici√≥n
            toggleEditBtn: document.getElementById('toggle-edit-btn'),
            podiumView: document.getElementById('podium-view'),
            podiumEdit: document.getElementById('podium-edit'),
            primerSelect: document.getElementById('primer-select'),
            segundoSelect: document.getElementById('segundo-select'),
            terceroSelect: document.getElementById('tercero-select'),
            primerRazon: document.getElementById('primer-razon'),
            segundoRazon: document.getElementById('segundo-razon'),
            terceroRazon: document.getElementById('tercero-razon'),
            saveChangesBtn: document.getElementById('save-changes-btn'),
            resetOriginalBtn: document.getElementById('reset-original-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            changesHistory: document.getElementById('changes-history'),
            changesList: document.getElementById('changes-list'),
            
            // Podio
            primerPremioContent: document.getElementById('primer-premio-content'),
            segundoPremioContent: document.getElementById('segundo-premio-content'),
            tercerPremioContent: document.getElementById('tercer-premio-content'),
            juryTop3: document.getElementById('jury-top3'),
            publicTop3: document.getElementById('public-top3'),
            
            // Rankings
            tabJurados: document.getElementById('tab-jurados'),
            tabPublico: document.getElementById('tab-publico'),
            tabCombinado: document.getElementById('tab-combinado'),
            rankingJurados: document.getElementById('ranking-jurados'),
            rankingPublico: document.getElementById('ranking-publico'),
            rankingCombinado: document.getElementById('ranking-combinado'),
            juryRanking: document.getElementById('jury-ranking'),
            publicRanking: document.getElementById('public-ranking'),
            combinedRankingTable: document.getElementById('combined-ranking-table'),
            
            // Estad√≠sticas
            totalArtists: document.getElementById('total-artists'),
            totalGalas: document.getElementById('total-galas'),
            totalVotes: document.getElementById('total-votes'),
            avgScore: document.getElementById('avg-score'),
            galaDetails: document.getElementById('gala-details'),
            
            // Exportaci√≥n
            exportCsvBtn: document.getElementById('export-csv-btn'),
            printReportBtn: document.getElementById('print-report-btn'),
            shareResultsBtn: document.getElementById('share-results-btn')
        };

        // Criterios de evaluaci√≥n
        const CRITERIA = {
            afinacion: 'Afinaci√≥n',
            ritmo: 'Ritmo y Tempo',
            tecnica: 'T√©cnica Vocal',
            expresion: 'Expresi√≥n',
            presencia: 'Presencia Esc√©nica',
            originalidad: 'Originalidad',
            diccion: 'Dicci√≥n',
            conexion: 'Conexi√≥n con P√∫blico',
            actitud: 'Actitud',
            evolucion: 'Evoluci√≥n'
        };

        // Inicializaci√≥n
        async function initialize() {
            try {
                showLoading(true);
                ui.eventNameDisplay.textContent = eventName;
                
                await loadAllData();
                await generateFinalReport();
                setupEventListeners();
                
                showMessage('Reporte final generado correctamente', 'success');
            } catch (error) {
                console.error('Error inicializando:', error);
                showMessage('Error al cargar el reporte: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadAllData() {
            // Cargar artistas
            const artistsSnapshot = await getDocs(collection(db, 'events', eventId, 'artists'));
            allArtists = artistsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Cargar votos de jurados
            const votesSnapshot = await getDocs(collection(db, 'events', eventId, 'jury_votes'));
            allVotes = votesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Cargar votos del p√∫blico
            const publicVotesSnapshot = await getDocs(collection(db, 'events', eventId, 'votes'));
            allPublicVotes = publicVotesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Cargar cambios editoriales existentes
            await loadExistingChanges();
            
            // Extraer galas √∫nicas de ambos tipos de votos
            const juryGalas = [...new Set(allVotes.map(vote => vote.galaId))];
            const publicGalas = [...new Set(allPublicVotes.map(vote => vote.galaId))];
            const allGalaIds = [...new Set([...juryGalas, ...publicGalas])].sort();
            
            allGalas = allGalaIds.map(id => ({ id, name: `Gala ${id}` }));
        }

        async function generateFinalReport() {
            const includeSecret = ui.includeSecret.checked;
            const votingModeFilter = ui.votingModeFilter.value;

            // USAR NUEVO SISTEMA CONSOLIDADO
            console.log('üöÄ Generando reporte con sistema de artistas globales...');
            await generateConsolidatedRanking();
            
            // Generar ranking del p√∫blico (sin cambios)
            await generatePublicRanking();
            
            // NO llamar updatePodium() porque lo hace generateConsolidatedRanking()
            console.log('‚úÖ Reporte final generado con sistema consolidado');
            updateJuryRanking();
            updatePublicRanking();
            updateCombinedRanking();
            updateStatistics();
            updateGalaDetails();
            updateEvolutionChart();
        }

        // NUEVA FUNCI√ìN: Generar ranking consolidado por artistas globales
        async function generateConsolidatedRanking() {
            console.log('üèÜ Generando ranking consolidado del certamen...');
            
            try {
                // Obtener votos consolidados usando el GlobalArtistsManager
                const consolidatedVotes = await globalArtistsManager.getConsolidatedVotes(db);
                
                // Generar ranking final
                const finalRanking = globalArtistsManager.generateFinalRanking(consolidatedVotes);
                
                console.log('üéØ Ranking final:', finalRanking);
                
                // Actualizar interfaz con el ranking consolidado
                renderConsolidatedRanking(finalRanking);
                
                // Actualizar podio con los 3 primeros
                updatePodiumWithConsolidated(finalRanking);
                
                return finalRanking;
                
            } catch (error) {
                console.error('‚ùå Error generando ranking consolidado:', error);
                // Fallback al sistema anterior
                return await generateJuryRanking(false, 'all');
            }
        }

        // Renderizar ranking consolidado en la interfaz
        function renderConsolidatedRanking(finalRanking) {
            const juryRankingContainer = document.getElementById('jury-ranking');
            
            if (!juryRankingContainer) {
                console.warn('‚ö†Ô∏è Container jury-ranking no encontrado');
                return;
            }
            
            juryRankingContainer.innerHTML = finalRanking.map((artist, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                return `
                    <div class="glass-effect p-4 rounded-lg flex items-center gap-4 ${artist.isWinner ? 'border-2 border-yellow-400' : ''}">
                        <div class="text-2xl font-bold ${artist.isWinner ? 'text-yellow-400' : 'text-sky-300'}">
                            ${medal} #${artist.position}
                        </div>
                        <div class="flex-grow">
                            <h4 class="text-lg font-bold text-white">${artist.name}</h4>
                            ${artist.alternativeNames.length > 0 ? 
                                `<p class="text-sm text-gray-400">Tambi√©n conocido como: ${artist.alternativeNames.join(', ')}</p>` : ''
                            }
                            <p class="text-sm text-gray-300">
                                Particip√≥ en ${artist.galas.length} gala${artist.galas.length > 1 ? 's' : ''}:
                                ${artist.galas.map(g => `<span class="text-blue-300">${g.name || g.eventId}</span>`).join(', ')}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-green-400">${artist.averageScore.toFixed(1)}</p>
                            <p class="text-sm text-gray-400">${artist.totalVotes} votos</p>
                            <p class="text-xs text-gray-500">Total: ${artist.totalScore.toFixed(1)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar informaci√≥n del sistema consolidado
            const infoDiv = document.createElement('div');
            infoDiv.className = 'mt-4 p-4 bg-blue-900 bg-opacity-50 rounded-lg text-center';
            infoDiv.innerHTML = `
                <h4 class="text-lg font-bold text-blue-300 mb-2">üîó Sistema de Consolidaci√≥n Activado</h4>
                <p class="text-sm text-gray-300">
                    Este ranking consolida autom√°ticamente los votos de artistas que participaron en m√∫ltiples galas.
                    Los participantes con nombres similares son detectados y sus puntuaciones se suman para determinar el ganador real del certamen.
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    Total de artistas √∫nicos consolidados: ${finalRanking.length}
                </p>
            `;
            
            juryRankingContainer.appendChild(infoDiv);
        }

        // Actualizar podio con datos consolidados
        function updatePodiumWithConsolidated(finalRanking) {
            if (finalRanking.length >= 1) {
                const winner = finalRanking[0];
                document.getElementById('primer-premio').innerHTML = `
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h3 class="text-2xl font-bold text-yellow-300 mb-2">GANADOR DEL CERTAMEN</h3>
                    <p class="text-xl font-bold text-white">${winner.name}</p>
                    <p class="text-lg text-yellow-200">${winner.averageScore.toFixed(1)} puntos</p>
                    <p class="text-sm text-gray-300 mt-2">${winner.totalVotes} votos ‚Ä¢ ${winner.galas.length} gala${winner.galas.length > 1 ? 's' : ''}</p>
                `;
            }
            
            if (finalRanking.length >= 2) {
                const second = finalRanking[1];
                document.getElementById('segundo-premio').innerHTML = `
                    <div class="text-5xl mb-4">ü•à</div>
                    <h3 class="text-xl font-bold text-gray-300 mb-2">SEGUNDO LUGAR</h3>
                    <p class="text-lg font-bold text-white">${second.name}</p>
                    <p class="text-md text-gray-200">${second.averageScore.toFixed(1)} puntos</p>
                    <p class="text-sm text-gray-400 mt-1">${second.totalVotes} votos</p>
                `;
            }
            
            if (finalRanking.length >= 3) {
                const third = finalRanking[2];
                document.getElementById('tercer-premio').innerHTML = `
                    <div class="text-4xl mb-4">ü•â</div>
                    <h3 class="text-lg font-bold text-orange-300 mb-2">TERCER LUGAR</h3>
                    <p class="text-md font-bold text-white">${third.name}</p>
                    <p class="text-md text-orange-200">${third.averageScore.toFixed(1)} puntos</p>
                    <p class="text-sm text-gray-400 mt-1">${third.totalVotes} votos</p>
                `;
            }
        }

        async function generateJuryRanking(includeSecret, votingModeFilter) {
            // Filtrar votos seg√∫n configuraci√≥n
            let filteredVotes = allVotes.filter(vote => {
                if (!includeSecret && vote.isSecret) return false;
                
                if (votingModeFilter === 'individual' && vote.isCollaborative) return false;
                if (votingModeFilter === 'collaborative' && !vote.isCollaborative) return false;
                
                return true;
            });

            // Calcular puntajes finales por artista
            const artistScores = {};
            
            allArtists.forEach(artist => {
                artistScores[artist.id] = {
                    artist: artist,
                    totalScore: 0,
                    voteCount: 0,
                    galaScores: {},
                    averageScore: 0,
                    evolution: []
                };
            });

            // Procesar votos por gala
            allGalas.forEach(gala => {
                const galaVotes = filteredVotes.filter(vote => vote.galaId === gala.id);
                
                // Agrupar votos por artista en esta gala
                const galaArtistVotes = {};
                galaVotes.forEach(vote => {
                    if (!galaArtistVotes[vote.artistId]) {
                        galaArtistVotes[vote.artistId] = [];
                    }
                    galaArtistVotes[vote.artistId].push(vote);
                });

                // Calcular promedio por artista en esta gala
                Object.keys(galaArtistVotes).forEach(artistId => {
                    const votes = galaArtistVotes[artistId];
                    
                    if (votes.length > 0) {
                        let galaScore;
                        if (votes[0].isCollaborative) {
                            galaScore = Object.values(votes[0].scores).reduce((sum, val) => sum + val, 0);
                        } else {
                            const totalSum = votes.reduce((sum, vote) => {
                                return sum + Object.values(vote.scores).reduce((s, v) => s + v, 0);
                            }, 0);
                            galaScore = Math.round(totalSum / votes.length);
                        }

                        if (artistScores[artistId]) {
                            artistScores[artistId].galaScores[gala.id] = galaScore;
                            artistScores[artistId].totalScore += galaScore;
                            artistScores[artistId].voteCount++;
                            artistScores[artistId].evolution.push({ gala: gala.id, score: galaScore });
                        }
                    }
                });
            });

            // Crear ranking de jurados
            juryRanking = Object.values(artistScores)
                .filter(artistData => artistData.voteCount > 0)
                .map(artistData => ({
                    ...artistData,
                    averageScore: Math.round(artistData.totalScore / artistData.voteCount)
                }))
                .sort((a, b) => b.averageScore - a.averageScore);
        }

        async function generatePublicRanking() {
            // Calcular votos del p√∫blico por artista
            const publicScores = {};
            
            allArtists.forEach(artist => {
                publicScores[artist.id] = {
                    artist: artist,
                    totalVotes: 0,
                    galaVotes: {},
                    averageVotes: 0
                };
            });

            // Procesar votos del p√∫blico por gala
            allGalas.forEach(gala => {
                const galaPublicVotes = allPublicVotes.filter(vote => vote.galaId === gala.id);
                
                // Contar votos por artista en esta gala
                const galaVoteCounts = {};
                galaPublicVotes.forEach(vote => {
                    if (!galaVoteCounts[vote.artistId]) {
                        galaVoteCounts[vote.artistId] = 0;
                    }
                    galaVoteCounts[vote.artistId]++;
                });

                // Asignar conteos
                Object.keys(galaVoteCounts).forEach(artistId => {
                    if (publicScores[artistId]) {
                        publicScores[artistId].galaVotes[gala.id] = galaVoteCounts[artistId];
                        publicScores[artistId].totalVotes += galaVoteCounts[artistId];
                    }
                });
            });

            // Crear ranking del p√∫blico
            publicRanking = Object.values(publicScores)
                .filter(artistData => artistData.totalVotes > 0)
                .map(artistData => ({
                    ...artistData,
                    averageVotes: Math.round(artistData.totalVotes / allGalas.length)
                }))
                .sort((a, b) => b.totalVotes - a.totalVotes);
        }

        function updatePodium() {
            // Determinar ganadores (editados o autom√°ticos)
            const primerGanador = customWinners.primer || juryRanking[0];
            const segundoGanador = customWinners.segundo || juryRanking[1];
            const tercerGanador = customWinners.tercero || publicRanking[0];

            // Actualizar contenido del podio
            if (primerGanador) {
                ui.primerPremioContent.innerHTML = createPodiumCard(primerGanador, 'jury');
            }

            if (segundoGanador) {
                ui.segundoPremioContent.innerHTML = createPodiumCard(segundoGanador, 'jury');
            }

            if (tercerGanador) {
                ui.tercerPremioContent.innerHTML = createPodiumCard(tercerGanador, 'public');
            }

            // Actualizar comparaciones
            updateTopComparisons();
            
            // Actualizar selectors en modo edici√≥n
            updateEditSelectors();
        }

        function updateEditSelectors() {
            // Llenar selector primer premio (ranking de jurados)
            ui.primerSelect.innerHTML = '<option value="">Seleccionar ganador...</option>';
            juryRanking.forEach((artist, index) => {
                const option = document.createElement('option');
                option.value = artist.artist.id;
                option.textContent = `${index + 1}. ${artist.artist.name} (${artist.averageScore} pts)`;
                if (customWinners.primer?.artist.id === artist.artist.id) {
                    option.selected = true;
                }
                ui.primerSelect.appendChild(option);
            });

            // Llenar selector segundo premio (ranking de jurados)
            ui.segundoSelect.innerHTML = '<option value="">Seleccionar ganador...</option>';
            juryRanking.forEach((artist, index) => {
                const option = document.createElement('option');
                option.value = artist.artist.id;
                option.textContent = `${index + 1}. ${artist.artist.name} (${artist.averageScore} pts)`;
                if (customWinners.segundo?.artist.id === artist.artist.id) {
                    option.selected = true;
                }
                ui.segundoSelect.appendChild(option);
            });

            // Llenar selector tercer premio (TODOS los artistas para m√°xima flexibilidad)
            ui.terceroSelect.innerHTML = '<option value="">Seleccionar ganador...</option>';
            
            // Agregar grupo "Top P√∫blico"
            const publicGroup = document.createElement('optgroup');
            publicGroup.label = 'üë• Top Votaci√≥n P√∫blica';
            publicRanking.forEach((artist, index) => {
                const option = document.createElement('option');
                option.value = artist.artist.id;
                option.textContent = `${index + 1}. ${artist.artist.name} (${artist.totalVotes} votos)`;
                if (customWinners.tercero?.artist.id === artist.artist.id) {
                    option.selected = true;
                }
                publicGroup.appendChild(option);
            });
            ui.terceroSelect.appendChild(publicGroup);

            // Agregar grupo "Top Jurados" 
            const juryGroup = document.createElement('optgroup');
            juryGroup.label = 'üé≠ Top Jurados (referencia)';
            juryRanking.forEach((artist, index) => {
                const option = document.createElement('option');
                option.value = artist.artist.id;
                option.textContent = `${index + 1}. ${artist.artist.name} (${artist.averageScore} pts)`;
                if (customWinners.tercero?.artist.id === artist.artist.id) {
                    option.selected = true;
                }
                juryGroup.appendChild(option);
            });
            ui.terceroSelect.appendChild(juryGroup);

            // Agregar grupo "Todos los Artistas"
            const allGroup = document.createElement('optgroup');
            allGroup.label = 'üé§ Todos los Artistas';
            allArtists.forEach(artist => {
                // Solo agregar si no est√° ya en los otros grupos
                const inPublic = publicRanking.find(p => p.artist.id === artist.id);
                const inJury = juryRanking.find(j => j.artist.id === artist.id);
                
                if (!inPublic && !inJury) {
                    const option = document.createElement('option');
                    option.value = artist.id;
                    option.textContent = `${artist.name} (sin votos registrados)`;
                    if (customWinners.tercero?.artist.id === artist.id) {
                        option.selected = true;
                    }
                    allGroup.appendChild(option);
                }
            });
            if (allGroup.children.length > 0) {
                ui.terceroSelect.appendChild(allGroup);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            if (isEditMode) {
                ui.podiumView.classList.add('hidden');
                ui.podiumEdit.classList.remove('hidden');
                ui.toggleEditBtn.innerHTML = 'üëÅÔ∏è Modo Vista';
                ui.toggleEditBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                ui.toggleEditBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
                // Mostrar historial si hay cambios
                if (editorialChanges.length > 0) {
                    ui.changesHistory.classList.remove('hidden');
                    updateChangesHistory();
                }
            } else {
                ui.podiumView.classList.remove('hidden');
                ui.podiumEdit.classList.add('hidden');
                ui.toggleEditBtn.innerHTML = '‚úèÔ∏è Modo Edici√≥n';
                ui.toggleEditBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                ui.toggleEditBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            }
        }

        function saveEditorialChanges() {
            const changes = {};
            let hasChanges = false;

            // Verificar cambios en primer premio
            const primerSelected = ui.primerSelect.value;
            if (primerSelected) {
                const selectedArtist = findArtistInRanking(primerSelected, juryRanking);
                if (selectedArtist && selectedArtist.artist.id !== juryRanking[0]?.artist.id) {
                    customWinners.primer = selectedArtist;
                    changes.primer = {
                        artist: selectedArtist.artist.name,
                        artistId: selectedArtist.artist.id,
                        razon: ui.primerRazon.value.trim(),
                        originalPos: juryRanking.findIndex(a => a.artist.id === selectedArtist.artist.id) + 1
                    };
                    hasChanges = true;
                }
            }

            // Verificar cambios en segundo premio
            const segundoSelected = ui.segundoSelect.value;
            if (segundoSelected) {
                const selectedArtist = findArtistInRanking(segundoSelected, juryRanking);
                if (selectedArtist && selectedArtist.artist.id !== juryRanking[1]?.artist.id) {
                    customWinners.segundo = selectedArtist;
                    changes.segundo = {
                        artist: selectedArtist.artist.name,
                        artistId: selectedArtist.artist.id,
                        razon: ui.segundoRazon.value.trim(),
                        originalPos: juryRanking.findIndex(a => a.artist.id === selectedArtist.artist.id) + 1
                    };
                    hasChanges = true;
                }
            }

            // Verificar cambios en tercer premio
            const terceroSelected = ui.terceroSelect.value;
            if (terceroSelected) {
                let selectedArtist = findArtistInRanking(terceroSelected, publicRanking);
                if (!selectedArtist) {
                    selectedArtist = findArtistInRanking(terceroSelected, juryRanking);
                }
                if (!selectedArtist) {
                    // Buscar en todos los artistas
                    const artist = allArtists.find(a => a.id === terceroSelected);
                    if (artist) {
                        selectedArtist = { artist: artist, totalVotes: 0, averageVotes: 0 };
                    }
                }
                
                if (selectedArtist && selectedArtist.artist.id !== publicRanking[0]?.artist.id) {
                    customWinners.tercero = selectedArtist;
                    changes.tercero = {
                        artist: selectedArtist.artist.name,
                        artistId: selectedArtist.artist.id,
                        razon: ui.terceroRazon.value.trim(),
                        originalPos: publicRanking.findIndex(a => a.artist.id === selectedArtist.artist.id) + 1 || 'N/A'
                    };
                    hasChanges = true;
                }
            }

            if (hasChanges) {
                // Registrar cambio en historial
                const changeRecord = {
                    timestamp: new Date().toLocaleString(),
                    changes: changes
                };
                editorialChanges.push(changeRecord);

                // Guardar en base de datos
                saveChangesToDatabase(changeRecord).then(() => {
                    // Actualizar UI
                    updatePodium();
                    toggleEditMode();
                    
                    showMessage('Cambios guardados en el registro oficial del certamen', 'success');
                }).catch(error => {
                    console.error('Error guardando cambios:', error);
                    showMessage('Error al guardar cambios: ' + error.message, 'error');
                });
            } else {
                showMessage('No se detectaron cambios', 'info');
            }
        }

        async function saveChangesToDatabase(changeRecord) {
            try {
                // Crear documento con los ganadores oficiales editados
                const finalResults = {
                    eventId: eventId,
                    eventName: eventName,
                    generatedAt: new Date().toISOString(),
                    
                    // Ganadores oficiales (editados o autom√°ticos)
                    officialWinners: {
                        primerPremio: {
                            artistId: (customWinners.primer || juryRanking[0])?.artist.id,
                            artistName: (customWinners.primer || juryRanking[0])?.artist.name,
                            category: 'Mejor Cantante (Jurados)',
                            isEdited: !!customWinners.primer,
                            editReason: customWinners.primer ? changeRecord.changes.primer?.razon : null
                        },
                        segundoPremio: {
                            artistId: (customWinners.segundo || juryRanking[1])?.artist.id,
                            artistName: (customWinners.segundo || juryRanking[1])?.artist.name,
                            category: 'Segundo Mejor (Jurados)',
                            isEdited: !!customWinners.segundo,
                            editReason: customWinners.segundo ? changeRecord.changes.segundo?.razon : null
                        },
                        tercerPremio: {
                            artistId: (customWinners.tercero || publicRanking[0])?.artist.id,
                            artistName: (customWinners.tercero || publicRanking[0])?.artist.name,
                            category: 'Elegido por el P√∫blico',
                            isEdited: !!customWinners.tercero,
                            editReason: customWinners.tercero ? changeRecord.changes.tercero?.razon : null
                        }
                    },
                    
                    // Rankings originales para referencia
                    originalRankings: {
                        juryRanking: juryRanking.map((artist, index) => ({
                            position: index + 1,
                            artistId: artist.artist.id,
                            artistName: artist.artist.name,
                            score: artist.averageScore
                        })),
                        publicRanking: publicRanking.map((artist, index) => ({
                            position: index + 1,
                            artistId: artist.artist.id,
                            artistName: artist.artist.name,
                            votes: artist.totalVotes
                        }))
                    },
                    
                    // Historial de cambios editoriales
                    editorialHistory: editorialChanges,
                    
                    // Metadata para auditor√≠a
                    lastEditedAt: new Date().toISOString(),
                    editedBy: 'Administrador del Certamen',
                    version: editorialChanges.length
                };

                // Guardar en Firebase
                await setDoc(doc(db, 'events', eventId, 'final_results', 'official'), finalResults);
                
                // Tambi√©n crear un backup con timestamp
                const backupId = `backup_${Date.now()}`;
                await setDoc(doc(db, 'events', eventId, 'final_results', backupId), finalResults);
                
                console.log('Resultados oficiales guardados en la base de datos');
                
            } catch (error) {
                console.error('Error guardando resultados oficiales:', error);
                throw error;
            }
        }

        async function loadExistingChanges() {
            try {
                // Cargar cambios editoriales existentes si los hay
                const resultsDoc = await getDoc(doc(db, 'events', eventId, 'final_results', 'official'));
                
                if (resultsDoc.exists()) {
                    const data = resultsDoc.data();
                    
                    // Restaurar ganadores editados
                    if (data.officialWinners.primerPremio.isEdited) {
                        const artist = juryRanking.find(a => a.artist.id === data.officialWinners.primerPremio.artistId);
                        if (artist) customWinners.primer = artist;
                    }
                    
                    if (data.officialWinners.segundoPremio.isEdited) {
                        const artist = juryRanking.find(a => a.artist.id === data.officialWinners.segundoPremio.artistId);
                        if (artist) customWinners.segundo = artist;
                    }
                    
                    if (data.officialWinners.tercerPremio.isEdited) {
                        let artist = publicRanking.find(a => a.artist.id === data.officialWinners.tercerPremio.artistId);
                        if (!artist) {
                            artist = juryRanking.find(a => a.artist.id === data.officialWinners.tercerPremio.artistId);
                        }
                        if (!artist) {
                            const foundArtist = allArtists.find(a => a.id === data.officialWinners.tercerPremio.artistId);
                            if (foundArtist) {
                                artist = { artist: foundArtist, totalVotes: 0, averageVotes: 0 };
                            }
                        }
                        if (artist) customWinners.tercero = artist;
                    }
                    
                    // Restaurar historial
                    if (data.editorialHistory) {
                        editorialChanges = data.editorialHistory;
                    }
                    
                    console.log('Cambios editoriales existentes cargados');
                }
            } catch (error) {
                console.error('Error cargando cambios existentes:', error);
                // No es cr√≠tico, continuar sin cambios previos
            }
        }

        function resetToOriginal() {
            if (confirm('¬øEst√°s seguro de que quieres restaurar los ganadores originales? Se perder√°n todos los cambios editoriales.')) {
                customWinners = { primer: null, segundo: null, tercero: null };
                editorialChanges = [];
                
                // Limpiar campos
                ui.primerRazon.value = '';
                ui.segundoRazon.value = '';
                ui.terceroRazon.value = '';
                
                updatePodium();
                ui.changesHistory.classList.add('hidden');
                
                showMessage('Ganadores restaurados a resultados originales', 'success');
            }
        }

        function updateChangesHistory() {
            ui.changesList.innerHTML = '';
            
            editorialChanges.forEach((change, index) => {
                const changeDiv = document.createElement('div');
                changeDiv.className = 'bg-gray-600 p-3 rounded text-sm';
                
                let changesText = '';
                Object.entries(change.changes).forEach(([premio, data]) => {
                    const premioName = premio === 'primer' ? 'ü•á Primer Premio' : 
                                     premio === 'segundo' ? 'ü•à Segundo Premio' : 'ü•â Tercer Premio';
                    changesText += `<strong>${premioName}:</strong> ${data.artist} `;
                    if (data.originalPos !== 'N/A') {
                        changesText += `(era #${data.originalPos}) `;
                    }
                    if (data.razon) {
                        changesText += `- ${data.razon}`;
                    }
                    changesText += '<br>';
                });
                
                changeDiv.innerHTML = `
                    <div class="text-gray-300 mb-1">${change.timestamp}</div>
                    <div class="text-gray-100">${changesText}</div>
                `;
                
                ui.changesList.appendChild(changeDiv);
            });
        }

        function findArtistInRanking(artistId, ranking) {
            return ranking.find(item => item.artist.id === artistId);
        }

        function exportToCSV() {
            // CSV con ambos rankings
            let csv = 'RANKING DE JURADOS\n';
            csv += 'Posici√≥n,Artista,Ciudad,Promedio Jurados,Total Galas';
            
            // Agregar columnas por gala
            allGalas.forEach(gala => {
                csv += `,Gala ${gala.id}`;
            });
            csv += '\n';

            // Agregar datos de jurados
            juryRanking.forEach((artistData, index) => {
                csv += `${index + 1},"${artistData.artist.name}","${artistData.artist.city || ''}",${artistData.averageScore},${artistData.voteCount}`;
                
                allGalas.forEach(gala => {
                    csv += `,${artistData.galaScores[gala.id] || ''}`;
                });
                csv += '\n';
            });

            csv += '\n\nRANKING DEL P√öBLICO\n';
            csv += 'Posici√≥n,Artista,Ciudad,Total Votos,Promedio por Gala';
            
            // Agregar columnas por gala para votos p√∫blicos
            allGalas.forEach(gala => {
                csv += `,Votos Gala ${gala.id}`;
            });
            csv += '\n';

            // Agregar datos del p√∫blico
            publicRanking.forEach((artistData, index) => {
                csv += `${index + 1},"${artistData.artist.name}","${artistData.artist.city || ''}",${artistData.totalVotes},${artistData.averageVotes}`;
                
                allGalas.forEach(gala => {
                    csv += `,${artistData.galaVotes[gala.id] || 0}`;
                });
                csv += '\n';
            });

            csv += '\n\nPREMIACI√ìN OFICIAL FINAL\n';
            csv += 'Premio,Artista,Criterio,Estado\n';
            
            // Determinar ganadores finales (editados o autom√°ticos)
            const primerFinal = customWinners.primer || juryRanking[0];
            const segundoFinal = customWinners.segundo || juryRanking[1];
            const tercerFinal = customWinners.tercero || publicRanking[0];
            
            if (primerFinal) {
                const estado = customWinners.primer ? 'EDITADO' : 'AUTOM√ÅTICO';
                csv += `PRIMER PREMIO,"${primerFinal.artist.name}",Mejor Cantante (Jurados),${estado}\n`;
            }
            if (segundoFinal) {
                const estado = customWinners.segundo ? 'EDITADO' : 'AUTOM√ÅTICO';
                csv += `SEGUNDO PREMIO,"${segundoFinal.artist.name}",Segundo Mejor (Jurados),${estado}\n`;
            }
            if (tercerFinal) {
                const estado = customWinners.tercero ? 'EDITADO' : 'AUTOM√ÅTICO';
                csv += `TERCER PREMIO,"${tercerFinal.artist.name}",Elegido por el P√∫blico,${estado}\n`;
            }

            // Agregar historial de cambios editoriales si existen
            if (editorialChanges.length > 0) {
                csv += '\n\nHISTORIAL DE CAMBIOS EDITORIALES\n';
                csv += 'Fecha/Hora,Premio,Artista Seleccionado,Raz√≥n\n';
                
                editorialChanges.forEach(change => {
                    Object.entries(change.changes).forEach(([premio, data]) => {
                        const premioName = premio === 'primer' ? 'PRIMER PREMIO' : 
                                         premio === 'segundo' ? 'SEGUNDO PREMIO' : 'TERCER PREMIO';
                        csv += `"${change.timestamp}","${premioName}","${data.artist}","${data.razon || 'Sin raz√≥n especificada'}"\n`;
                    });
                });
            }

            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const filename = editorialChanges.length > 0 ? 
                `reporte_final_EDITADO_${eventName.replace(/\s+/g, '_')}.csv` :
                `reporte_final_completo_${eventName.replace(/\s+/g, '_')}.csv`;
            link.download = filename;
            link.click();
        }

        function printReport() {
            window.print();
        }

        function shareResults() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: `Resultados Finales - ${eventName}`,
                    text: `Ve los resultados completos del certamen ${eventName}`,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    showMessage('Enlace copiado al portapapeles', 'success');
                });
            }
        }

        function createPodiumCard(artistData, type) {
            const isPublic = type === 'public';
            const scoreText = isPublic 
                ? `${artistData.totalVotes} votos` 
                : `${artistData.averageScore} pts`;

            return `
                ${artistData.artist.photoUrl ? `
                    <img src="${artistData.artist.photoUrl}" alt="${artistData.artist.name}" 
                         class="w-20 h-20 object-cover rounded-full mx-auto mb-3 border-4 border-current">
                ` : `
                    <div class="w-20 h-20 bg-gray-600 rounded-full mx-auto mb-3 flex items-center justify-center border-4 border-current">
                        <span class="text-2xl">üé§</span>
                    </div>
                `}
                <h4 class="text-lg font-bold text-white">${artistData.artist.name}</h4>
                <p class="text-sm text-gray-300 mb-2">${artistData.artist.city || ''}</p>
                <div class="text-2xl font-bold ${isPublic ? 'text-green-400' : 'text-yellow-400'}">${scoreText}</div>
                <p class="text-xs text-gray-400 mt-1">
                    ${isPublic ? `${artistData.averageVotes} votos/gala` : `${artistData.voteCount} galas participadas`}
                </p>
            `;
        }

        function updateTopComparisons() {
            // Top 3 Jurados
            const juryTop3HTML = juryRanking.slice(0, 3).map((artist, index) => `
                <div class="flex justify-between items-center">
                    <span class="text-gray-300">${index + 1}. ${artist.artist.name}</span>
                    <span class="text-yellow-400 font-bold">${artist.averageScore} pts</span>
                </div>
            `).join('');
            ui.juryTop3.innerHTML = juryTop3HTML;

            // Top 3 P√∫blico
            const publicTop3HTML = publicRanking.slice(0, 3).map((artist, index) => `
                <div class="flex justify-between items-center">
                    <span class="text-gray-300">${index + 1}. ${artist.artist.name}</span>
                    <span class="text-green-400 font-bold">${artist.totalVotes} votos</span>
                </div>
            `).join('');
            ui.publicTop3.innerHTML = publicTop3HTML;
        }

        function updateJuryRanking() {
            ui.juryRanking.innerHTML = '';
            
            juryRanking.forEach((artistData, index) => {
                const position = index + 1;
                const card = document.createElement('div');
                card.className = `ranking-card p-4 rounded-lg ${position <= 3 ? `position-${position}` : ''}`;
                
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-2xl font-bold text-sky-400 w-12 text-center">
                            ${position <= 3 ? ['ü•á', 'ü•à', 'ü•â'][position - 1] : `#${position}`}
                        </div>
                        ${artistData.artist.photoUrl ? `
                            <img src="${artistData.artist.photoUrl}" alt="${artistData.artist.name}" 
                                 class="w-16 h-16 object-cover rounded-full border-2 border-sky-300">
                        ` : `
                            <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center border-2 border-sky-300">
                                <span class="text-xl">üé§</span>
                            </div>
                        `}
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-sky-300">${artistData.artist.name}</h3>
                            <p class="text-sm text-gray-400">${artistData.artist.city || ''}</p>
                            <div class="score-evolution">
                                <div class="flex flex-wrap gap-1">
                                    ${artistData.evolution.map(evo => `
                                        <span class="gala-score bg-gray-600 text-white">
                                            G${evo.gala}: ${evo.score}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-yellow-400">${artistData.averageScore}</div>
                            <p class="text-sm text-gray-400">promedio</p>
                            <p class="text-xs text-gray-500">${artistData.voteCount} galas</p>
                        </div>
                    </div>
                `;
                
                ui.juryRanking.appendChild(card);
            });
        }

        function updatePublicRanking() {
            ui.publicRanking.innerHTML = '';
            
            publicRanking.forEach((artistData, index) => {
                const position = index + 1;
                const card = document.createElement('div');
                card.className = `ranking-card p-4 rounded-lg ${position === 1 ? 'public-favorite' : ''}`;
                
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-2xl font-bold text-green-400 w-12 text-center">
                            ${position === 1 ? 'üëë' : `#${position}`}
                        </div>
                        ${artistData.artist.photoUrl ? `
                            <img src="${artistData.artist.photoUrl}" alt="${artistData.artist.name}" 
                                 class="w-16 h-16 object-cover rounded-full border-2 border-green-300">
                        ` : `
                            <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center border-2 border-green-300">
                                <span class="text-xl">üé§</span>
                            </div>
                        `}
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-green-300">${artistData.artist.name}</h3>
                            <p class="text-sm text-gray-400">${artistData.artist.city || ''}</p>
                            <div class="score-evolution">
                                <div class="flex flex-wrap gap-1">
                                    ${Object.entries(artistData.galaVotes).map(([gala, votes]) => `
                                        <span class="gala-score bg-green-700 text-white">
                                            G${gala}: ${votes} votos
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-green-400">${artistData.totalVotes}</div>
                            <p class="text-sm text-gray-400">votos totales</p>
                            <p class="text-xs text-gray-500">${artistData.averageVotes}/gala</p>
                        </div>
                    </div>
                `;
                
                ui.publicRanking.appendChild(card);
            });
        }

        function updateCombinedRanking() {
            ui.combinedRankingTable.innerHTML = '';
            
            // Crear mapa de posiciones del p√∫blico
            const publicPositions = {};
            publicRanking.forEach((artist, index) => {
                publicPositions[artist.artist.id] = {
                    position: index + 1,
                    votes: artist.totalVotes
                };
            });
            
            juryRanking.forEach((juryArtist, juryIndex) => {
                const publicData = publicPositions[juryArtist.artist.id];
                const juryPos = juryIndex + 1;
                const publicPos = publicData ? publicData.position : '-';
                const publicVotes = publicData ? publicData.votes : 0;
                
                // Calcular diferencia (positivo = mejor en jurados, negativo = mejor en p√∫blico)
                const difference = publicData ? juryPos - publicData.position : 0;
                const diffText = difference === 0 ? '=' : difference > 0 ? `+${difference}` : `${difference}`;
                const diffColor = difference === 0 ? 'text-gray-400' : difference > 0 ? 'text-red-400' : 'text-green-400';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                row.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            ${juryArtist.artist.photoUrl ? `
                                <img src="${juryArtist.artist.photoUrl}" class="w-8 h-8 rounded-full object-cover">
                            ` : `
                                <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                                    <span class="text-xs">üé§</span>
                                </div>
                            `}
                            <span class="font-semibold">${juryArtist.artist.name}</span>
                        </div>
                    </td>
                    <td class="p-3 text-center font-bold text-yellow-400">#${juryPos}</td>
                    <td class="p-3 text-center">${juryArtist.averageScore}</td>
                    <td class="p-3 text-center font-bold text-green-400">${publicPos}</td>
                    <td class="p-3 text-center">${publicVotes}</td>
                    <td class="p-3 text-center font-bold ${diffColor}">${diffText}</td>
                `;
                
                ui.combinedRankingTable.appendChild(row);
            });
        }

        function updateStatistics() {
            ui.totalArtists.textContent = Math.max(juryRanking.length, publicRanking.length);
            ui.totalGalas.textContent = allGalas.length;
            ui.totalVotes.textContent = allVotes.length + allPublicVotes.length;
            
            const avgScore = juryRanking.length > 0 
                ? Math.round(juryRanking.reduce((sum, artist) => sum + artist.averageScore, 0) / juryRanking.length)
                : 0;
            ui.avgScore.textContent = avgScore;
        }

        function switchTab(activeTab) {
            // Remover clase active de todos los tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('bg-sky-600');
                btn.classList.add('bg-gray-600');
            });
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.ranking-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Activar tab seleccionado
            activeTab.classList.add('active');
            activeTab.classList.remove('bg-gray-600');
            activeTab.classList.add('bg-sky-600');
            
            // Mostrar contenido correspondiente
            const tabId = activeTab.id;
            if (tabId === 'tab-jurados') {
                ui.rankingJurados.classList.remove('hidden');
            } else if (tabId === 'tab-publico') {
                ui.rankingPublico.classList.remove('hidden');
            } else if (tabId === 'tab-combinado') {
                ui.rankingCombinado.classList.remove('hidden');
            }
        }

        function updateGalaDetails() {
            ui.galaDetails.innerHTML = '';
            
            allGalas.forEach(gala => {
                const galaVotes = allVotes.filter(vote => vote.galaId === gala.id);
                const galaRanking = finalRanking
                    .filter(artist => artist.galaScores[gala.id])
                    .map(artist => ({
                        ...artist,
                        galaScore: artist.galaScores[gala.id]
                    }))
                    .sort((a, b) => b.galaScore - a.galaScore)
                    .slice(0, 5);

                const galaCard = document.createElement('div');
                galaCard.className = 'bg-gray-700 p-4 rounded-lg';
                
                galaCard.innerHTML = `
                    <h3 class="text-lg font-bold text-sky-300 mb-3">${gala.name}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-2">Top 5 de la Gala:</h4>
                            <div class="space-y-1">
                                ${galaRanking.map((artist, idx) => `
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-300">${idx + 1}. ${artist.artist.name}</span>
                                        <span class="text-green-400 font-bold">${artist.galaScore}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-2">Estad√≠sticas:</h4>
                            <div class="text-sm text-gray-400">
                                <p>‚Ä¢ Participantes: ${galaRanking.length}</p>
                                <p>‚Ä¢ Votos emitidos: ${galaVotes.length}</p>
                                <p>‚Ä¢ Puntaje m√°s alto: ${galaRanking[0]?.galaScore || 0}</p>
                                <p>‚Ä¢ Promedio de gala: ${galaRanking.length > 0 ? Math.round(galaRanking.reduce((sum, a) => sum + a.galaScore, 0) / galaRanking.length) : 0}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                ui.galaDetails.appendChild(galaCard);
            });
        }

        function updateEvolutionChart() {
            const ctx = document.getElementById('evolutionChart');
            
            if (evolutionChart) {
                evolutionChart.destroy();
            }

            // Datos para el top 5 de jurados
            const topFive = juryRanking.slice(0, 5);
            const galaLabels = allGalas.map(g => `Gala ${g.id}`);
            
            const datasets = topFive.map((artistData, index) => {
                const colors = ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#ff9f40'];
                
                const data = allGalas.map(gala => {
                    return artistData.galaScores[gala.id] || null;
                });

                return {
                    label: artistData.artist.name,
                    data: data,
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '20',
                    tension: 0.4,
                    fill: false
                };
            });

            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: galaLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evoluci√≥n Top 5 Jurados por Gala',
                            color: '#f9fafb'
                        },
                        legend: {
                            labels: { color: '#f9fafb' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#f9fafb' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: '#f9fafb' },
                            grid: { color: '#374151' },
                            beginAtZero: true,
                            max: 1000
                        }
                    }
                }
            });
        }

        function setupEventListeners() {
            ui.updateReportBtn.addEventListener('click', () => {
                showLoading(true);
                generateFinalReport().finally(() => showLoading(false));
            });
            
            ui.includeSecret.addEventListener('change', () => {
                showLoading(true);
                generateFinalReport().finally(() => showLoading(false));
            });
            
            ui.votingModeFilter.addEventListener('change', () => {
                showLoading(true);
                generateFinalReport().finally(() => showLoading(false));
            });

            // Event listeners para tabs
            ui.tabJurados.addEventListener('click', () => switchTab(ui.tabJurados));
            ui.tabPublico.addEventListener('click', () => switchTab(ui.tabPublico));
            ui.tabCombinado.addEventListener('click', () => switchTab(ui.tabCombinado));

            // Event listeners para modo de edici√≥n
            ui.toggleEditBtn.addEventListener('click', toggleEditMode);
            ui.saveChangesBtn.addEventListener('click', saveEditorialChanges);
            ui.resetOriginalBtn.addEventListener('click', resetToOriginal);
            ui.cancelEditBtn.addEventListener('click', () => {
                // Restaurar selecciones sin guardar
                updateEditSelectors();
                toggleEditMode();
            });

            ui.exportCsvBtn.addEventListener('click', exportToCSV);
            ui.printReportBtn.addEventListener('click', printReport);
            ui.shareResultsBtn.addEventListener('click', shareResults);
            
            // Bot√≥n para limpiar datos globales
            document.getElementById('clear-global-data-btn').addEventListener('click', () => {
                const confirmation = confirm('‚ö†Ô∏è ADVERTENCIA: Esto borrar√° TODOS los datos de vinculaci√≥n de artistas globales.\n\n¬øEst√°s SEGURO de que quieres continuar?\n\nEsta acci√≥n NO se puede deshacer.');
                
                if (confirmation) {
                    globalArtistsManager.clearAllData();
                    alert('üßπ Datos de artistas globales limpiados.\n\nEl sistema volver√° a crear nuevas vinculaciones cuando votes nuevamente.');
                    
                    // Regenerar el reporte
                    generateFinalReport();
                }
            });
        }

        function showLoading(show) {
            ui.loadingOverlay.classList.toggle('hidden', !show);
        }

        function showMessage(message, type = 'info') {
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            
            ui.messageContainer.innerHTML = `
                <div class="${bgColor} text-white p-4 rounded-lg shadow-xl">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                ui.messageContainer.innerHTML = '';
            }, 5000);
        }

        // Inicializar la aplicaci√≥n
        initialize();
    </script>
</body>
</html>