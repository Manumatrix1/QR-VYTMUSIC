<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaci√≥n Directa - VYT Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">üé≠ VOTACI√ìN DE JURADOS</h1>
            <p id="juror-name" class="text-xl text-green-400">Cargando...</p>
        </div>

        <div id="artists-container" class="space-y-6"></div>
        
        <div class="text-center mt-8">
            <button onclick="submitVotes()" class="bg-green-600 hover:bg-green-700 px-8 py-4 rounded-lg font-bold text-xl">
                üìä ENVIAR VOTOS
            </button>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // OBTENER JURADO DE LA URL
        const urlParams = new URLSearchParams(window.location.search);
        const jurorName = urlParams.get('juror') || 'Jurado';
        const eventId = 'gmxINHvzSJ18Zt3SNeW7';
        
        document.getElementById('juror-name').textContent = `Hola ${jurorName}`;
        
        let votes = {};
        let artists = [];

        // FUNCI√ìN PARA PROBAR M√öLTIPLES EVENTIDS
        async function tryMultipleEventIds() {
            const possibleEventIds = [
                'gmxINHvzSJ18Zt3SNeW7',
                '1GALA2024',
                'primera-gala',
                'gala1',
                'default'
            ];
            
            for (let testEventId of possibleEventIds) {
                console.log(`üîç Probando eventId: ${testEventId}`);
                try {
                    const snapshot = await getDocs(collection(db, `events/${testEventId}/artists`));
                    console.log(`üìä En ${testEventId} encontrados: ${snapshot.docs.length} artistas`);
                    
                    if (snapshot.docs.length > 0) {
                        console.log(`‚úÖ ¬°ENCONTRADOS! Usando eventId: ${testEventId}`);
                        return { snapshot, eventId: testEventId };
                    }
                } catch (error) {
                    console.log(`‚ùå Error en ${testEventId}:`, error.message);
                }
            }
            return null;
        }

        // CRITERIOS DE VOTACI√ìN
        const RATINGS = [
            { id: 'malo', name: 'Malo', value: 20, color: 'bg-red-500' },
            { id: 'mediano', name: 'Mediano', value: 40, color: 'bg-orange-500' },
            { id: 'bueno', name: 'Bueno', value: 60, color: 'bg-yellow-500' },
            { id: 'muy_bueno', name: 'Muy Bueno', value: 80, color: 'bg-green-500' },
            { id: 'excelente', name: 'Excelente', value: 100, color: 'bg-blue-500' }
        ];

        const CRITERIA = [
            { id: 'afinacion', name: 'üéµ Afinaci√≥n' },
            { id: 'puesta_escena', name: 'üé≠ Puesta en Escena' },
            { id: 'vestimenta', name: 'üëî Vestimenta' },
            { id: 'conexion_publico', name: 'üë• Conexi√≥n P√∫blico' },
            { id: 'eleccion_cancion', name: 'üé∂ Elecci√≥n Canci√≥n' }
        ];

        // CARGAR ARTISTAS
        async function loadArtists() {
            console.log('üé§ Buscando artistas en m√∫ltiples eventIds...');
            
            try {
                // Primero intentar encontrar donde est√°n los artistas
                const result = await tryMultipleEventIds();
                
                if (result) {
                    artists = result.snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    window.workingEventId = result.eventId; // Guardar el eventId que funciona
                    console.log(`‚úÖ ${artists.length} artistas encontrados en ${result.eventId}`);
                } else {
                    console.log('‚ùå No se encontraron artistas en ning√∫n eventId');
                    document.getElementById('artists-container').innerHTML = `
                        <div class="text-center text-red-400 p-8">
                            <h3 class="text-xl mb-4">‚ùå No hay artistas cargados</h3>
                            <p class="mb-4">Ve a "Gesti√≥n de Votaciones" y agrega artistas primero.</p>
                            <p class="text-sm text-gray-400">EventIds probados: gmxINHvzSJ18Zt3SNeW7, 1GALA2024, primera-gala, gala1, default</p>
                        </div>
                    `;
                    return;
                }

                renderArtists();
                
            } catch (error) {
                console.error('‚ùå Error cargando artistas:', error);
                document.getElementById('artists-container').innerHTML = 
                    '<p class="text-center text-red-400 text-xl">‚ùå Error: ' + error.message + '</p>';
            }
        }

        function renderArtists() {
            const container = document.getElementById('artists-container');
            container.innerHTML = '';

            artists.forEach(artist => {
                const artistDiv = document.createElement('div');
                artistDiv.className = 'bg-gray-800 rounded-lg p-6';
                artistDiv.innerHTML = `
                    <div class="flex items-center space-x-4 mb-6">
                        <img src="${artist.photoURL || 'https://via.placeholder.com/80'}" 
                             alt="${artist.name}" class="w-20 h-20 rounded-full object-cover">
                        <div>
                            <h3 class="text-2xl font-bold">${artist.name}</h3>
                            <p class="text-gray-400">${artist.song || 'Sin canci√≥n'}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${CRITERIA.map(criterion => `
                            <div>
                                <h4 class="font-bold mb-2">${criterion.name}</h4>
                                <div class="grid grid-cols-5 gap-2">
                                    ${RATINGS.map(rating => `
                                        <button onclick="vote('${artist.id}', '${criterion.id}', ${rating.value})" 
                                                class="${rating.color} hover:opacity-80 text-white py-2 px-3 rounded text-sm font-bold"
                                                id="btn-${artist.id}-${criterion.id}-${rating.value}">
                                            ${rating.name}
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="text-center mt-2 text-sm text-gray-400" id="score-${artist.id}-${criterion.id}">
                                    Sin calificar
                                </p>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(artistDiv);
            });
        }

        window.vote = function(artistId, criterionId, score) {
            if (!votes[artistId]) votes[artistId] = {};
            votes[artistId][criterionId] = score;
            
            // Actualizar display
            document.getElementById(`score-${artistId}-${criterionId}`).textContent = `${score} puntos`;
            
            // Limpiar botones anteriores
            RATINGS.forEach(rating => {
                const btn = document.getElementById(`btn-${artistId}-${criterionId}-${rating.value}`);
                if (btn) {
                    btn.classList.remove('ring-4', 'ring-white');
                }
            });
            
            // Marcar bot√≥n seleccionado
            const selectedBtn = document.getElementById(`btn-${artistId}-${criterionId}-${score}`);
            if (selectedBtn) {
                selectedBtn.classList.add('ring-4', 'ring-white');
            }
        };

        window.submitVotes = async function() {
            const finalEventId = window.workingEventId || eventId;
            console.log('üìä Enviando votos a eventId:', finalEventId);
            
            try {
                const votePromises = Object.entries(votes).map(([artistId, artistVotes]) => {
                    const average = Object.values(artistVotes).reduce((a, b) => a + b, 0) / Object.values(artistVotes).length;
                    
                    return setDoc(doc(db, `events/${finalEventId}/jury_votes`, `${jurorName}_${artistId}`), {
                        jurorName: jurorName,
                        artistId: artistId,
                        scores: artistVotes,
                        average: average,
                        timestamp: new Date()
                    });
                });

                await Promise.all(votePromises);
                alert('üéâ ¬°Votos enviados exitosamente!\n\nGracias por participar.');
            } catch (error) {
                alert('‚ùå Error al enviar votos: ' + error.message);
            }
        };

        // Iniciar
        loadArtists();
    </script>
</body>
</html>