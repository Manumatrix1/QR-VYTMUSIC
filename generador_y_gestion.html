<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador y Gestión - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #38bdf8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 900; display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; max-width: 90%; width: 500px; }
        .ticket-card-preview { background-color: #1f2937; color: #f9fafb; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 1rem; padding: 1.5rem; border-radius: 0.5rem; max-width: 400px; margin: 0 auto; }
        .qrcode-wrapper { position: relative; width: 100%; max-width: 300px; padding-bottom: 100%; height: 0; background-color: white; border-radius: 0.25rem; overflow: hidden; margin: 0 auto; }
        .qrcode-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .qrcode-container canvas { width: 100% !important; height: 100% !important; object-fit: contain; }
        .qrcode-logo { position: absolute; z-index: 10; width: 20%; height: auto; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; background-color: white; padding: 5px; }
        .artist-preview-card { display: flex; align-items: center; background-color: #1f2937; padding: 0.75rem; border-radius: 0.5rem; gap: 1rem; }
        .artist-image-container-small { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid #38bdf8; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        .artist-image { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <a href="index.html" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Panel Principal</a>
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Generador y Gestión</h1>
        </header>

        <main class="space-y-8">
            <section id="batch-ticket-generator-section" class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4">Generar Entradas en Lote</h2>
                <form id="generator-form" class="space-y-4">
                    <div>
                        <label for="show-name-input" class="block mb-1 font-semibold text-gray-300">Nombre del Show</label>
                        <input type="text" id="show-name-input" placeholder="Concierto de Verano" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                    </div>
                    <div>
                        <label for="ticket-prefix-input" class="block mb-1 font-semibold text-gray-300">Prefijo de Artista/Grupo (ID Único)</label>
                        <input type="text" id="ticket-prefix-input" placeholder="Ej: JuanPerezShow" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                    </div>
                    <div>
                        <label for="batch-ticket-names-input" class="block mb-1 font-semibold text-gray-300">Nombres (uno por línea o separados por coma)</label>
                        <textarea id="batch-ticket-names-input" rows="5" placeholder="Juan Perez, Maria Gonzalez, ..." required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white"></textarea>
                    </div>
                    <button type="submit" id="generator-form-submit-btn" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">Generar Entradas</button>
                </form>
                <div id="generated-tickets-container" class="mt-6"></div>
            </section>

            <section id="voting-section" class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4">Gestión de Votaciones</h2>
                 <div class="bg-gray-900 p-6 rounded-lg max-w-2xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">Agregar Nuevos Artistas</h3>
                    <form id="artist-form" class="space-y-4">
                        <div>
                            <label for="artist-photos-input" class="block mb-1 font-semibold text-gray-300">Fotos de los Artistas</label>
                            <input type="file" id="artist-photos-input" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-600 file:text-white hover:file:bg-sky-700" multiple />
                        </div>
                        <div id="artist-previews-container" class="grid grid-cols-1 gap-4 mt-4"></div>
                        <button type="submit" id="add-artists-btn" class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>Agregar Artistas</button>
                    </form>
                    <a href="voting_page.html" target="_blank" class="block w-full text-center px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 mt-6">Abrir Página de Votación del Público</a>
                </div>
            </section>

            <section id="assistant-management-section" class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4">Gestionar Asistentes</h2>
                <p class="text-gray-400 mb-6">Genera códigos para que tus asistentes puedan acceder a las funciones de escaneo.</p>
                <button id="generate-code-btn" class="w-full max-w-xs mx-auto block px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 mb-6">Generar Nuevo Código de Evento</button>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-center">Códigos Activos</h3>
                    <ul id="event-codes-list" class="space-y-3"></ul>
                </div>
            </section>
        </main>
    </div>
    
    <div id="loading-overlay" class="loading-overlay hidden"><div class="spinner"></div></div>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, writeBatch, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_2Ukoxf_ry7QfKtou1Cz6nY-qTVw4qTU",
            authDomain: "vyt-music.firebaseapp.com",
            projectId: "vyt-music",
            storageBucket: "vyt-music.appspot.com",
            messagingSenderId: "574981837817",
            appId: "1:574981837817:web:a29933a22bbfd51a086328"
        };

        const state = { db: null, storage: null, pendingArtists: [], appId: firebaseConfig.projectId };
        const ui = {};

        function cacheUIElements() {
            ui.loadingOverlay = document.getElementById('loading-overlay');
            ui.generatorForm = document.getElementById('generator-form');
            ui.generatedTicketsContainer = document.getElementById('generated-tickets-container');
            ui.artistForm = document.getElementById('artist-form');
            ui.artistPhotosInput = document.getElementById('artist-photos-input');
            ui.artistPreviewsContainer = document.getElementById('artist-previews-container');
            ui.addArtistsBtn = document.getElementById('add-artists-btn');
            ui.generateCodeBtn = document.getElementById('generate-code-btn');
            ui.eventCodesList = document.getElementById('event-codes-list');
        }

        function setLoading(show) { ui.loadingOverlay.classList.toggle('hidden', !show); }

        function displayMessage(message, type = 'success') {
            alert(`[${type.toUpperCase()}] ${message}`);
        }

        function generateVisualCodesForTicket(ticket, container) {
            const cardWrapper = document.createElement('div');
            cardWrapper.id = `card-${ticket.id}`;
            cardWrapper.className = 'ticket-card-preview';
            cardWrapper.innerHTML = `
                <div class="w-full"><h3 class="text-2xl font-bold text-sky-400">${ticket.name}</h3></div>
                <div class="qrcode-wrapper">
                    <div id="qrcode-${ticket.id}" class="qrcode-container"></div>
                    <img src="logonegro.png" alt="Logo" class="qrcode-logo">
                </div>
                <div class="mt-1 p-2 bg-white rounded-md"><svg id="barcode-${ticket.id}" class="w-full"></svg></div>
                <div class="w-full mt-4"><p class="text-lg font-semibold">${ticket.showName}</p><p class="text-xs text-gray-500 mt-2">ID: ${ticket.id}</p></div>
                <button class="download-qr-btn w-full mt-4 px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">Descargar Entrada (PNG)</button>`;
            container.appendChild(cardWrapper);
            new QRCode(document.getElementById(`qrcode-${ticket.id}`), { text: ticket.id, width: 256, height: 256, correctLevel: QRCode.CorrectLevel.H });
            JsBarcode(document.getElementById(`barcode-${ticket.id}`), ticket.id, { format: "CODE128", lineColor: "#000", width: 2, height: 30, displayValue: true, fontSize: 14 });
            cardWrapper.querySelector('.download-qr-btn').addEventListener('click', () => {
                html2canvas(document.getElementById(`card-${ticket.id}`), { backgroundColor: '#1f2937', useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `Entrada_VYTMUSIC_${ticket.name.replace(/\s/g, '_')}.png`;
                    link.click();
                });
            });
        }

        function renderArtistPreviews(files) {
            ui.artistPreviewsContainer.innerHTML = '';
            state.pendingArtists = [];
            if (files.length === 0) { ui.addArtistsBtn.disabled = true; return; }
            Array.from(files).forEach((file, index) => {
                let defaultName = file.name.split('.').slice(0, -1).join('.').replace(/[_-]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                const artist = { file, name: defaultName, id: `pending-${index}` };
                state.pendingArtists.push(artist);
                const card = document.createElement('div');
                card.className = 'artist-preview-card';
                card.innerHTML = `
                    <div class="flex-grow"><input type="text" value="${artist.name}" data-artist-id="${artist.id}" class="artist-name-input w-full p-2 rounded-md border border-gray-600 bg-gray-900 text-white"></div>
                    <button type="button" data-artist-id="${artist.id}" class="remove-artist-preview-btn ml-2 p-2 rounded-full bg-red-600 text-white">X</button>`;
                ui.artistPreviewsContainer.appendChild(card);
            });
            ui.addArtistsBtn.disabled = false;
        }

        function setupEventListeners() {
            ui.generatorForm.addEventListener('submit', async (e) => {
                e.preventDefault(); setLoading(true);
                const ticketPrefix = document.getElementById('ticket-prefix-input').value.trim();
                const showName = document.getElementById('show-name-input').value.trim();
                const names = document.getElementById('batch-ticket-names-input').value.trim().split(/[\n,]+/).map(n => n.trim()).filter(Boolean);
                try {
                    const batch = writeBatch(state.db);
                    const ticketsCol = collection(state.db, `artifacts/${state.appId}/public/data/tickets`);
                    ui.generatedTicketsContainer.innerHTML = '';
                    names.forEach(name => {
                        const ticketId = `${ticketPrefix}-${crypto.randomUUID().substring(0, 8)}`;
                        const ticketData = { id: ticketId, prefix: ticketPrefix, name, showName, used: false, generatedAt: new Date().toISOString() };
                        batch.set(doc(ticketsCol, ticketId), ticketData);
                        generateVisualCodesForTicket(ticketData, ui.generatedTicketsContainer);
                    });
                    await batch.commit();
                    displayMessage(`${names.length} entradas generadas.`, 'success');
                } catch (error) { displayMessage(`Error: ${error.message}`, 'error'); } 
                finally { setLoading(false); }
            });

            ui.artistForm.addEventListener('submit', async (e) => {
                e.preventDefault(); if (state.pendingArtists.length === 0) return;
                setLoading(true);
                try {
                    const uploadPromises = state.pendingArtists.map(async (artist) => {
                        const fileName = `${Date.now()}-${artist.file.name}`;
                        const photoRef = ref(state.storage, `artifacts/${state.appId}/public/artist_photos/${fileName}`);
                        await uploadBytes(photoRef, artist.file);
                        const photoURL = await getDownloadURL(photoRef);
                        return { name: artist.name, photoURL, totalRatingsCount: 0, totalScore: 0 };
                    });
                    const artistsToSave = await Promise.all(uploadPromises);
                    const batch = writeBatch(state.db);
                    const artistsCollection = collection(state.db, `artifacts/${state.appId}/public/data/artists`);
                    artistsToSave.forEach(artistData => {
                        batch.set(doc(artistsCollection), artistData);
                    });
                    await batch.commit();
                    displayMessage(`${artistsToSave.length} artista(s) agregado(s).`, 'success');
                    ui.artistForm.reset();
                    ui.artistPreviewsContainer.innerHTML = '';
                } catch (error) { displayMessage(`Error: ${error.message}`, 'error'); }
                finally { setLoading(false); }
            });

            ui.artistPhotosInput.addEventListener('change', (e) => renderArtistPreviews(e.target.files));
            ui.artistPreviewsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('artist-name-input')) {
                    const artist = state.pendingArtists.find(a => a.id === e.target.dataset.artistId);
                    if (artist) artist.name = e.target.value;
                }
            });
            ui.artistPreviewsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-artist-preview-btn')) {
                    state.pendingArtists = state.pendingArtists.filter(a => a.id !== e.target.dataset.artistId);
                    e.target.closest('.artist-preview-card').remove();
                }
            });

            ui.generateCodeBtn.addEventListener('click', async () => {
                setLoading(true);
                try {
                    const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await addDoc(collection(state.db, `artifacts/${state.appId}/public/data/event_codes`), {
                        code: newCode, createdAt: new Date().toISOString(), active: true
                    });
                    displayMessage(`Código de evento "${newCode}" generado.`, 'success');
                } catch (error) { displayMessage(`Error: ${error.message}`, 'error'); }
                finally { setLoading(false); }
            });

            ui.eventCodesList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('deactivate-code-btn')) {
                    const codeId = e.target.dataset.codeId;
                    if(confirm("¿Seguro que quieres desactivar este código?")) {
                        await updateDoc(doc(state.db, `artifacts/${state.appId}/public/data/event_codes`, codeId), { active: false });
                    }
                }
            });
        }
        
        function renderEventCodes(codes) {
            ui.eventCodesList.innerHTML = '';
            codes.filter(c => c.active).forEach(code => {
                const li = document.createElement('li');
                li.className = 'bg-gray-900 p-4 rounded-md flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-xl text-sky-300">${code.code}</p>
                        <p class="text-xs text-gray-500">${new Date(code.createdAt).toLocaleString()}</p>
                    </div>
                    <button data-code-id="${code.id}" class="deactivate-code-btn px-3 py-1 text-xs bg-red-600 text-white rounded">Desactivar</button>`;
                ui.eventCodesList.appendChild(li);
            });
        }
        
        function initApp() {
            const app = initializeApp(firebaseConfig);
            state.db = getFirestore(app);
            state.storage = getStorage(app);
            cacheUIElements();
            setupEventListeners();

            const eventCodesQuery = query(collection(state.db, `artifacts/${state.appId}/public/data/event_codes`));
            onSnapshot(eventCodesQuery, (snapshot) => {
                const codes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEventCodes(codes);
            });
        }

        window.onload = initApp;
    </script>
</body>
</html>