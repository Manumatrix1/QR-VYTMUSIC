<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback en Vivo - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: #f9fafb; 
        }
        .hidden { display: none !important; }
        .score-card {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border: 2px solid #4b5563;
            transition: all 0.3s ease;
        }
        .score-card:hover {
            border-color: #38bdf8;
            transform: translateY(-2px);
        }
        .score-display {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #38bdf8, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .juror-card {
            background-color: #1f2937;
            border-left: 4px solid #38bdf8;
        }
        .secret-juror {
            border-left-color: #fbbf24;
            background-color: #1c1917;
        }
        
        /* OPTIMIZACIÓN MÓVIL COMPLETA */
        @media (max-width: 768px) {
            .container { 
                padding: 0.5rem; 
                max-width: 100%;
            }
            
            /* Header responsive */
            header h1 { 
                font-size: 1.75rem; 
                margin-bottom: 0.5rem;
            }
            header img {
                max-width: 80px !important;
            }
            
            /* Secciones más compactas */
            section {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Selector responsive */
            .grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            /* Score cards responsive */
            .score-card {
                padding: 1rem !important;
            }
            
            .score-display {
                font-size: 2rem !important;
            }
            
            /* Grid de criterios responsive */
            .grid-cols-5 {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            /* Juror cards más compactas */
            .juror-card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem;
            }
            
            /* Información del artista más compacta */
            .flex.items-center.gap-6 {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            #artist-photo {
                width: 80px !important;
                height: 80px !important;
            }
            
            /* Feedback script más legible */
            #feedback-script {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            /* Botones responsive */
            .grid-cols-3 button {
                padding: 0.875rem 0.5rem;
                font-size: 0.85rem;
            }
            
            /* Textarea responsive */
            textarea {
                font-size: 0.9rem;
                padding: 0.75rem;
            }
            
            /* Breakdown de criterios */
            #criteria-breakdown > div {
                padding: 0.5rem !important;
                font-size: 0.8rem;
            }
            
            #criteria-breakdown h4 {
                font-size: 0.75rem !important;
            }
            
            #criteria-breakdown .text-lg {
                font-size: 1rem !important;
            }
        }
        
        /* Pantallas muy pequeñas */
        @media (max-width: 480px) {
            .container {
                padding: 0.25rem;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            section {
                padding: 0.75rem !important;
            }
            
            .score-display {
                font-size: 1.75rem !important;
            }
            
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            /* Simplificar grid de criterios en pantallas muy pequeñas */
            .grid-cols-5 {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
            
            /* Botones stack verticalmente */
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-6xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <a id="back-to-panel-link" href="#" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Panel del Evento</a>
            <img src="https://i.imgur.com/rqkZi9P.png" alt="VYTMUSIC Logo" class="mx-auto mb-4 bg-white rounded-full" style="max-width: 100px;">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Panel de Feedback en Vivo</h1>
            <p id="event-name-display" class="text-xl text-gray-300 mt-2"></p>
            <p class="text-gray-400 mt-1">Herramienta para dar devoluciones inmediatas con puntajes exactos</p>
        </header>

        <div id="message-container" class="mb-4"></div>

        <!-- Lista de Artistas para Feedback -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-4">💬 Selecciona un Artista para Dar Feedback</h2>
            
            <!-- Selector de Gala -->
            <div class="mb-6">
                <label for="gala-select" class="block text-sm font-medium text-gray-300 mb-2">Seleccionar Gala:</label>
                <select id="gala-select" class="w-full md:w-1/2 p-3 border border-gray-600 rounded-lg bg-gray-700 text-white">
                    <option value="">Seleccionar gala...</option>
                </select>
            </div>

            <!-- Grid de Artistas -->
            <div id="artists-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden">
                <!-- Se llenará dinámicamente con artistas -->
            </div>
            
            <div id="no-artists-message" class="text-center text-gray-400 py-8 hidden">
                <div class="text-4xl mb-2">🎭</div>
                <p>Selecciona una gala para ver los artistas disponibles</p>
            </div>
        </section>

        <!-- Modal de Votación Individual -->
        <div id="voting-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <!-- Header del Modal -->
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-sky-400">💬 Panel de Feedback</h2>
                        <button id="close-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>

                    <!-- Información del Artista -->
                    <div class="flex items-center gap-4 mb-6 p-4 bg-gray-700 rounded-lg">
                        <img id="modal-artist-photo" src="" alt="Foto del artista" class="w-16 h-16 object-cover rounded-full border-2 border-sky-300">
                        <div>
                            <h3 id="modal-artist-name" class="text-xl font-bold text-white"></h3>
                            <p id="modal-artist-info" class="text-gray-300 text-sm"></p>
                        </div>
                    </div>

                    <!-- Sistema de Puntuación -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white mb-4">📊 Evaluar por Categorías (25-100 puntos cada una)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="category-scores">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Feedback Automático -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white mb-4">🤖 Feedback Sugerido (basado en puntuaciones)</h4>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <textarea id="auto-feedback" class="w-full h-32 bg-gray-600 text-white p-3 rounded border border-gray-500 resize-none" 
                                      placeholder="El feedback se generará automáticamente cuando puntúes las categorías..."></textarea>
                            <p class="text-xs text-gray-400 mt-2">💡 Este feedback se genera automáticamente. Puedes editarlo antes de enviarlo.</p>
                        </div>
                    </div>

                    <!-- Puntuación Total -->
                    <div class="text-center mb-6">
                        <div class="bg-gray-700 p-4 rounded-lg inline-block">
                            <h4 class="text-lg font-bold text-yellow-300">Total:</h4>
                            <div id="total-score" class="text-3xl font-bold text-yellow-400">0/600</div>
                            <p class="text-sm text-gray-400">Puntuación combinada de todas las categorías</p>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="flex gap-4 justify-end">
                        <button id="cancel-vote" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Cancelar
                        </button>
                        <button id="save-feedback" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            💾 Guardar Feedback
                        </button>
                    </div>
                </div>
            </div>
        </div>
                        📊 Cargar Puntuaciones
                    </button>
                </div>
            </div>
        </section>

        <!-- Panel de puntuaciones -->
        <div id="scores-panel" class="hidden">
            <!-- Información del artista -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                <div class="flex items-center gap-6">
                    <img id="artist-photo" src="" alt="Foto del artista" class="w-20 h-20 object-cover rounded-full border-4 border-sky-300">
                    <div>
                        <h2 id="artist-name-display" class="text-2xl font-bold text-sky-400"></h2>
                        <p id="artist-song" class="text-gray-300"></p>
                        <p id="artist-city" class="text-sm text-gray-400"></p>
                    </div>
                </div>
            </section>

            <!-- Puntuaciones por jurado -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                <h2 class="text-2xl font-bold mb-6">Puntuaciones Individuales por Jurado</h2>
                <div id="individual-scores" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Se llenarán dinámicamente -->
                </div>
            </section>

            <!-- Resumen para feedback -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
                <h2 class="text-2xl font-bold mb-6 text-center">Resumen para Feedback en Vivo</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Promedio de jurados principales -->
                    <div class="score-card p-6 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-sky-300 mb-2">Promedio Jurados Principales</h3>
                        <div id="main-average" class="score-display">0</div>
                        <p class="text-gray-400 mt-2">Puntos de 1000</p>
                        <p id="main-jurors-count" class="text-sm text-gray-500 mt-1">0 jurados principales</p>
                    </div>

                    <!-- Promedio total incluyendo secreto -->
                    <div class="score-card p-6 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-yellow-300 mb-2">Promedio Total (+ Secreto)</h3>
                        <div id="total-average" class="score-display">0</div>
                        <p class="text-gray-400 mt-2">Puntos de 1000</p>
                        <p id="total-jurors-count" class="text-sm text-gray-500 mt-1">0 jurados total</p>
                    </div>
                </div>

                <!-- Desglose por criterios -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-center">Desglose por Criterios (Promedio Principal)</h3>
                    <div id="criteria-breakdown" class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <!-- Se llenarán dinámicamente -->
                    </div>
                </div>
            </section>

            <!-- Herramienta de feedback -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-6">Herramienta de Feedback</h2>
                
                <!-- Script para el feedback -->
                <div class="bg-gray-700 p-4 rounded-lg mb-4">
                    <h3 class="font-semibold text-sky-300 mb-3">💬 Script Sugerido para Devolución:</h3>
                    <div id="feedback-script" class="text-gray-200 leading-relaxed">
                        <!-- Se generará automáticamente -->
                    </div>
                </div>

                <!-- Notas adicionales del jurado -->
                <div class="mb-4">
                    <label for="additional-notes" class="block text-sm font-medium text-gray-300 mb-2">
                        Notas Adicionales del Jurado
                    </label>
                    <textarea id="additional-notes" rows="3" 
                              class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white"
                              placeholder="Comentarios adicionales, sugerencias específicas, observaciones especiales..."></textarea>
                </div>

                <!-- Acciones -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="generate-feedback-btn" class="py-3 px-6 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">
                        🔄 Regenerar Script
                    </button>
                    <button id="save-feedback-btn" class="py-3 px-6 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors">
                        💾 Guardar Feedback
                    </button>
                    <button id="copy-script-btn" class="py-3 px-6 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                        📋 Copiar Script
                    </button>
                </div>
            </section>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, getDoc, query, where, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        
        if (!eventId) {
            document.body.innerHTML = '<p class="text-center text-red-500">Error: No se ha especificado un evento.</p>';
            throw new Error('Event ID missing');
        }

        let currentArtist = null;
        let currentScores = [];

        // Elementos del DOM
        const ui = {
            galaSelect: document.getElementById('gala-select'),
            artistSelect: document.getElementById('artist-select'),
            loadScoresBtn: document.getElementById('load-scores-btn'),
            scoresPanel: document.getElementById('scores-panel'),
            artistPhoto: document.getElementById('artist-photo'),
            artistNameDisplay: document.getElementById('artist-name-display'),
            artistSong: document.getElementById('artist-song'),
            artistCity: document.getElementById('artist-city'),
            individualScores: document.getElementById('individual-scores'),
            mainAverage: document.getElementById('main-average'),
            totalAverage: document.getElementById('total-average'),
            mainJurorsCount: document.getElementById('main-jurors-count'),
            totalJurorsCount: document.getElementById('total-jurors-count'),
            criteriaBreakdown: document.getElementById('criteria-breakdown'),
            feedbackScript: document.getElementById('feedback-script'),
            additionalNotes: document.getElementById('additional-notes'),
            generateFeedbackBtn: document.getElementById('generate-feedback-btn'),
            saveFeedbackBtn: document.getElementById('save-feedback-btn'),
            copyScriptBtn: document.getElementById('copy-script-btn')
        };

        // Criterios de evaluación
        const CRITERIA = {
            afinacion: 'Afinación',
            ritmo: 'Ritmo y Tempo',
            tecnica: 'Técnica Vocal',
            expresion: 'Expresión',
            presencia: 'Presencia Escénica',
            originalidad: 'Originalidad',
            diccion: 'Dicción',
            conexion: 'Conexión con Público',
            actitud: 'Actitud',
            evolucion: 'Evolución'
        };

        // Inicialización
        async function initialize() {
            try {
                await loadEventData();
                await loadGalas();
                setupEventListeners();
                showMessage('Panel de feedback cargado correctamente', 'success');
            } catch (error) {
                console.error('Error inicializando:', error);
                showMessage('Error al cargar el panel: ' + error.message, 'error');
            }
        }

        async function loadEventData() {
            const eventDoc = await getDoc(doc(db, 'events', eventId));
            if (eventDoc.exists()) {
                const eventData = eventDoc.data();
                document.getElementById('event-name-display').textContent = eventData.name;
                
                // Configurar enlace de regreso con eventId y eventName
                document.getElementById('back-to-panel-link').href = `panel_evento.html?eventId=${eventId}&eventName=${encodeURIComponent(eventData.name)}`;
            }
        }

        async function loadGalas() {
            try {
                // Cargar galas desde los votos existentes (tanto jurados como público)
                const [juryVotesSnapshot, publicVotesSnapshot] = await Promise.all([
                    getDocs(collection(db, 'events', eventId, 'jury_votes')),
                    getDocs(collection(db, 'events', eventId, 'votes'))
                ]);
                
                // Extraer galas únicas
                const galaIds = new Set();
                
                juryVotesSnapshot.forEach(doc => {
                    const vote = doc.data();
                    if (vote.galaId) {
                        galaIds.add(vote.galaId);
                    }
                });
                
                publicVotesSnapshot.forEach(doc => {
                    const vote = doc.data();
                    if (vote.galaId) {
                        galaIds.add(vote.galaId);
                    }
                });
                
                // Limpiar selector
                ui.galaSelect.innerHTML = '<option value="">Seleccionar gala...</option>';
                
                if (galaIds.size === 0) {
                    ui.galaSelect.innerHTML = '<option value="">No hay galas con votaciones</option>';
                    return;
                }
                
                // Ordenar y agregar opciones
                const sortedGalas = Array.from(galaIds).sort((a, b) => {
                    return parseInt(a) - parseInt(b);
                });
                
                sortedGalas.forEach(galaId => {
                    const option = document.createElement('option');
                    option.value = galaId;
                    option.textContent = `Gala ${galaId}`;
                    ui.galaSelect.appendChild(option);
                });
                
                console.log(`Cargadas ${sortedGalas.length} galas con votaciones`);
                
            } catch (error) {
                console.error('Error loading galas:', error);
                ui.galaSelect.innerHTML = '<option value="">Error cargando galas</option>';
                showMessage('Error cargando galas: ' + error.message, 'error');
            }
        }

        async function loadArtistsForGala(galaId) {
            if (!galaId) {
                const artistsGrid = document.getElementById('artists-grid');
                if (artistsGrid) {
                    artistsGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full">Primero selecciona una gala...</p>';
                }
                // Mantener compatibilidad con el selector original
                ui.artistSelect.innerHTML = '<option value="">Primero selecciona una gala...</option>';
                return;
            }

            try {
                const artistsQuery = query(collection(db, 'events', eventId, 'artists'));
                const artistsSnapshot = await getDocs(artistsQuery);
                
                const artistsGrid = document.getElementById('artists-grid');
                
                if (artistsGrid) {
                    // Nueva interfaz de grid
                    artistsGrid.innerHTML = '';
                    
                    if (artistsSnapshot.empty) {
                        artistsGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full">No hay artistas registrados para esta gala.</p>';
                        return;
                    }
                    
                    artistsSnapshot.forEach(doc => {
                        const artist = doc.data();
                        const artistData = { id: doc.id, ...artist };
                        
                        const artistCard = document.createElement('div');
                        artistCard.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow duration-200 border border-gray-200';
                        artistCard.onclick = () => openVotingModal(artistData);
                        
                        artistCard.innerHTML = `
                            <div class="aspect-video bg-gray-100">
                                <img src="${artist.foto || 'https://via.placeholder.com/300x200/e5e7eb/6b7280?text=Sin+Foto'}" 
                                     alt="${artist.nombre || artist.name}" 
                                     class="w-full h-full object-cover"
                                     onerror="this.src='https://via.placeholder.com/300x200/e5e7eb/6b7280?text=Sin+Foto'">
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-gray-900 text-center">${artist.nombre || artist.name}</h3>
                            </div>
                        `;
                        
                        artistsGrid.appendChild(artistCard);
                    });
                }
                
                // Mantener compatibilidad con el selector original
                ui.artistSelect.innerHTML = '<option value="">Seleccionar artista...</option>';
                artistsSnapshot.forEach(doc => {
                    const artist = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = artist.nombre || artist.name;
                    ui.artistSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando artistas:', error);
                showMessage('Error cargando artistas: ' + error.message, 'error');
            }
        }

        async function loadScoresForArtist() {
            const galaId = ui.galaSelect.value;
            const artistId = ui.artistSelect.value;
            
            if (!galaId || !artistId) {
                showMessage('Por favor selecciona una gala y un artista', 'error');
                return;
            }

            try {
                // Cargar datos del artista
                const artistDoc = await getDoc(doc(db, 'events', eventId, 'artists', artistId));
                if (!artistDoc.exists()) {
                    showMessage('Artista no encontrado', 'error');
                    return;
                }
                
                currentArtist = { id: artistId, ...artistDoc.data() };
                
                // Cargar puntuaciones
                const votesQuery = query(
                    collection(db, 'events', eventId, 'jury_votes'),
                    where('artistId', '==', artistId),
                    where('galaId', '==', galaId)
                );
                
                const votesSnapshot = await getDocs(votesQuery);
                currentScores = [];
                
                votesSnapshot.forEach(doc => {
                    currentScores.push({ id: doc.id, ...doc.data() });
                });

                // Mostrar datos
                displayArtistInfo();
                displayScores();
                generateFeedbackScript();
                
                ui.scoresPanel.classList.remove('hidden');
                showMessage('Puntuaciones cargadas correctamente', 'success');
                
            } catch (error) {
                console.error('Error cargando puntuaciones:', error);
                showMessage('Error al cargar las puntuaciones: ' + error.message, 'error');
            }
        }

        function displayArtistInfo() {
            ui.artistNameDisplay.textContent = currentArtist.name;
            ui.artistSong.textContent = currentArtist.currentSong || 'Sin canción especificada';
            ui.artistCity.textContent = currentArtist.city || '';
            
            if (currentArtist.photoUrl) {
                ui.artistPhoto.src = currentArtist.photoUrl;
                ui.artistPhoto.style.display = 'block';
            } else {
                ui.artistPhoto.style.display = 'none';
            }
        }

        function displayScores() {
            // Limpiar contenedor
            ui.individualScores.innerHTML = '';
            
            if (currentScores.length === 0) {
                ui.individualScores.innerHTML = '<div class="col-span-full text-center text-gray-400">No hay puntuaciones registradas para este artista en esta gala</div>';
                return;
            }

            // Separar jurados principales y secretos
            const mainJurors = currentScores.filter(score => !score.isSecret);
            const secretJurors = currentScores.filter(score => score.isSecret);

            // Mostrar jurados principales
            mainJurors.forEach(score => {
                createJurorCard(score, false);
            });

            // Mostrar jurados secretos
            secretJurors.forEach(score => {
                createJurorCard(score, true);
            });

            // Calcular y mostrar promedios
            calculateAverages();
        }

        function createJurorCard(score, isSecret) {
            const totalScore = Object.values(score.scores).reduce((sum, val) => sum + val, 0);
            
            const card = document.createElement('div');
            card.className = `juror-card p-4 rounded-lg ${isSecret ? 'secret-juror' : ''}`;
            
            // Determinar tipo de voto
            let voteType = '';
            if (score.isCollaborative) {
                voteType = '🤝 Colaborativo';
            } else if (isSecret) {
                voteType = '🔒 Secreto';
            } else {
                voteType = '👤 Individual';
            }
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold ${isSecret ? 'text-yellow-300' : 'text-sky-300'}">
                        ${score.jurorName} 
                        <span class="text-xs px-2 py-1 rounded ${score.isCollaborative ? 'bg-green-700' : isSecret ? 'bg-yellow-700' : 'bg-blue-700'}">${voteType}</span>
                    </h3>
                    <div class="text-xl font-bold text-green-400">${totalScore}/1000</div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    ${Object.entries(score.scores).map(([criteria, value]) => `
                        <div class="flex justify-between">
                            <span class="text-gray-400">${CRITERIA[criteria] || criteria}:</span>
                            <span class="text-gray-200">${value}</span>
                        </div>
                    `).join('')}
                </div>
                ${score.comentarios ? `
                    <div class="mt-3 p-2 bg-gray-600 rounded text-sm">
                        <strong>Comentarios:</strong> ${score.comentarios}
                    </div>
                ` : ''}
            `;
            
            ui.individualScores.appendChild(card);
        }

        function calculateAverages() {
            // Separar votos individuales de colaborativos
            const individualVotes = currentScores.filter(score => !score.isCollaborative && !score.isSecret);
            const collaborativeVotes = currentScores.filter(score => score.isCollaborative && !score.isSecret);
            const secretVotes = currentScores.filter(score => score.isSecret);

            let mainVotes = [];
            let displayText = '';

            // Determinar qué votos usar para el promedio principal
            if (collaborativeVotes.length > 0) {
                // Si hay votos colaborativos, usar esos
                mainVotes = collaborativeVotes;
                displayText = 'Consenso Colaborativo';
            } else if (individualVotes.length > 0) {
                // Si no hay colaborativos, usar individuales
                mainVotes = individualVotes;
                displayText = `${individualVotes.length} jurados individuales`;
            }

            // Promedio principal (colaborativo o individual)
            if (mainVotes.length > 0) {
                const mainSum = mainVotes.reduce((sum, score) => {
                    return sum + Object.values(score.scores).reduce((s, v) => s + v, 0);
                }, 0);
                const mainAverage = Math.round(mainSum / mainVotes.length);
                
                ui.mainAverage.textContent = mainAverage;
                ui.mainJurorsCount.textContent = displayText;
            } else {
                ui.mainAverage.textContent = '0';
                ui.mainJurorsCount.textContent = 'Sin votos principales';
            }

            // Promedio total (incluyendo secretos)
            const allMainVotes = [...mainVotes, ...secretVotes];
            if (allMainVotes.length > 0) {
                const totalSum = allMainVotes.reduce((sum, score) => {
                    return sum + Object.values(score.scores).reduce((s, v) => s + v, 0);
                }, 0);
                const totalAverage = Math.round(totalSum / allMainVotes.length);
                
                ui.totalAverage.textContent = totalAverage;
                ui.totalJurorsCount.textContent = `${allMainVotes.length} votos total (+ ${secretVotes.length} secretos)`;
            } else {
                ui.totalAverage.textContent = '0';
                ui.totalJurorsCount.textContent = '0 votos total';
            }

            // Desglose por criterios (usar votos principales)
            displayCriteriaBreakdown(mainVotes);
        }

        function displayCriteriaBreakdown(jurors) {
            ui.criteriaBreakdown.innerHTML = '';
            
            if (jurors.length === 0) return;

            Object.entries(CRITERIA).forEach(([key, name]) => {
                const values = jurors.map(juror => juror.scores[key] || 0);
                const average = Math.round(values.reduce((sum, val) => sum + val, 0) / values.length);
                
                const criteriaCard = document.createElement('div');
                criteriaCard.className = 'bg-gray-700 p-3 rounded text-center';
                criteriaCard.innerHTML = `
                    <h4 class="font-semibold text-sky-300 text-sm mb-1">${name}</h4>
                    <div class="text-lg font-bold text-green-400">${average}</div>
                    <div class="text-xs text-gray-400">de 100</div>
                `;
                
                ui.criteriaBreakdown.appendChild(criteriaCard);
            });
        }

        function generateFeedbackScript() {
            if (!currentArtist || currentScores.length === 0) return;

            const mainJurors = currentScores.filter(score => !score.isSecret);
            
            if (mainJurors.length === 0) {
                ui.feedbackScript.innerHTML = '<p class="text-gray-400">No hay puntuaciones de jurados principales para generar feedback.</p>';
                return;
            }

            const mainSum = mainJurors.reduce((sum, score) => {
                return sum + Object.values(score.scores).reduce((s, v) => s + v, 0);
            }, 0);
            const mainAverage = Math.round(mainSum / mainJurors.length);

            // Determinar nivel de puntuación
            let performanceLevel = '';
            let encouragement = '';
            
            if (mainAverage >= 800) {
                performanceLevel = 'excepcional';
                encouragement = 'Tu presentación fue verdaderamente sobresaliente. Continúa con esa excelencia.';
            } else if (mainAverage >= 650) {
                performanceLevel = 'muy buena';
                encouragement = 'Tienes un gran talento. Con pequeños ajustes puedes alcanzar la excelencia.';
            } else if (mainAverage >= 500) {
                performanceLevel = 'buena';
                encouragement = 'Vas por buen camino. Sigue trabajando en los aspectos que te mencionaremos.';
            } else if (mainAverage >= 350) {
                performanceLevel = 'regular';
                encouragement = 'Tienes potencial. Enfócate en mejorar los aspectos fundamentales.';
            } else {
                performanceLevel = 'mejorable';
                encouragement = 'Todos empezamos desde algún lugar. Con práctica y dedicación verás grandes mejoras.';
            }

            // Encontrar fortalezas y áreas de mejora
            const criteriaAverages = {};
            Object.keys(CRITERIA).forEach(key => {
                const values = mainJurors.map(juror => juror.scores[key] || 0);
                criteriaAverages[key] = Math.round(values.reduce((sum, val) => sum + val, 0) / values.length);
            });

            const sortedCriteria = Object.entries(criteriaAverages).sort((a, b) => b[1] - a[1]);
            const strengths = sortedCriteria.slice(0, 2);
            const improvements = sortedCriteria.slice(-2).reverse();

            const script = `
                <p><strong>Hola ${currentArtist.name},</strong></p>
                <p>El jurado ha evaluado tu presentación de "${currentArtist.currentSong || 'tu canción'}" y queremos darte una devolución inmediata.</p>
                
                <div class="bg-sky-600 p-3 rounded mt-3 mb-3">
                    <p><strong>📊 Tu puntuación promedio es: ${mainAverage} puntos de 1000</strong></p>
                    <p>Esto representa una presentación <strong>${performanceLevel}</strong>.</p>
                </div>

                <p><strong>💪 Tus fortalezas principales:</strong></p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    ${strengths.map(([key, value]) => 
                        `<li><strong>${CRITERIA[key]}:</strong> ${value} puntos - Muy bien logrado</li>`
                    ).join('')}
                </ul>

                <p><strong>🎯 Áreas para seguir mejorando:</strong></p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    ${improvements.map(([key, value]) => 
                        `<li><strong>${CRITERIA[key]}:</strong> ${value} puntos - Enfócate en practicar este aspecto</li>`
                    ).join('')}
                </ul>

                <p><strong>💡 Mensaje del jurado:</strong></p>
                <p class="italic">${encouragement}</p>

                <p class="mt-3">Sigue trabajando con pasión y dedicación. ¡El certamen continúa y esperamos verte crecer!</p>
            `;

            ui.feedbackScript.innerHTML = script;
        }

        async function saveFeedback() {
            if (!currentArtist) return;

            const galaId = ui.galaSelect.value;
            const additionalNotes = ui.additionalNotes.value.trim();
            
            try {
                const feedbackData = {
                    artistId: currentArtist.id,
                    artistName: currentArtist.name,
                    galaId: galaId,
                    scores: currentScores,
                    mainAverage: parseInt(ui.mainAverage.textContent),
                    totalAverage: parseInt(ui.totalAverage.textContent),
                    feedbackScript: ui.feedbackScript.innerHTML,
                    additionalNotes: additionalNotes,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Sistema de Feedback'
                };

                await setDoc(doc(db, 'events', eventId, 'live_feedback', `${galaId}_${currentArtist.id}`), feedbackData);
                showMessage('Feedback guardado correctamente', 'success');
                
            } catch (error) {
                console.error('Error guardando feedback:', error);
                showMessage('Error al guardar el feedback: ' + error.message, 'error');
            }
        }

        function copyScriptToClipboard() {
            const scriptText = ui.feedbackScript.textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                showMessage('Script copiado al portapapeles', 'success');
            }).catch(err => {
                console.error('Error copiando al portapapeles:', err);
                showMessage('Error al copiar el script', 'error');
            });
        }

        function setupEventListeners() {
            ui.galaSelect.addEventListener('change', () => {
                loadArtistsForGala(ui.galaSelect.value);
                ui.scoresPanel.classList.add('hidden');
            });

            // Nuevos event listeners para el modal
            document.getElementById('close-modal').addEventListener('click', closeVotingModal);
            document.getElementById('cancel-vote').addEventListener('click', closeVotingModal);
            document.getElementById('save-feedback').addEventListener('click', saveFeedbackAndVote);

            // Event listeners originales (mantener compatibilidad)
            ui.loadScoresBtn.addEventListener('click', loadScoresForArtist);
            ui.generateFeedbackBtn.addEventListener('click', generateFeedbackScript);
            ui.saveFeedbackBtn.addEventListener('click', saveFeedback);
            ui.copyScriptBtn.addEventListener('click', copyScriptToClipboard);
            
            // Event listeners para los sliders del modal
            const categories = ['canto', 'transmision', 'actitud', 'originalidad', 'vestuario', 'puesta'];
            categories.forEach(category => {
                const slider = document.getElementById(`${category}-score`);
                if (slider) {
                    slider.addEventListener('input', () => updateScoreDisplay(category));
                }
            });
        }

        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('message-container');
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            
            messageContainer.innerHTML = `
                <div class="${bgColor} text-white p-4 rounded-lg shadow-xl">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        // Funciones para el nuevo sistema de modal de votación
        function openVotingModal(artistData) {
            const modal = document.getElementById('voting-modal');
            const artistName = document.getElementById('modal-artist-name');
            const artistImage = document.getElementById('modal-artist-image');
            
            artistName.textContent = artistData.nombre;
            artistImage.src = artistData.foto || 'https://via.placeholder.com/300x200/e5e7eb/6b7280?text=Sin+Foto';
            artistImage.alt = artistData.nombre;
            
            // Limpiar el formulario
            resetModalForm();
            
            // Guardar datos del artista para uso posterior
            window.currentArtist = artistData;
            
            modal.classList.remove('hidden');
        }

        function closeVotingModal() {
            const modal = document.getElementById('voting-modal');
            modal.classList.add('hidden');
            window.currentArtist = null;
        }

        function resetModalForm() {
            // Resetear sliders de categorías
            const categories = ['canto', 'transmision', 'actitud', 'originalidad', 'vestuario', 'puesta'];
            categories.forEach(category => {
                const slider = document.getElementById(`${category}-score`);
                const display = document.getElementById(`${category}-display`);
                if (slider && display) {
                    slider.value = 50;
                    display.textContent = '50';
                }
            });
            
            // Limpiar textarea de feedback
            const feedbackTextarea = document.getElementById('intelligent-feedback');
            if (feedbackTextarea) {
                feedbackTextarea.value = '';
            }
        }

        function updateScoreDisplay(category) {
            const slider = document.getElementById(`${category}-score`);
            const display = document.getElementById(`${category}-display`);
            if (slider && display) {
                display.textContent = slider.value;
                generateIntelligentFeedback();
            }
        }

        function generateIntelligentFeedback() {
            const categories = ['canto', 'transmision', 'actitud', 'originalidad', 'vestuario', 'puesta'];
            const scores = {};
            let totalScore = 0;
            
            // Obtener puntajes
            categories.forEach(category => {
                const slider = document.getElementById(`${category}-score`);
                if (slider) {
                    scores[category] = parseInt(slider.value);
                    totalScore += scores[category];
                }
            });
            
            const averageScore = totalScore / categories.length;
            let feedback = '';
            
            // Generar feedback inteligente basado en puntajes
            if (averageScore >= 90) {
                feedback = `¡Presentación excepcional! ${window.currentArtist?.nombre || 'El artista'} demostró un nivel extraordinario en todos los aspectos evaluados. `;
                feedback += `Especialmente destacable en ${getHighestCategory(scores)}.`;
            } else if (averageScore >= 75) {
                feedback = `Muy buena presentación. ${window.currentArtist?.nombre || 'El artista'} mostró un gran nivel técnico y artístico. `;
                feedback += `Puntos fuertes en ${getHighestCategory(scores)}. `;
                feedback += `Oportunidades de mejora en ${getLowestCategory(scores)}.`;
            } else if (averageScore >= 50) {
                feedback = `Buena presentación con elementos positivos. ${window.currentArtist?.nombre || 'El artista'} mostró potencial. `;
                feedback += `Se recomienda trabajar en ${getLowestCategory(scores)} para alcanzar el siguiente nivel.`;
            } else {
                feedback = `Presentación con áreas importantes de mejora. Se sugiere enfocarse en el desarrollo técnico, `;
                feedback += `especialmente en ${getLowestCategory(scores)}. Con práctica y dedicación puede lograr grandes avances.`;
            }
            
            const feedbackTextarea = document.getElementById('intelligent-feedback');
            if (feedbackTextarea) {
                feedbackTextarea.value = feedback;
            }
        }

        function getHighestCategory(scores) {
            const categoryNames = {
                'canto': 'técnica vocal',
                'transmision': 'transmisión',
                'actitud': 'actitud escénica',
                'originalidad': 'originalidad',
                'vestuario': 'vestuario',
                'puesta': 'puesta en escena'
            };
            
            let highest = { category: '', score: 0 };
            Object.entries(scores).forEach(([category, score]) => {
                if (score > highest.score) {
                    highest = { category, score };
                }
            });
            
            return categoryNames[highest.category] || 'varios aspectos';
        }

        function getLowestCategory(scores) {
            const categoryNames = {
                'canto': 'técnica vocal',
                'transmision': 'transmisión',
                'actitud': 'actitud escénica',
                'originalidad': 'originalidad',
                'vestuario': 'vestuario',
                'puesta': 'puesta en escena'
            };
            
            let lowest = { category: '', score: 100 };
            Object.entries(scores).forEach(([category, score]) => {
                if (score < lowest.score) {
                    lowest = { category, score };
                }
            });
            
            return categoryNames[lowest.category] || 'varios aspectos';
        }

        async function saveFeedbackAndVote() {
            if (!window.currentArtist) {
                showMessage('Error: No hay artista seleccionado', 'error');
                return;
            }

            try {
                const categories = ['canto', 'transmision', 'actitud', 'originalidad', 'vestuario', 'puesta'];
                const scores = {};
                
                // Obtener puntajes
                categories.forEach(category => {
                    const slider = document.getElementById(`${category}-score`);
                    if (slider) {
                        scores[category] = parseInt(slider.value);
                    }
                });
                
                const feedback = document.getElementById('intelligent-feedback').value;
                const galaId = ui.galaSelect.value;
                
                if (!feedback.trim()) {
                    showMessage('Por favor ingrese el feedback antes de guardar', 'error');
                    return;
                }

                // Guardar en Firebase
                const voteData = {
                    artistId: window.currentArtist.id,
                    artistName: window.currentArtist.nombre,
                    galaId: galaId,
                    jurorName: 'Jurado Principal', // Esto se puede hacer dinámico
                    timestamp: new Date(),
                    scores: scores,
                    feedback: feedback,
                    totalScore: Object.values(scores).reduce((a, b) => a + b, 0)
                };

                await addDoc(collection(db, 'jury_votes'), voteData);
                
                showMessage('Feedback guardado exitosamente', 'success');
                closeVotingModal();
                
                // Recargar la lista de artistas para mostrar el estado actualizado
                loadArtistsForGala(galaId);
                
            } catch (error) {
                console.error('Error guardando feedback:', error);
                showMessage('Error guardando el feedback: ' + error.message, 'error');
            }
        }

        // Inicializar la aplicación
        initialize();
    </script>
</body>
</html>