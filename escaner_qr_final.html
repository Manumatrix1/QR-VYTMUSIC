<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc√°ner de Entradas - VYT MUSIC</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    
    <!-- Firebase v9 SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_2Ukoxf_ry7QfKtou1Cz6nY-qTVw4qTU", 
            authDomain: "vyt-music.firebaseapp.com",
            projectId: "vyt-music", 
            storageBucket: "vyt-music.firebasestorage.app", 
            messagingSenderId: "574981837817", 
            appId: "1:574981837817:web:a29933a22bbfd51a086328"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            margin: 0 auto;
            padding: 20px;
            max-width: 800px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            color: white;
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* BOT√ìN DE NAVEGACI√ìN ATR√ÅS */
        .back-button {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: white;
            font-size: 20px;
            z-index: 10;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-50%) scale(1.1);
        }

        .back-button:active {
            transform: translateY(-50%) scale(0.95);
            background: rgba(255,255,255,0.4);
        }

        /* RESPONSIVE - M√ìVILES */
        @media (max-width: 768px) {
            .back-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
                left: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                padding: 0 60px; /* Espacio para el bot√≥n */
            }
        }

        .event-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        /* ESC√ÅNER PANTALLA COMPLETA - ESTILO MERCADO PAGO */
        .scanner-container {
            background: rgba(0,0,0,0.9);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .scanner-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            border-radius: 0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.95);
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            height: 350px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
            position: relative;
        }

        .scanner-container.fullscreen #qr-reader {
            width: 90vw;
            height: 60vh;
            max-width: none;
            max-height: 500px;
            border: 3px solid #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        /* OVERLAY DE ESCANEO - ESTILO MERCADO PAGO */
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #667eea;
            border-radius: 15px;
            box-shadow: 
                0 0 0 9999px rgba(0,0,0,0.3),
                inset 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .fullscreen .scanner-overlay::before {
            width: 250px;
            height: 250px;
            border-width: 3px;
            animation: scannerPulse 2s infinite;
        }

        @keyframes scannerPulse {
            0%, 100% { 
                border-color: #667eea;
                box-shadow: 
                    0 0 0 9999px rgba(0,0,0,0.3),
                    inset 0 0 20px rgba(102, 126, 234, 0.3);
            }
            50% { 
                border-color: #764ba2;
                box-shadow: 
                    0 0 0 9999px rgba(0,0,0,0.3),
                    inset 0 0 20px rgba(118, 75, 162, 0.3);
            }
        }

        .scanner-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .fullscreen .scanner-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-fullscreen {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ESTAD√çSTICAS PEQUE√ëAS */
        .stats-mini {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-mini {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-mini-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            display: block;
        }

        .stat-mini-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }

        /* FILTRO POR ARTISTA */
        .artist-filter {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .filter-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .filter-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        /* LISTA DE ENTRADAS */
        .entries-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .entries-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .entry-item {
            background: rgba(255,255,255,0.9);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-info {
            flex: 1;
        }

        .entry-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .entry-details {
            font-size: 0.9rem;
            color: #666;
        }

        .entry-artist {
            color: #667eea;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-entered {
            background: #d1fae5;
            color: #065f46;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        /* RESULTADO DEL ESCANEO */
        .scan-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .scan-success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
        }

        .scan-error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        /* DI√ÅLOGO DE VALIDACI√ìN */
        .validation-dialog {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.3);
            animation: validationPulse 1s ease-out;
        }

        @keyframes validationPulse {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .validation-info h3 {
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .entry-details-validation {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .entry-details-validation p {
            margin: 8px 0;
            color: #fff;
            font-size: 1rem;
        }

        .entry-details-validation strong {
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .validation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-validation {
            min-width: 160px;
            padding: 15px 25px;
            font-size: 1.1rem;
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-validation::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-validation:hover::before {
            left: 100%;
        }

        .btn-validation:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .validation-active {
            animation: validationAlert 0.5s ease-out;
        }

        @keyframes validationAlert {
            0%, 100% { border-color: rgba(255,255,255,0.3); }
            50% { border-color: #10b981; }
        }

        /* CONEXI√ìN */
        .connection-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .connection-online { background: #10b981; }
        .connection-offline { background: #ef4444; }

        @media (max-width: 480px) {
            .stats-mini {
                grid-template-columns: 1fr;
            }
            
            .scanner-controls {
                flex-direction: column;
            }
            
            .entry-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .entry-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <button class="back-button" onclick="goBack()" title="Volver atr√°s">
                ‚Üê
            </button>
            <h1>üéµ Esc√°ner de Entradas VYT</h1>
        </div>

        <!-- INFO DEL EVENTO Y CONEXI√ìN -->
        <div class="event-info">
            <h3 id="event-name">Cargando evento...</h3>
            <p>üë§ <span id="admin-name">Administrador</span></p>
            <div class="connection-indicator">
                <div class="connection-dot" id="connection-dot"></div>
                <span id="connection-text">Verificando conexi√≥n...</span>
            </div>
        </div>

        <!-- ESC√ÅNER QR - ESTILO MERCADO PAGO -->
        <div class="scanner-container" id="scanner-container">
            <h3 style="margin-bottom: 15px; color: white;">üì∑ Esc√°ner de C√≥digos QR</h3>
            <div id="qr-reader">
                <div class="scanner-overlay"></div>
            </div>
            <div class="scanner-controls">
                <button id="start-btn" class="btn btn-primary">üì∑ Iniciar Esc√°ner</button>
                <button id="fullscreen-btn" class="btn btn-fullscreen">üîç Pantalla Completa</button>
                <button id="stop-btn" class="btn btn-danger" disabled>‚èπÔ∏è Detener</button>
            </div>
            <div id="scan-result"></div>
            <div id="scanner-help" style="margin-top: 15px; color: rgba(255,255,255,0.8); font-size: 0.9rem; text-align: center;">
                üí° Apunta la c√°mara al c√≥digo QR o c√≥digo de barras
            </div>
        </div>

        <!-- ESTAD√çSTICAS PEQUE√ëAS -->
        <div class="stats-mini">
            <div class="stat-mini">
                <span class="stat-mini-number" id="entries-generated">0</span>
                <div class="stat-mini-label">Entradas Generadas</div>
            </div>
            <div class="stat-mini">
                <span class="stat-mini-number" id="entries-entered">0</span>
                <div class="stat-mini-label">Ya Ingresaron</div>
            </div>
            <div class="stat-mini">
                <span class="stat-mini-number" id="entries-pending">0</span>
                <div class="stat-mini-label">Faltan Ingresar</div>
            </div>
        </div>

        <!-- FILTRO POR ARTISTA -->
        <div class="artist-filter">
            <input type="text" id="artist-filter" class="filter-input" 
                   placeholder="üîç Buscar por artista o invitado (ej: Emilia mostrar√° todos sus invitados)">
        </div>

        <!-- LISTA DE ENTRADAS DE LA GALA -->
        <div class="entries-container">
            <h3 style="margin-bottom: 15px; color: white;">üìã Invitados de la Gala</h3>
            <div id="entries-list" class="entries-list">
                <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                    Cargando entradas de la gala...
                </div>
            </div>
        </div>
    </div>

    <script>
        class SimpleQRScanner {
            constructor() {
                this.scanner = null;
                this.eventId = null;
                this.eventName = null;
                this.assistantName = null;
                this.isScanning = false;
                this.isOnline = false;
                this.db = null;
                
                // Variables de validaci√≥n
                this.isValidating = false;
                this.validationEntry = null;
                
                this.galaEntries = [];
                this.artists = []; // Nueva variable para los artistas
                this.filteredEntries = [];
                
                this.stats = {
                    generated: 0,
                    entered: 0,
                    pending: 0
                };
                
                this.init();
            }

            async init() {
                console.log('üöÄ Iniciando Esc√°ner Simple VYT');
                
                // Detectar configuraci√≥n
                await this.detectEventConfig();
                
                // Inicializar Firebase
                await this.initFirebase();
                
                // Configurar elementos
                this.setupElements();
                
                // Verificar conexi√≥n
                await this.checkConnection();
                
                // Cargar entradas de la gala
                await this.loadGalaEntries();
                
                // Iniciar monitoreo
                this.startConnectionMonitoring();
                
                console.log('‚úÖ Sistema listo');
            }

            async detectEventConfig() {
                const urlParams = new URLSearchParams(window.location.search);
                this.eventId = urlParams.get('eventId');
                this.eventName = urlParams.get('eventName');
                const adminParam = urlParams.get('admin');
                
                console.log('üîç Configuraci√≥n detectada:', { 
                    eventId: this.eventId, 
                    eventName: this.eventName, 
                    admin: adminParam 
                });

                if (this.eventId && this.eventName && adminParam === 'true') {
                    this.eventName = decodeURIComponent(this.eventName);
                    this.assistantName = 'Administrador';
                    console.log('‚úÖ Configuraci√≥n desde panel - EventId:', this.eventId);
                    return;
                }

                // Fallbacks - usar los mismos valores que el panel
                this.eventId = localStorage.getItem('currentEvent') || 'G12VYTMUSIC';
                this.eventName = localStorage.getItem('currentEventName') || 'GALA 1 CON PUNTUACI√ìN. G12 VYTMUSIC';
                this.assistantName = 'Esc√°ner de Entradas';
                
                console.log('‚ö†Ô∏è Usando fallback - EventId:', this.eventId);
                console.log('üìã Event Name:', this.eventName);
            }

            async initFirebase() {
                try {
                    this.db = firebase.firestore();
                    console.log('‚úÖ Firebase conectado');
                } catch (error) {
                    console.error('‚ùå Error Firebase:', error);
                }
            }

            setupElements() {
                // Actualizar info del evento
                document.getElementById('event-name').textContent = this.eventName;
                document.getElementById('admin-name').textContent = this.assistantName;

                // Configurar botones
                document.getElementById('start-btn').onclick = () => this.startScanner();
                document.getElementById('fullscreen-btn').onclick = () => this.startScanner(true);
                document.getElementById('stop-btn').onclick = () => this.stopScanner();

                // Configurar filtro por artista
                const artistFilter = document.getElementById('artist-filter');
                if (artistFilter) {
                    artistFilter.oninput = (e) => this.filterByArtist(e.target.value);
                }
                
                // El bot√≥n de atr√°s ya est√° configurado en el HTML con onclick="goBack()"
            }

            async checkConnection() {
                try {
                    if (this.db) {
                        // Verificar conexi√≥n real con Firebase
                        const testRef = this.db.collection('eventos').doc('test');
                        await testRef.get();
                        this.isOnline = true;
                        console.log('üü¢ Conexi√≥n Firebase OK');
                    }
                } catch (error) {
                    console.warn('üî¥ Sin conexi√≥n Firebase:', error);
                    this.isOnline = false;
                }
                
                this.updateConnectionStatus();
            }

            updateConnectionStatus() {
                const dot = document.getElementById('connection-dot');
                const text = document.getElementById('connection-text');
                
                if (this.isOnline) {
                    dot.className = 'connection-dot connection-online';
                    text.textContent = 'Conectado a Firebase';
                } else {
                    dot.className = 'connection-dot connection-offline';
                    text.textContent = 'Sin conexi√≥n - Modo offline';
                }
            }

            async loadGalaEntries() {
                console.log('üì• Cargando entradas REALES de la gala...');
                console.log('üéØ EventId:', this.eventId);
                
                try {
                    this.galaEntries = [];
                    this.artists = []; // Limpiar artistas
                    
                    if (this.isOnline && this.db) {
                        // Cargar artistas desde Firebase
                        console.log('üé§ Consultando artistas:', `events/${this.eventId}/artists`);
                        
                        try {
                            const artistsSnapshot = await this.db
                                .collection('events')
                                .doc(this.eventId)
                                .collection('artists')
                                .get();

                            console.log(`üé≠ Encontrados ${artistsSnapshot.size} artistas en Firebase`);

                            artistsSnapshot.forEach(artistDoc => {
                                const artistData = artistDoc.data();
                                this.artists.push({
                                    id: artistDoc.id,
                                    name: artistData.name || artistData.artistName || 'Artista sin nombre',
                                    prefix: artistData.prefix || artistData.code || artistDoc.id,
                                    ticketsSold: artistData.totalInvitados || artistData.ticketsSold || 0,
                                    type: 'artist' // Marcador para diferenciarlo de invitados
                                });
                            });
                            
                            console.log(`‚úÖ Cargados ${this.artists.length} artistas`);
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error cargando artistas:', error);
                            this.artists = [];
                        }
                        
                        // Cargar desde Firebase - ESTRUCTURA REAL DEL SISTEMA
                        console.log('üîç Consultando tickets reales:', `events/${this.eventId}/tickets`);
                        
                        const ticketsSnapshot = await this.db
                            .collection('events')
                            .doc(this.eventId)
                            .collection('tickets')
                            .get();

                        console.log(`üìä Encontrados ${ticketsSnapshot.size} tickets en Firebase`);

                        ticketsSnapshot.forEach(ticketDoc => {
                            const ticketData = ticketDoc.data();
                            
                            // DETECTAR TODOS LOS POSIBLES CAMPOS DE ARTISTA
                            const artistName = ticketData.artistName || 
                                             ticketData.artist || 
                                             ticketData.artistaName || 
                                             ticketData.artista || 
                                             ticketData.selectedArtist ||
                                             ticketData.invitedBy ||
                                             'üé§ Artista no especificado';
                            
                            console.log('üé´ Ticket encontrado:', {
                                id: ticketDoc.id,
                                guestName: ticketData.guestName,
                                artistName: artistName,
                                used: ticketData.used,
                                qrCode: ticketData.qrCode,
                                allData: ticketData // Para debugging
                            });

                            this.galaEntries.push({
                                id: ticketDoc.id,
                                guestName: ticketData.guestName || ticketData.name || ticketData.inviteeName || 'Sin nombre',
                                phone: ticketData.phone || ticketData.telefono || ticketData.phoneNumber || '',
                                artistName: artistName,
                                qrCode: ticketData.qrCode || ticketData.code || ticketData.id || ticketDoc.id,
                                status: ticketData.used ? 'entered' : 'pending',
                                accessTime: ticketData.accessTime || ticketData.usedAt || ticketData.entryTime,
                                createdAt: ticketData.createdAt || ticketData.timestamp || ticketData.createdDate || new Date().toISOString(),
                                price: ticketData.price || ticketData.amount || 0,
                                seller: ticketData.seller || ticketData.createdBy || ticketData.generatedBy || 'Sistema'
                            });
                        });

                        console.log(`‚úÖ Cargadas ${this.galaEntries.length} entradas REALES`);
                        console.log('üìä Primeras 3 entradas:', this.galaEntries.slice(0, 3));
                    } else {
                        console.log('‚ùå Sin conexi√≥n - usando datos de ejemplo');
                        this.galaEntries = this.createSampleEntries();
                    }
                    
                    this.filteredEntries = [...this.galaEntries];
                    console.log('üìà Actualizando estad√≠sticas...');
                    this.updateStats();
                    console.log('üìã Mostrando entradas...');
                    this.displayEntries();
                    
                } catch (error) {
                    console.error('‚ùå Error cargando entradas reales:', error);
                    console.log('üîÑ Intentando con datos de ejemplo...');
                    this.galaEntries = this.createSampleEntries();
                    this.filteredEntries = [...this.galaEntries];
                    this.updateStats();
                    this.displayEntries();
                }
            }

            createSampleEntries() {
                // Datos de ejemplo para cuando no hay conexi√≥n
                return [
                    {
                        id: 'sample1',
                        guestName: 'Juan P√©rez',
                        phone: '1234567890',
                        artistName: 'Emilia',
                        qrCode: 'QR-EMI-001',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'sample2',
                        guestName: 'Mar√≠a Garc√≠a',
                        phone: '0987654321',
                        artistName: 'L-Gante',
                        qrCode: 'QR-LG-001',
                        status: 'entered',
                        accessTime: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'sample3',
                        guestName: 'Carlos Rodr√≠guez',
                        phone: '5555555555',
                        artistName: 'Emilia',
                        qrCode: 'QR-EMI-002',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            async startScanner(fullscreen = false) {
                if (this.isScanning) return;

                try {
                    console.log('üì∑ Iniciando esc√°ner...', { fullscreen });
                    this.isScanning = true;
                    this.isFullscreen = fullscreen;
                    
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('fullscreen-btn').disabled = true;

                    // CONFIGURACI√ìN MEJORADA - ESTILO MERCADO PAGO
                    const config = {
                        fps: 10, // FPS estable
                        qrbox: fullscreen ? { width: 300, height: 300 } : { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        // CONFIGURACI√ìN SIMPLE Y ESTABLE
                        rememberLastUsedCamera: true,
                        showTorchButtonIfSupported: true
                    };

                    // CONFIGURACI√ìN SIMPLE DE C√ÅMARA
                    const cameraConfig = { facingMode: "environment" };

                    this.scanner = new Html5Qrcode("qr-reader");
                    
                    // Si es pantalla completa, cambiar UI
                    if (fullscreen) {
                        this.enterFullscreen();
                    }
                    
                    await this.scanner.start(
                        cameraConfig,
                        config,
                        (decodedText) => this.onScanSuccess(decodedText),
                        (errorMessage) => this.onScanError(errorMessage)
                    );

                    const message = fullscreen ? 
                        'üîç Esc√°ner en pantalla completa - Apunta al c√≥digo' : 
                        '‚úÖ Esc√°ner activo - Apunta al c√≥digo QR';
                    this.showScanResult(message, 'success');

                } catch (error) {
                    console.error('‚ùå Error al iniciar esc√°ner:', error);
                    this.showScanResult('‚ùå Error al acceder a la c√°mara. Verifica los permisos.', 'error');
                    this.resetScannerButtons();
                    this.exitFullscreen();
                }
            }

            async stopScanner() {
                if (!this.isScanning || !this.scanner) return;

                try {
                    await this.scanner.stop();
                    await this.scanner.clear();
                    this.scanner = null;
                    this.isScanning = false;
                    
                    this.resetScannerButtons();
                    this.exitFullscreen();
                    this.showScanResult('‚èπÔ∏è Esc√°ner detenido', 'success');

                } catch (error) {
                    console.error('‚ùå Error al detener esc√°ner:', error);
                }
            }

            resetScannerButtons() {
                document.getElementById('start-btn').disabled = false;
                document.getElementById('fullscreen-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }

            // FUNCIONES DE PANTALLA COMPLETA
            enterFullscreen() {
                const container = document.getElementById('scanner-container');
                container.classList.add('fullscreen');
                document.body.style.overflow = 'hidden';
                
                // Ocultar otros elementos
                const elements = document.querySelectorAll('.stats-mini, .entries-section, .header .event-info');
                elements.forEach(el => el.style.display = 'none');
                
                console.log('üîç Modo pantalla completa activado');
            }

            exitFullscreen() {
                const container = document.getElementById('scanner-container');
                container.classList.remove('fullscreen');
                document.body.style.overflow = 'auto';
                
                // Mostrar otros elementos
                const elements = document.querySelectorAll('.stats-mini, .entries-section, .header .event-info');
                elements.forEach(el => el.style.display = '');
                
                console.log('üì± Modo normal activado');
            }

            goBack() {
                if (this.isScanning) {
                    this.stopScanner();
                } else if (document.getElementById('scanner-container').classList.contains('fullscreen')) {
                    this.exitFullscreen();
                } else {
                    // Volver al panel principal o cerrar
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.close();
                    }
                }
            }

            async onScanSuccess(decodedText) {
                console.log('üì± QR escaneado:', decodedText);
                console.log('üîç Buscando en', this.galaEntries.length, 'entradas reales...');
                
                // REPRODUCIR SONIDO DE LECTURA
                this.playBeepSound();
                
                try {
                    // Buscar con m√∫ltiples criterios para mayor compatibilidad
                    const entry = this.galaEntries.find(e => {
                        const matches = [
                            e.qrCode === decodedText,
                            e.id === decodedText,
                            e.ticketId === decodedText,
                            // B√∫squeda parcial para c√≥digos que contengan el texto
                            decodedText.includes(e.id),
                            e.qrCode && decodedText.includes(e.qrCode)
                        ];
                        return matches.some(match => match);
                    });

                    console.log('üé´ Entrada encontrada:', entry ? {
                        id: entry.id,
                        name: entry.guestName,
                        artist: entry.artistName,
                        status: entry.status
                    } : 'NO ENCONTRADA');

                    if (!entry) {
                        this.playErrorSound();
                        this.showScanResult(`‚ùå C√≥digo QR no encontrado en las ${this.galaEntries.length} entradas`, 'error');
                        console.log('üîç C√≥digo buscado:', decodedText);
                        console.log('üìã Primeras 3 entradas disponibles:', this.galaEntries.slice(0, 3).map(e => ({
                            id: e.id,
                            qrCode: e.qrCode,
                            name: e.guestName
                        })));
                        return;
                    }

                    if (entry.status === 'entered') {
                        this.playErrorSound();
                        this.showScanResult(`‚ùå ${entry.guestName} ya ingres√≥ anteriormente`, 'error');
                        return;
                    }

                    // PARAR EL ESC√ÅNER Y MOSTRAR BOT√ìN DE VALIDACI√ìN
                    await this.pauseScannerForValidation(entry);

                } catch (error) {
                    console.error('‚ùå Error procesando QR:', error);
                    this.playErrorSound();
                    this.showScanResult('‚ùå Error al procesar el c√≥digo', 'error');
                }
            }

            // FUNCIONES DE SONIDO
            playBeepSound() {
                try {
                    // Crear tono de confirmaci√≥n - estilo Mercado Pago
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Tono alto
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    
                    console.log('üîä Sonido beep reproducido');
                } catch (error) {
                    console.warn('üîá No se pudo reproducir sonido:', error);
                }
            }

            playErrorSound() {
                try {
                    // Crear tono de error
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime); // Tono bajo
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    
                    console.log('üîä Sonido error reproducido');
                } catch (error) {
                    console.warn('üîá No se pudo reproducir sonido de error:', error);
                }
            }

            playSuccessSound() {
                try {
                    // Crear doble beep de √©xito
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Primer beep
                    const osc1 = audioContext.createOscillator();
                    const gain1 = audioContext.createGain();
                    osc1.connect(gain1);
                    gain1.connect(audioContext.destination);
                    osc1.frequency.setValueAtTime(600, audioContext.currentTime);
                    osc1.type = 'sine';
                    gain1.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    osc1.start();
                    osc1.stop(audioContext.currentTime + 0.1);
                    
                    // Segundo beep
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.frequency.setValueAtTime(800, audioContext.currentTime + 0.15);
                    osc2.type = 'sine';
                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.15);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                    osc2.start(audioContext.currentTime + 0.15);
                    osc2.stop(audioContext.currentTime + 0.25);
                    
                    console.log('üîä Sonido √©xito reproducido');
                } catch (error) {
                    console.warn('üîá No se pudo reproducir sonido de √©xito:', error);
                }
            }

            // FUNCI√ìN DE VALIDACI√ìN CON PAUSA
            async pauseScannerForValidation(entry) {
                console.log('‚è∏Ô∏è Pausando esc√°ner para validaci√≥n:', entry.guestName);
                
                // Pausar temporalmente el esc√°ner sin detenerlo completamente
                this.validationEntry = entry;
                this.isValidating = true;
                
                this.showValidationDialog(entry);
            }

            showValidationDialog(entry) {
                const resultDiv = document.getElementById('scan-result');
                resultDiv.innerHTML = `
                    <div class="validation-dialog">
                        <div class="validation-info">
                            <h3>‚úÖ QR V√ÅLIDO DETECTADO</h3>
                            <div class="entry-details-validation">
                                <p><strong>üë§ Invitado:</strong> ${entry.guestName}</p>
                                <p><strong>üé§ Viene a ver:</strong> ${entry.artistName}</p>
                                <p><strong>üì± Tel√©fono:</strong> ${entry.phone || 'No especificado'}</p>
                            </div>
                        </div>
                        <div class="validation-actions">
                            <button class="btn btn-success btn-validation" onclick="scanner.confirmAccess()">
                                ‚úÖ CONFIRMAR INGRESO
                            </button>
                            <button class="btn btn-secondary btn-validation" onclick="scanner.cancelValidation()">
                                ‚ùå CANCELAR
                            </button>
                        </div>
                    </div>
                `;
                resultDiv.className = 'scan-result validation-active';
            }

            async confirmAccess() {
                if (!this.validationEntry) return;
                
                console.log('‚úÖ Confirmando acceso para:', this.validationEntry.guestName);
                
                // Reproducir sonido de √©xito
                this.playSuccessSound();
                
                // Registrar acceso
                await this.recordAccess(this.validationEntry);
                
                // Mostrar resultado
                this.showScanResult(
                    `‚úÖ ACCESO CONFIRMADO: ${this.validationEntry.guestName} (${this.validationEntry.artistName})`, 
                    'success'
                );
                
                // Limpiar validaci√≥n
                this.clearValidation();
                
                // Continuar escaneando despu√©s de 2 segundos
                setTimeout(() => {
                    this.showScanResult('üì∑ Listo para el siguiente c√≥digo QR', 'success');
                }, 2000);
            }

            cancelValidation() {
                console.log('‚ùå Validaci√≥n cancelada');
                this.clearValidation();
                this.showScanResult('üì∑ Escaneo cancelado - Listo para continuar', 'success');
            }

            clearValidation() {
                this.validationEntry = null;
                this.isValidating = false;
                document.getElementById('scan-result').className = 'scan-result';
            }

            onScanError(errorMessage) {
                // Ignorar errores menores y no procesar si estamos validando
                if (this.isValidating) return;
                
                if (!errorMessage.includes('NotFoundException')) {
                    console.warn('‚ö†Ô∏è Error escaneo:', errorMessage);
                }
            }

            async recordAccess(entry) {
                const accessTime = new Date().toISOString();
                
                // Actualizar localmente
                entry.status = 'entered';
                entry.accessTime = accessTime;

                // Intentar guardar en Firebase - ESTRUCTURA REAL
                if (this.isOnline && this.db) {
                    try {
                        console.log('üíæ Guardando acceso en estructura real:', `events/${this.eventId}/tickets/${entry.id}`);
                        
                        // Actualizar el ticket en la estructura real
                        await this.db
                            .collection('events')
                            .doc(this.eventId)
                            .collection('tickets')
                            .doc(entry.id)
                            .update({
                                used: true,
                                usedAt: accessTime,
                                accessTime: accessTime,
                                scannedBy: this.assistantName,
                                scannedDevice: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
                            });
                        
                        // Registrar en log de accesos global
                        await this.db.collection('access_log').add({
                            ticketId: entry.id,
                            guestName: entry.guestName,
                            artistName: entry.artistName,
                            eventId: this.eventId,
                            eventName: this.eventName,
                            accessTime: accessTime,
                            scannedBy: this.assistantName,
                            device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
                        });

                        console.log('‚úÖ Acceso registrado correctamente en Firebase');
                    } catch (error) {
                        console.error('‚ùå Error guardando en Firebase:', error);
                        // Guardar localmente para sincronizar despu√©s
                        this.saveAccessLocally(entry, accessTime);
                    }
                } else {
                    this.saveAccessLocally(entry, accessTime);
                }

                this.updateStats();
                this.displayEntries();
            }

            saveAccessLocally(entry, accessTime) {
                const localAccesses = JSON.parse(localStorage.getItem(`accesses_${this.eventId}`) || '[]');
                localAccesses.push({
                    entryId: entry.id,
                    guestName: entry.guestName,
                    artistName: entry.artistName,
                    accessTime: accessTime,
                    scannedBy: this.assistantName
                });
                localStorage.setItem(`accesses_${this.eventId}`, JSON.stringify(localAccesses));
                console.log('üíæ Acceso guardado localmente');
            }

            filterByArtist(query) {
                if (!query.trim()) {
                    // Sin filtro - mostrar todos los invitados y todos los artistas
                    this.filteredEntries = [...this.galaEntries];
                } else {
                    const searchTerm = query.toLowerCase();
                    
                    // Filtrar invitados por nombre del artista o del invitado
                    this.filteredEntries = this.galaEntries.filter(entry =>
                        entry.artistName.toLowerCase().includes(searchTerm) ||
                        entry.guestName.toLowerCase().includes(searchTerm)
                    );
                    
                    // Tambi√©n filtrar artistas por nombre (se filtra en displayEntries)
                    // Los artistas siempre se muestran si coinciden con la b√∫squeda
                }
                this.displayEntries();
            }

            displayEntries() {
                const container = document.getElementById('entries-list');
                
                if (this.filteredEntries.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">No se encontraron invitados</div>';
                    return;
                }

                // Solo mostrar invitados, no artistas separados
                container.innerHTML = this.filteredEntries.map(entry => {
                    return `
                        <div class="entry-item">
                            <div class="entry-info">
                                <div class="entry-name" style="color: white; font-weight: bold; font-size: 18px;">${entry.guestName || entry.name || 'Sin nombre'}</div>
                                <div class="entry-details" style="margin-top: 4px;">
                                    <div style="color: #3b82f6; font-size: 14px; font-weight: 500;">üé§ ${entry.artistName || 'Sin artista'}</div>
                                    ${entry.phone ? `<div style="color: #a3a3a3; font-size: 12px;">üì± ${entry.phone}</div>` : ''}
                                    ${entry.accessTime ? `<div style="color: #10b981; font-size: 12px;">‚úÖ ${new Date(entry.accessTime).toLocaleTimeString('es-ES')}</div>` : ''}
                                </div>
                            </div>
                            <div class="entry-actions">
                                <span class="status-badge status-${entry.status}" style="background: ${entry.status === 'entered' ? '#374151' : '#1f2937'}; color: white; font-size: 12px;">
                                    ${entry.status === 'entered' ? 'Ya Ingres√≥' : 'Pendiente'}
                                </span>
                                ${entry.status === 'pending' ? `
                                    <button class="btn btn-small btn-success" onclick="scanner.allowManualAccess('${entry.id}')" style="background: #3b82f6; color: white; font-size: 12px; margin-top: 4px;">
                                        ‚úÖ Permitir
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async allowManualAccess(entryId) {
                const entry = this.galaEntries.find(e => e.id === entryId);
                if (!entry || entry.status === 'entered') return;

                await this.recordAccess(entry);
                this.showScanResult(`‚úÖ Acceso manual autorizado: ${entry.guestName}`, 'success');
            }

            updateStats() {
                const total = this.galaEntries.length;
                const entered = this.galaEntries.filter(e => e.status === 'entered').length;
                const pending = total - entered;

                this.stats.generated = total;
                this.stats.entered = entered;
                this.stats.pending = pending;

                document.getElementById('entries-generated').textContent = total;
                document.getElementById('entries-entered').textContent = entered;
                document.getElementById('entries-pending').textContent = pending;
            }

            showScanResult(message, type) {
                const container = document.getElementById('scan-result');
                container.innerHTML = `<div class="scan-result scan-${type}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 4000);
            }

            startConnectionMonitoring() {
                setInterval(async () => {
                    await this.checkConnection();
                }, 30000); // Verificar cada 30 segundos
            }
        }

        // Variable global
        let scanner;

        // Funci√≥n global para el bot√≥n atr√°s
        function goBack() {
            if (scanner) {
                scanner.goBack();
            }
        }

        // Inicializar cuando carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            scanner = new SimpleQRScanner();
            window.scanner = scanner;
        });
    </script>
</body>
</html>