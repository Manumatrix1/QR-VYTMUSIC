<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Acceso VYT MUSIC - Sistema Completo</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <script src="firebase_config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            margin: 0 auto;
            padding: 15px;
            max-width: 1200px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1e3a8a;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #1e3a8a;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .scanner-section {
            text-align: center;
            margin-bottom: 30px;
        }

        #qr-reader {
            max-width: 400px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: #1e3a8a;
            color: white;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .guests-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }

        .guest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.3s ease;
        }

        .guest-item:hover {
            background: #f8fafc;
        }

        .guest-info {
            flex: 1;
        }

        .guest-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .guest-details {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 10px;
        }

        .status-valid {
            background: #d1fae5;
            color: #065f46;
        }

        .status-used {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }

        .form-input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #1e3a8a;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a8a;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .connection-online {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .sync-online { background: #10b981; }
        .sync-offline { background: #ef4444; }
        .sync-syncing { 
            background: #f59e0b; 
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .result-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }

        .result-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .result-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .result-warning {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Control de Acceso VYT MUSIC</h1>
            <p><strong id="event-name">Cargando evento...</strong> - <span id="admin-name">Administrador</span></p>
            <div class="connection-status" id="connection-status">
                <div class="sync-indicator" id="sync-indicator"></div>
                <span id="connection-text">Verificando conexi√≥n...</span>
            </div>
        </div>

        <!-- Estad√≠sticas Generales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-scanned">0</div>
                <div class="stat-label">C√≥digos Escaneados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-valid">0</div>
                <div class="stat-label">Entradas V√°lidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-pending">0</div>
                <div class="stat-label">Pendientes Sync</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-generated">0</div>
                <div class="stat-label">Generadas Hoy</div>
            </div>
        </div>

        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('scanner')">üì∑ Esc√°ner QR</button>
            <button class="tab" onclick="showTab('search')">üîç Buscar Entrada</button>
            <button class="tab" onclick="showTab('generate')">‚ûï Nueva Entrada</button>
            <button class="tab" onclick="showTab('list')">üìã Lista Completa</button>
        </div>

        <!-- Contenido Esc√°ner QR -->
        <div id="scanner-tab" class="tab-content active">
            <div class="scanner-section">
                <div id="qr-reader"></div>
                <div class="controls">
                    <button id="start-btn" class="btn btn-primary">üì∑ Iniciar Esc√°ner</button>
                    <button id="stop-btn" class="btn btn-danger" disabled>‚èπÔ∏è Detener</button>
                    <button id="manual-search-btn" class="btn btn-warning">üîç B√∫squeda Manual</button>
                </div>
            </div>
            <div id="scanner-result"></div>
        </div>

        <!-- Contenido B√∫squeda -->
        <div id="search-tab" class="tab-content">
            <div class="search-section">
                <input type="text" id="search-input" class="search-input" 
                       placeholder="üîç Buscar por nombre, tel√©fono o c√≥digo...">
                <div id="search-results" class="guests-list"></div>
            </div>
        </div>

        <!-- Contenido Generar Nueva Entrada -->
        <div id="generate-tab" class="tab-content">
            <h3 style="margin-bottom: 20px; color: #1e3a8a;">‚ûï Generar Nueva Entrada</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" id="new-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tel√©fono</label>
                    <input type="tel" id="new-phone" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio $</label>
                    <input type="number" id="new-price" class="form-input" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Quien Cobr√≥</label>
                    <input type="text" id="new-seller" class="form-input" placeholder="Nombre del vendedor">
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Observaciones</label>
                <input type="text" id="new-notes" class="form-input" placeholder="Informaci√≥n adicional">
            </div>
            <button id="generate-ticket-btn" class="btn btn-success" style="width: 100%;">
                üé´ Generar Entrada
            </button>
            <div id="generate-result"></div>
        </div>

        <!-- Contenido Lista Completa -->
        <div id="list-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #1e3a8a;">üìã Lista de Entradas</h3>
                <button id="refresh-list-btn" class="btn btn-primary">üîÑ Actualizar</button>
            </div>
            <input type="text" id="list-filter" class="search-input" 
                   placeholder="üîç Filtrar por nombre, estado o vendedor...">
            <div id="complete-list" class="guests-list"></div>
        </div>
    </div>

    <script>
        class AccessControlSystem {
            constructor() {
                this.scanner = null;
                this.eventId = null;
                this.eventName = null;
                this.assistantName = null;
                this.isScanning = false;
                this.isOnline = false;
                this.db = null;
                
                this.stats = {
                    scanned: 0,
                    valid: 0,
                    pending: 0,
                    generated: 0
                };
                
                this.localQueue = [];
                this.allTickets = [];
                
                this.init();
            }

            async init() {
                console.log('üöÄ Iniciando Sistema de Control de Acceso');
                
                // Detectar administrador y configuraci√≥n
                await this.detectAdmin();
                
                // Configurar Firebase
                await this.initFirebase();
                
                // Configurar elementos de la interfaz
                this.setupElements();
                
                // Verificar conexi√≥n y cargar datos
                await this.checkConnectionAndSync();
                
                // Cargar datos iniciales
                await this.loadInitialData();
                
                // Comenzar monitoreo de conexi√≥n
                this.startConnectionMonitoring();
                
                console.log('‚úÖ Sistema inicializado correctamente');
            }

            async detectAdmin() {
                const urlParams = new URLSearchParams(window.location.search);
                this.eventId = urlParams.get('eventId');
                this.eventName = urlParams.get('eventName');
                const adminParam = urlParams.get('admin');
                
                console.log('üîç Par√°metros URL:', { 
                    eventId: this.eventId, 
                    eventName: this.eventName, 
                    admin: adminParam 
                });

                if (this.eventId && this.eventName && adminParam === 'true') {
                    this.isAdmin = true;
                    this.eventName = decodeURIComponent(this.eventName);
                    this.assistantName = 'Administrador del Sistema';
                    console.log('‚úÖ Administrador detectado');
                    return;
                }

                // Fallbacks
                if (document.referrer.includes('panel_evento')) {
                    this.isAdmin = true;
                    this.eventId = localStorage.getItem('currentEvent') || 'demo-event';
                    this.eventName = localStorage.getItem('currentEventName') || 'Evento Demo';
                    this.assistantName = 'Administrador del Sistema';
                    return;
                }

                // Configuraci√≥n por defecto
                this.isAdmin = true;
                this.eventId = 'demo-event';
                this.eventName = 'Evento Demo';
                this.assistantName = 'Sistema de Acceso';
            }

            async initFirebase() {
                try {
                    this.db = firebase.firestore();
                    console.log('‚úÖ Firebase inicializado');
                } catch (error) {
                    console.error('‚ùå Error inicializando Firebase:', error);
                }
            }

            setupElements() {
                // Actualizar informaci√≥n del evento
                document.getElementById('event-name').textContent = this.eventName;
                document.getElementById('admin-name').textContent = this.assistantName;

                // Configurar botones
                document.getElementById('start-btn').onclick = () => this.startScanner();
                document.getElementById('stop-btn').onclick = () => this.stopScanner();
                document.getElementById('manual-search-btn').onclick = () => showTab('search');
                document.getElementById('generate-ticket-btn').onclick = () => this.generateNewTicket();
                document.getElementById('refresh-list-btn').onclick = () => this.loadAllTickets();

                // Configurar b√∫squeda
                document.getElementById('search-input').oninput = (e) => this.searchTickets(e.target.value);
                document.getElementById('list-filter').oninput = (e) => this.filterCompleteList(e.target.value);
            }

            async checkConnectionAndSync() {
                try {
                    if (this.db) {
                        const testRef = this.db.collection('connection_test').doc('test');
                        await testRef.get();
                        this.isOnline = true;
                        await this.syncPendingData();
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Sin conexi√≥n a Firebase:', error);
                    this.isOnline = false;
                }
                
                this.updateConnectionStatus();
            }

            updateConnectionStatus() {
                const statusDiv = document.getElementById('connection-status');
                const indicator = document.getElementById('sync-indicator');
                const text = document.getElementById('connection-text');
                
                if (this.isOnline) {
                    statusDiv.className = 'connection-status connection-online';
                    indicator.className = 'sync-indicator sync-online';
                    text.textContent = 'üü¢ En l√≠nea - Sincronizando con Firebase';
                } else {
                    statusDiv.className = 'connection-status connection-offline';
                    indicator.className = 'sync-indicator sync-offline';
                    text.textContent = 'üî¥ Sin conexi√≥n - Guardando localmente';
                }
            }

            async loadInitialData() {
                await this.loadAllTickets();
                this.updateStats();
            }

            async loadAllTickets() {
                try {
                    this.allTickets = [];
                    
                    // Cargar desde Firebase si hay conexi√≥n
                    if (this.isOnline && this.db) {
                        console.log('üì• Cargando tickets desde Firebase...');
                        const snapshot = await this.db
                            .collection('tickets')
                            .where('eventId', '==', this.eventId)
                            .orderBy('createdAt', 'desc')
                            .get();
                        
                        snapshot.forEach(doc => {
                            this.allTickets.push({ id: doc.id, ...doc.data() });
                        });
                    }
                    
                    // Agregar tickets locales pendientes
                    const localTickets = JSON.parse(localStorage.getItem(`tickets_${this.eventId}`) || '[]');
                    this.allTickets = [...this.allTickets, ...localTickets];
                    
                    console.log(`üìã Cargados ${this.allTickets.length} tickets`);
                    this.displayCompleteList();
                    this.updateStats();
                    
                } catch (error) {
                    console.error('‚ùå Error cargando tickets:', error);
                    // Cargar solo desde localStorage
                    const localTickets = JSON.parse(localStorage.getItem(`tickets_${this.eventId}`) || '[]');
                    this.allTickets = localTickets;
                    this.displayCompleteList();
                }
            }

            async startScanner() {
                if (this.isScanning) return;

                try {
                    console.log('üì∑ Iniciando esc√°ner...');
                    this.isScanning = true;
                    
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;

                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                    };

                    this.scanner = new Html5Qrcode("qr-reader");
                    
                    await this.scanner.start(
                        { facingMode: "environment" },
                        config,
                        (decodedText) => this.onScanSuccess(decodedText),
                        (errorMessage) => this.onScanError(errorMessage)
                    );

                    this.showScannerResult('‚úÖ Esc√°ner activo - Apunta al c√≥digo QR', 'success');

                } catch (error) {
                    console.error('‚ùå Error al iniciar esc√°ner:', error);
                    this.showScannerResult('‚ùå Error al acceder a la c√°mara: ' + error.message, 'error');
                    this.resetScannerButtons();
                }
            }

            async stopScanner() {
                if (!this.isScanning || !this.scanner) return;

                try {
                    await this.scanner.stop();
                    await this.scanner.clear();
                    this.scanner = null;
                    this.isScanning = false;
                    
                    this.resetScannerButtons();
                    this.showScannerResult('‚èπÔ∏è Esc√°ner detenido', 'success');

                } catch (error) {
                    console.error('‚ùå Error al detener esc√°ner:', error);
                }
            }

            resetScannerButtons() {
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }

            async onScanSuccess(decodedText) {
                console.log('üì± QR escaneado:', decodedText);
                
                this.stats.scanned++;
                this.updateStats();

                try {
                    const result = await this.processTicket(decodedText);
                    
                    if (result.success) {
                        this.stats.valid++;
                        this.showScannerResult(`‚úÖ ${result.message}`, 'success');
                        await this.recordAccess(result.ticket, 'qr-scan');
                    } else {
                        this.showScannerResult(`‚ùå ${result.message}`, 'error');
                    }

                } catch (error) {
                    console.error('‚ùå Error procesando ticket:', error);
                    this.showScannerResult('‚ùå Error al procesar el c√≥digo', 'error');
                }

                this.updateStats();
            }

            onScanError(errorMessage) {
                // Ignorar errores menores
                if (!errorMessage.includes('NotFoundException')) {
                    console.warn('‚ö†Ô∏è Error de escaneo:', errorMessage);
                }
            }

            async processTicket(qrData) {
                // Buscar ticket en la lista cargada
                const ticket = this.allTickets.find(t => 
                    t.qrCode === qrData || 
                    t.ticketId === qrData ||
                    t.id === qrData
                );

                if (!ticket) {
                    return {
                        success: false,
                        message: 'C√≥digo no v√°lido o no encontrado'
                    };
                }

                if (ticket.status === 'used') {
                    return {
                        success: false,
                        message: `Entrada ya utilizada - ${ticket.guestName}`
                    };
                }

                return {
                    success: true,
                    message: `Acceso autorizado - ${ticket.guestName}`,
                    ticket: ticket
                };
            }

            async recordAccess(ticket, accessType) {
                const accessRecord = {
                    ticketId: ticket.id || ticket.ticketId,
                    guestName: ticket.guestName,
                    eventId: this.eventId,
                    accessTime: new Date().toISOString(),
                    accessType: accessType,
                    assistantName: this.assistantName,
                    device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
                };

                // Marcar ticket como usado
                ticket.status = 'used';
                ticket.accessTime = accessRecord.accessTime;

                if (this.isOnline && this.db) {
                    try {
                        // Guardar en Firebase
                        await this.db.collection('access_records').add(accessRecord);
                        await this.db.collection('tickets').doc(ticket.id).update({
                            status: 'used',
                            accessTime: accessRecord.accessTime
                        });
                        console.log('‚úÖ Acceso registrado en Firebase');
                    } catch (error) {
                        console.error('‚ùå Error guardando en Firebase:', error);
                        this.saveToLocalQueue(accessRecord);
                    }
                } else {
                    this.saveToLocalQueue(accessRecord);
                }

                // Actualizar lista local
                this.updateLocalTickets();
            }

            saveToLocalQueue(record) {
                this.localQueue.push(record);
                localStorage.setItem(`access_queue_${this.eventId}`, JSON.stringify(this.localQueue));
                this.stats.pending = this.localQueue.length;
                console.log('üíæ Registro guardado localmente');
            }

            async syncPendingData() {
                if (!this.isOnline || !this.db || this.localQueue.length === 0) return;

                console.log(`üîÑ Sincronizando ${this.localQueue.length} registros pendientes...`);
                
                const indicator = document.getElementById('sync-indicator');
                indicator.className = 'sync-indicator sync-syncing';

                try {
                    for (const record of this.localQueue) {
                        await this.db.collection('access_records').add(record);
                    }
                    
                    // Limpiar cola local
                    this.localQueue = [];
                    localStorage.removeItem(`access_queue_${this.eventId}`);
                    this.stats.pending = 0;
                    
                    console.log('‚úÖ Sincronizaci√≥n completada');
                    indicator.className = 'sync-indicator sync-online';
                    
                } catch (error) {
                    console.error('‚ùå Error en sincronizaci√≥n:', error);
                    indicator.className = 'sync-indicator sync-offline';
                }
            }

            async generateNewTicket() {
                const name = document.getElementById('new-name').value.trim();
                const phone = document.getElementById('new-phone').value.trim();
                const price = parseFloat(document.getElementById('new-price').value) || 0;
                const seller = document.getElementById('new-seller').value.trim() || this.assistantName;
                const notes = document.getElementById('new-notes').value.trim();

                if (!name) {
                    this.showGenerateResult('‚ùå El nombre es obligatorio', 'error');
                    return;
                }

                const newTicket = {
                    ticketId: `TICKET-${Date.now()}`,
                    qrCode: `vyt-music-${Date.now()}`,
                    guestName: name,
                    phone: phone,
                    price: price,
                    seller: seller,
                    notes: notes,
                    eventId: this.eventId,
                    status: 'valid',
                    createdAt: new Date().toISOString(),
                    createdBy: this.assistantName,
                    source: 'door-sale'
                };

                try {
                    if (this.isOnline && this.db) {
                        // Guardar en Firebase
                        const docRef = await this.db.collection('tickets').add(newTicket);
                        newTicket.id = docRef.id;
                        console.log('‚úÖ Ticket guardado en Firebase');
                    } else {
                        // Guardar localmente
                        newTicket.id = newTicket.ticketId;
                        this.saveTicketLocally(newTicket);
                    }

                    // Agregar a la lista local
                    this.allTickets.unshift(newTicket);
                    this.stats.generated++;
                    this.updateStats();
                    this.displayCompleteList();

                    this.showGenerateResult(`‚úÖ Entrada generada: ${name}`, 'success');
                    this.clearGenerateForm();

                } catch (error) {
                    console.error('‚ùå Error generando ticket:', error);
                    // Guardar localmente como fallback
                    newTicket.id = newTicket.ticketId;
                    this.saveTicketLocally(newTicket);
                    this.allTickets.unshift(newTicket);
                    this.stats.generated++;
                    this.updateStats();
                    this.showGenerateResult(`‚úÖ Entrada generada localmente: ${name}`, 'warning');
                    this.clearGenerateForm();
                }
            }

            saveTicketLocally(ticket) {
                const localTickets = JSON.parse(localStorage.getItem(`tickets_${this.eventId}`) || '[]');
                localTickets.unshift(ticket);
                localStorage.setItem(`tickets_${this.eventId}`, JSON.stringify(localTickets));
                console.log('üíæ Ticket guardado localmente');
            }

            updateLocalTickets() {
                const localTickets = this.allTickets.filter(t => t.source === 'door-sale' || !t.id.includes('firebase'));
                localStorage.setItem(`tickets_${this.eventId}`, JSON.stringify(localTickets));
            }

            clearGenerateForm() {
                document.getElementById('new-name').value = '';
                document.getElementById('new-phone').value = '';
                document.getElementById('new-price').value = '';
                document.getElementById('new-seller').value = '';
                document.getElementById('new-notes').value = '';
            }

            searchTickets(query) {
                if (!query.trim()) {
                    document.getElementById('search-results').innerHTML = '';
                    return;
                }

                const filtered = this.allTickets.filter(ticket =>
                    ticket.guestName.toLowerCase().includes(query.toLowerCase()) ||
                    (ticket.phone && ticket.phone.includes(query)) ||
                    (ticket.ticketId && ticket.ticketId.toLowerCase().includes(query.toLowerCase()))
                );

                this.displaySearchResults(filtered);
            }

            displaySearchResults(tickets) {
                const container = document.getElementById('search-results');
                
                if (tickets.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #6b7280;">No se encontraron resultados</p>';
                    return;
                }

                container.innerHTML = tickets.map(ticket => `
                    <div class="guest-item">
                        <div class="guest-info">
                            <div class="guest-name">${ticket.guestName}</div>
                            <div class="guest-details">
                                ${ticket.phone ? `üì± ${ticket.phone} ‚Ä¢ ` : ''}
                                üí∞ $${ticket.price || 0} ‚Ä¢ 
                                ${ticket.seller ? `üë§ ${ticket.seller}` : ''}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge status-${ticket.status}">
                                ${ticket.status === 'valid' ? 'V√°lida' : ticket.status === 'used' ? 'Usada' : 'Pendiente'}
                            </span>
                            <button class="btn btn-success" onclick="accessControl.allowAccess('${ticket.id}')" 
                                    ${ticket.status === 'used' ? 'disabled' : ''}>
                                ‚úÖ Permitir Acceso
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            async allowAccess(ticketId) {
                const ticket = this.allTickets.find(t => t.id === ticketId);
                if (!ticket) return;

                if (ticket.status === 'used') {
                    this.showScannerResult('‚ùå Entrada ya utilizada', 'error');
                    return;
                }

                await this.recordAccess(ticket, 'manual-search');
                this.stats.valid++;
                this.updateStats();
                this.showScannerResult(`‚úÖ Acceso autorizado - ${ticket.guestName}`, 'success');
                
                // Actualizar vista de b√∫squeda
                const searchQuery = document.getElementById('search-input').value;
                if (searchQuery) {
                    this.searchTickets(searchQuery);
                }
                
                // Actualizar lista completa
                this.displayCompleteList();
            }

            filterCompleteList(query) {
                const filtered = query.trim() ? 
                    this.allTickets.filter(ticket =>
                        ticket.guestName.toLowerCase().includes(query.toLowerCase()) ||
                        ticket.status.toLowerCase().includes(query.toLowerCase()) ||
                        (ticket.seller && ticket.seller.toLowerCase().includes(query.toLowerCase()))
                    ) : this.allTickets;

                this.displayFilteredList(filtered);
            }

            displayCompleteList() {
                this.displayFilteredList(this.allTickets);
            }

            displayFilteredList(tickets) {
                const container = document.getElementById('complete-list');
                
                if (tickets.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #6b7280;">No hay entradas registradas</p>';
                    return;
                }

                container.innerHTML = tickets.map(ticket => `
                    <div class="guest-item">
                        <div class="guest-info">
                            <div class="guest-name">${ticket.guestName}</div>
                            <div class="guest-details">
                                ${ticket.phone ? `üì± ${ticket.phone} ‚Ä¢ ` : ''}
                                üí∞ $${ticket.price || 0} ‚Ä¢ 
                                üë§ ${ticket.seller || 'N/A'} ‚Ä¢ 
                                üïê ${new Date(ticket.createdAt).toLocaleString('es-ES')}
                                ${ticket.accessTime ? ` ‚Ä¢ ‚úÖ ${new Date(ticket.accessTime).toLocaleString('es-ES')}` : ''}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge status-${ticket.status}">
                                ${ticket.status === 'valid' ? 'V√°lida' : ticket.status === 'used' ? 'Usada' : 'Pendiente'}
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                document.getElementById('total-scanned').textContent = this.stats.scanned;
                document.getElementById('total-valid').textContent = this.stats.valid;
                document.getElementById('total-pending').textContent = this.stats.pending;
                document.getElementById('total-generated').textContent = this.stats.generated;
            }

            showScannerResult(message, type) {
                const container = document.getElementById('scanner-result');
                container.innerHTML = `<div class="result-message result-${type}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 4000);
            }

            showGenerateResult(message, type) {
                const container = document.getElementById('generate-result');
                container.innerHTML = `<div class="result-message result-${type}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 4000);
            }

            startConnectionMonitoring() {
                setInterval(async () => {
                    await this.checkConnectionAndSync();
                }, 30000); // Verificar cada 30 segundos
            }
        }

        // Funciones globales
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Detener esc√°ner si se cambia de pesta√±a
            if (tabName !== 'scanner' && window.accessControl && window.accessControl.isScanning) {
                window.accessControl.stopScanner();
            }
        }

        // Variable global para acceso desde HTML
        let accessControl;

        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', () => {
            accessControl = new AccessControlSystem();
            window.accessControl = accessControl;
        });
    </script>
</body>
</html>