<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc√°ner de Entradas - VYT MUSIC</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <script src="firebase_config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            margin: 0 auto;
            padding: 20px;
            max-width: 800px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .event-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        /* ESC√ÅNER - ARRIBA DE TODO */
        .scanner-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ESTAD√çSTICAS PEQUE√ëAS */
        .stats-mini {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-mini {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-mini-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            display: block;
        }

        .stat-mini-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }

        /* FILTRO POR ARTISTA */
        .artist-filter {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .filter-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .filter-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        /* LISTA DE ENTRADAS */
        .entries-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .entries-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .entry-item {
            background: rgba(255,255,255,0.9);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-info {
            flex: 1;
        }

        .entry-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .entry-details {
            font-size: 0.9rem;
            color: #666;
        }

        .entry-artist {
            color: #667eea;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-entered {
            background: #d1fae5;
            color: #065f46;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        /* RESULTADO DEL ESCANEO */
        .scan-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .scan-success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
        }

        .scan-error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        /* CONEXI√ìN */
        .connection-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .connection-online { background: #10b981; }
        .connection-offline { background: #ef4444; }

        @media (max-width: 480px) {
            .stats-mini {
                grid-template-columns: 1fr;
            }
            
            .scanner-controls {
                flex-direction: column;
            }
            
            .entry-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .entry-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üéµ Esc√°ner de Entradas VYT</h1>
        </div>

        <!-- INFO DEL EVENTO Y CONEXI√ìN -->
        <div class="event-info">
            <h3 id="event-name">Cargando evento...</h3>
            <p>üë§ <span id="admin-name">Administrador</span></p>
            <div class="connection-indicator">
                <div class="connection-dot" id="connection-dot"></div>
                <span id="connection-text">Verificando conexi√≥n...</span>
            </div>
        </div>

        <!-- ESC√ÅNER QR - ARRIBA DE TODO -->
        <div class="scanner-container">
            <h3 style="margin-bottom: 15px; color: #333;">üì∑ Esc√°ner de C√≥digos QR</h3>
            <div id="qr-reader"></div>
            <div class="scanner-controls">
                <button id="start-btn" class="btn btn-primary">üì∑ Iniciar Esc√°ner</button>
                <button id="stop-btn" class="btn btn-danger" disabled>‚èπÔ∏è Detener</button>
            </div>
            <div id="scan-result"></div>
        </div>

        <!-- ESTAD√çSTICAS PEQUE√ëAS -->
        <div class="stats-mini">
            <div class="stat-mini">
                <span class="stat-mini-number" id="entries-generated">0</span>
                <div class="stat-mini-label">Entradas Generadas</div>
            </div>
            <div class="stat-mini">
                <span class="stat-mini-number" id="entries-entered">0</span>
                <div class="stat-mini-label">Ya Ingresaron</div>
            </div>
            <div class="stat-mini">
                <span class="stat-mini-number" id="entries-pending">0</span>
                <div class="stat-mini-label">Faltan Ingresar</div>
            </div>
        </div>

        <!-- FILTRO POR ARTISTA -->
        <div class="artist-filter">
            <input type="text" id="artist-filter" class="filter-input" 
                   placeholder="üé§ Filtrar por artista (ej: Emilia, L-Gante, etc.)">
        </div>

        <!-- LISTA DE ENTRADAS DE LA GALA -->
        <div class="entries-container">
            <h3 style="margin-bottom: 15px; color: white;">üìã Entradas de la Gala</h3>
            <div id="entries-list" class="entries-list">
                <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                    Cargando entradas de la gala...
                </div>
            </div>
        </div>
    </div>

    <script>
        class SimpleQRScanner {
            constructor() {
                this.scanner = null;
                this.eventId = null;
                this.eventName = null;
                this.assistantName = null;
                this.isScanning = false;
                this.isOnline = false;
                this.db = null;
                
                this.galaEntries = [];
                this.filteredEntries = [];
                
                this.stats = {
                    generated: 0,
                    entered: 0,
                    pending: 0
                };
                
                this.init();
            }

            async init() {
                console.log('üöÄ Iniciando Esc√°ner Simple VYT');
                
                // Detectar configuraci√≥n
                await this.detectEventConfig();
                
                // Inicializar Firebase
                await this.initFirebase();
                
                // Configurar elementos
                this.setupElements();
                
                // Verificar conexi√≥n
                await this.checkConnection();
                
                // Cargar entradas de la gala
                await this.loadGalaEntries();
                
                // Iniciar monitoreo
                this.startConnectionMonitoring();
                
                console.log('‚úÖ Sistema listo');
            }

            async detectEventConfig() {
                const urlParams = new URLSearchParams(window.location.search);
                this.eventId = urlParams.get('eventId');
                this.eventName = urlParams.get('eventName');
                const adminParam = urlParams.get('admin');
                
                console.log('üîç Configuraci√≥n detectada:', { 
                    eventId: this.eventId, 
                    eventName: this.eventName, 
                    admin: adminParam 
                });

                if (this.eventId && this.eventName && adminParam === 'true') {
                    this.eventName = decodeURIComponent(this.eventName);
                    this.assistantName = 'Administrador';
                    return;
                }

                // Fallbacks
                this.eventId = localStorage.getItem('currentEvent') || 'gala-2025';
                this.eventName = localStorage.getItem('currentEventName') || 'Gala VYT Music 2025';
                this.assistantName = 'Esc√°ner de Entradas';
            }

            async initFirebase() {
                try {
                    this.db = firebase.firestore();
                    console.log('‚úÖ Firebase conectado');
                } catch (error) {
                    console.error('‚ùå Error Firebase:', error);
                }
            }

            setupElements() {
                // Actualizar info del evento
                document.getElementById('event-name').textContent = this.eventName;
                document.getElementById('admin-name').textContent = this.assistantName;

                // Configurar botones
                document.getElementById('start-btn').onclick = () => this.startScanner();
                document.getElementById('stop-btn').onclick = () => this.stopScanner();

                // Configurar filtro por artista
                document.getElementById('artist-filter').oninput = (e) => this.filterByArtist(e.target.value);
            }

            async checkConnection() {
                try {
                    if (this.db) {
                        // Verificar conexi√≥n real con Firebase
                        const testRef = this.db.collection('eventos').doc('test');
                        await testRef.get();
                        this.isOnline = true;
                        console.log('üü¢ Conexi√≥n Firebase OK');
                    }
                } catch (error) {
                    console.warn('üî¥ Sin conexi√≥n Firebase:', error);
                    this.isOnline = false;
                }
                
                this.updateConnectionStatus();
            }

            updateConnectionStatus() {
                const dot = document.getElementById('connection-dot');
                const text = document.getElementById('connection-text');
                
                if (this.isOnline) {
                    dot.className = 'connection-dot connection-online';
                    text.textContent = 'Conectado a Firebase';
                } else {
                    dot.className = 'connection-dot connection-offline';
                    text.textContent = 'Sin conexi√≥n - Modo offline';
                }
            }

            async loadGalaEntries() {
                console.log('üì• Cargando entradas de la gala...');
                
                try {
                    this.galaEntries = [];
                    
                    if (this.isOnline && this.db) {
                        // Cargar desde Firebase - entradas reales de la gala
                        const artistsSnapshot = await this.db
                            .collection('artistas')
                            .where('eventoId', '==', this.eventId)
                            .get();

                        for (const artistDoc of artistsSnapshot.docs) {
                            const artistData = artistDoc.data();
                            console.log(`üé§ Cargando entradas para: ${artistData.nombre}`);

                            // Cargar entradas de este artista
                            const entriesSnapshot = await this.db
                                .collection('entradas')
                                .where('artistaId', '==', artistDoc.id)
                                .where('eventoId', '==', this.eventId)
                                .get();

                            entriesSnapshot.forEach(entryDoc => {
                                const entryData = entryDoc.data();
                                this.galaEntries.push({
                                    id: entryDoc.id,
                                    ...entryData,
                                    artistName: artistData.nombre,
                                    artistImage: artistData.imagen || '',
                                    status: entryData.hasEntered ? 'entered' : 'pending'
                                });
                            });
                        }
                    } else {
                        // Datos de ejemplo para pruebas offline
                        this.galaEntries = this.createSampleEntries();
                    }
                    
                    console.log(`üìã Cargadas ${this.galaEntries.length} entradas`);
                    this.filteredEntries = [...this.galaEntries];
                    this.updateStats();
                    this.displayEntries();
                    
                } catch (error) {
                    console.error('‚ùå Error cargando entradas:', error);
                    // Usar datos de ejemplo en caso de error
                    this.galaEntries = this.createSampleEntries();
                    this.filteredEntries = [...this.galaEntries];
                    this.updateStats();
                    this.displayEntries();
                }
            }

            createSampleEntries() {
                // Datos de ejemplo para cuando no hay conexi√≥n
                return [
                    {
                        id: 'sample1',
                        guestName: 'Juan P√©rez',
                        phone: '1234567890',
                        artistName: 'Emilia',
                        qrCode: 'QR-EMI-001',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'sample2',
                        guestName: 'Mar√≠a Garc√≠a',
                        phone: '0987654321',
                        artistName: 'L-Gante',
                        qrCode: 'QR-LG-001',
                        status: 'entered',
                        accessTime: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'sample3',
                        guestName: 'Carlos Rodr√≠guez',
                        phone: '5555555555',
                        artistName: 'Emilia',
                        qrCode: 'QR-EMI-002',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            async startScanner() {
                if (this.isScanning) return;

                try {
                    console.log('üì∑ Iniciando esc√°ner...');
                    this.isScanning = true;
                    
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;

                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                    };

                    this.scanner = new Html5Qrcode("qr-reader");
                    
                    await this.scanner.start(
                        { facingMode: "environment" },
                        config,
                        (decodedText) => this.onScanSuccess(decodedText),
                        (errorMessage) => this.onScanError(errorMessage)
                    );

                    this.showScanResult('‚úÖ Esc√°ner activo - Apunta al c√≥digo QR', 'success');

                } catch (error) {
                    console.error('‚ùå Error al iniciar esc√°ner:', error);
                    this.showScanResult('‚ùå Error al acceder a la c√°mara', 'error');
                    this.resetScannerButtons();
                }
            }

            async stopScanner() {
                if (!this.isScanning || !this.scanner) return;

                try {
                    await this.scanner.stop();
                    await this.scanner.clear();
                    this.scanner = null;
                    this.isScanning = false;
                    
                    this.resetScannerButtons();
                    this.showScanResult('‚èπÔ∏è Esc√°ner detenido', 'success');

                } catch (error) {
                    console.error('‚ùå Error al detener esc√°ner:', error);
                }
            }

            resetScannerButtons() {
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }

            async onScanSuccess(decodedText) {
                console.log('üì± QR escaneado:', decodedText);
                
                try {
                    const entry = this.galaEntries.find(e => 
                        e.qrCode === decodedText || 
                        e.id === decodedText ||
                        e.ticketId === decodedText
                    );

                    if (!entry) {
                        this.showScanResult('‚ùå C√≥digo QR no encontrado', 'error');
                        return;
                    }

                    if (entry.status === 'entered') {
                        this.showScanResult(`‚ùå ${entry.guestName} ya ingres√≥`, 'error');
                        return;
                    }

                    // Registrar acceso
                    await this.recordAccess(entry);
                    this.showScanResult(`‚úÖ Acceso autorizado: ${entry.guestName} (${entry.artistName})`, 'success');

                } catch (error) {
                    console.error('‚ùå Error procesando QR:', error);
                    this.showScanResult('‚ùå Error al procesar el c√≥digo', 'error');
                }
            }

            onScanError(errorMessage) {
                // Ignorar errores menores
                if (!errorMessage.includes('NotFoundException')) {
                    console.warn('‚ö†Ô∏è Error escaneo:', errorMessage);
                }
            }

            async recordAccess(entry) {
                const accessTime = new Date().toISOString();
                
                // Actualizar localmente
                entry.status = 'entered';
                entry.accessTime = accessTime;

                // Intentar guardar en Firebase
                if (this.isOnline && this.db) {
                    try {
                        await this.db.collection('entradas').doc(entry.id).update({
                            hasEntered: true,
                            accessTime: accessTime,
                            scannedBy: this.assistantName
                        });
                        
                        // Registrar en log de accesos
                        await this.db.collection('access_log').add({
                            entryId: entry.id,
                            guestName: entry.guestName,
                            artistName: entry.artistName,
                            eventId: this.eventId,
                            accessTime: accessTime,
                            scannedBy: this.assistantName,
                            device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
                        });

                        console.log('‚úÖ Acceso registrado en Firebase');
                    } catch (error) {
                        console.error('‚ùå Error guardando en Firebase:', error);
                        // Guardar localmente para sincronizar despu√©s
                        this.saveAccessLocally(entry, accessTime);
                    }
                } else {
                    this.saveAccessLocally(entry, accessTime);
                }

                this.updateStats();
                this.displayEntries();
            }

            saveAccessLocally(entry, accessTime) {
                const localAccesses = JSON.parse(localStorage.getItem(`accesses_${this.eventId}`) || '[]');
                localAccesses.push({
                    entryId: entry.id,
                    guestName: entry.guestName,
                    artistName: entry.artistName,
                    accessTime: accessTime,
                    scannedBy: this.assistantName
                });
                localStorage.setItem(`accesses_${this.eventId}`, JSON.stringify(localAccesses));
                console.log('üíæ Acceso guardado localmente');
            }

            filterByArtist(query) {
                if (!query.trim()) {
                    this.filteredEntries = [...this.galaEntries];
                } else {
                    this.filteredEntries = this.galaEntries.filter(entry =>
                        entry.artistName.toLowerCase().includes(query.toLowerCase()) ||
                        entry.guestName.toLowerCase().includes(query.toLowerCase())
                    );
                }
                this.displayEntries();
            }

            displayEntries() {
                const container = document.getElementById('entries-list');
                
                if (this.filteredEntries.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">No se encontraron entradas</div>';
                    return;
                }

                container.innerHTML = this.filteredEntries.map(entry => `
                    <div class="entry-item">
                        <div class="entry-info">
                            <div class="entry-name">${entry.guestName}</div>
                            <div class="entry-details">
                                üé§ <span class="entry-artist">${entry.artistName}</span>
                                ${entry.phone ? ` ‚Ä¢ üì± ${entry.phone}` : ''}
                                ${entry.accessTime ? ` ‚Ä¢ ‚úÖ ${new Date(entry.accessTime).toLocaleTimeString('es-ES')}` : ''}
                            </div>
                        </div>
                        <div class="entry-actions">
                            <span class="status-badge status-${entry.status}">
                                ${entry.status === 'entered' ? 'Ya Ingres√≥' : 'Pendiente'}
                            </span>
                            ${entry.status === 'pending' ? `
                                <button class="btn btn-small btn-success" onclick="scanner.allowManualAccess('${entry.id}')">
                                    ‚úÖ Permitir
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            async allowManualAccess(entryId) {
                const entry = this.galaEntries.find(e => e.id === entryId);
                if (!entry || entry.status === 'entered') return;

                await this.recordAccess(entry);
                this.showScanResult(`‚úÖ Acceso manual autorizado: ${entry.guestName}`, 'success');
            }

            updateStats() {
                const total = this.galaEntries.length;
                const entered = this.galaEntries.filter(e => e.status === 'entered').length;
                const pending = total - entered;

                this.stats.generated = total;
                this.stats.entered = entered;
                this.stats.pending = pending;

                document.getElementById('entries-generated').textContent = total;
                document.getElementById('entries-entered').textContent = entered;
                document.getElementById('entries-pending').textContent = pending;
            }

            showScanResult(message, type) {
                const container = document.getElementById('scan-result');
                container.innerHTML = `<div class="scan-result scan-${type}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 4000);
            }

            startConnectionMonitoring() {
                setInterval(async () => {
                    await this.checkConnection();
                }, 30000); // Verificar cada 30 segundos
            }
        }

        // Variable global
        let scanner;

        // Inicializar cuando carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            scanner = new SimpleQRScanner();
            window.scanner = scanner;
        });
    </script>
</body>
</html>