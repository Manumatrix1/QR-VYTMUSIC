<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Mi Reporte - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-3xl p-4 sm:p-6">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="mb-6">
                <h1 class="text-4xl font-bold text-sky-400 mb-4">üé§ Acceso a Reportes</h1>
                <p id="gala-name" class="text-xl text-gray-300">Cargando informaci√≥n...</p>
                <p class="text-sm text-gray-400 mt-2">Selecciona tu nombre para ver tu reporte personal</p>
            </div>
        </header>

        <!-- Informaci√≥n de la Gala -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg text-center">
                <h2 class="text-2xl font-bold mb-4">üìã Informaci√≥n de la Gala</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Participantes</p>
                        <p id="total-artists" class="text-2xl font-bold text-sky-400">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Total Votos</p>
                        <p id="total-votes" class="text-2xl font-bold text-green-400">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Fecha</p>
                        <p id="gala-date" class="text-sm font-bold text-yellow-400">-</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Artistas para Acceso -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">üé≠ Selecciona Tu Nombre</h2>
                <div id="artists-list" class="space-y-3">
                    <p class="text-center text-gray-400">Cargando lista de participantes...</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center">
            <div class="glass-effect p-4 rounded-lg">
                <p class="text-gray-400">
                    üéµ Powered by <strong class="text-sky-400">VYTMUSIC</strong>
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    Sistema de gesti√≥n de eventos musicales
                </p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let galaData = null;

        // Obtener par√°metros de URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                eventId: params.get('eventId'),
                eventName: params.get('eventName')
            };
        }

        // Cargar datos de la gala
        async function loadGalaInfo() {
            const { eventId, eventName } = getUrlParams();

            if (!eventId) {
                document.body.innerHTML = `
                    <div class="container mx-auto max-w-4xl p-4 text-center">
                        <h1 class="text-3xl font-bold text-red-400 mb-4">‚ùå Enlace Inv√°lido</h1>
                        <p class="text-gray-300">Este enlace no contiene la informaci√≥n necesaria.</p>
                        <p class="text-sm text-gray-500 mt-4">Contacta con la organizaci√≥n para obtener el enlace correcto.</p>
                    </div>
                `;
                return;
            }

            try {
                console.log(`Cargando informaci√≥n de la gala ${eventId}`);

                // Cargar informaci√≥n del evento
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                if (!eventDoc.exists()) {
                    throw new Error('Evento no encontrado');
                }

                galaData = { id: eventId, ...eventDoc.data() };
                document.getElementById('gala-name').textContent = galaData.name;
                document.getElementById('gala-date').textContent = galaData.date || 'Sin fecha';

                // Cargar todos los artistas
                const artistsSnapshot = await getDocs(collection(db, `events/${eventId}/artists`));
                const allArtists = artistsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Estad√≠sticas generales
                const totalVotes = allArtists.reduce((sum, artist) => sum + (artist.totalRatingsCount || 0), 0);
                document.getElementById('total-artists').textContent = allArtists.length;
                document.getElementById('total-votes').textContent = totalVotes;

                // Ordenar artistas alfab√©ticamente
                allArtists.sort((a, b) => a.name.localeCompare(b.name));

                renderArtistsList(allArtists);

            } catch (error) {
                console.error('Error cargando informaci√≥n:', error);
                document.body.innerHTML = `
                    <div class="container mx-auto max-w-4xl p-4 text-center">
                        <h1 class="text-3xl font-bold text-red-400 mb-4">‚ùå Error al Cargar</h1>
                        <p class="text-gray-300">No se pudo cargar la informaci√≥n de la gala.</p>
                        <p class="text-sm text-gray-500 mt-4">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderArtistsList(artists) {
            const container = document.getElementById('artists-list');
            container.innerHTML = '';

            if (artists.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">No hay participantes registrados</p>';
                return;
            }

            artists.forEach(artist => {
                const artistCard = document.createElement('div');
                artistCard.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-sky-500 hover:bg-gray-700 transition-all cursor-pointer';
                
                artistCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-sky-500 to-blue-600 flex items-center justify-center mr-4">
                                <span class="text-white font-bold text-lg">${artist.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">${artist.name}</h3>
                                <p class="text-sm text-gray-400">Clic para ver tu reporte personal</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sky-400 font-bold">
                                ${artist.totalRatingsCount || 0} votos
                            </div>
                            <div class="text-xs text-gray-500">
                                ${artist.totalScore || 0} pts
                            </div>
                        </div>
                    </div>
                `;

                artistCard.addEventListener('click', () => {
                    const params = new URLSearchParams(window.location.search);
                    const reportUrl = `reporte_artista_publico.html?eventId=${params.get('eventId')}&artistId=${artist.id}&eventName=${encodeURIComponent(params.get('eventName') || '')}`;
                    window.location.href = reportUrl;
                });

                container.appendChild(artistCard);
            });
        }

        // Inicializar
        loadGalaInfo();
    </script>
</body>
</html>