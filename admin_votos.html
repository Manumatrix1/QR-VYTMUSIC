<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n de Votos - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: #f9fafb; 
        }
        .hidden { display: none !important; }
        .danger-zone {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            border: 2px solid #dc2626;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto max-w-6xl p-4">
        <!-- Header -->
        <header class="text-center mb-8">
            <a href="index.html" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Panel Principal</a>
            <img src="https://i.imgur.com/rqkZi9P.png" alt="VYTMUSIC Logo" class="mx-auto mb-4 bg-white rounded-full" style="max-width: 100px;">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">üóëÔ∏è Administraci√≥n de Votos</h1>
            <p class="text-xl text-gray-300 mt-2">Gestionar y eliminar votos de prueba o incorrectos</p>
        </header>

        <div id="message-container" class="mb-6"></div>

        <!-- Filtros y Controles -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-4">üîç Filtrar Votos</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Tipo de Voto:</label>
                    <select id="vote-type-filter" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white">
                        <option value="all">Todos los votos</option>
                        <option value="public">Solo votos p√∫blicos</option>
                        <option value="jury">Solo votos del jurado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Buscar por nombre:</label>
                    <input type="text" id="search-filter" placeholder="Nombre del artista o jurado..." 
                           class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white">
                </div>
                <div class="flex items-end">
                    <button onclick="loadVotes()" class="w-full py-3 px-6 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">
                        üîÑ Cargar Votos
                    </button>
                </div>
            </div>
        </section>

        <!-- Estad√≠sticas -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-4">üìä Estad√≠sticas</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-400" id="total-public-votes">0</div>
                    <div class="text-sm text-gray-400">Votos P√∫blicos</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-yellow-400" id="total-jury-votes">0</div>
                    <div class="text-sm text-gray-400">Votos Jurado</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-400" id="total-artists">0</div>
                    <div class="text-sm text-gray-400">Artistas con Votos</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-400" id="total-jurors">0</div>
                    <div class="text-sm text-gray-400">Jurados Activos</div>
                </div>
            </div>
        </section>

        <!-- Lista de Votos -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìã Lista de Votos</h2>
                <div class="flex gap-2">
                    <button onclick="selectAllVisible()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ‚úÖ Seleccionar Visibles
                    </button>
                    <button onclick="clearSelection()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                        ‚ùå Limpiar Selecci√≥n
                    </button>
                </div>
            </div>
            
            <div id="votes-container" class="space-y-4">
                <!-- Los votos se cargar√°n aqu√≠ -->
                <div class="text-center text-gray-400 py-8">
                    <div class="text-4xl mb-2">üì≠</div>
                    <p>Haz clic en "Cargar Votos" para ver los votos disponibles</p>
                </div>
            </div>
        </section>

        <!-- Zona de Peligro -->
        <section class="danger-zone p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-4 text-red-100">‚ö†Ô∏è Zona de Peligro</h2>
            <p class="text-red-200 mb-4">Las siguientes acciones son permanentes y no se pueden deshacer.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="deleteSelectedVotes()" 
                        class="py-3 px-6 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 disabled:opacity-50"
                        id="delete-selected-btn" disabled>
                    üóëÔ∏è Eliminar Votos Seleccionados (<span id="selected-count">0</span>)
                </button>
                <button onclick="deleteAllTestVotes()" 
                        class="py-3 px-6 bg-red-800 text-white font-bold rounded-lg hover:bg-red-900">
                    üßπ Eliminar Todos los Votos de Prueba
                </button>
            </div>
        </section>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales
        let allVotes = [];
        let filteredVotes = [];
        let selectedVotes = new Set();
        const eventId = 'gmxINHvzSJ18Zt3SNeW7'; // ID del evento

        // Cargar todos los votos
        window.loadVotes = async function() {
            try {
                showMessage('Cargando votos...', 'info');
                allVotes = [];

                // Cargar votos p√∫blicos
                const publicVotesSnapshot = await getDocs(collection(db, 'votes'));
                publicVotesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.eventId === eventId) {
                        allVotes.push({
                            id: doc.id,
                            type: 'public',
                            data: data,
                            collection: 'votes'
                        });
                    }
                });

                // Cargar votos del jurado (jury_evaluations)
                const juryEvaluationsSnapshot = await getDocs(collection(db, 'jury_evaluations'));
                juryEvaluationsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.eventId === eventId) {
                        allVotes.push({
                            id: doc.id,
                            type: 'jury',
                            data: data,
                            collection: 'jury_evaluations'
                        });
                    }
                });

                // Cargar votos del jurado (jury_votes - sistema nuevo)
                try {
                    const juryVotesSnapshot = await getDocs(collection(db, 'jury_votes'));
                    juryVotesSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.eventId === eventId || data.galaId === eventId) {
                            allVotes.push({
                                id: doc.id,
                                type: 'jury',
                                data: data,
                                collection: 'jury_votes'
                            });
                        }
                    });
                } catch (error) {
                    console.log('Collection jury_votes no existe o est√° vac√≠a');
                }

                applyFilters();
                updateStats();
                showMessage(`${allVotes.length} votos cargados exitosamente`, 'success');

            } catch (error) {
                console.error('Error cargando votos:', error);
                showMessage('Error cargando los votos: ' + error.message, 'error');
            }
        };

        // Aplicar filtros
        function applyFilters() {
            const typeFilter = document.getElementById('vote-type-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();

            filteredVotes = allVotes.filter(vote => {
                // Filtro por tipo
                if (typeFilter !== 'all' && vote.type !== typeFilter) {
                    return false;
                }

                // Filtro por b√∫squeda
                if (searchFilter) {
                    const artistName = (vote.data.artistName || '').toLowerCase();
                    const jurorName = (vote.data.jurorName || vote.data.voterName || '').toLowerCase();
                    const userName = (vote.data.userName || '').toLowerCase();
                    
                    if (!artistName.includes(searchFilter) && 
                        !jurorName.includes(searchFilter) && 
                        !userName.includes(searchFilter)) {
                        return false;
                    }
                }

                return true;
            });

            renderVotes();
        }

        // Renderizar votos
        function renderVotes() {
            const container = document.getElementById('votes-container');
            
            if (filteredVotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-2">üîç</div>
                        <p>No se encontraron votos con los filtros aplicados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredVotes.map(vote => {
                const isSelected = selectedVotes.has(vote.id);
                const borderColor = vote.type === 'public' ? 'border-blue-500' : 'border-yellow-500';
                const bgColor = vote.type === 'public' ? 'bg-blue-900' : 'bg-yellow-900';
                const typeIcon = vote.type === 'public' ? 'üë•' : '‚öñÔ∏è';
                const typeName = vote.type === 'public' ? 'P√∫blico' : 'Jurado';

                // Identificar si es voto de prueba
                const isTestVote = isTestVoteData(vote.data);
                const testWarning = isTestVote ? `
                    <div class="bg-red-600 bg-opacity-50 px-2 py-1 rounded text-xs font-bold">
                        üß™ VOTO DE PRUEBA
                    </div>
                ` : '';

                return `
                    <div class="p-4 rounded-lg border-2 ${isSelected ? 'border-red-500 bg-red-900' : borderColor} ${bgColor} bg-opacity-20 cursor-pointer"
                         onclick="toggleVoteSelection('${vote.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${typeIcon}</span>
                                <div>
                                    <h3 class="font-bold">${vote.data.artistName || 'Sin nombre'}</h3>
                                    <p class="text-sm text-gray-400">${typeName} - ${vote.collection}</p>
                                </div>
                                ${testWarning}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">
                                    ${vote.type === 'public' ? 
                                        `${vote.data.totalScore || 0} pts` : 
                                        `${calculateJuryScore(vote.data)} pts`}
                                </div>
                                <div class="text-xs text-gray-400">
                                    ${formatDate(vote.data.timestamp || vote.data.createdAt)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-sm text-gray-300">
                            <p><strong>Evaluador:</strong> ${vote.data.jurorName || vote.data.voterName || vote.data.userName || 'An√≥nimo'}</p>
                            ${vote.data.feedback ? `<p><strong>Comentario:</strong> "${vote.data.feedback}"</p>` : ''}
                        </div>
                        
                        <div class="mt-2 text-xs text-gray-500">
                            ID: ${vote.id}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Identificar votos de prueba
        function isTestVoteData(data) {
            const testNames = ['fitto peola', 'test', 'prueba', 'demo', 'ejemplo'];
            const artistName = (data.artistName || '').toLowerCase();
            const jurorName = (data.jurorName || data.voterName || data.userName || '').toLowerCase();
            
            return testNames.some(testName => 
                artistName.includes(testName) || jurorName.includes(testName)
            );
        }

        // Calcular puntaje del jurado
        function calculateJuryScore(data) {
            if (data.totalScore) return data.totalScore;
            if (data.score) return data.score;
            if (data.scores) {
                return Object.values(data.scores).reduce((sum, val) => sum + (val || 0), 0);
            }
            return 0;
        }

        // Formatear fecha
        function formatDate(timestamp) {
            if (!timestamp) return 'Sin fecha';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES');
        }

        // Seleccionar/deseleccionar voto
        window.toggleVoteSelection = function(voteId) {
            if (selectedVotes.has(voteId)) {
                selectedVotes.delete(voteId);
            } else {
                selectedVotes.add(voteId);
            }
            
            updateSelectionUI();
            renderVotes();
        };

        // Seleccionar todos los visibles
        window.selectAllVisible = function() {
            filteredVotes.forEach(vote => selectedVotes.add(vote.id));
            updateSelectionUI();
            renderVotes();
        };

        // Limpiar selecci√≥n
        window.clearSelection = function() {
            selectedVotes.clear();
            updateSelectionUI();
            renderVotes();
        };

        // Actualizar UI de selecci√≥n
        function updateSelectionUI() {
            const count = selectedVotes.size;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('delete-selected-btn').disabled = count === 0;
        }

        // Eliminar votos seleccionados
        window.deleteSelectedVotes = async function() {
            if (selectedVotes.size === 0) return;

            const confirmed = confirm(`¬øEst√°s seguro de que quieres eliminar ${selectedVotes.size} votos seleccionados?\n\nEsta acci√≥n no se puede deshacer.`);
            if (!confirmed) return;

            try {
                showMessage('Eliminando votos seleccionados...', 'info');
                
                const deletePromises = Array.from(selectedVotes).map(async (voteId) => {
                    const vote = allVotes.find(v => v.id === voteId);
                    if (vote) {
                        await deleteDoc(doc(db, vote.collection, voteId));
                    }
                });

                await Promise.all(deletePromises);
                
                selectedVotes.clear();
                await loadVotes(); // Recargar votos
                showMessage(`${deletePromises.length} votos eliminados exitosamente`, 'success');

            } catch (error) {
                console.error('Error eliminando votos:', error);
                showMessage('Error eliminando votos: ' + error.message, 'error');
            }
        };

        // Eliminar todos los votos de prueba
        window.deleteAllTestVotes = async function() {
            const testVotes = allVotes.filter(vote => isTestVoteData(vote.data));
            
            if (testVotes.length === 0) {
                showMessage('No se encontraron votos de prueba para eliminar', 'info');
                return;
            }

            const confirmed = confirm(`Se encontraron ${testVotes.length} votos de prueba.\n\n¬øEliminar todos los votos de prueba?\n\nEsta acci√≥n no se puede deshacer.`);
            if (!confirmed) return;

            try {
                showMessage('Eliminando votos de prueba...', 'info');
                
                const deletePromises = testVotes.map(async (vote) => {
                    await deleteDoc(doc(db, vote.collection, vote.id));
                });

                await Promise.all(deletePromises);
                await loadVotes(); // Recargar votos
                showMessage(`${testVotes.length} votos de prueba eliminados exitosamente`, 'success');

            } catch (error) {
                console.error('Error eliminando votos de prueba:', error);
                showMessage('Error eliminando votos de prueba: ' + error.message, 'error');
            }
        };

        // Actualizar estad√≠sticas
        function updateStats() {
            const publicVotes = allVotes.filter(vote => vote.type === 'public');
            const juryVotes = allVotes.filter(vote => vote.type === 'jury');
            const uniqueArtists = new Set(allVotes.map(vote => vote.data.artistName)).size;
            const uniqueJurors = new Set(juryVotes.map(vote => vote.data.jurorName)).size;

            document.getElementById('total-public-votes').textContent = publicVotes.length;
            document.getElementById('total-jury-votes').textContent = juryVotes.length;
            document.getElementById('total-artists').textContent = uniqueArtists;
            document.getElementById('total-jurors').textContent = uniqueJurors;
        }

        // Mostrar mensajes
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            
            container.innerHTML = `
                <div class="${bgColor} text-white p-4 rounded-lg shadow-xl">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Event listeners
        document.getElementById('vote-type-filter').addEventListener('change', applyFilters);
        document.getElementById('search-filter').addEventListener('input', applyFilters);

        // Cargar votos autom√°ticamente al iniciar
        window.addEventListener('load', () => {
            setTimeout(loadVotes, 500);
        });
    </script>
</body>
</html>