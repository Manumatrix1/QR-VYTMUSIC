<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Entradas y Votaciones VYTMUSIC</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        .section { display: none; }
        .section.active { display: block; }
        .hidden { display: none !important; }
        
        .nav-card {
            background-color: #1f2937;
            transition: all 0.2s ease-in-out;
            border: 1px solid #374151;
        }
        .nav-card:hover {
            transform: translateY(-4px);
            background-color: #374151;
            border-color: #38bdf8;
        }
        .nav-card.active {
            background-color: #1e40af;
            color: #f9fafb;
            border-color: #38bdf8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        .nav-card svg { transition: transform 0.2s ease-in-out; }
        .nav-card:hover svg { transform: scale(1.1); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.3s ease;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #38bdf8;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); z-index: 900;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem;
            max-width: 90%; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .ticket-card-preview {
            background-color: #1f2937; color: #f9fafb; position: relative;
            overflow: hidden; display: flex; flex-direction: column;
            align-items: center; text-align: center; gap: 1rem;
            padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            max-width: 400px; margin: 0 auto;
        }
        .qrcode-wrapper {
            position: relative; width: 100%; max-width: 300px;
            padding-bottom: 100%; height: 0; background-color: white;
            border-radius: 0.25rem; overflow: hidden; margin: 0 auto;
        }
        .qrcode-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        .qrcode-container canvas { width: 100% !important; height: 100% !important; object-fit: contain; }
        .qrcode-logo {
            position: absolute; z-index: 10; width: 20%; height: auto;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; background-color: white; padding: 5px;
        }
        
        #fullscreen-scanner-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #qr-code-reader { width: 100vw; height: 100vh; }
        #qr-code-reader video { width: 100% !important; height: 100% !important; object-fit: cover; }
        .scanner-button {
            position: absolute; z-index: 60; background-color: rgba(0,0,0,0.5);
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border: 1px solid rgba(255,255,255,0.3);
        }
        #close-scanner-btn { top: 1.5rem; right: 1.5rem; }
        #scanner-status-message-fullscreen {
            position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7); padding: 0.5rem 1rem; border-radius: 0.5rem; z-index: 60;
        }
        #scanned-ticket-info-fullscreen {
            position: absolute; bottom: 6rem; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 60;
        }
        .scan-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1100; pointer-events: none; opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        .scan-flash.valid { background-color: rgba(74, 222, 128, 0.5); }
        .scan-flash.invalid { background-color: rgba(248, 113, 113, 0.5); }
        .scan-flash.used { background-color: rgba(250, 204, 21, 0.5); }

        .artist-preview-card {
            display: flex; align-items: center; background-color: #1f2937;
            padding: 0.75rem; border-radius: 0.5rem; gap: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .artist-image-container-small {
            width: 60px; height: 60px; border-radius: 50%; overflow: hidden;
            border: 2px solid #38bdf8; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
        }
        .artist-image { width: 100%; height: 100%; object-fit: cover; }
        
        .tab-content.hidden { display: none; }
    </style>
</head>
<body>

    <!-- Overlays y Modales -->
    <div id="loading-overlay" class="loading-overlay hidden"><div class="spinner"></div></div>
    <div id="scan-flash-overlay" class="scan-flash"></div>
    <div id="share-link-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="share-modal-title" class="text-xl font-bold mb-4">Compartir Enlace</h3>
            <p id="share-modal-text" class="mb-4">Copia el siguiente enlace:</p>
            <div class="flex items-center space-x-2 mb-4">
                <input type="text" id="share-link-display" class="flex-grow p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500" readonly>
                <button id="copy-share-link-btn" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Copiar</button>
            </div>
            <div class="flex justify-end">
                <button id="close-share-modal-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="reset-confirmation-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Reiniciar Estadísticas</h3>
            <p class="mb-4">Esto borrará TODAS las entradas, historial, artistas y votos. Esta acción no se puede deshacer.</p>
            <p class="mb-4 font-bold text-red-400">Para confirmar, escribe "REINICIO" en el campo de abajo:</p>
            <input type="text" id="reset-confirm-input" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-red-500 mb-4" placeholder="Escribe REINICIO">
            <div class="flex justify-end space-x-4">
                <button type="button" id="reset-modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cancelar</button>
                <button type="button" id="reset-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700" disabled>Confirmar Reinicio</button>
            </div>
        </div>
    </div>
    <div id="confirmation-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirmar Acción</h3>
            <p id="modal-body" class="mb-6">¿Estás seguro de que deseas continuar?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cancelar</button>
                <button type="button" id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="assistant-login-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Ingreso de Asistente</h3>
            <p class="mb-4 text-gray-300">Ingresa el código del evento proporcionado por el administrador.</p>
            <form id="assistant-login-form">
                <input type="text" id="event-code-input" placeholder="Código de Evento" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500 mb-4">
                <div class="flex justify-end space-x-4">
                    <button type="button" id="assistant-modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Verificar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <!-- NOTA: Se recomienda subir esta imagen a Firebase Storage o a tu propio servidor para evitar problemas de CORS con html2canvas -->
            <img src="https://i.imgur.com/rqkZi9P.png" alt="VYTMUSIC Logo" class="mx-auto mb-4 bg-white rounded-full" style="max-width: 150px;" onerror="this.onerror=null;this.src='https://placehold.co/150x150/ffffff/000000?text=Logo';">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">VYTMUSIC</h1>
            <p class="text-lg text-gray-300">Panel de Control</p>
            <div id="user-info" class="text-xs text-gray-500 mt-2">
                <span id="user-email-display"></span>
                <button id="logout-btn" class="hidden ml-4 text-sky-400 hover:underline">[Cerrar Sesión]</button>
            </div>
        </header>

        <div id="message-container" class="mb-4"></div>

        <div id="app-content" class="hidden">
            <div class="bg-gray-800 p-4 rounded-lg shadow-md mb-6 flex flex-col sm:flex-row justify-around items-center text-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div>
                    <p class="text-sm text-gray-400">Entradas Generadas</p>
                    <p id="total-generated-tickets" class="text-2xl font-bold text-sky-400">0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Entradas Usadas</p>
                    <p id="total-used-tickets" class="text-2xl font-bold text-green-400">0</p>
                </div>
            </div>

            <!-- Grilla de Navegación -->
            <div id="navigation-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <button data-section="batch-ticket-generator-section" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span>Generar</span>
                </button>
                <button id="open-scanner-btn" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span>Escanear</span>
                </button>
                <button data-section="all-tickets-section" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    <span>Lista</span>
                </button>
                <button data-section="scan-history-section" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Historial</span>
                </button>
                <button data-section="dashboard-section" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Dashboard</span>
                </button>
                <button data-section="voting-section" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0zM12 6a6 6 0 00-4 10.66V18a2 2 0 002 2h4a2 2 0 002-2v-1.34A6 6 0 0012 6z"></path></svg>
                    <span>Votaciones</span>
                </button>
                <button data-section="assistant-management-section" class="nav-card p-4 rounded-lg flex flex-col items-center justify-center text-center font-semibold">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197"></path></svg>
                    <span>Asistentes</span>
                </button>
            </div>
            
            <!-- VISTA PREVIA DE VOTACIONES EN VIVO -->
            <div id="live-voting-preview-container" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                <h3 class="text-2xl font-bold mb-4 text-center text-sky-400">Votaciones en Vivo (Top 3)</h3>
                <div id="live-voting-preview-list" class="space-y-3 mb-6">
                    <p class="text-center text-gray-400">Cargando ranking...</p>
                </div>
                <button id="go-to-voting-panel-btn" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition-colors">
                    Ir al Panel de Votaciones Completo
                </button>
            </div>

            <main>
                <section id="batch-ticket-generator-section" class="section">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4">Generar Entradas en Lote</h2>
                        <form id="generator-form" class="space-y-4">
                            <div>
                                <label for="show-name-input" class="block mb-1 font-semibold text-gray-300">Nombre del Show</label>
                                <input type="text" id="show-name-input" placeholder="Concierto de Verano" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="show-location-input" class="block mb-1 font-semibold text-gray-300">Lugar del Show</label>
                                <input type="text" id="show-location-input" placeholder="Teatro Central" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="show-address-input" class="block mb-1 font-semibold text-gray-300">Dirección (URL de Google Maps opcional)</label>
                                <input type="text" id="show-address-input" placeholder="Calle Falsa 123, Ciudad" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="ticket-prefix-input" class="block mb-1 font-semibold text-gray-300">Prefijo de Artista/Grupo (ID Único)</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="ticket-prefix-input" placeholder="Ej: JuanPerezShow" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                                    <button type="button" id="search-prefix-btn" class="p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700" title="Buscar Entradas Anteriores">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    </button>
                                </div>
                            </div>
                             <div>
                                 <label for="ticket-seat-location-input" class="block mb-1 font-semibold text-gray-300">Ubicación (ej: Mesa 5, Sector VIP)</label>
                                 <input type="text" id="ticket-seat-location-input" placeholder="Mesa 5" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                             </div>
                            <div>
                                <label for="batch-ticket-names-input" class="block mb-1 font-semibold text-gray-300">Nombres (uno por línea o separados por coma)</label>
                                <textarea id="batch-ticket-names-input" rows="5" placeholder="Juan Perez, Maria Gonzalez, ..." required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" id="generator-form-submit-btn" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 disabled:opacity-50">Generar</button>
                                <button type="button" id="generator-form-clear-btn" class="w-full px-4 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700">Limpiar</button>
                            </div>
                        </form>
                        <div id="generated-tickets-container" class="mt-6"></div>
                        <div id="qr-carousel-controls" class="hidden mt-4 flex items-center justify-center gap-4">
                            <button id="prev-qr-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-700">&lt; Anterior</button>
                            <span id="qr-counter" class="font-semibold"></span>
                            <button id="next-qr-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-700">Siguiente &gt;</button>
                        </div>
                        <button id="share-batch-qrs-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 mt-4 hidden">Compartir Entradas del Grupo</button>
                    </div>
                </section>
                
                <section id="all-tickets-section" class="section">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4">Lista de Todas las Entradas</h2>
                        <input type="text" id="all-tickets-search-input" placeholder="Buscar por nombre, ID, prefijo..." class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500 mb-4">
                        <ul id="all-tickets-list" class="space-y-3"></ul>
                    </div>
                </section>

                <section id="scan-history-section" class="section">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4">Historial de Escaneos</h2>
                        <div class="flex justify-end mb-4">
                            <button id="export-csv-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Exportar a CSV</button>
                        </div>
                        <ul id="scan-history-list" class="space-y-3"></ul>
                        <!-- ZONA DE REINICIO TOTAL -->
                        <div class="mt-8 pt-6 border-t border-gray-700 max-w-md mx-auto">
                            <button id="reset-all-data-btn" type="button" class="w-full px-4 py-2 bg-red-800 text-white font-semibold text-sm rounded-lg hover:bg-red-900">
                                Reiniciar TODO (Acción Peligrosa)
                            </button>
                        </div>
                    </div>
                </section>

                <section id="dashboard-section" class="section">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">Dashboard en Vivo</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-700 p-4 rounded-lg text-center">
                                <h3 class="text-lg font-semibold text-sky-400">Ocupación Total</h3>
                                <p id="occupancy-rate" class="text-4xl font-bold mt-2">0%</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg text-center">
                                <h3 class="text-lg font-semibold text-sky-400">Ingresos por Hora</h3>
                                <div id="scans-per-hour" class="mt-2 text-left"><p class="text-gray-400">No hay datos aún.</p></div>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg text-center md:col-span-2">
                                <h3 class="text-lg font-semibold text-sky-400">Ingresos por Grupo/Artista</h3>
                                <div id="scans-by-prefix" class="mt-2 text-left"><p class="text-gray-400">No hay datos aún.</p></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="voting-section" class="section">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-3xl font-bold mb-6 text-center">Panel de Votaciones</h2>
                
                        <!-- Navegación de Pestañas -->
                        <div class="flex border-b border-gray-700 mb-6">
                            <button id="config-tab-btn" class="tab-btn px-6 py-3 text-lg font-semibold text-sky-400 border-b-2 border-sky-400">
                                Configurar Votación
                            </button>
                            <button id="results-tab-btn" class="tab-btn px-6 py-3 text-lg font-semibold text-gray-400">
                                Resultados Completos
                            </button>
                        </div>
                
                        <!-- Contenido de la Pestaña de Configuración -->
                        <div id="config-tab-content" class="tab-content">
                            <div class="bg-gray-900 p-6 rounded-lg max-w-2xl mx-auto">
                                <h3 class="text-xl font-semibold mb-4">Agregar Nuevos Artistas</h3>
                                <form id="artist-form" class="space-y-4">
                                    <div>
                                        <label for="artist-photos-input" class="block mb-1 font-semibold text-gray-300">Fotos de los Artistas</label>
                                        <input type="file" id="artist-photos-input" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-600 file:text-white hover:file:bg-sky-700" multiple />
                                        <p class="text-xs text-gray-400 mt-1">Puedes seleccionar varias imágenes.</p>
                                    </div>
                                    <div id="artist-previews-container" class="grid grid-cols-1 gap-4 mt-4"></div>
                                    <button type="submit" id="add-artists-btn" class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>Agregar Artistas</button>
                                </form>
                                <button id="share-voting-link-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 mt-6">Compartir Enlace de Votación</button>
                            </div>
                        </div>
                
                        <!-- Contenido de la Pestaña de Resultados -->
                        <div id="results-tab-content" class="tab-content hidden">
                            <h3 class="text-2xl font-semibold mb-4 text-center text-sky-400">Ranking Completo</h3>
                            <div id="votes-stats" class="space-y-4 max-w-2xl mx-auto">
                                <p class="text-center text-gray-400">Cargando resultados...</p>
                            </div>
                        </div>
                        
                        <!-- ZONA DE REINICIO -->
                        <div class="mt-8 pt-6 border-t border-gray-700 max-w-md mx-auto">
                            <button id="reset-voting-btn" type="button" class="w-full px-4 py-3 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700">
                                Reiniciar Votación (Borrar Artistas y Votos)
                            </button>
                        </div>
                    </div>
                </section>
                
                <section id="assistant-management-section" class="section">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold mb-4">Gestionar Asistentes</h2>
                        <p class="text-gray-400 mb-6">Genera códigos para que tus asistentes puedan acceder a las funciones de escaneo y lista de entradas.</p>
                        <button id="generate-code-btn" class="w-full max-w-xs mx-auto block px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 mb-6">Generar Nuevo Código de Evento</button>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-center">Códigos Activos</h3>
                            <ul id="event-codes-list" class="space-y-3">
                                <!-- Los códigos se listarán aquí -->
                            </ul>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <div id="auth-screen" class="hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-center">Iniciar Sesión o Registrarse</h2>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="email-input" class="block mb-1 font-semibold text-gray-300">Email</label>
                        <input type="email" id="email-input" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="password-input" class="block mb-1 font-semibold text-gray-300">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="password-input" required class="w-full p-3 pr-10 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-sky-400">
                                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274 4.057 5.064 7 9.542 7 .847 0 1.67.134 2.46.382m-.022 2.992A3.004 3.004 0 0012 9a3 3 0 103 3m-3-3a3 3 0 00-3 3m2.25 4.5a10.013 10.013 0 01-1.25 1.325M16.5 10.5a3 3 0 00-3-3m-3 3a3 3 0 003 3m-3-3h3m-3 3v-3" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1l22 22" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" id="login-btn" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">Iniciar Sesión</button>
                        <button type="button" id="register-btn" class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Registrarse</button>
                    </div>
                     <div class="mt-4 text-center">
                         <button type="button" id="assistant-login-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Ingresar como Asistente</button>
                     </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="fullscreen-scanner-container" class="hidden">
        <div id="qr-code-reader"></div>
        <button id="close-scanner-btn" class="scanner-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        <p id="scanner-status-message-fullscreen" class="text-center text-gray-200">Iniciando escáner...</p>
        <div id="scanned-ticket-info-fullscreen" class="hidden bg-gray-800 bg-opacity-90 p-4 rounded-lg shadow-xl">
            <h3 class="text-xl font-bold mb-2">Entrada Escaneada</h3>
            <p><strong>ID:</strong> <span id="current-scanned-ticket-id-fullscreen" class="break-all text-sky-300"></span></p>
            <p><strong>Nombre:</strong> <span id="current-scanned-ticket-name-fullscreen" class="text-sky-300"></span></p>
            <p><strong>Ubicación:</strong> <span id="current-scanned-ticket-seat-location-fullscreen" class="text-sky-300"></span></p>
            <p class="mt-4 text-lg font-semibold">Estado: <span id="current-scanned-ticket-status-fullscreen" class="text-2xl font-bold p-2 rounded-md"></span></p>
            <div class="mt-4 text-center">
                <button id="mark-used-btn-fullscreen" class="hidden w-full px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Marcar como Usado</button>
                <button id="scan-again-btn-fullscreen" class="hidden w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 mt-2">Volver a Escanear</button>
            </div>
        </div>
    </div>

    <!-- Libraries - Moved to body end with defer for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, doc, getDoc, setDoc, where, getDocs, writeBatch, deleteDoc, updateDoc,  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURACIÓN DE FIREBASE (INCRUSTADA) ---
        // Estas son tus credenciales REALES obtenidas de tus capturas de pantalla.
        // Se incrustan directamente aquí para evitar problemas de carga de módulos en Netlify.
        const firebaseConfig = {
            apiKey: "AIzaSyC_2Ukoxf_ry7QfKtou1Cz6nY-qTVw4qTU", 
            authDomain: "vyt-music.firebaseapp.com",
            projectId: "vyt-music", 
            storageBucket: "vyt-music.firebasestorage.app", 
            messagingSenderId: "574981837817", 
            appId: "1:574981837817:web:a29933a22bbfd51a086328"
            // measurementId: "G-XXXXXXXXXX" // Eliminado para evitar problemas de CSP en Canvas
        };

        // --- ESTADO Y UI GLOBALES ---
        const state = {
            db: null, auth: null, storage: null, userId: null,
            userRole: null, // 'admin' or 'assistant'
            isSubmitting: false, scanner: null, isScannerActive: false,
            currentScannedTicketId: null, currentBatchGeneratedTickets: [], currentQrIndex: 0,
            allTicketsData: [], scanHistory: [], synth: null, pendingArtists: [],
            allArtistsData: [], // Store all artists for voting panel
            appId: firebaseConfig.projectId, // Se inicializa directamente con el projectId
            unsubscribeListeners: [] // Para limpiar listeners al cerrar sesión
        };
        const ui = {};

        // --- FUNCIONES DE LA INTERFAZ DE USUARIO (UI) ---
        function cacheUIElements() {
            const ids = [
                'loading-overlay', 'share-link-modal', 'share-link-display', 'copy-share-link-btn', 'close-share-modal-btn',
                'share-modal-title', 'share-modal-text', 'main-content', 'message-container', 'app-content', 
                'total-generated-tickets', 'total-used-tickets', 'batch-ticket-generator-section', 'all-tickets-section', 
                'scan-history-section', 'dashboard-section', 'voting-section', 'assistant-management-section', 'generator-form', 'show-name-input', 
                'show-location-input', 'show-address-input', 'ticket-prefix-input', 'ticket-seat-location-input', 
                'batch-ticket-names-input', 'generator-form-submit-btn', 'generator-form-clear-btn', 'generated-tickets-container', 
                'qr-carousel-controls', 'prev-qr-btn', 'next-qr-btn', 'qr-counter', 'share-batch-qrs-btn', 
                'all-tickets-search-input', 'all-tickets-list', 'open-scanner-btn', 'scan-history-list', 'export-csv-btn', 
                'reset-confirmation-modal', 'reset-confirm-input', 'reset-modal-cancel-btn', 
                'reset-modal-confirm-btn', 'confirmation-modal', 'modal-title', 'modal-body', 'modal-cancel-btn', 
                'modal-confirm-btn', 'scan-flash-overlay', 'fullscreen-scanner-container', 'qr-code-reader', 'close-scanner-btn', 
                'scanner-status-message-fullscreen', 'scanned-ticket-info-fullscreen', 'current-scanned-ticket-id-fullscreen', 
                'current-scanned-ticket-name-fullscreen', 'current-scanned-ticket-seat-location-fullscreen', 
                'current-scanned-ticket-status-fullscreen', 'mark-used-btn-fullscreen', 'scan-again-btn-fullscreen',
                'auth-screen', 'auth-form', 'email-input', 'password-input', 'login-btn', 'register-btn', 'user-info', 
                'user-email-display', 'logout-btn', 'toggle-password-btn', 'eye-icon', 'eye-slash-icon', 'search-prefix-btn',
                'artist-form', 'artist-photos-input', 'artist-previews-container', 'add-artists-btn', 'votes-stats',
                'share-voting-link-btn', 'occupancy-rate', 'scans-per-hour', 'scans-by-prefix',
                'assistant-login-modal', 'assistant-login-form', 'event-code-input', 'assistant-modal-cancel-btn', 'assistant-login-btn',
                'generate-code-btn', 'event-codes-list',
                'live-voting-preview-container', 'live-voting-preview-list', 'go-to-voting-panel-btn',
                'config-tab-btn', 'results-tab-btn', 'config-tab-content', 'results-tab-content',
                'reset-voting-btn', 'reset-all-data-btn'
            ];
            ids.forEach(id => {
                const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                ui[camelCaseId] = document.getElementById(id);
            });
            ui.navCards = document.querySelectorAll('.nav-card');
            ui.tabButtons = document.querySelectorAll('.tab-btn');
        }

        function displayMessage(message, type = 'success', duration = 5000) {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500 text-black', info: 'bg-sky-500' };
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-md mb-4 text-white ${colors[type]} transition-opacity duration-300`;
            messageDiv.textContent = message;
            ui.messageContainer.prepend(messageDiv);
            setTimeout(() => { 
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, duration);
        }

        function setLoading(show) { ui.loadingOverlay.classList.toggle('hidden', !show); }

        function showShareLinkModal(link, type = 'tickets') {
            ui.shareModalTitle.textContent = type === 'tickets' ? 'Compartir Enlace' : 'Compartir Enlace de Votación'; // CAMBIO: Título más genérico para compartir
            ui.shareModalText.textContent = type === 'tickets' ? 'Copia el siguiente enlace para tus invitados:' : 'Copia el enlace para que el público pueda votar:'; // CAMBIO: Texto más específico
            ui.shareLinkDisplay.value = link;
            ui.shareLinkModal.classList.remove('hidden');
            
            // Seleccionar el texto automáticamente al abrir el modal
            ui.shareLinkDisplay.select();

            const copyHandler = () => {
                navigator.clipboard.writeText(link).then(() => {
                    displayMessage('¡Enlace copiado!', 'success');
                }).catch(() => {
                    // Fallback para copiar si navigator.clipboard no funciona
                    try {
                        const tempInput = document.createElement('input');
                        tempInput.value = link;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        displayMessage('Error: No se pudo copiar automáticamente. Copia el texto manualmente.', 'error'); // Mensaje más claro
                    } catch (err) {
                        displayMessage('Error al copiar. Por favor, hazlo manualmente.', 'error');
                    }
                });
            };
            const closeHandler = () => {
                ui.copyShareLinkBtn.removeEventListener('click', copyHandler);
                ui.closeShareModalBtn.removeEventListener('click', closeHandler);
                ui.shareLinkModal.classList.add('hidden');
            };
            ui.copyShareLinkBtn.addEventListener('click', copyHandler, { once: true });
            ui.closeShareModalBtn.addEventListener('click', closeHandler, { once: true });
        }

        function showConfirmation(title, body, onConfirm) {
            ui.modalTitle.textContent = title;
            ui.modalBody.textContent = body;
            ui.confirmationModal.classList.remove('hidden');
            const confirmHandler = () => { hideConfirmation(); onConfirm(); };
            const cancelHandler = () => hideConfirmation();
            const hideConfirmation = () => {
                ui.modalConfirmBtn.removeEventListener('click', confirmHandler);
                ui.modalCancelBtn.removeEventListener('click', cancelHandler);
                ui.confirmationModal.classList.add('hidden');
            };
            ui.modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            ui.modalCancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        function showResetConfirmation(onConfirm) {
            ui.resetConfirmationModal.classList.remove('hidden');
            ui.resetConfirmInput.value = '';
            ui.resetModalConfirmBtn.disabled = true;
            const inputHandler = () => { ui.resetModalConfirmBtn.disabled = ui.resetConfirmInput.value !== 'REINICIO'; };
            const confirmHandler = () => { if (ui.resetConfirmInput.value === 'REINICIO') { hideResetConfirmation(); onConfirm(); } };
            const cancelHandler = () => hideResetConfirmation();
            const hideResetConfirmation = () => {
                ui.resetConfirmInput.removeEventListener('input', inputHandler);
                ui.resetModalConfirmBtn.removeEventListener('click', confirmHandler);
                ui.resetModalCancelBtn.removeEventListener('click', cancelHandler);
                ui.resetConfirmationModal.classList.add('hidden');
            };
            ui.resetConfirmInput.addEventListener('input', inputHandler);
            ui.resetModalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            ui.resetModalCancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        function showSection(sectionToShow) {
            document.querySelectorAll('#app-content .section').forEach(section => section.classList.remove('active'));
            if (sectionToShow) sectionToShow.classList.add('active');
            ui.navCards.forEach(card => {
                card.classList.toggle('active', card.dataset.section === (sectionToShow ? sectionToShow.id : ''));
            });
        }
        
        function updateUIAfterLogin(user, role = 'admin') {
            state.userId = user.uid;
            state.userRole = role;

            if (ui.authScreen) ui.authScreen.classList.add('hidden');
            if (ui.appContent) ui.appContent.classList.remove('hidden');
            if (ui.userEmailDisplay) ui.userEmailDisplay.textContent = user.email || `Asistente (${state.userId.substring(0,6)})`;
            if (ui.logoutBtn) ui.logoutBtn.classList.remove('hidden');
            if (ui.userInfo) ui.userInfo.classList.remove('hidden');

            // Ajustar UI según el rol
            const adminOnlySections = ['batch-ticket-generator-section', 'dashboard-section', 'voting-section', 'assistant-management-section', 'scan-history-section'];
            
            if (ui.navCards) {
                ui.navCards.forEach(card => {
                    const sectionName = card.dataset.section;
                    if (sectionName && adminOnlySections.includes(sectionName)) {
                        card.style.display = role === 'admin' ? 'flex' : 'none';
                    } else {
                        card.style.display = 'flex'; // Always show for assistants (Scan, List)
                    }
                });
            }

            if (ui.liveVotingPreviewContainer) {
                ui.liveVotingPreviewContainer.style.display = role === 'admin' ? 'block' : 'none';
            }

            // Show default section based on role
            if (role === 'admin') {
                if (ui.batchTicketGeneratorSection) showSection(ui.batchTicketGeneratorSection);
            } else { // Assistant
                if (ui.allTicketsSection) showSection(ui.allTicketsSection);
            }

            attachDataListeners();
        }

        function updateUIAfterLogout() {
            // Detener todos los listeners de Firebase
            state.unsubscribeListeners.forEach(unsub => unsub());
            state.unsubscribeListeners = [];

            state.userId = null;
            state.userRole = null;
            if(ui.authScreen) ui.authScreen.classList.remove('hidden');
            if(ui.appContent) ui.appContent.classList.add('hidden');
            if(ui.userInfo) ui.userInfo.classList.add('hidden');
            if(ui.logoutBtn) ui.logoutBtn.classList.add('hidden');
            if(ui.userEmailDisplay) ui.userEmailDisplay.textContent = '';
            
            // Limpiar datos en la UI
            if(ui.allTicketsList) ui.allTicketsList.innerHTML = '';
            if(ui.scanHistoryList) ui.scanHistoryList.innerHTML = '';
            if(ui.liveVotingPreviewList) ui.liveVotingPreviewList.innerHTML = '<p class="text-center text-gray-400">Cargando ranking...</p>';
            if(ui.votesStats) ui.votesStats.innerHTML = '<p class="text-center text-gray-400">Cargando resultados...</p>';

            state.allTicketsData = [];
            state.scanHistory = [];
            state.allArtistsData = [];

            // Reset navigation card visibility
            if (ui.navCards) {
                ui.navCards.forEach(card => {
                    card.style.display = 'flex'; // Make all visible initially for login screen
                });
            }
        }


        // --- LÓGICA DE FIREBASE ---

        const FirebaseOps = {
            // Rutas estandarizadas para evitar errores
            paths: {
                tickets: () => collection(state.db, `artifacts/${state.appId}/public/data/tickets`),
                ticket: (id) => doc(state.db, `artifacts/${state.appId}/public/data/tickets`, id),
                scanHistory: () => collection(state.db, `artifacts/${state.appId}/users/${state.userId}/scanHistory`),
                artists: () => collection(state.db, `artifacts/${state.appId}/public/data/artists`),
                artist: (id) => doc(state.db, `artifacts/${state.appId}/public/data/artists`, id),
                votes: () => collection(state.db, `artifacts/${state.appId}/public/data/votes`), // Individual votes, if needed
                eventCodes: () => collection(state.db, `artifacts/${state.appId}/public/data/event_codes`),
                eventCode: (id) => doc(state.db, `artifacts/${state.appId}/public/data/event_codes`, id),
                artistPhoto: (fileName) => ref(state.storage, `artifacts/${state.appId}/public/artist_photos/${fileName}`)
            },

            async updateTicket(ticketId, data) {
                await updateDoc(FirebaseOps.paths.ticket(ticketId), data);
            },
            async saveScanEvent(ticketData, scanStatus) {
                if (!state.userId) return;
                await addDoc(FirebaseOps.paths.scanHistory(), {
                    ...ticketData, status: scanStatus, scannedAt: new Date().toISOString()
                });
            },
            async addArtist(artistData) {
                // Initialize new artist with voting scores
                const newArtistData = {
                    ...artistData,
                    totalSingingScore: 0,
                    totalTransmissionScore: 0,
                    totalAttitudeScore: 0,
                    totalOriginalityScore: 0,
                    totalRatingsCount: 0
                };
                return await addDoc(FirebaseOps.paths.artists(), newArtistData);
            },
            async deleteArtist(artistId) {
                await deleteDoc(FirebaseOps.paths.artist(artistId));
            },
            async getEventCode(code) {
                const q = query(FirebaseOps.paths.eventCodes(), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                return querySnapshot.empty ? null : { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
            },
            async addEventCode(code) {
                await addDoc(FirebaseOps.paths.eventCodes(), {
                    code: code,
                    generatedBy: state.userId,
                    createdAt: new Date().toISOString(),
                    active: true
                });
            },
            async deactivateEventCode(codeId) {
                await updateDoc(FirebaseOps.paths.eventCode(codeId), { active: false });
            }
        };
        
        // --- PROCESO DE SUBIDA DE FOTOS (CORREGIDO) ---
        async function handleArtistFormSubmit(e) {
            e.preventDefault();
            if (state.isSubmitting || state.pendingArtists.length === 0) return;

            setLoading(true);
            state.isSubmitting = true;
            ui.addArtistsBtn.disabled = true;

            try {
                const uploadPromises = state.pendingArtists.map(async (artist) => {
                    const { file, name } = artist;
                    // Crear una referencia única para el archivo
                    const fileName = `${Date.now()}-${name.replace(/\s+/g, '-')}-${file.name}`;
                    const photoRef = FirebaseOps.paths.artistPhoto(fileName);
                    
                    // 1. Subir el archivo a Firebase Storage
                    await uploadBytes(photoRef, file);
                    
                    // 2. Obtener la URL de descarga pública
                    const photoURL = await getDownloadURL(photoRef);
                    
                    // 3. Devolver los datos del artista con la URL, inicializando los campos de votación
                    return { 
                        name, 
                        photoURL, 
                        totalSingingScore: 0,
                        totalTransmissionScore: 0,
                        totalAttitudeScore: 0,
                        totalOriginalityScore: 0,
                        totalRatingsCount: 0
                    };
                });

                // Esperar a que todas las subidas y obtención de URLs terminen
                const artistsToSave = await Promise.all(uploadPromises);

                // 4. Guardar todos los artistas en Firestore en un solo lote
                const batch = writeBatch(state.db);
                const artistsCollection = FirebaseOps.paths.artists();
                artistsToSave.forEach(artistData => {
                    const newArtistRef = doc(artistsCollection);
                    batch.set(newArtistRef, artistData);
                });
                await batch.commit();

                displayMessage(`${artistsToSave.length} artista(s) agregado(s) con éxito.`, 'success');
                // Limpiar el formulario y las vistas previas
                ui.artistForm.reset();
                ui.artistPreviewsContainer.innerHTML = '';
                state.pendingArtists = [];

            } catch (error) {
                console.error("Error al agregar artistas:", error);
                displayMessage(`Error al agregar artistas: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                state.isSubmitting = false;
                // El botón se habilitará/deshabilitará por el listener de 'change' en el input de archivos
            }
        }

        // --- RENDERIZADO Y VISUALIZACIÓN ---
        function generateVisualCodesForTicket(ticket, container) {
            const cardWrapper = document.createElement('div');
            cardWrapper.id = `card-${ticket.id}`;
            cardWrapper.className = 'ticket-card-preview';
            
            const codesContainer = `
                <div class="w-full max-w-[300px] mx-auto">
                    <div class="qrcode-wrapper">
                        <div id="qrcode-${ticket.id}" class="qrcode-container"></div>
                        <!-- NOTA: Se recomienda subir esta imagen a Firebase Storage o a tu propio servidor para evitar problemas de CORS con html2canvas -->
                        <img src="https://i.imgur.com/rqkZi9P.png" alt="Logo" class="qrcode-logo">
                    </div>
                    <div class="mt-1 p-2 bg-white rounded-md">
                        <svg id="barcode-${ticket.id}" class="w-full"></svg>
                    </div>
                </div>`;

            const addressHtml = ticket.showAddress ? `<p class="text-sm text-gray-400">${ticket.showAddress.startsWith('http') ? `<a href="${ticket.showAddress}" target="_blank" class="text-sky-400 hover:underline">Ver en Mapa</a>` : ticket.showAddress}</p>` : '';
            cardWrapper.innerHTML = `
                <div class="w-full"><h3 class="text-2xl font-bold text-sky-400">${ticket.name}</h3><p class="text-gray-300">${ticket.seatLocation || 'Ubicación General'}</p></div>
                ${codesContainer}
                <div class="w-full mt-4"><p class="text-lg font-semibold">${ticket.showName}</p><p class="text-md text-gray-400">${ticket.showLocation}</p>${addressHtml}<p class="text-xs text-gray-500 mt-2">ID: ${ticket.id}</p></div>
                <div class="mt-4 border-t border-gray-700 pt-4 w-full"><p class="text-xl font-bold text-sky-400">VYT-MUSIC</p><p class="text-sm text-gray-300">certamen de canto</p><a href="https://wa.me/5493417422062" target="_blank" class="text-green-400 mt-2 inline-block hover:underline">¡Inscribite aquí!</a></div>
                <button class="download-qr-btn w-full mt-4 px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700" role="button">Descargar Entrada (PNG)</button>`;
            
            container.appendChild(cardWrapper);
            
            new QRCode(document.getElementById(`qrcode-${ticket.id}`), { text: ticket.id, width: 256, height: 256, correctLevel: QRCode.CorrectLevel.H });
            try { 
                const barcodeElement = document.getElementById(`barcode-${ticket.id}`);
                if (barcodeElement) {
                    JsBarcode(barcodeElement, ticket.id, { format: "CODE128", lineColor: "#000", width: 2, height: 30, displayValue: true, fontSize: 14, textMargin: 2, background: "transparent", margin: 10 }); 
                }
            } catch (e) { console.error("Error al generar el código de barras:", e); }

            cardWrapper.querySelector('.download-qr-btn').addEventListener('click', () => {
                displayMessage('Generando imagen de la entrada...', 'info');
                setTimeout(() => {
                    html2canvas(document.getElementById(`card-${ticket.id}`), { 
                        backgroundColor: '#1f2937', 
                        useCORS: true,
                        allowTaint: false
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `Entrada_VYTMUSIC_${ticket.name.replace(/\s/g, '_')}.png`;
                        link.click();
                        displayMessage('Descarga iniciada. Revisa tu carpeta de descargas.', 'success');
                    }).catch(error => {
                        console.error('Error al generar la imagen:', error);
                        displayMessage('Error al generar la imagen de la entrada. Asegúrate de que el logo sea accesible.', 'error');
                    });
                }, 500);
            });
        }

        function displayCurrentQr() {
            ui.generatedTicketsContainer.innerHTML = '';
            const ticket = state.currentBatchGeneratedTickets[state.currentQrIndex];
            if (ticket) {
                generateVisualCodesForTicket(ticket, ui.generatedTicketsContainer);
                ui.qrCounter.textContent = `Entrada ${state.currentQrIndex + 1} de ${state.currentBatchGeneratedTickets.length}`;
            }
        }
        
        function renderAllTickets(tickets) {
            state.allTicketsData = tickets;
            if (!ui.allTicketsList) return;
            ui.allTicketsList.innerHTML = '';
            if (!tickets || tickets.length === 0) {
                ui.allTicketsList.innerHTML = '<li class="text-center text-gray-400">No hay entradas.</li>';
                return;
            }
            tickets.sort((a, b) => a.name.localeCompare(b.name)).forEach(ticket => {
                const li = document.createElement('li');
                li.className = 'bg-gray-900 p-4 rounded-md flex justify-between items-center gap-4';
                const statusClass = ticket.used ? 'bg-yellow-600' : 'bg-green-600';
                const buttonClass = ticket.used ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                const buttonText = ticket.used ? 'Anular Ingreso' : 'Confirmar Ingreso';

                // Añadido el estado de votado
                const votedStatus = typeof ticket.voted === 'boolean' ? (ticket.voted ? 'VOTADO' : 'NO VOTADO') : 'N/A';
                const votedClass = typeof ticket.voted === 'boolean' ? (ticket.voted ? 'bg-purple-600' : 'bg-gray-500') : 'bg-gray-500';

                li.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold">${ticket.name} <span class="text-gray-400 text-sm">(${ticket.prefix})</span></p>
                        <p class="text-sm text-gray-400">ID: ${ticket.id}</p>
                        <p class="text-sm text-gray-400">Ubicación: ${ticket.seatLocation || 'N/A'}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                            <span class="block px-3 py-1 rounded-full text-xs font-semibold ${statusClass} mb-2">${ticket.used ? 'USADO' : 'DISPONIBLE'}</span>
                            <span class="block px-3 py-1 rounded-full text-xs font-semibold ${votedClass} mb-2">${votedStatus}</span>
                            <button data-ticket-id="${ticket.id}" data-ticket-used="${ticket.used}" class="manual-checkin-btn px-3 py-1 text-xs text-white font-bold rounded-lg ${buttonClass}">${buttonText}</button>
                    </div>`;
                ui.allTicketsList.appendChild(li);
            });
        }

        function renderScanHistory(historyItems) {
            state.scanHistory = historyItems;
            if (!ui.scanHistoryList) return;
            ui.scanHistoryList.innerHTML = '';
            if (!historyItems || historyItems.length === 0) {
                ui.scanHistoryList.innerHTML = '<li class="text-center text-gray-400">No hay historial de escaneos.</li>';
                return;
            }
            historyItems.sort((a, b) => new Date(b.scannedAt) - new Date(a.scannedAt)).forEach(item => {
                const li = document.createElement('li');
                li.className = 'bg-gray-900 p-4 rounded-md flex justify-between items-center';
                let statusText = item.status.toUpperCase().replace('_', ' ');
                let statusClass = item.status.includes('valid') || item.status.includes('checkin') ? 'bg-green-600' : item.status.includes('used') ? 'bg-yellow-600' : item.status.includes('invalid') ? 'bg-red-600' : 'bg-gray-500';
                li.innerHTML = `
                    <div>
                        <p class="font-semibold">${item.name || 'N/A'} <span class="text-gray-400 text-sm">(${item.prefix || 'N/A'})</span></p>
                        <p class="text-sm text-gray-400">${item.id}</p>
                        <p class="text-xs text-gray-500">${new Date(item.scannedAt).toLocaleString()}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">${statusText}</span>`;
                ui.scanHistoryList.appendChild(li);
            });
        }
        
        function renderArtistPreviews(files) {
            ui.artistPreviewsContainer.innerHTML = '';
            state.pendingArtists = [];
            if (files.length === 0) {
                ui.addArtistsBtn.disabled = true;
                return;
            }

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    let defaultName = file.name.split('.').slice(0, -1).join('.');
                    // Mejorado: Limpiar nombre del archivo para hacerlo más presentable
                    defaultName = defaultName.replace(/[_-]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    const artist = { file, name: defaultName, previewUrl: e.target.result, id: `pending-${index}` };
                    state.pendingArtists.push(artist);

                    const card = document.createElement('div');
                    card.className = 'artist-preview-card';
                    card.innerHTML = `
                        <div class="artist-image-container-small">
                            <img src="${artist.previewUrl}" alt="Vista previa de ${artist.name}" class="artist-image">
                        </div>
                        <div class="flex-grow">
                            <input type="text" value="${artist.name}" data-artist-id="${artist.id}" class="artist-name-input w-full p-2 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Nombre del Artista">
                        </div>
                        <button type="button" data-artist-id="${artist.id}" class="remove-artist-preview-btn ml-2 p-2 rounded-full bg-red-600 hover:bg-red-700 text-white">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    ui.artistPreviewsContainer.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
            ui.addArtistsBtn.disabled = false;
        }

        function renderLiveVotingPreview(artists) {
            if (!ui.liveVotingPreviewList) return;
            ui.liveVotingPreviewList.innerHTML = '';
            if (!artists || artists.length === 0) {
                ui.liveVotingPreviewList.innerHTML = '<p class="text-center text-gray-400">No hay artistas registrados para votación.</p>';
                return;
            }
            // Sort by total score descending, then by name ascending
            const sortedArtists = [...artists].sort((a, b) => {
                const scoreA = (a.totalSingingScore || 0) + (a.totalTransmissionScore || 0) + (a.totalAttitudeScore || 0) + (a.totalOriginalityScore || 0);
                const scoreB = (b.totalSingingScore || 0) + (b.totalTransmissionScore || 0) + (b.totalAttitudeScore || 0) + (b.totalOriginalityScore || 0);
                return scoreB - scoreA || a.name.localeCompare(b.name);
            });

            sortedArtists.slice(0, 3).forEach((artist, index) => {
                const totalScore = (artist.totalSingingScore || 0) + (artist.totalTransmissionScore || 0) + (artist.totalAttitudeScore || 0) + (artist.totalOriginalityScore || 0);
                const card = document.createElement('div');
                card.className = 'artist-preview-card';
                card.innerHTML = `
                    <div class="artist-image-container-small">
                        <img src="${artist.photoURL || 'https://placehold.co/60x60/1f2937/f9fafb?text=ART'}" alt="${artist.name}" class="artist-image">
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-lg text-sky-300">${index + 1}. ${artist.name}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <span class="text-xl font-bold text-green-400">${totalScore} puntos</span>
                    </div>
                `;
                ui.liveVotingPreviewList.appendChild(card);
            });
        }

        function renderFullVotingResults(artists) {
            if (!ui.votesStats) return;
            ui.votesStats.innerHTML = '';
            if (!artists || artists.length === 0) {
                ui.votesStats.innerHTML = '<p class="text-center text-gray-400">No hay artistas registrados para votación.</p>';
                return;
            }
            // Sort by total score descending, then by name ascending
            const sortedArtists = [...artists].sort((a, b) => {
                const scoreA = (a.totalSingingScore || 0) + (a.totalTransmissionScore || 0) + (a.totalAttitudeScore || 0) + (a.totalOriginalityScore || 0);
                const scoreB = (b.totalSingingScore || 0) + (b.totalTransmissionScore || 0) + (b.totalAttitudeScore || 0) + (b.totalOriginalityScore || 0);
                return scoreB - scoreA || a.name.localeCompare(b.name);
            });

            sortedArtists.forEach((artist, index) => {
                const totalScore = (artist.totalSingingScore || 0) + (artist.totalTransmissionScore || 0) + (artist.totalAttitudeScore || 0) + (artist.totalOriginalityScore || 0);
                const card = document.createElement('div');
                card.className = 'bg-gray-700 p-4 rounded-lg flex items-center justify-between gap-4';
                card.innerHTML = `
                    <div class="artist-image-container-small">
                        <img src="${artist.photoURL || 'https://placehold.co/60x60/1f2937/f9fafb?text=ART'}" alt="${artist.name}" class="artist-image">
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-lg text-sky-300">${index + 1}. ${artist.name}</p>
                        <p class="text-sm text-gray-400">Votos recibidos: ${artist.totalRatingsCount || 0}</p>
                        <p class="text-sm text-gray-400">Canto: ${artist.totalRatingsCount > 0 ? (artist.totalSingingScore / artist.totalRatingsCount).toFixed(1) : 'N/A'}</p>
                        <p class="text-sm text-gray-400">Transmisión: ${artist.totalRatingsCount > 0 ? (artist.totalTransmissionScore / artist.totalRatingsCount).toFixed(1) : 'N/A'}</p>
                        <p class="text-sm text-gray-400">Actitud: ${artist.totalRatingsCount > 0 ? (artist.totalAttitudeScore / artist.totalRatingsCount).toFixed(1) : 'N/A'}</p>
                        <p class="text-sm text-gray-400">Originalidad: ${artist.totalRatingsCount > 0 ? (artist.totalOriginalityScore / artist.totalRatingsCount).toFixed(1) : 'N/A'}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <span class="text-2xl font-bold text-green-400">${totalScore}</span>
                        <span class="text-gray-400 text-sm">puntos</span>
                    </div>
                `;
                ui.votesStats.appendChild(card);
            });
        }

        function renderEventCodes(codes) {
            if (!ui.eventCodesList) return;
            ui.eventCodesList.innerHTML = '';
            if (!codes || codes.length === 0) {
                ui.eventCodesList.innerHTML = '<li class="text-center text-gray-400">No hay códigos de evento activos.</li>';
                return;
            }
            codes.filter(c => c.active).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(code => {
                const li = document.createElement('li');
                li.className = 'bg-gray-900 p-4 rounded-md flex justify-between items-center gap-4';
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-xl text-sky-300">${code.code}</p>
                        <p class="text-sm text-gray-400">Generado por: ${code.generatedBy.substring(0, 6)}...</p>
                        <p class="text-xs text-gray-500">${new Date(code.createdAt).toLocaleString()}</p>
                    </div>
                    <button data-code-id="${code.id}" class="deactivate-code-btn px-3 py-1 text-xs bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Desactivar</button>
                `;
                ui.eventCodesList.appendChild(li);
            });
        }

        function updateDashboard() {
            if (!state.allTicketsData || !ui.occupancyRate) return;

            const usedCount = state.allTicketsData.filter(t => t.used).length;
            const totalCount = state.allTicketsData.length;
            const occupancy = totalCount > 0 ? (usedCount / totalCount) * 100 : 0;
            ui.occupancyRate.textContent = `${occupancy.toFixed(1)}%`;

            const scansByHour = state.scanHistory.reduce((acc, s) => { 
                const h = new Date(s.scannedAt).getHours(); 
                acc[h] = (acc[h] || 0) + 1; 
                return acc; 
            }, {});
            ui.scansPerHour.innerHTML = Object.keys(scansByHour).length > 0 ? '' : '<p class="text-gray-400">No hay datos.</p>';
            Object.keys(scansByHour).sort((a,b) => a-b).forEach(h => { ui.scansPerHour.innerHTML += `<p>${h}:00 - ${h+1}:00: <span class="font-bold">${scansByHour[h]}</span></p>`; });

            const scansByPrefix = state.scanHistory.filter(s => s.status.includes('valid') || s.status.includes('checkin') || s.status.includes('used')).reduce((acc, s) => { 
                if(s.prefix) acc[s.prefix] = (acc[s.prefix] || 0) + 1; 
                return acc; 
            }, {});
            ui.scansByPrefix.innerHTML = Object.keys(scansByPrefix).length > 0 ? '' : '<p class="text-gray-400">No hay datos.</p>';
            Object.keys(scansByPrefix).sort().forEach(p => { ui.scansByPrefix.innerHTML += `<p>${p}: <span class="font-bold">${scansByPrefix[p]}</span></p>`; });
        }

        // --- ESCÁNER Y PROCESAMIENTO ---
        function startQrScanner() {
            if (state.isScannerActive) return;
            state.isScannerActive = true;
            ui.fullscreenScannerContainer.classList.remove('hidden');
            state.scanner = new Html5Qrcode("qr-code-reader");
            ui.scannerStatusMessageFullscreen.textContent = 'Iniciando cámara...';
            state.scanner.start({ facingMode: "environment" }, { fps: 10 }, onScanSuccess, (errorMessage) => {
                // console.warn("QR Code scanning error:", errorMessage); // Log error for debugging
                // Do nothing for continuous error messages to avoid spamming console
            })
                .then(() => { ui.scannerStatusMessageFullscreen.textContent = 'Apunte al código QR o de barras'; })
                .catch(err => { displayMessage('Error de cámara. ' + err.message, 'error'); stopAndCloseScanner(); });
        }

        async function stopAndCloseScanner() {
            if (state.scanner && state.isScannerActive) {
                try { await state.scanner.stop(); } catch (err) { console.error("Error stopping scanner:", err); }
                state.scanner = null;
            }
            state.isScannerActive = false;
            ui.fullscreenScannerContainer.classList.add('hidden');
            ui.scannedTicketInfoFullscreen.classList.add('hidden'); // Hide info on close
            ui.scannerStatusMessageFullscreen.textContent = 'Iniciando escáner...'; // Reset status
        }
        
        async function onScanSuccess(decodedText) {
            if (state.scanner) state.scanner.pause(true);
            ui.scannerStatusMessageFullscreen.textContent = 'Procesando...';
            await processScan(decodedText, 'fullscreen');
        }

        async function processScan(decodedText, context = 'fullscreen') {
            try {
                const ticketId = decodedText;
                const ticketDoc = await getDoc(FirebaseOps.paths.ticket(ticketId));
                
                const infoContainer = ui.scannedTicketInfoFullscreen;
                
                infoContainer.classList.remove('hidden');
                ui.markUsedBtnFullscreen.classList.add('hidden');
                
                let status, colorClass, sound, ticketData = null;
                
                if (!ticketDoc.exists()) {
                    status = 'INVÁLIDO'; colorClass = 'text-red-500'; sound = "C3";
                    FirebaseOps.saveScanEvent({ id: ticketId }, 'invalid');
                } else {
                    ticketData = {id: ticketDoc.id, ...ticketDoc.data()};
                    if (ticketData.used) {
                        status = 'YA USADO'; colorClass = 'text-yellow-500'; sound = "G3";
                        FirebaseOps.saveScanEvent(ticketData, 'used');
                    } else {
                        status = 'VÁLIDO'; colorClass = 'text-green-500'; sound = "C4";
                        ui.markUsedBtnFullscreen.classList.remove('hidden');
                        state.currentScannedTicketId = ticketData.id;
                        FirebaseOps.saveScanEvent(ticketData, 'valid');
                    }
                }
                
                ui.currentScannedTicketIdFullscreen.textContent = ticketId;
                ui.currentScannedTicketNameFullscreen.textContent = ticketData?.name || 'N/A';
                ui.currentScannedTicketSeatLocationFullscreen.textContent = ticketData?.seatLocation || 'N/A';
                ui.currentScannedTicketStatusFullscreen.textContent = status;
                ui.currentScannedTicketStatusFullscreen.className = `text-2xl font-bold p-2 rounded-md ${colorClass}`;
                
                ui.scanFlashOverlay.className = `scan-flash ${status.toLowerCase().split(' ')[0]}`;
                ui.scanFlashOverlay.style.opacity = '1';
                setTimeout(() => { ui.scanFlashOverlay.style.opacity = '0'; }, 500);

                if (state.synth) Tone.start().then(() => state.synth.triggerAttackRelease(sound, "8n"));

            } catch (error) {
                displayMessage('Error al procesar el ticket.', 'error');
                console.error("Error processing scan:", error);
            } finally {
                ui.scanAgainBtnFullscreen.classList.remove('hidden');
            }
        }

        // --- MANEJO DE EVENTOS ---
        function setupEventListeners() {
            ui.navCards.forEach(card => {
                if (card.id === 'open-scanner-btn') card.addEventListener('click', startQrScanner);
                else if (card.dataset.section) card.addEventListener('click', (e) => {
                    const section = document.getElementById(e.currentTarget.dataset.section);
                    if (section) { // Asegurarse de que la sección exista
                        if (section.id === 'dashboard-section') updateDashboard();
                        showSection(section);
                    }
                });
            });
            
            ui.generatorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (state.isSubmitting) return;
                state.isSubmitting = true; setLoading(true);
                
                const ticketPrefix = ui.ticketPrefixInput.value.trim();
                const showName = ui.showNameInput.value.trim();
                const showLocation = ui.showLocationInput.value.trim();
                const showAddress = ui.showAddressInput.value.trim();
                const names = ui.batchTicketNamesInput.value.trim().split(/[\n,]+/).map(n => n.trim()).filter(Boolean);
                const seatLocation = ui.ticketSeatLocationInput.value.trim();

                if (names.length === 0 || !ticketPrefix || !showName || !showLocation) {
                    displayMessage('Faltan datos requeridos.', 'warning');
                    setLoading(false); state.isSubmitting = false; return;
                }

                try {
                    const batch = writeBatch(state.db);
                    const ticketsCol = FirebaseOps.paths.tickets();
                    state.currentBatchGeneratedTickets = [];
                    names.forEach(name => {
                        const ticketId = `${ticketPrefix}-${crypto.randomUUID().substring(0, 8)}`;
                        // AÑADE 'voted: false' AQUÍ
                        const ticketData = { id: ticketId, prefix: ticketPrefix, name, seatLocation, showName, showLocation, showAddress, used: false, voted: false, generatedAt: new Date().toISOString(), usedAt: null, usedBy: null };
                        batch.set(doc(ticketsCol, ticketId), ticketData);
                        state.currentBatchGeneratedTickets.push(ticketData);
                    });
                    await batch.commit();
                    state.currentQrIndex = 0; displayCurrentQr();
                    ui.qrCarouselControls.classList.remove('hidden');
                    ui.shareBatchQrsBtn.classList.remove('hidden');
                    displayMessage(`${names.length} tickets generados.`, 'success');
                } catch (error) {
                    displayMessage(`Error: ${error.message}`, 'error');
                    console.error("Error generating tickets:", error);
                } finally {
                    setLoading(false);
                    state.isSubmitting = false;
                }
            });

            ui.generatorFormClearBtn.addEventListener('click', () => {
                ui.generatorForm.reset(); ui.generatedTicketsContainer.innerHTML = '';
                state.currentBatchGeneratedTickets = []; ui.shareBatchQrsBtn.classList.add('hidden');
                ui.qrCarouselControls.classList.add('hidden');
            });
            ui.shareBatchQrsBtn.addEventListener('click', () => {
                const artistPrefix = ui.ticketPrefixInput.value.trim();
                if (!artistPrefix) return displayMessage('Ingresa un Prefijo de Artista/Grupo para poder compartir.', 'warning');
                
                const loc = window.location;
                let path = loc.pathname;
                path = path.substring(0, path.lastIndexOf('/'));
                const baseUrl = `${loc.origin}${path}`;
                // CAMBIO CLAVE: Cambiar voting_page.html a shared_tickets.html
                const shareableLink = `${baseUrl}/visor_qr_compartido.html?artist=${encodeURIComponent(artistPrefix)}&appId=${state.appId}`; 
                
                showShareLinkModal(shareableLink, 'tickets');
            });
            ui.prevQrBtn.addEventListener('click', () => { if (state.currentQrIndex > 0) { state.currentQrIndex--; displayCurrentQr(); } });
            ui.nextQrBtn.addEventListener('click', () => { if (state.currentQrIndex < state.currentBatchGeneratedTickets.length - 1) { state.currentQrIndex++; displayCurrentQr(); } });
            
            ui.allTicketsSearchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = state.allTicketsData.filter(t => t.name.toLowerCase().includes(term) || t.id.toLowerCase().includes(term) || t.prefix.toLowerCase().includes(term));
                renderAllTickets(filtered);
            });

            ui.exportCsvBtn.addEventListener('click', () => {
                if (state.scanHistory.length === 0) return displayMessage("No hay historial para exportar.", "warning");
                const headers = "ID,Nombre,Prefijo,Ubicacion,Show,Estado,FechaEscaneo";
                const rows = state.scanHistory.map(s => [s.id, s.name, s.prefix, s.seatLocation, s.showName, s.status, new Date(s.scannedAt).toLocaleString()].map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(','));
                const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `historial_escaneos_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });
            
            ui.closeScannerBtn.addEventListener('click', stopAndCloseScanner);
            ui.scanAgainBtnFullscreen.addEventListener('click', () => {
                ui.scannedTicketInfoFullscreen.classList.add('hidden');
                if (state.scanner) { try { state.scanner.resume(); } catch(e) {console.error("Error resuming scanner:", e);} }
            });
            ui.markUsedBtnFullscreen.addEventListener('click', () => {
                if (state.currentScannedTicketId) {
                    showConfirmation('Confirmar Uso', `¿Marcar ticket como USADO?`, async () => {
                        setLoading(true);
                        try {
                            await FirebaseOps.updateTicket(state.currentScannedTicketId, { used: true, usedAt: new Date().toISOString(), usedBy: state.userId });
                            ui.scannedTicketInfoFullscreen.classList.add('hidden');
                            if (state.scanner) { try { state.scanner.resume(); } catch(e) {console.error("Error resuming scanner:", e);} }
                            displayMessage('Entrada marcada como usada.', 'success');
                        } catch (error) {
                            displayMessage('Error al actualizar la entrada.', 'error');
                            console.error("Error updating ticket manually:", error);
                        } finally {
                            setLoading(false);
                        }
                    });
                }
            });

            ui.loginBtn.addEventListener('click', async () => {
                try {
                    await signInWithEmailAndPassword(state.auth, ui.emailInput.value, ui.passwordInput.value);
                    displayMessage('Inicio de sesión exitoso.', 'success');
                } catch (err) {
                    console.error("Error durante el inicio de sesión:", err); // Log del error completo
                    displayMessage(`Error al iniciar sesión: ${err.message} (Código: ${err.code || 'N/A'})`, 'error');
                }
            });

            ui.registerBtn.addEventListener('click', async () => {
                try {
                    await createUserWithEmailAndPassword(state.auth, ui.emailInput.value, ui.passwordInput.value);
                    displayMessage('Registro exitoso. ¡Bienvenido!', 'success');
                } catch (err) {
                    console.error("Error durante el registro:", err); // Log del error completo
                    displayMessage(`Error al registrarse: ${err.message} (Código: ${err.code || 'N/A'})`, 'error');
                }
            });
            ui.logoutBtn.addEventListener('click', () => signOut(state.auth));

            ui.allTicketsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('manual-checkin-btn')) {
                    const ticketId = e.target.dataset.ticketId;
                    const isUsed = e.target.dataset.ticketUsed === 'true';
                    const actionText = isUsed ? 'ANULAR INGRESO' : 'CONFIRMAR INGRESO';
                    const ticketName = state.allTicketsData.find(t => t.id === ticketId)?.name || ticketId;

                    showConfirmation(`Confirmar Acción`, `¿Deseas ${actionText} para la entrada de ${ticketName}?`, async () => {
                        setLoading(true);
                        try {
                            await FirebaseOps.updateTicket(ticketId, { used: !isUsed, usedAt: !isUsed ? new Date().toISOString() : null, usedBy: !isUsed ? state.userId : null });
                            await FirebaseOps.saveScanEvent(state.allTicketsData.find(t => t.id === ticketId), !isUsed ? 'manual_checkin' : 'manual_checkout');
                            displayMessage(`Estado de la entrada actualizado.`, 'success');
                        } catch (error) {
                            displayMessage('Error al actualizar la entrada.', 'error');
                            console.error("Error updating ticket manually:", error);
                        } finally {
                            setLoading(false);
                        }
                    });
                }
            });

            // Event listener para el formulario de artistas
            ui.artistForm.addEventListener('submit', handleArtistFormSubmit);
            ui.artistPhotosInput.addEventListener('change', (e) => renderArtistPreviews(e.target.files));
            ui.artistPreviewsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('artist-name-input')) {
                    const artistId = e.target.dataset.artistId;
                    const artist = state.pendingArtists.find(a => a.id === artistId);
                    if (artist) {
                        artist.name = e.target.value;
                    }
                }
            });
            ui.artistPreviewsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-artist-preview-btn') || e.target.closest('.remove-artist-preview-btn')) {
                    const btn = e.target.closest('.remove-artist-preview-btn');
                    const artistIdToRemove = btn.dataset.artistId;
                    state.pendingArtists = state.pendingArtists.filter(artist => artist.id !== artistIdToRemove);
                    btn.closest('.artist-preview-card').remove();
                    if (state.pendingArtists.length === 0) {
                        ui.addArtistsBtn.disabled = true;
                    }
                }
            });
            
            ui.resetAllDataBtn.addEventListener('click', () => {
                showResetConfirmation(async () => {
                    setLoading(true);
                    try {
                        const batch = writeBatch(state.db);
                        const collectionsToDelete = ['tickets', 'artists', 'votes', 'event_codes'];
                        for (const coll of collectionsToDelete) {
                            const snapshot = await getDocs(collection(state.db, `artifacts/${state.appId}/public/data/${coll}`));
                            snapshot.forEach(doc => batch.delete(doc.ref));
                        }
                        // Delete user-specific votes collections (user_artist_votes)
                        // This requires listing subcollections, which is not directly supported by client SDK.
                        // A more robust solution for deleting subcollections would involve a Cloud Function.
                        // For now, we'll delete the main user_artist_votes collection, but subcollections will remain.
                        // If this becomes a problem, we'd need a server-side solution.
                        const userArtistVotesCollectionRef = collection(state.db, `artifacts/${state.appId}/public/data/user_artist_votes`);
                        const userArtistVotesSnapshot = await getDocs(userArtistVotesCollectionRef);
                        userArtistVotesSnapshot.forEach(doc => batch.delete(doc.ref));

                        // CAMBIO: Eliminar también la colección ticket_artist_votes
                        const ticketArtistVotesCollectionRef = collection(state.db, `artifacts/${state.appId}/public/data/ticket_artist_votes`);
                        const ticketArtistVotesSnapshot = await getDocs(ticketArtistVotesCollectionRef);
                        ticketArtistVotesSnapshot.forEach(doc => batch.delete(doc.ref));


                        // Delete scan history for the current user
                        const historySnapshot = await getDocs(FirebaseOps.paths.scanHistory());
                        historySnapshot.forEach(doc => batch.delete(doc.ref));

                        // Delete all artist photos from storage
                        const photosRef = ref(state.storage, `artifacts/${state.appId}/public/artist_photos`);
                        const listResult = await listAll(photosRef);
                        listResult.items.forEach((itemRef) => {
                            deleteObject(itemRef).catch(e => console.error("Error deleting photo:", e));
                        });

                        await batch.commit();
                        displayMessage('Todos los datos han sido eliminados.', 'success');
                    } catch (error) {
                        displayMessage(`Error al reiniciar los datos: ${error.message}`, 'error');
                        console.error("Error resetting all data:", error);
                    } finally {
                        setLoading(false);
                    }
                });
            });

            // Toggle password visibility
            ui.togglePasswordBtn.addEventListener('click', () => {
                const type = ui.passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                ui.passwordInput.setAttribute('type', type);
                ui.eyeIcon.classList.toggle('hidden');
                ui.eyeSlashIcon.classList.toggle('hidden');
            });

            // Assistant Login
            ui.assistantLoginBtn.addEventListener('click', () => {
                ui.assistantLoginModal.classList.remove('hidden');
            });
            ui.assistantModalCancelBtn.addEventListener('click', () => {
                ui.assistantLoginModal.classList.add('hidden');
                ui.assistantLoginForm.reset();
            });
            ui.assistantLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const eventCode = ui.eventCodeInput.value.trim();
                setLoading(true);
                try {
                    const codeDoc = await FirebaseOps.getEventCode(eventCode);
                    if (codeDoc && codeDoc.active) {
                        // Sign in anonymously for assistants
                        const userCredential = await signInAnonymously(state.auth);
                        updateUIAfterLogin(userCredential.user, 'assistant');
                        displayMessage('Ingreso como asistente exitoso.', 'success');
                        ui.assistantLoginModal.classList.add('hidden');
                        ui.assistantLoginForm.reset();
                    } else {
                        displayMessage('Código de evento inválido o inactivo.', 'error');
                    }
                } catch (error) {
                    displayMessage(`Error al ingresar como asistente: ${error.message}`, 'error');
                    console.error("Assistant login error:", error);
                } finally {
                    setLoading(false);
                }
            });

            // Generate Event Code
            ui.generateCodeBtn.addEventListener('click', async () => {
                setLoading(true);
                try {
                    const newCode = Math.random().toString(36).substring(2, 8).toUpperCase(); // Simple 6-char code
                    await FirebaseOps.addEventCode(newCode);
                    displayMessage(`Código de evento "${newCode}" generado con éxito.`, 'success');
                } catch (error) {
                    displayMessage(`Error al generar código: ${error.message}`, 'error');
                    console.error("Error generating event code:", error);
                } finally {
                    setLoading(false);
                }
            });

            // Deactivate Event Code
            ui.eventCodesList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('deactivate-code-btn')) {
                    const codeId = e.target.dataset.codeId;
                    showConfirmation('Desactivar Código', '¿Estás seguro de que deseas desactivar este código de evento? Los asistentes no podrán usarlo más.', async () => {
                        setLoading(true);
                        try {
                            await FirebaseOps.deactivateEventCode(codeId);
                            displayMessage('Código desactivado.', 'success');
                        } catch (error) {
                            displayMessage(`Error al desactivar código: ${error.message}`, 'error');
                            console.error("Error deactivating event code:", error);
                        } finally {
                            setLoading(false);
                        }
                    });
                }
            });

            // Voting Panel Tab Navigation
            ui.tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    ui.tabButtons.forEach(btn => {
                        btn.classList.remove('border-sky-400', 'text-sky-400');
                        btn.classList.add('text-gray-400');
                    });
                    e.currentTarget.classList.add('border-sky-400', 'text-sky-400');
                    e.currentTarget.classList.remove('text-gray-400');

                    ui.configTabContent.classList.add('hidden');
                    ui.resultsTabContent.classList.add('hidden');

                    if (e.currentTarget.id === 'config-tab-btn') {
                        ui.configTabContent.classList.remove('hidden');
                    } else if (e.currentTarget.id === 'results-tab-btn') {
                        ui.resultsTabContent.classList.remove('hidden');
                    }
                });
            });

            // Go to Voting Panel button
            ui.goToVotingPanelBtn.addEventListener('click', () => {
                showSection(ui.votingSection);
                // Ensure config tab is active by default when navigating here
                ui.configTabBtn.click();
            });

            // Share Voting Link
            ui.shareVotingLinkBtn.addEventListener('click', () => {
                const loc = window.location;
                let path = loc.pathname;
                path = path.substring(0, path.lastIndexOf('/'));
                const baseUrl = `${loc.origin}${path}`;
                const shareableLink = `${baseUrl}/voting_page.html?appId=${state.appId}`; 
                console.log("Enlace de votación generado:", shareableLink); // Log para depuración
                showShareLinkModal(shareableLink, 'voting');
            });

            // Reset Voting
            ui.resetVotingBtn.addEventListener('click', () => {
                showConfirmation('Reiniciar Votación', 'Esto eliminará TODOS los artistas y sus votos. Esta acción no se puede deshacer.', async () => {
                    setLoading(true);
                    try {
                        const batch = writeBatch(state.db);
                        const collectionsToDelete = ['tickets', 'artists', 'votes', 'event_codes'];
                        for (const coll of collectionsToDelete) {
                            const snapshot = await getDocs(collection(state.db, `artifacts/${state.appId}/public/data/${coll}`));
                            snapshot.forEach(doc => batch.delete(doc.ref));
                        }
                        // Delete user-specific votes collections (user_artist_votes)
                        // This requires listing subcollections, which is not directly supported by client SDK.
                        // A more robust solution for deleting subcollections would involve a Cloud Function.
                        // For now, we'll delete the main user_artist_votes collection, but subcollections will remain.
                        // If this becomes a problem, we'd need a server-side solution.
                        const userArtistVotesCollectionRef = collection(state.db, `artifacts/${state.appId}/public/data/user_artist_votes`);
                        const userArtistVotesSnapshot = await getDocs(userArtistVotesCollectionRef);
                        userArtistVotesSnapshot.forEach(doc => batch.delete(doc.ref));

                        // CAMBIO: Eliminar también la colección ticket_artist_votes
                        const ticketArtistVotesCollectionRef = collection(state.db, `artifacts/${state.appId}/public/data/ticket_artist_votes`);
                        const ticketArtistVotesSnapshot = await getDocs(ticketArtistVotesCollectionRef);
                        ticketArtistVotesSnapshot.forEach(doc => batch.delete(doc.ref));


                        // Delete scan history for the current user
                        const historySnapshot = await getDocs(FirebaseOps.paths.scanHistory());
                        historySnapshot.forEach(doc => batch.delete(doc.ref));

                        // Delete all artist photos from storage
                        const photosRef = ref(state.storage, `artifacts/${state.appId}/public/artist_photos`);
                        const listResult = await listAll(photosRef);
                        listResult.items.forEach((itemRef) => {
                            deleteObject(itemRef).catch(e => console.error("Error deleting photo:", e));
                        });

                        await batch.commit();
                        displayMessage('Todos los datos han sido eliminados.', 'success');
                    } catch (error) {
                        displayMessage(`Error al reiniciar los datos: ${error.message}`, 'error');
                        console.error("Error resetting all data:", error);
                    } finally {
                        setLoading(false);
                    }
                });
            });

            // Search Prefix button functionality
            ui.searchPrefixBtn.addEventListener('click', async () => {
                const prefix = ui.ticketPrefixInput.value.trim();
                if (!prefix) {
                    displayMessage('Por favor, ingresa un prefijo para buscar.', 'warning');
                    return;
                }
                setLoading(true);
                try {
                    const q = query(FirebaseOps.paths.tickets(), where("prefix", "==", prefix));
                    const querySnapshot = await getDocs(q);
                    const names = querySnapshot.docs.map(doc => doc.data().name);
                    if (names.length > 0) {
                        ui.batchTicketNamesInput.value = names.join('\n');
                        displayMessage(`Se encontraron ${names.length} entradas con el prefijo "${prefix}".`, 'info');
                    } else {
                        ui.batchTicketNamesInput.value = '';
                        displayMessage(`No se encontraron entradas con el prefijo "${prefix}".`, 'warning');
                    }
                } catch (error) {
                    displayMessage(`Error al buscar entradas por prefijo: ${error.message}`, 'error');
                    console.error("Error searching tickets by prefix:", error);
                } finally {
                    setLoading(false);
                }
            });
        }

        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        function attachDataListeners() {
            // Limpiar listeners anteriores para evitar duplicados
            state.unsubscribeListeners.forEach(unsub => unsub());
            state.unsubscribeListeners = [];
            
            // Listeners para tickets
            const qTickets = query(FirebaseOps.paths.tickets());
            const unsubTickets = onSnapshot(qTickets, (snapshot) => {
                const tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllTickets(tickets);
                if (ui.totalGeneratedTickets) ui.totalGeneratedTickets.textContent = tickets.length;
                if (ui.totalUsedTickets) ui.totalUsedTickets.textContent = tickets.filter(t => t.used).length;
                updateDashboard();
            }, err => console.error("Error en listener de tickets:", err));
            state.unsubscribeListeners.push(unsubTickets);

            // Listeners para historial de escaneos (solo si el usuario es admin o asistente)
            if (state.userId) { // Only attach if userId is available (after login)
                const qHistory = query(FirebaseOps.paths.scanHistory());
                const unsubHistory = onSnapshot(qHistory, (snapshot) => {
                    const history = snapshot.docs.map(doc => doc.data());
                    renderScanHistory(history);
                    updateDashboard();
                }, err => console.error("Error en listener de historial:", err));
                state.unsubscribeListeners.push(unsubHistory);
            }

            // Listeners para artistas (votación)
            const qArtists = query(FirebaseOps.paths.artists());
            const unsubArtists = onSnapshot(qArtists, (snapshot) => {
                const artists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.allArtistsData = artists; // Store for full results
                renderLiveVotingPreview(artists);
                renderFullVotingResults(artists); // Update full results tab
            }, err => console.error("Error en listener de artistas:", err));
            state.unsubscribeListeners.push(unsubArtists);

            // Listeners para códigos de evento (solo para admin)
            if (state.userRole === 'admin') {
                const qEventCodes = query(FirebaseOps.paths.eventCodes());
                const unsubEventCodes = onSnapshot(qEventCodes, (snapshot) => {
                    const codes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEventCodes(codes);
                }, err => console.error("Error en listener de códigos de evento:", err));
                state.unsubscribeListeners.push(unsubEventCodes);
            }
        }

        async function initApp() {
            cacheUIElements();
            setupEventListeners();
            try {
                state.synth = new Tone.Synth().toDestination();
            } catch(e) { console.warn("No se pudo inicializar el sintetizador de audio."); }

            // --- CONFIGURACIÓN DE FIREBASE (INCRUSTADA) ---
            // Estas son tus credenciales REALES obtenidas de tus capturas de pantalla.
            // Se incrustan directamente aquí para evitar problemas de carga de módulos en Netlify.
            const firebaseConfig = {
                apiKey: "AIzaSyC_2Ukoxf_ry7QfKtou1Cz6nY-qTVw4qTU", 
                authDomain: "vyt-music.firebaseapp.com",
                projectId: "vyt-music", 
                storageBucket: "vyt-music.firebasestorage.app", 
                messagingSenderId: "574981837817", 
                appId: "1:574981837817:web:a29933a22bbfd51a086328"
                // measurementId: "G-XXXXXXXXXX" // Eliminado para evitar problemas de CSP en Canvas
            };

            if (!firebaseConfig.apiKey) {
                if(ui.authScreen) {
                    ui.authScreen.innerHTML = `<div class="text-center text-red-400">Error de configuración de Firebase. La aplicación no puede iniciarse.</div>`;
                    ui.authScreen.classList.remove('hidden');
                }
                return;
            }
            
            const app = initializeApp(firebaseConfig);
            state.db = getFirestore(app);
            state.auth = getAuth(app);
            state.storage = getStorage(app);

            onAuthStateChanged(state.auth, (user) => {
                if (user) {
                    // Check if the user is an anonymous assistant user
                    if (user.isAnonymous) {
                        // For anonymous users, we assume they are assistants.
                        // In a real app, you might want to store more info about the assistant
                        // or check if their anonymous ID is linked to an active event code.
                        // For simplicity here, any anonymous user is an assistant.
                        updateUIAfterLogin(user, 'assistant');
                    } else {
                        // Regular authenticated user (email/password) is an admin
                        updateUIAfterLogin(user, 'admin');
                    }
                } else {
                    // El usuario ha cerrado sesión o no está autenticado
                    updateUIAfterLogout();
                }
                setLoading(false);
            });

            // Intento de inicio de sesión con token personalizado si está disponible
            setLoading(true);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Intentando inicio de sesión con token personalizado."); // Log
                    await signInWithCustomToken(state.auth, __initial_auth_token);
                } else {
                    console.log("No se encontró token personalizado. Mostrando pantalla de autenticación."); // Log
                    setLoading(false);
                    if(ui.authScreen) ui.authScreen.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error en el inicio de sesión automático:", error); // Log del error completo
                displayMessage(`Error en inicio de sesión automático: ${error.message}`, 'error'); 
                setLoading(false);
                if(ui.authScreen) ui.authScreen.classList.remove('hidden');
            }
        }

        // Iniciar la aplicación cuando la ventana se cargue
        window.onload = initApp;

    </script>
</body>
</html>
