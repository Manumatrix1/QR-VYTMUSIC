<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfiles de Artistas - Simple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none !important; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 900; display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; max-width: 90%; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        .artist-card { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #374151; transition: all 0.2s; margin-bottom: 1rem; }
        .artist-card:hover { border-color: #38bdf8; }
    </style>
</head>
<body class="antialiased">
    
    <!-- Modal para editar perfil simple -->
    <div id="artist-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">‚úèÔ∏è Editar Artista</h3>
            <form id="artist-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="artist-name" class="block mb-1 font-semibold text-gray-300">Nombre del Artista</label>
                        <input type="text" id="artist-name" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                    </div>
                    <div>
                        <label for="artist-age" class="block mb-1 font-semibold text-gray-300">Edad</label>
                        <input type="number" id="artist-age" min="10" max="100" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                    </div>
                    <div>
                        <label for="artist-city" class="block mb-1 font-semibold text-gray-300">Ciudad</label>
                        <input type="text" id="artist-city" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                    </div>
                    <div>
                        <label for="artist-style" class="block mb-1 font-semibold text-gray-300">Estilo Musical</label>
                        <input type="text" id="artist-style" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                    </div>
                </div>
                
                <div>
                    <label for="artist-song" class="block mb-1 font-semibold text-gray-300">Canci√≥n Actual</label>
                    <input type="text" id="artist-song" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                </div>
                
                <!-- Secci√≥n de foto simplificada (URL directa) -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-300 mb-3">üì∏ Foto del Artista</h4>
                    <div class="flex items-center gap-4 mb-3">
                        <div class="flex-shrink-0">
                            <img id="photo-preview" src="" alt="Foto" 
                                 class="w-16 h-16 rounded-full object-cover border-2 border-sky-400 hidden">
                            <div id="photo-placeholder" class="w-16 h-16 bg-sky-600 rounded-full flex items-center justify-center text-xl font-bold text-white">
                                A
                            </div>
                        </div>
                        <div class="flex-1">
                            <label for="photo-file" class="block mb-2 font-semibold text-gray-300">üìÅ Subir desde tu PC</label>
                            <input type="file" id="photo-file" accept="image/*" 
                                   class="w-full p-2 rounded-md border border-gray-600 bg-gray-800 text-white text-sm">
                            <p class="text-xs text-gray-400 mt-1">Selecciona una imagen desde tu computadora (recomendado)</p>
                        </div>
                        <button type="button" id="remove-photo-btn" 
                                class="px-3 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                            üóëÔ∏è Quitar
                        </button>
                    </div>
                    
                    <div class="border-t border-gray-600 pt-3">
                        <label for="photo-url" class="block mb-2 font-semibold text-gray-300">üåê O pegar enlace de internet</label>
                        <div class="flex gap-2">
                            <input type="url" id="photo-url" placeholder="https://ejemplo.com/foto.jpg" 
                                   class="flex-1 p-2 rounded-md border border-gray-600 bg-gray-800 text-white text-sm">
                            <button type="button" id="test-photo-btn" 
                                    class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                üëÅÔ∏è Ver
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Alternativa: pega el enlace de una imagen desde internet</p>
                    </div>
                </div>
                
                <div>
                    <label for="artist-notes" class="block mb-1 font-semibold text-gray-300">Observaciones</label>
                    <textarea id="artist-notes" rows="3" class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container mx-auto max-w-6xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <a id="back-link" href="#" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Panel</a>
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Perfiles de Artistas - Simple</h1>
            <p class="text-xl text-gray-300 mt-2">Gesti√≥n simplificada sin dependencias complejas</p>
        </header>

        <div id="message-container" class="mb-4"></div>

        <!-- Estad√≠sticas -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-2xl font-bold mb-4">üìä Estad√≠sticas</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-sky-600 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold" id="total-artists">0</div>
                    <div class="text-sm opacity-80">Total Artistas</div>
                </div>
                <div class="bg-green-600 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold" id="completed-profiles">0</div>
                    <div class="text-sm opacity-80">Perfiles Completos</div>
                </div>
                <div class="bg-blue-600 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold">‚úì</div>
                    <div class="text-sm opacity-80">Sistema Simple</div>
                </div>
            </div>
        </section>

        <!-- Agregar artista -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">‚ûï Agregar Nuevo Artista</h2>
                <button id="add-artist-btn" class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                    Crear Artista
                </button>
            </div>
        </section>

        <!-- Lista de artistas -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold mb-4">üé§ Artistas del Evento</h2>
            <div id="artists-list" class="space-y-4">
                <p class="text-center text-gray-400">Cargando artistas...</p>
            </div>
        </section>
    </div>

    <script type="module">
        // VERSI√ìN S√öPER SIMPLE SIN FIREBASE STORAGE
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, updateDoc, setDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId') || 'demo-event';
        const eventName = urlParams.get('eventName') || 'Demo Event';

        // UI Elements
        const ui = {
            backLink: document.getElementById('back-link'),
            messageContainer: document.getElementById('message-container'),
            totalArtists: document.getElementById('total-artists'),
            completedProfiles: document.getElementById('completed-profiles'),
            addArtistBtn: document.getElementById('add-artist-btn'),
            artistsList: document.getElementById('artists-list'),
            
            // Modal
            artistModal: document.getElementById('artist-modal'),
            artistForm: document.getElementById('artist-form'),
            cancelBtn: document.getElementById('cancel-btn'),
            
            // Form fields
            artistName: document.getElementById('artist-name'),
            artistAge: document.getElementById('artist-age'),
            artistCity: document.getElementById('artist-city'),
            artistStyle: document.getElementById('artist-style'),
            artistSong: document.getElementById('artist-song'),
            photoUrl: document.getElementById('photo-url'),
            photoPreview: document.getElementById('photo-preview'),
            testPhotoBtn: document.getElementById('test-photo-btn'),
            artistNotes: document.getElementById('artist-notes')
        };

        let artists = [];
        let currentArtistId = null;

        // Initialize
        ui.backLink.href = `panel_evento.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;

        function showMessage(message, type = 'success') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            ui.messageContainer.innerHTML = `<div class="p-4 rounded-md mb-4 text-white ${colors[type]}">${message}</div>`;
            setTimeout(() => { ui.messageContainer.innerHTML = ''; }, 5000);
        }

        async function loadArtists() {
            try {
                console.log('üìã Cargando artistas para evento:', eventId);
                const artistsSnapshot = await getDocs(collection(db, `events/${eventId}/artists`));
                
                artists = artistsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('‚úÖ Artistas cargados:', artists.length);
                renderArtists();
                updateStats();
                
            } catch (error) {
                console.error('‚ùå Error loading artists:', error);
                ui.artistsList.innerHTML = '<p class="text-center text-red-400">Error al cargar artistas</p>';
            }
        }

        function renderArtists() {
            if (artists.length === 0) {
                ui.artistsList.innerHTML = '<p class="text-center text-gray-400">No hay artistas registrados</p>';
                return;
            }

            ui.artistsList.innerHTML = artists.map(artist => {
                const completion = calculateCompletion(artist);
                const photoUrl = artist.photoURL || 'https://placehold.co/60x60/1f2937/f9fafb?text=' + (artist.name ? artist.name.charAt(0) : 'A');
                
                return `
                    <div class="artist-card">
                        <div class="flex items-center gap-4">
                            <img src="${photoUrl}" alt="${artist.name}" 
                                 class="w-16 h-16 rounded-full object-cover border-2 border-sky-400">
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg">${artist.name}</h3>
                                <p class="text-gray-400">
                                    ${artist.musicalStyle || 'Sin estilo'} ‚Ä¢ ${artist.currentSong || 'Sin canci√≥n'}
                                </p>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="flex-1 bg-gray-600 h-2 rounded">
                                        <div class="h-2 bg-${completion >= 70 ? 'green' : completion >= 40 ? 'yellow' : 'red'}-500 rounded" 
                                             style="width: ${completion}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-400">${completion}%</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editArtist('${artist.id}')" 
                                        class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteArtist('${artist.id}')" 
                                        class="px-3 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateCompletion(artist) {
            const fields = ['name', 'age', 'city', 'musicalStyle', 'currentSong', 'photoURL'];
            const completed = fields.filter(field => artist[field] && artist[field].toString().trim()).length;
            return Math.round((completed / fields.length) * 100);
        }

        function updateStats() {
            ui.totalArtists.textContent = artists.length;
            ui.completedProfiles.textContent = artists.filter(a => calculateCompletion(a) >= 70).length;
        }

        // Modal functions
        function openModal(artist = null) {
            currentArtistId = artist ? artist.id : null;
            
            if (artist) {
                console.log('‚úèÔ∏è Editando artista:', artist.name);
                
                // Llenar campos b√°sicos
                ui.artistName.value = artist.name || '';
                ui.artistAge.value = artist.age || '';
                ui.artistCity.value = artist.city || '';
                ui.artistStyle.value = artist.musicalStyle || '';
                ui.artistSong.value = artist.currentSong || '';
                ui.artistNotes.value = artist.juryNotes || '';
                
                // Manejar foto existente
                if (artist.photoURL) {
                    console.log('üì∏ Cargando foto existente');
                    document.getElementById('photo-preview').src = artist.photoURL;
                    document.getElementById('photo-preview').classList.remove('hidden');
                    document.getElementById('photo-placeholder').style.display = 'none';
                    
                    // Si es URL, ponerla en el campo URL
                    if (artist.photoURL.startsWith('http')) {
                        document.getElementById('photo-url').value = artist.photoURL;
                    }
                    
                    window.currentPhotoData = artist.photoURL;
                } else {
                    // Sin foto - mostrar placeholder
                    document.getElementById('photo-preview').classList.add('hidden');
                    document.getElementById('photo-placeholder').style.display = 'flex';
                    document.getElementById('photo-placeholder').textContent = artist.name ? artist.name.charAt(0).toUpperCase() : 'A';
                    document.getElementById('photo-url').value = '';
                    window.currentPhotoData = null;
                }
                
                // Limpiar selector de archivo
                document.getElementById('photo-file').value = '';
                
            } else {
                console.log('‚ûï Creando nuevo artista');
                ui.artistForm.reset();
                
                // Limpiar foto
                document.getElementById('photo-preview').classList.add('hidden');
                document.getElementById('photo-placeholder').style.display = 'flex';
                document.getElementById('photo-placeholder').textContent = 'A';
                document.getElementById('photo-file').value = '';
                document.getElementById('photo-url').value = '';
                window.currentPhotoData = null;
            }
            
            ui.artistModal.classList.remove('hidden');
        }

        function closeModal() {
            ui.artistModal.classList.add('hidden');
            currentArtistId = null;
        }

        function updatePhotoPreview() {
            const url = ui.photoUrl.value.trim();
            if (url) {
                ui.photoPreview.src = url;
            } else {
                ui.photoPreview.src = 'https://placehold.co/64x64/1f2937/f9fafb?text=' + (ui.artistName.value.charAt(0) || '?');
            }
        }

        async function saveArtist(e) {
            e.preventDefault();
            
            // Obtener foto actual (Base64 o URL)
            let photoData = null;
            if (window.currentPhotoData) {
                photoData = window.currentPhotoData;
                console.log('üì∏ Guardando foto:', photoData.substring(0, 50) + '...');
            }
            
            const artistData = {
                name: ui.artistName.value.trim(),
                age: ui.artistAge.value ? parseInt(ui.artistAge.value) : null,
                city: ui.artistCity.value.trim(),
                musicalStyle: ui.artistStyle.value.trim(),
                currentSong: ui.artistSong.value.trim(),
                photoURL: photoData,  // Aqu√≠ guardamos Base64 o URL
                juryNotes: ui.artistNotes.value.trim(),
                updatedAt: new Date().toISOString()
            };

            if (!artistData.name) {
                showMessage('El nombre es obligatorio', 'error');
                return;
            }

            try {
                console.log('üíæ Guardando artista...', artistData.name);
                showMessage('Guardando...', 'info');
                
                if (currentArtistId) {
                    await updateDoc(doc(db, `events/${eventId}/artists`, currentArtistId), artistData);
                    showMessage('‚úÖ Artista y foto actualizados correctamente');
                } else {
                    artistData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, `events/${eventId}/artists`), artistData);
                    showMessage('‚úÖ Artista y foto creados correctamente');
                }
                
                closeModal();
                loadArtists();
                
            } catch (error) {
                console.error('Error saving artist:', error);
                showMessage('‚ùå Error al guardar: ' + error.message, 'error');
            }
        }

        // Funciones para manejo de fotos
        function handlePhotoFile(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('üìÅ Archivo seleccionado:', file.name);
                
                // Verificar tama√±o (m√°ximo 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showMessage('‚ùå La imagen es muy grande. M√°ximo 2MB.', 'error');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    console.log('‚úÖ Imagen convertida a Base64');
                    
                    // Mostrar preview
                    document.getElementById('photo-preview').src = base64;
                    document.getElementById('photo-preview').classList.remove('hidden');
                    document.getElementById('photo-placeholder').style.display = 'none';
                    
                    // Limpiar URL si hab√≠a algo
                    document.getElementById('photo-url').value = '';
                    
                    // Guardar en variable global para cuando se guarde
                    window.currentPhotoData = base64;
                    
                    showMessage('‚úÖ Foto cargada correctamente', 'success');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removePhoto() {
            console.log('üóëÔ∏è Removiendo foto');
            
            // Limpiar preview
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('photo-placeholder').style.display = 'flex';
            
            // Limpiar inputs
            document.getElementById('photo-file').value = '';
            document.getElementById('photo-url').value = '';
            
            // Limpiar variable global
            window.currentPhotoData = null;
            
            showMessage('üóëÔ∏è Foto removida', 'info');
        }
        
        function updatePhotoPreview() {
            const url = document.getElementById('photo-url').value.trim();
            if (url) {
                console.log('üåê Probando URL:', url);
                
                // Crear imagen temporal para validar
                const img = new Image();
                img.onload = function() {
                    console.log('‚úÖ URL v√°lida');
                    document.getElementById('photo-preview').src = url;
                    document.getElementById('photo-preview').classList.remove('hidden');
                    document.getElementById('photo-placeholder').style.display = 'none';
                    
                    // Limpiar archivo si hab√≠a algo
                    document.getElementById('photo-file').value = '';
                    
                    // Guardar URL para cuando se guarde
                    window.currentPhotoData = url;
                    
                    showMessage('‚úÖ Foto desde URL cargada', 'success');
                };
                img.onerror = function() {
                    console.log('‚ùå URL no v√°lida');
                    showMessage('‚ùå URL de imagen no v√°lida', 'error');
                };
                img.src = url;
            }
        }

        // Global functions
        window.editArtist = (id) => {
            const artist = artists.find(a => a.id === id);
            if (artist) openModal(artist);
        };

        window.deleteArtist = async (id) => {
            const artist = artists.find(a => a.id === id);
            if (!artist) return;
            
            if (confirm(`¬øEliminar a ${artist.name}?`)) {
                try {
                    await deleteDoc(doc(db, `events/${eventId}/artists`, id));
                    showMessage('‚úÖ Artista eliminado');
                    loadArtists();
                } catch (error) {
                    showMessage('‚ùå Error al eliminar', 'error');
                }
            }
        };

        // Event listeners
        ui.addArtistBtn.addEventListener('click', () => openModal());
        ui.cancelBtn.addEventListener('click', closeModal);
        ui.artistForm.addEventListener('submit', saveArtist);
        ui.testPhotoBtn.addEventListener('click', updatePhotoPreview);
        ui.photoUrl.addEventListener('input', updatePhotoPreview);
        
        // Event listeners para nuevas funciones de foto
        document.getElementById('photo-file').addEventListener('change', handlePhotoFile);
        document.getElementById('remove-photo-btn').addEventListener('click', removePhoto);

        // Initialize
        loadArtists();
    </script>
</body>
</html>