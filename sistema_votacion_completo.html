<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Completo de Votaci√≥n Jurados - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none !important; }
        .loading { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #38bdf8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* TARJETA DE ARTISTA */
        .artist-card { background-color: #1f2937; border: 2px solid #374151; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; transition: all 0.3s; }
        .artist-card:hover { border-color: #38bdf8; box-shadow: 0 8px 25px rgba(56, 189, 248, 0.15); }
        .artist-card.voted { border-color: #10b981; background-color: #064e3b; }
        
        /* CRITERIOS DE VOTACI√ìN */
        .criteria-section { background-color: #374151; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .criteria-title { color: #38bdf8; font-weight: bold; margin-bottom: 0.75rem; font-size: 1.1rem; }
        .rating-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; }
        .rating-btn { 
            padding: 0.75rem 0.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 2px solid transparent; 
            font-size: 0.9rem;
            min-height: 50px;
        }
        .rating-btn:hover { transform: scale(1.05); opacity: 0.9; }
        
        /* COLORES DE RATING */
        .rating-malo { background-color: #dc2626; color: white; }
        .rating-mediocre { background-color: #ea580c; color: white; }
        .rating-bueno { background-color: #eab308; color: white; }
        .rating-muy-bueno { background-color: #16a34a; color: white; }
        .rating-excelente { background-color: #059669; color: white; }
        
        /* SELECCIONADO */
        .rating-btn.selected { 
            border-color: #ffffff !important; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8) !important; 
            transform: scale(1.1) !important;
            position: relative !important;
        }
        .rating-btn.selected::after {
            content: '‚úì SELECCIONADO';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .rating-buttons { grid-template-columns: 1fr; }
            .artist-card { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- LOADING -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-white">Cargando sistema de votaci√≥n...</p>
        </div>
    </div>

    <!-- AUTENTICACI√ìN -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40">
        <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6 text-sky-400">üé§ Panel de Votaci√≥n - Jurado</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block mb-2 font-semibold text-gray-300">Nombre del Jurado</label>
                    <input type="text" id="juror-name" required 
                           class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 text-white" 
                           placeholder="Ingresa tu nombre">
                </div>
                <div>
                    <label class="block mb-2 font-semibold text-gray-300">Contrase√±a</label>
                    <input type="password" id="juror-password" required 
                           class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 text-white" 
                           placeholder="Ingresa tu contrase√±a">
                </div>
                <button type="submit" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">
                    Acceder al Sistema
                </button>
            </form>
            <div id="auth-error" class="mt-4 text-red-400 text-center hidden"></div>
            <div class="mt-4 text-xs text-gray-400 text-center">
                <p>üí° Usa las credenciales que te proporcion√≥ el organizador</p>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div id="main-content" class="hidden container mx-auto max-w-6xl p-4">
        <!-- HEADER -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-400 mb-2">üé§ Sistema de Votaci√≥n para Jurados</h1>
            <p id="event-name" class="text-xl text-gray-300 mb-2">Cargando evento...</p>
            <p id="juror-info" class="text-lg text-green-400">Cargando jurado...</p>
            <button id="logout-btn" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Cerrar Sesi√≥n
            </button>
        </header>

        <!-- ESTAD√çSTICAS -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">üìä Estado de Votaci√≥n</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-blue-700 p-4 rounded-lg">
                    <p class="text-2xl font-bold" id="total-artists">0</p>
                    <p class="text-sm">Artistas Totales</p>
                </div>
                <div class="bg-green-700 p-4 rounded-lg">
                    <p class="text-2xl font-bold" id="voted-artists">0</p>
                    <p class="text-sm">Ya Votados</p>
                </div>
                <div class="bg-yellow-700 p-4 rounded-lg">
                    <p class="text-2xl font-bold" id="pending-artists">0</p>
                    <p class="text-sm">Pendientes</p>
                </div>
            </div>
        </div>

        <!-- LISTA DE ARTISTAS -->
        <div id="artists-container">
            <h2 class="text-3xl font-bold mb-6 text-center">üé≠ Artistas Participantes</h2>
            <div id="artists-list">
                <div class="text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p>Cargando artistas...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // === CONFIGURACI√ìN FIREBASE ===
        import { db } from './firebase_config.js';
        import { collection, getDocs, query, orderBy, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURACI√ìN DEL SISTEMA ===
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        
        if (!eventId) {
            alert('‚ùå Error: No se especific√≥ el evento');
            window.location.href = 'panel_evento.html';
        }

        // === CONFIGURACI√ìN DE CRITERIOS Y PUNTAJES ===
        const CRITERIA = [
            { id: 'afinacion', name: 'üéµ Afinaci√≥n' },
            { id: 'puesta-escena', name: 'üé≠ Puesta en Escena' },
            { id: 'vestimenta', name: 'üëî Vestimenta' },
            { id: 'conexion-publico', name: 'üë• Conexi√≥n con el P√∫blico' },
            { id: 'eleccion-cancion', name: 'üé∂ Elecci√≥n de Canci√≥n' }
        ];

        const RATING_VALUES = {
            'malo': 20,
            'mediocre': 40,
            'bueno': 60,
            'muy-bueno': 80,
            'excelente': 100
        };

        // === VARIABLES GLOBALES ===
        let currentJuror = null;
        let artists = [];
        let eventData = null;
        let userVotes = {};

        // === ELEMENTOS DEL DOM ===
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            authModal: document.getElementById('auth-modal'),
            authForm: document.getElementById('auth-form'),
            authError: document.getElementById('auth-error'),
            jurorName: document.getElementById('juror-name'),
            jurorPassword: document.getElementById('juror-password'),
            mainContent: document.getElementById('main-content'),
            eventName: document.getElementById('event-name'),
            jurorInfo: document.getElementById('juror-info'),
            logoutBtn: document.getElementById('logout-btn'),
            totalArtists: document.getElementById('total-artists'),
            votedArtists: document.getElementById('voted-artists'),
            pendingArtists: document.getElementById('pending-artists'),
            artistsList: document.getElementById('artists-list')
        };

        // === FUNCIONES PRINCIPALES ===

        async function init() {
            console.log('üöÄ Iniciando sistema de votaci√≥n...');
            elements.loadingOverlay.classList.remove('hidden');
            
            try {
                await loadEventData();
                await loadArtistsFromFirebase();
                console.log('‚úÖ Sistema iniciado correctamente');
            } catch (error) {
                console.error('‚ùå Error al inicializar:', error);
                alert('Error al cargar el sistema: ' + error.message);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        async function loadEventData() {
            console.log('üìÑ Cargando datos del evento...');
            try {
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                if (eventDoc.exists()) {
                    eventData = eventDoc.data();
                    elements.eventName.textContent = eventData.name || 'Evento sin nombre';
                    console.log('‚úÖ Evento cargado:', eventData.name);
                } else {
                    throw new Error('Evento no encontrado');
                }
            } catch (error) {
                console.error('‚ùå Error cargando evento:', error);
                elements.eventName.textContent = 'Error al cargar evento';
            }
        }

        async function loadArtistsFromFirebase() {
            console.log('üé§ Cargando artistas desde Firebase...');
            elements.artistsList.innerHTML = '<div class="text-center"><div class="loading mx-auto mb-4"></div><p>Cargando artistas...</p></div>';
            
            try {
                const artistsSnapshot = await getDocs(query(collection(db, `events/${eventId}/artists`), orderBy('name')));
                
                artists = artistsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${artists.length} artistas cargados:`, artists.map(a => a.name));
                
                if (artists.length === 0) {
                    elements.artistsList.innerHTML = `
                        <div class="text-center p-8 bg-gray-800 rounded-lg">
                            <p class="text-red-400 text-xl mb-2">‚ùå No hay artistas registrados</p>
                            <p class="text-gray-400">Ve a "Gesti√≥n de Votaciones" para agregar artistas primero.</p>
                        </div>
                    `;
                    return;
                }

                renderArtists();
                updateStats();
                
            } catch (error) {
                console.error('‚ùå Error cargando artistas:', error);
                elements.artistsList.innerHTML = `
                    <div class="text-center p-8 bg-red-900 rounded-lg">
                        <p class="text-red-400 text-xl mb-2">‚ùå Error al cargar artistas</p>
                        <p class="text-gray-300">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderArtists() {
            console.log('üé® Renderizando artistas...');
            
            elements.artistsList.innerHTML = artists.map(artist => {
                const hasVoted = userVotes[artist.id];
                
                return `
                    <div class="artist-card ${hasVoted ? 'voted' : ''}" data-artist-id="${artist.id}">
                        <!-- INFORMACI√ìN DEL ARTISTA -->
                        <div class="flex items-center mb-6 p-4 bg-gray-700 rounded-lg">
                            <img src="${artist.photoURL || 'https://placehold.co/80x80/374151/f9fafb?text=' + artist.name.charAt(0)}" 
                                 alt="${artist.name}" 
                                 class="w-20 h-20 rounded-full object-cover border-4 border-sky-400 mr-4">
                            <div class="flex-grow">
                                <h3 class="text-2xl font-bold text-sky-300 mb-1">${artist.name}</h3>
                                <p class="text-gray-300">üéµ Participante del certamen</p>
                                ${hasVoted ? `
                                    <div class="mt-2 px-3 py-1 bg-green-700 rounded-full inline-block">
                                        <span class="text-green-200 text-sm font-bold">‚úì VOTADO - Promedio: ${hasVoted.average.toFixed(1)} pts</span>
                                    </div>
                                ` : `
                                    <div class="mt-2 px-3 py-1 bg-yellow-700 rounded-full inline-block">
                                        <span class="text-yellow-200 text-sm font-bold">‚è≥ PENDIENTE</span>
                                    </div>
                                `}
                            </div>
                        </div>

                        ${hasVoted ? `
                            <!-- VOTACI√ìN COMPLETADA -->
                            <div class="text-center p-6 bg-green-900 rounded-lg">
                                <h4 class="text-xl font-bold text-green-300 mb-4">‚úÖ Votaci√≥n Completada</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    ${CRITERIA.map(criteria => `
                                        <div class="bg-green-800 p-3 rounded">
                                            <p class="text-sm text-green-200">${criteria.name}</p>
                                            <p class="text-lg font-bold text-white">${hasVoted.scores[criteria.id]} pts</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <p class="text-xl font-bold text-green-200 mt-4">Promedio Final: ${hasVoted.average.toFixed(1)} puntos</p>
                                <button onclick="editVote('${artist.id}')" 
                                        class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    ‚úèÔ∏è Editar Votaci√≥n
                                </button>
                            </div>
                        ` : `
                            <!-- FORMULARIO DE VOTACI√ìN -->
                            <div class="space-y-6">
                                ${CRITERIA.map(criteria => `
                                    <div class="criteria-section" data-criteria="${criteria.id}">
                                        <h4 class="criteria-title">${criteria.name}</h4>
                                        <div class="rating-buttons">
                                            ${Object.entries(RATING_VALUES).map(([rating, value]) => `
                                                <button class="rating-btn rating-${rating}" 
                                                        onclick="selectRating('${artist.id}', '${criteria.id}', '${rating}', ${value})"
                                                        data-artist="${artist.id}" data-criteria="${criteria.id}" data-rating="${rating}">
                                                    ${rating.charAt(0).toUpperCase() + rating.slice(1).replace('-', ' ')}
                                                    <br><span class="text-xs">(${value} pts)</span>
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <div class="text-center pt-6">
                                    <button onclick="submitVote('${artist.id}')" 
                                            id="submit-${artist.id}"
                                            class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                            disabled>
                                        üó≥Ô∏è Enviar Votaci√≥n
                                    </button>
                                    <p class="text-sm text-gray-400 mt-2">Califica todos los criterios para habilitar el env√≠o</p>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            
            console.log('‚úÖ Artistas renderizados correctamente');
        }

        function updateStats() {
            const total = artists.length;
            const voted = Object.keys(userVotes).length;
            const pending = total - voted;

            elements.totalArtists.textContent = total;
            elements.votedArtists.textContent = voted;
            elements.pendingArtists.textContent = pending;
        }

        // === FUNCIONES GLOBALES PARA onClick ===
        
        window.selectRating = function(artistId, criteriaId, rating, value) {
            console.log(`üîò Seleccionando: ${rating} (${value} pts) para ${criteriaId} del artista ${artistId}`);
            
            // Quitar selecci√≥n previa
            const criteriaDiv = document.querySelector(`[data-artist-id="${artistId}"] [data-criteria="${criteriaId}"]`);
            if (!criteriaDiv) {
                console.error('‚ùå No se encontr√≥ el criterio:', criteriaId);
                return;
            }
            
            criteriaDiv.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Seleccionar nuevo bot√≥n
            const selectedBtn = criteriaDiv.querySelector(`[data-rating="${rating}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                console.log('‚úÖ Bot√≥n seleccionado correctamente');
                
                // Verificar si todos los criterios est√°n seleccionados
                checkAllCriteriaSelected(artistId);
            } else {
                console.error('‚ùå No se encontr√≥ el bot√≥n:', rating);
            }
        };

        window.submitVote = async function(artistId) {
            console.log(`üì§ Enviando voto para artista: ${artistId}`);
            
            const artist = artists.find(a => a.id === artistId);
            if (!artist) {
                alert('‚ùå Error: Artista no encontrado');
                return;
            }
            
            // Recopilar todas las puntuaciones
            const scores = {};
            let isValid = true;
            
            CRITERIA.forEach(criteria => {
                const selectedBtn = document.querySelector(`[data-artist-id="${artistId}"] [data-criteria="${criteria.id}"] .rating-btn.selected`);
                if (selectedBtn) {
                    const rating = selectedBtn.getAttribute('data-rating');
                    scores[criteria.id] = RATING_VALUES[rating];
                } else {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                alert('‚ùå Debes calificar todos los criterios');
                return;
            }
            
            // Calcular promedio
            const average = Object.values(scores).reduce((sum, score) => sum + score, 0) / Object.values(scores).length;
            
            try {
                // Guardar en Firebase
                const voteData = {
                    artistId: artistId,
                    artistName: artist.name,
                    jurorName: currentJuror.name,
                    scores: scores,
                    average: average,
                    timestamp: new Date().toISOString()
                };
                
                await setDoc(doc(db, `events/${eventId}/jury_votes`, `${currentJuror.id}_${artistId}`), voteData);
                
                // Guardar localmente
                userVotes[artistId] = { scores, average };
                
                console.log('‚úÖ Voto guardado exitosamente');
                alert(`‚úÖ Votaci√≥n enviada correctamente para ${artist.name}\nPromedio: ${average.toFixed(1)} puntos`);
                
                // Re-renderizar
                renderArtists();
                updateStats();
                
            } catch (error) {
                console.error('‚ùå Error al guardar voto:', error);
                alert('‚ùå Error al enviar la votaci√≥n: ' + error.message);
            }
        };

        window.editVote = function(artistId) {
            if (confirm('¬øEst√°s seguro de que quieres editar esta votaci√≥n?')) {
                delete userVotes[artistId];
                renderArtists();
                updateStats();
            }
        };

        function checkAllCriteriaSelected(artistId) {
            const allSelected = CRITERIA.every(criteria => {
                const criteriaDiv = document.querySelector(`[data-artist-id="${artistId}"] [data-criteria="${criteria.id}"]`);
                return criteriaDiv && criteriaDiv.querySelector('.rating-btn.selected');
            });
            
            const submitBtn = document.getElementById(`submit-${artistId}`);
            if (submitBtn) {
                submitBtn.disabled = !allSelected;
                submitBtn.style.opacity = allSelected ? '1' : '0.5';
            }
        }

        // === AUTENTICACI√ìN ===
        
        elements.authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = elements.jurorName.value.trim();
            const password = elements.jurorPassword.value.trim();
            
            if (!name || !password) {
                showAuthError('Por favor completa todos los campos');
                return;
            }
            
            try {
                // Buscar jurado en Firebase (implementaci√≥n simple)
                const jurorsSnapshot = await getDocs(collection(db, `events/${eventId}/jurors`));
                let foundJuror = null;
                
                jurorsSnapshot.docs.forEach(doc => {
                    const juror = doc.data();
                    if (juror.name.toLowerCase() === name.toLowerCase() && juror.password === password) {
                        foundJuror = { id: doc.id, ...juror };
                    }
                });
                
                if (foundJuror) {
                    currentJuror = foundJuror;
                    elements.jurorInfo.textContent = `üë®‚Äç‚öñÔ∏è Jurado: ${foundJuror.name}`;
                    elements.authModal.classList.add('hidden');
                    elements.mainContent.classList.remove('hidden');
                    
                    // Cargar votos previos
                    await loadPreviousVotes();
                    renderArtists();
                    updateStats();
                    
                    console.log('‚úÖ Autenticaci√≥n exitosa');
                } else {
                    showAuthError('Credenciales incorrectas');
                }
                
            } catch (error) {
                console.error('‚ùå Error en autenticaci√≥n:', error);
                showAuthError('Error al verificar credenciales');
            }
        });

        async function loadPreviousVotes() {
            try {
                const votesSnapshot = await getDocs(collection(db, `events/${eventId}/jury_votes`));
                votesSnapshot.docs.forEach(doc => {
                    const vote = doc.data();
                    if (vote.jurorName === currentJuror.name) {
                        userVotes[vote.artistId] = {
                            scores: vote.scores,
                            average: vote.average
                        };
                    }
                });
                console.log('‚úÖ Votos previos cargados:', Object.keys(userVotes).length);
            } catch (error) {
                console.error('‚ùå Error cargando votos previos:', error);
            }
        }

        function showAuthError(message) {
            elements.authError.textContent = message;
            elements.authError.classList.remove('hidden');
            setTimeout(() => {
                elements.authError.classList.add('hidden');
            }, 5000);
        }

        // === LOGOUT ===
        elements.logoutBtn.addEventListener('click', () => {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                currentJuror = null;
                userVotes = {};
                elements.authModal.classList.remove('hidden');
                elements.mainContent.classList.add('hidden');
                elements.authForm.reset();
            }
        });

        // === INICIALIZACI√ìN ===
        init();
    </script>
</body>
</html>