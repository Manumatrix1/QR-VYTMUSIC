<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ ESC√ÅNER VYTMUSIC - CORAZ√ìN DEL SISTEMA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #1e293b, #0f172a); 
            color: white; 
        }
        .hidden { display: none !important; }
        
        /* Esc√°ner pantalla completa */
        #scanner-area { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 50; 
        }
        #qr-reader { width: 100vw; height: 100vh; }
        
        /* Confirmaci√≥n MEGA VISIBLE con sonido */
        .confirmacion {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: flex; align-items: center; justify-content: center;
            text-align: center; pointer-events: none;
            animation: pulseConfirm 0.5s ease;
        }
        
        @keyframes pulseConfirm {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .exito { background: rgba(34, 197, 94, 0.95); }
        .usado { background: rgba(245, 158, 11, 0.95); }
        .error { background: rgba(239, 68, 68, 0.95); }
        
        /* Contadores grandes */
        .counter-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            border: 2px solid;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .counter-success { border-color: #22c55e; }
        .counter-warning { border-color: #f59e0b; }
        .counter-info { border-color: #3b82f6; }
        
        /* B√∫squeda manual */
        .search-result {
            padding: 15px; margin: 10px 0; border-radius: 10px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid #475569;
            cursor: pointer; transition: all 0.2s ease;
        }
        .search-result:hover {
            background: rgba(34, 197, 94, 0.3); border-color: #22c55e;
        }
        .search-result.usado {
            background: rgba(239, 68, 68, 0.2); cursor: not-allowed;
        }
        
        /* Estados de conexi√≥n */
        .status-online { color: #22c55e; }
        .status-offline { color: #f59e0b; }
        .status-error { color: #ef4444; }
        
        /* Artistas de la gala */
        .artist-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            border: 2px solid #475569;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .artist-card:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .artist-card.selected {
            border-color: #22c55e;
            background: linear-gradient(135deg, #16a34a, #15803d);
        }
        
        .artist-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .guest-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .guest-item:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        
        .guest-item.usado {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            cursor: not-allowed;
        }
        
        /* Botones grandes y claros */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            padding: 20px; font-size: 1.25rem; font-weight: bold;
            border-radius: 15px; transition: all 0.2s ease;
        }
        .btn-primary:hover { transform: scale(1.05); }
        
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
    </style>
</head>
<body>
    <!-- Panel principal -->
    <div id="main-panel" class="min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="text-3xl font-bold text-blue-400 mb-2">üéØ ESC√ÅNER VYTMUSIC</h1>
                <div class="flex justify-center items-center gap-4">
                    <div id="connection-status" class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                        <span class="status-offline">Verificando conexi√≥n...</span>
                    </div>
                    <div id="sync-status" class="text-sm">
                        <span>√öltima sync: <span id="last-sync">--:--</span></span>
                    </div>
                </div>
            </div>

            <!-- Contadores peque√±os arriba del esc√°ner -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button class="bg-blue-600 p-3 rounded-xl text-center">
                    <div class="text-lg font-bold" id="total-entradas">--</div>
                    <div class="text-xs">VENDIDAS</div>
                </button>
                <button class="bg-emerald-600 p-3 rounded-xl text-center">
                    <div class="text-lg font-bold" id="escaneadas">0</div>
                    <div class="text-xs">ESCANEADAS</div>
                </button>
                <button class="bg-orange-600 p-3 rounded-xl text-center">
                    <div class="text-lg font-bold" id="pendientes">--</div>
                    <div class="text-xs">PENDIENTES</div>
                </button>
            </div>

            <!-- Bot√≥n principal del esc√°ner -->
            <button id="start-scanner" class="w-full btn-primary btn-success text-white mb-6">
                üì± INICIAR ESC√ÅNER R√ÅPIDO (30fps)
            </button>

            <!-- Panel de b√∫squeda manual -->
            <div class="bg-slate-800 rounded-2xl p-6 mb-6">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">üîç B√öSQUEDA MANUAL (Backup QR)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <input type="text" id="search-artista" 
                               class="w-full p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-yellow-400 focus:outline-none" 
                               placeholder="Buscar ARTISTA por nombre...">
                    </div>
                    <div>
                        <input type="text" id="search-invitado" 
                               class="w-full p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-yellow-400 focus:outline-none" 
                               placeholder="Buscar INVITADO por nombre...">
                    </div>
                </div>
                <button id="show-all-list" class="w-full p-3 bg-yellow-600 text-white font-bold rounded-xl mb-4">
                    üìã MOSTRAR LISTA COMPLETA ALFAB√âTICA
                </button>
                <div id="search-results" class="max-h-80 overflow-y-auto">
                    <p class="text-gray-400 text-center py-4">Escribir nombre para buscar o mostrar lista completa...</p>
                </div>
            </div>

            <!-- Lista de Artistas por Gala -->
            <div class="bg-slate-800 rounded-2xl p-6 mb-6">
                <h3 class="text-xl font-bold text-blue-400 mb-4">üé§ ARTISTAS DE ESTA GALA</h3>
                <p class="text-sm text-gray-400 mb-4">Haz clic en un artista para ver sus invitados y marcar ingreso r√°pido</p>
                <div id="artists-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <p class="text-gray-400 text-center py-4 col-span-full">Cargando artistas...</p>
                </div>
                
                <!-- Panel expandido de invitados del artista -->
                <div id="artist-guests-panel" class="hidden mt-6 p-4 bg-slate-700 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h4 id="selected-artist-name" class="text-lg font-bold text-blue-300"></h4>
                        <button id="close-artist-panel" class="text-red-400 hover:text-red-300 text-xl">&times;</button>
                    </div>
                    <div id="artist-guests-list" class="max-h-60 overflow-y-auto space-y-2">
                        <!-- Los invitados del artista aparecer√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Crear entrada en puerta -->
            <div class="bg-slate-800 rounded-2xl p-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">‚ûï CREAR ENTRADA EN PUERTA</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="new-name" 
                           class="p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-emerald-400 focus:outline-none" 
                           placeholder="Nombre completo">
                    <select id="new-type" class="p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-emerald-400">
                        <option value="artista">üé§ Artista</option>
                        <option value="invitado">üë§ Invitado VIP</option>
                        <option value="prensa">üì∞ Prensa</option>
                        <option value="staff">‚öôÔ∏è Staff</option>
                    </select>
                    <select id="new-group" class="p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-emerald-400">
                        <option value="VIP">VIP</option>
                        <option value="General">General</option>
                        <option value="Backstage">Backstage</option>
                    </select>
                </div>
                <button id="create-entry" class="w-full p-4 btn-primary btn-success text-white">
                    ‚úÖ CREAR Y HABILITAR PARA VOTAR
                </button>
            </div>
        </div>
    </div>

    <!-- Esc√°ner pantalla completa -->
    <div id="scanner-area" class="hidden">
        <div id="qr-reader"></div>
        <div class="fixed bottom-4 left-4 right-4 flex gap-4 z-60">
            <button id="close-scanner" class="flex-1 p-4 bg-red-600 text-white font-bold rounded-xl">
                ‚ùå CERRAR
            </button>
            <button id="manual-search-btn" class="flex-1 p-4 bg-yellow-600 text-white font-bold rounded-xl">
                üîç B√öSQUEDA MANUAL
            </button>
        </div>
    </div>

    <!-- Confirmaciones con sonido -->
    <div id="confirmation" class="confirmacion hidden">
        <div id="confirmation-content" class="p-8 rounded-2xl max-w-md mx-auto">
        </div>
    </div>

    <!-- Audio para feedback -->
    <audio id="sound-success" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCTsAAA==" type="audio/wav">
    </audio>
    <audio id="sound-error" preload="auto">
        <source src="data:audio/wav;base64,UklGRt4CAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YboCAAC4uLi4QEBAQEBAuLi4uEBAQEBAQLi4uLhAQEBAQEC4uLi4QEBAQEBAuLi4uEBAQEBAQLi4uLhAQEBAQEC4uLi4QEBAQEBAuLi4uEBAQEBAQA==" type="audio/wav">
    </audio>

    <!-- Scripts -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script type="module">
        import { db } from './firebase_config.js';
        import { doc, getDoc, updateDoc, setDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        class CorazonDelSistema {
            constructor() {
                this.eventId = this.getEventId();
                this.html5QrCode = null;
                this.entradas = new Map();
                this.artistas = new Map(); // Agrupaci√≥n por artista/prefijo
                this.selectedArtist = null;
                this.escaneadasLocal = 0;
                this.totalEntradas = 0;
                this.connectionState = 'checking';
                this.lastSync = null;
                this.syncQueue = [];
                this.realTimeListener = null;
                
                this.init();
            }

            getEventId() {
                const params = new URLSearchParams(window.location.search);
                return params.get('eventId') || 'evento_' + new Date().getFullYear();
            }

            async init() {
                console.log('üéØ Iniciando CORAZ√ìN DEL SISTEMA...');
                this.setupEvents();
                await this.checkConnection();
                await this.loadEntradas();
                this.setupRealTimeSync();
                this.buildArtistsList();
                this.updateCounters();
                console.log('‚úÖ Sistema listo - Modo organizador autorizado');
            }

            setupEvents() {
                document.getElementById('start-scanner').onclick = () => this.startScanner();
                document.getElementById('close-scanner').onclick = () => this.stopScanner();
                document.getElementById('manual-search-btn').onclick = () => this.showManualSearch();
                document.getElementById('search-artista').oninput = (e) => this.searchEntradas(e.target.value, 'artista');
                document.getElementById('search-invitado').oninput = (e) => this.searchEntradas(e.target.value, 'invitado');
                document.getElementById('show-all-list').onclick = () => this.showCompleteList();
                document.getElementById('create-entry').onclick = () => this.createEntryAtDoor();
                document.getElementById('close-artist-panel').onclick = () => this.closeArtistPanel();
            }

            async checkConnection() {
                try {
                    await getDocs(collection(db, 'test').limit(1));
                    this.connectionState = 'online';
                    this.updateConnectionStatus('üü¢ CONECTADO', 'status-online');
                    console.log('üåê Conexi√≥n Firebase: OK');
                } catch (error) {
                    this.connectionState = 'offline';
                    this.updateConnectionStatus('üü° SIN CONEXI√ìN', 'status-offline');
                    console.log('üì± Modo offline activado');
                }
            }

            updateConnectionStatus(text, className) {
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = `
                    <div class="w-3 h-3 ${className === 'status-online' ? 'bg-green-400' : 'bg-yellow-400'} rounded-full ${className === 'status-online' ? '' : 'animate-pulse'}"></div>
                    <span class="${className}">${text}</span>
                `;
            }

            async loadEntradas() {
                try {
                    // BUSCAR EN LA COLECCI√ìN CORRECTA: events/{eventId}/tickets
                    const snapshot = await getDocs(collection(db, `events/${this.eventId}/tickets`));
                    let escaneadas = 0;
                    
                    snapshot.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        this.entradas.set(doc.id, data);
                        if (data.usado) escaneadas++;
                    });
                    
                    this.totalEntradas = this.entradas.size;
                    this.escaneadasLocal = escaneadas;
                    console.log(`üìä Cargadas ${this.totalEntradas} entradas, ${escaneadas} ya escaneadas`);
                    
                    // Si no hay entradas en la nueva estructura, buscar en la antigua por compatibilidad
                    if (this.totalEntradas === 0) {
                        console.log('üîÑ Buscando en estructura antigua...');
                        const oldSnapshot = await getDocs(collection(db, `entradas_${this.eventId}`));
                        escaneadas = 0;
                        
                        oldSnapshot.forEach(doc => {
                            const data = { id: doc.id, ...doc.data() };
                            this.entradas.set(doc.id, data);
                            if (data.usado) escaneadas++;
                        });
                        
                        this.totalEntradas = this.entradas.size;
                        this.escaneadasLocal = escaneadas;
                        console.log(`üìä [Estructura antigua] Cargadas ${this.totalEntradas} entradas, ${escaneadas} ya escaneadas`);
                    }
                } catch (error) {
                    console.log('üì± Error cargando entradas:', error);
                    this.totalEntradas = 0;
                }
            }

            setupRealTimeSync() {
                if (this.connectionState === 'online') {
                    try {
                        // ESCUCHAR LA COLECCI√ìN CORRECTA: events/{eventId}/tickets
                        this.realTimeListener = onSnapshot(
                            collection(db, `events/${this.eventId}/tickets`),
                            (snapshot) => {
                                let escaneadas = 0;
                                snapshot.forEach(doc => {
                                    const data = { id: doc.id, ...doc.data() };
                                    this.entradas.set(doc.id, data);
                                    if (data.usado) escaneadas++;
                                });
                                
                                this.totalEntradas = this.entradas.size;
                                this.escaneadasLocal = escaneadas;
                                this.buildArtistsList(); // Actualizar lista de artistas
                                this.updateCounters();
                                this.updateSyncTime();
                                console.log('üîÑ Sync autom√°tico completado');
                            }
                        );
                    } catch (error) {
                        console.log('‚ùå Error en sync en tiempo real:', error);
                    }
                }
            }

            updateCounters() {
                document.getElementById('total-entradas').textContent = this.totalEntradas;
                document.getElementById('escaneadas').textContent = this.escaneadasLocal;
                document.getElementById('pendientes').textContent = this.totalEntradas - this.escaneadasLocal;
            }

            updateSyncTime() {
                this.lastSync = new Date();
                document.getElementById('last-sync').textContent = this.lastSync.toLocaleTimeString();
            }

            async startScanner() {
                console.log('üì± Iniciando esc√°ner r√°pido...');
                document.getElementById('main-panel').classList.add('hidden');
                document.getElementById('scanner-area').classList.remove('hidden');

                this.html5QrCode = new Html5Qrcode("qr-reader");
                
                try {
                    await this.html5QrCode.start(
                        { facingMode: "environment" },
                        {
                            fps: 30, // M√ÅXIMA VELOCIDAD como MercadoLibre
                            qrbox: { width: 300, height: 300 }
                        },
                        (decodedText) => this.processCode(decodedText),
                        (error) => { /* silenciar errores */ }
                    );
                    console.log('üì± Esc√°ner iniciado a 30fps');
                } catch (error) {
                    alert('‚ùå Error: No se puede acceder a la c√°mara');
                    this.stopScanner();
                }
            }

            async stopScanner() {
                if (this.html5QrCode) {
                    await this.html5QrCode.stop();
                }
                document.getElementById('scanner-area').classList.add('hidden');
                document.getElementById('main-panel').classList.remove('hidden');
            }

            async processCode(code) {
                console.log(`üîç C√≥digo escaneado: ${code}`);
                
                const entrada = this.entradas.get(code);
                
                if (!entrada) {
                    this.showConfirmation('‚ùå', 'ENTRADA NO V√ÅLIDA', 'C√≥digo no encontrado', 'error');
                    this.playSound('error');
                    return;
                }

                if (entrada.usado) {
                    this.showConfirmation('‚ö†Ô∏è', 'YA INGRES√ì', `${entrada.nombre}<br>Ingres√≥: ${entrada.fechaIngreso ? new Date(entrada.fechaIngreso).toLocaleString() : 'Fecha desconocida'}`, 'usado');
                    this.playSound('error');
                    return;
                }

                // MARCAR COMO USADO INMEDIATAMENTE
                entrada.usado = true;
                entrada.fechaIngreso = new Date().toISOString();
                entrada.escaneadoPor = 'Organizador';
                
                this.escaneadasLocal++;
                this.updateCounters();

                // Guardar en Firebase (sin bloquear UI)
                this.saveToFirebase(code, entrada);

                // CONFIRMACI√ìN EXITOSA CON SONIDO
                this.showConfirmation('‚úÖ', 'ENTRADA V√ÅLIDA', `${entrada.nombre}<br>${entrada.tipo || 'Invitado'} - ${entrada.grupo || 'General'}`, 'exito');
                this.playSound('success');
                
                // Cerrar esc√°ner autom√°ticamente
                setTimeout(() => this.stopScanner(), 2000);
                
                console.log(`‚úÖ Entrada procesada: ${entrada.nombre}`);
            }

            async saveToFirebase(code, entrada) {
                if (this.connectionState === 'online') {
                    try {
                        // GUARDAR EN LA COLECCI√ìN CORRECTA: events/{eventId}/tickets
                        await updateDoc(doc(db, `events/${this.eventId}/tickets`, code), {
                            usado: true,
                            fechaIngreso: entrada.fechaIngreso,
                            escaneadoPor: entrada.escaneadoPor
                        });
                        console.log('üíæ Guardado en Firebase');
                    } catch (error) {
                        console.log('üì± Error guardando, agregado a cola de sync');
                        this.syncQueue.push({ code, entrada });
                    }
                } else {
                    this.syncQueue.push({ code, entrada });
                }
            }

            showCompleteList() {
                const results = document.getElementById('search-results');
                
                if (this.entradas.size === 0) {
                    results.innerHTML = '<p class="text-gray-400 text-center py-4">No hay entradas cargadas</p>';
                    return;
                }

                // Convertir a array y ordenar alfab√©ticamente
                const entradasArray = Array.from(this.entradas.values()).sort((a, b) => {
                    return a.nombre.localeCompare(b.nombre);
                });

                results.innerHTML = entradasArray.map(entrada => {
                    const estado = entrada.usado ? 'usado' : '';
                    const texto = entrada.usado ? '‚ùå YA INGRES√ì' : '‚úÖ MARCAR INGRESO';
                    const tipoEmoji = entrada.tipo === 'artista' ? 'üé§' : 'üë§';
                    const fechaIngreso = entrada.usado && entrada.fechaIngreso ? 
                        `<br><span class="text-xs">Ingres√≥: ${new Date(entrada.fechaIngreso).toLocaleString()}</span>` : '';
                    
                    return `
                        <div class="search-result ${estado}" onclick="corazon.processManual('${entrada.id}')">
                            <div class="font-bold text-lg">${tipoEmoji} ${entrada.nombre}</div>
                            <div class="text-sm text-gray-300">${entrada.tipo || 'Invitado'} - ${entrada.grupo || 'General'}${fechaIngreso}</div>
                            <div class="text-sm mt-1 ${entrada.usado ? 'text-red-400' : 'text-emerald-400'}">${texto}</div>
                        </div>
                    `;
                }).join('');
                
                console.log(`üìã Mostrando lista completa: ${entradasArray.length} entradas`);
            }

            searchEntradas(query, tipo) {
                const results = document.getElementById('search-results');
                
                if (!query || query.length < 1) {
                    results.innerHTML = '<p class="text-gray-400 text-center py-4">Escribir nombre para buscar o mostrar lista completa...</p>';
                    return;
                }

                const found = [];
                this.entradas.forEach(entrada => {
                    const matchesName = entrada.nombre && entrada.nombre.toLowerCase().includes(query.toLowerCase());
                    const matchesType = !tipo || entrada.tipo === tipo;
                    
                    if (matchesName && matchesType) {
                        found.push(entrada);
                    }
                });

                if (found.length === 0) {
                    results.innerHTML = `<p class="text-gray-400 text-center py-4">No se encontr√≥ "${query}" en ${tipo || 'entradas'}</p>`;
                    return;
                }

                // Ordenar resultados alfab√©ticamente
                found.sort((a, b) => a.nombre.localeCompare(b.nombre));

                results.innerHTML = found.map(entrada => {
                    const estado = entrada.usado ? 'usado' : '';
                    const texto = entrada.usado ? '‚ùå YA INGRES√ì' : '‚úÖ MARCAR INGRESO';
                    const tipoEmoji = entrada.tipo === 'artista' ? 'üé§' : 'üë§';
                    
                    return `
                        <div class="search-result ${estado}" onclick="corazon.processManual('${entrada.id}')">
                            <div class="font-bold text-lg">${tipoEmoji} ${entrada.nombre}</div>
                            <div class="text-sm text-gray-300">${entrada.tipo || 'Invitado'} - ${entrada.grupo || 'General'}</div>
                            <div class="text-sm mt-1 ${entrada.usado ? 'text-red-400' : 'text-emerald-400'}">${texto}</div>
                        </div>
                    `;
                }).join('');
                
                console.log(`üîç Encontrados ${found.length} resultados para "${query}"`);
            }

            async processManual(id) {
                const entrada = this.entradas.get(id);
                if (!entrada || entrada.usado) return;

                await this.processCode(id);
                
                // Limpiar b√∫squeda
                document.getElementById('search-artista').value = '';
                document.getElementById('search-invitado').value = '';
                document.getElementById('search-results').innerHTML = '<p class="text-gray-400 text-center py-4">Escribir nombre para buscar o mostrar lista completa...</p>';
            }

            async createEntryAtDoor() {
                const nombre = document.getElementById('new-name').value.trim();
                const tipo = document.getElementById('new-type').value;
                const grupo = document.getElementById('new-group').value;

                if (!nombre) {
                    alert('‚ùå Escribir el nombre completo');
                    return;
                }

                const id = 'puerta_' + Date.now();
                const nuevaEntrada = {
                    id,
                    nombre,
                    tipo,
                    grupo,
                    creadaEnPuerta: true,
                    fechaCreacion: new Date().toISOString(),
                    usado: false,
                    puedeVotar: true, // AUTOM√ÅTICO: PUEDE VOTAR
                    habilitadoPor: 'Organizador'
                };

                // Agregar localmente
                this.entradas.set(id, nuevaEntrada);
                this.totalEntradas++;
                this.updateCounters();

                // Guardar en Firebase
                if (this.connectionState === 'online') {
                    try {
                        // GUARDAR EN LA COLECCI√ìN CORRECTA: events/{eventId}/tickets
                        await setDoc(doc(db, `events/${this.eventId}/tickets`, id), nuevaEntrada);
                        
                        // TAMBI√âN HABILITAR PARA VOTAR
                        await setDoc(doc(db, `votantes_${this.eventId}`, id), {
                            nombre,
                            tipo,
                            grupo,
                            habilitado: true,
                            fechaHabilitacion: nuevaEntrada.fechaCreacion,
                            habilitadoPor: 'Organizador (Puerta)'
                        });
                        
                        console.log('üíæ Entrada creada y habilitada para votar');
                    } catch (error) {
                        console.log('üì± Entrada creada localmente');
                    }
                }

                this.showConfirmation('üéâ', 'ENTRADA CREADA', `${nombre}<br>${tipo} - ${grupo}<br>‚úÖ Ya puede votar`, 'exito');
                this.playSound('success');
                
                // Limpiar campos
                document.getElementById('new-name').value = '';
                document.getElementById('new-type').value = 'artista';
                document.getElementById('new-group').value = 'VIP';
            }

            showManualSearch() {
                this.stopScanner();
                document.getElementById('search-artista').focus();
            }

            showConfirmation(icono, titulo, detalle, tipo) {
                const confirmation = document.getElementById('confirmation');
                const content = document.getElementById('confirmation-content');
                
                content.innerHTML = `
                    <div class="text-8xl mb-6">${icono}</div>
                    <div class="text-4xl font-bold mb-4">${titulo}</div>
                    <div class="text-xl leading-relaxed">${detalle}</div>
                `;
                
                confirmation.className = `confirmacion ${tipo}`;
                confirmation.classList.remove('hidden');
                
                setTimeout(() => {
                    confirmation.classList.add('hidden');
                }, tipo === 'exito' ? 3000 : 2500);
            }

            playSound(type) {
                try {
                    const audio = document.getElementById(`sound-${type}`);
                    audio.currentTime = 0;
                    audio.play();
                } catch (error) {
                    console.log('üîá Audio no disponible');
                }
            }

            buildArtistsList() {
                this.artistas.clear();
                
                // Agrupar entradas por prefijo/artista
                this.entradas.forEach(entrada => {
                    const prefix = entrada.prefix || 'Sin_Grupo';
                    
                    if (!this.artistas.has(prefix)) {
                        this.artistas.set(prefix, {
                            nombre: entrada.artistName || prefix,
                            prefix: prefix,
                            entradas: [],
                            total: 0,
                            escaneadas: 0
                        });
                    }
                    
                    const grupo = this.artistas.get(prefix);
                    grupo.entradas.push(entrada);
                    grupo.total++;
                    if (entrada.usado) grupo.escaneadas++;
                });
                
                this.renderArtistsList();
            }

            renderArtistsList() {
                const container = document.getElementById('artists-list');
                
                if (this.artistas.size === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4 col-span-full">No hay artistas cargados</p>';
                    return;
                }

                // Convertir a array y ordenar por nombre
                const artistasArray = Array.from(this.artistas.values()).sort((a, b) => {
                    return a.nombre.localeCompare(b.nombre);
                });

                container.innerHTML = artistasArray.map(artista => {
                    const pendientes = artista.total - artista.escaneadas;
                    const porcentaje = artista.total > 0 ? Math.round((artista.escaneadas / artista.total) * 100) : 0;
                    
                    return `
                        <div class="artist-card" onclick="corazon.showArtistGuests('${artista.prefix}')">
                            <div class="artist-badge">${artista.total}</div>
                            <div class="text-lg font-bold text-blue-300 mb-2">üé§ ${artista.nombre}</div>
                            <div class="text-sm text-gray-300">
                                <div>‚úÖ ${artista.escaneadas} ingresaron</div>
                                <div>‚è≥ ${pendientes} pendientes</div>
                                <div class="text-xs mt-1 ${porcentaje === 100 ? 'text-green-400' : porcentaje > 50 ? 'text-yellow-400' : 'text-red-400'}">
                                    ${porcentaje}% completado
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log(`üé§ Lista de artistas actualizada: ${artistasArray.length} artistas`);
            }

            showArtistGuests(prefix) {
                const artista = this.artistas.get(prefix);
                if (!artista) return;

                this.selectedArtist = prefix;
                document.getElementById('selected-artist-name').textContent = `üé§ ${artista.nombre} (${artista.total} invitados)`;
                
                // Ordenar invitados por nombre
                const invitadosOrdenados = artista.entradas.sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                const guestsList = document.getElementById('artist-guests-list');
                guestsList.innerHTML = invitadosOrdenados.map(entrada => {
                    const estado = entrada.usado ? 'usado' : '';
                    const texto = entrada.usado ? '‚ùå YA INGRES√ì' : '‚úÖ MARCAR INGRESO';
                    const fechaIngreso = entrada.usado && entrada.fechaIngreso ? 
                        `<br><span class="text-xs text-gray-400">Ingres√≥: ${new Date(entrada.fechaIngreso).toLocaleString()}</span>` : '';
                    
                    return `
                        <div class="guest-item ${estado}" onclick="corazon.processManual('${entrada.id}')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-white">${entrada.nombre}</div>
                                    <div class="text-sm text-gray-300">${entrada.grupo || 'General'}${fechaIngreso}</div>
                                </div>
                                <div class="text-sm ${entrada.usado ? 'text-red-400' : 'text-emerald-400'} font-bold">
                                    ${texto}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Mostrar panel y actualizar estilos
                document.getElementById('artist-guests-panel').classList.remove('hidden');
                
                // Marcar tarjeta como seleccionada
                document.querySelectorAll('.artist-card').forEach(card => card.classList.remove('selected'));
                event.target.closest('.artist-card').classList.add('selected');
                
                console.log(`üë• Mostrando ${invitadosOrdenados.length} invitados de ${artista.nombre}`);
            }

            closeArtistPanel() {
                document.getElementById('artist-guests-panel').classList.add('hidden');
                document.querySelectorAll('.artist-card').forEach(card => card.classList.remove('selected'));
                this.selectedArtist = null;
            }
        }

        // Inicializar el coraz√≥n del sistema
        const corazon = new CorazonDelSistema();
        window.corazon = corazon; // Para acceso global
    </script>
</body>
</html>