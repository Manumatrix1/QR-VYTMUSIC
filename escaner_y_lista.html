<script type="module">
    import { db } from './firebase_config.js';
    import { collection, onSnapshot, query, doc, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- SIN CAMBIOS EN ESTA SECCIÓN ---
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventId');
    const eventName = urlParams.get('eventName');

    if (!eventId || !eventName) {
        alert('Error: No se ha especificado un evento.');
        window.location.href = 'eventos.html';
    }

    document.getElementById('back-to-panel-link').href = `panel_evento.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;
    
    let allTicketsData = [];
    let synth;

    try {
        synth = new Tone.Synth().toDestination();
    } catch(e) { console.warn("No se pudo inicializar el sintetizador de audio."); }

    function playSound(note) {
        if (synth) {
            Tone.start().then(() => synth.triggerAttackRelease(note, "8n"));
        }
    }

    function renderAllTickets(tickets) {
        const list = document.getElementById('all-tickets-list');
        if (!list) return;
        list.innerHTML = '';
        if (tickets.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400">No hay entradas generadas.</p>';
            return;
        }
        tickets.forEach(ticket => {
            const li = document.createElement('li');
            li.className = 'bg-gray-900 p-4 rounded-md flex justify-between items-center gap-4 flex-wrap';
            const paymentStatus = ticket.paymentStatus || 'Paga';
            const paymentClass = paymentStatus === 'Paga' ? 'bg-green-600' : 'bg-red-600';
            const actionButtonHTML = ticket.used ? `<button data-ticket-id="${ticket.id}" data-used="true" class="manual-check-in-btn px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded-lg">Anular Ingreso</button>` : `<button data-ticket-id="${ticket.id}" data-used="false" class="manual-check-in-btn px-3 py-1 bg-green-600 hover:bg-green-700 rounded-lg">Ingresar</button>`;
            li.innerHTML = `<div class="flex-grow"><p class="font-semibold">${ticket.name} <span class="text-gray-400 text-sm">(${ticket.prefix || 'N/A'})</span></p><p class="text-sm text-gray-500">${ticket.id}</p></div><div class="flex items-center gap-2 text-xs font-semibold flex-shrink-0"><span class="px-3 py-1 rounded-full ${paymentClass}">${paymentStatus}</span>${actionButtonHTML}<button data-ticket-id="${ticket.id}" title="Eliminar Entrada" class="delete-ticket-btn p-2 rounded-full bg-gray-700 hover:bg-red-700 text-white leading-none">X</button></div>`;
            list.appendChild(li);
        });
    }
    
    async function toggleTicketStatus(ticketId, isCurrentlyUsed) {
        const newUsedStatus = !isCurrentlyUsed;
        if (confirm(newUsedStatus ? `¿Marcar la entrada como USADA?` : `¿ANULAR el ingreso?`)) {
            const ticketRef = doc(db, `events/${eventId}/tickets`, ticketId);
            await updateDoc(ticketRef, { used: newUsedStatus, usedAt: newUsedStatus ? new Date().toISOString() : null });
        }
    }
    // --- FIN DE LA SECCIÓN SIN CAMBIOS ---


    // ==================================================================
    // ========= INICIO DE LA SECCIÓN DEL ESCÁNER CORREGIDA =========
    // ==================================================================

    // CAMBIO 1: La instancia del escáner se declara aquí para que sea única
    // y no se cree una nueva cada vez que se abre la cámara.
    let html5QrCode = null;
    let isScanning = false;

    // Función para reanudar el escáner de forma segura
    function resumeScanner() {
        const infoContainer = document.getElementById('scanned-ticket-info-fullscreen');
        infoContainer.classList.add('hidden');
        if (html5QrCode && !isScanning) {
            try {
                // El método resume() puede ser problemático, es más seguro llamar a start() de nuevo
                // con la misma configuración si ya está inicializado.
                // Sin embargo, para esta librería, pausar y reanudar es lo ideal.
                html5QrCode.resume();
                isScanning = true;
            } catch (e) {
                console.error("No se pudo reanudar el escáner.", e);
                // Si falla, intentamos reiniciar
                stopScanner();
                startScanner();
            }
        }
    }

    async function processScan(decodedText) {
        // Pausamos inmediatamente para procesar y evitar escaneos múltiples
        isScanning = false;
        html5QrCode.pause();
        
        const infoContainer = document.getElementById('scanned-ticket-info-fullscreen');
        const ticketRef = doc(db, `events/${eventId}/tickets`, decodedText);
        const ticketDoc = await getDoc(ticketRef);
        let status, colorClass, ticketData, sound;

        if (!ticketDoc.exists()) {
            status = 'ENTRADA INVÁLIDA';
            colorClass = 'text-red-400';
            sound = "C3";
            ticketData = { name: 'Desconocido' };
        } else {
            ticketData = { id: ticketDoc.id, ...ticketDoc.data() };
            if (ticketData.used) {
                status = 'YA UTILIZADA';
                colorClass = 'text-yellow-400';
                sound = "G3";
            } else {
                status = 'ENTRADA VÁLIDA';
                colorClass = 'text-green-400';
                sound = "C5";
                await updateDoc(ticketRef, { used: true, usedAt: new Date().toISOString() });
            }
        }

        playSound(sound);
        
        const flashOverlay = document.getElementById('scan-flash-overlay');
        const statusType = status.split(' ')[1].toLowerCase(); // invalida, utilizada, valida
        flashOverlay.className = `scan-flash ${statusType === 'inválida' ? 'invalid' : (statusType === 'utilizada' ? 'used' : 'valid')}`;
        flashOverlay.style.opacity = '1';
        setTimeout(() => { flashOverlay.style.opacity = '0'; }, 600);

        const paymentStatus = ticketData.paymentStatus || 'Paga';
        const paymentClass = paymentStatus === 'Paga' ? 'text-green-400' : 'text-red-400';
        
        // CAMBIO 2: Lógica de botones más clara y tiempo de reanudación más rápido
        let buttonHTML = '';
        if (status === 'ENTRADA VÁLIDA') {
            buttonHTML = '<p class="mt-4 text-gray-300 text-sm">Escaneando siguiente en 1 segundo...</p>';
            // Reanudación automática ultra rápida para agilizar el proceso
            setTimeout(resumeScanner, 800); // 800 milisegundos
        } else {
            // Botón claro para continuar manualmente
            buttonHTML = '<button id="scan-again-btn-internal" class="w-full mt-4 px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">Escanear Siguiente</button>';
        }

        infoContainer.innerHTML = `
            <h3 class="text-3xl font-bold ${colorClass}">${status}</h3>
            <div class="mt-4 text-left">
                <p><strong>Nombre:</strong> <span class="text-sky-300 font-semibold">${ticketData.name}</span></p>
                <p><strong>Pago:</strong> <span class="font-bold ${paymentClass}">${paymentStatus.toUpperCase()}</span></p>
            </div>
            ${buttonHTML}`;
        
        infoContainer.classList.remove('hidden');

        // Si se mostró el botón manual, le asignamos el evento
        if (status !== 'ENTRADA VÁLIDA') {
            document.getElementById('scan-again-btn-internal').addEventListener('click', resumeScanner);
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        if (isScanning) { // Solo procesar si estamos en estado de escaneo activo
            processScan(decodedText);
        }
    }

    function onScanFailure(error) {
        // Esta función se puede dejar vacía para que no muestre errores en la consola por cada cuadro que no detecta QR.
        // console.warn(`Code scan error = ${error}`);
    }

    function startScanner() {
        document.getElementById('fullscreen-scanner-container').classList.remove('hidden');

        // CAMBIO 3: Inicialización del escáner solo si es la primera vez
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("qr-code-reader", { 
                formatsToSupport: [ 
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128 
                ]
            });
        }
        
        // CAMBIO 4: Configuración optimizada y manejo de errores más robusto
        const config = { 
            fps: 20, // Aumentamos FPS para mayor fluidez
            qrbox: (viewfinderWidth, viewfinderHeight) => {
                let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                let qrboxSize = Math.floor(minEdge * 0.75); // Área de escaneo un poco más grande
                return {
                    width: qrboxSize,
                    height: qrboxSize
                };
            },
            aspectRatio: 1.0 // Ideal para cámaras de celular
        };
        
        if (!isScanning) {
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    isScanning = true;
                    console.log("Escáner iniciado correctamente.");
                })
                .catch(err => {
                    console.error("Error al iniciar escáner:", err);
                    alert("No se pudo iniciar la cámara. Asegúrate de haber dado los permisos necesarios y refresca la página.");
                    stopScanner(); // Asegurarse de cerrar todo si falla
                });
        }
    }

    function stopScanner() {
        if (html5QrCode && (isScanning || html5QrCode.isScanning)) {
            html5QrCode.stop()
                .then(() => {
                    isScanning = false;
                    console.log("Escáner detenido correctamente.");
                })
                .catch(err => {
                    console.error("Error al detener el escáner:", err);
                });
        }
        document.getElementById('fullscreen-scanner-container').classList.add('hidden');
        document.getElementById('scanned-ticket-info-fullscreen').classList.add('hidden');
    }

    // ================================================================
    // ========= FIN DE LA SECCIÓN DEL ESCÁNER CORREGIDA =========
    // ================================================================


    // --- SIN CAMBIOS EN ESTA SECCIÓN ---
    const ticketsQuery = query(collection(db, `events/${eventId}/tickets`));
    onSnapshot(ticketsQuery, (snapshot) => {
        allTicketsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name));
        renderAllTickets(allTicketsData);
        document.getElementById('total-tickets-summary').textContent = allTicketsData.length;
        const prefixCounts = allTicketsData.reduce((acc, ticket) => {
            const prefix = ticket.prefix || "Sin Grupo";
            acc[prefix] = (acc[prefix] || 0) + 1;
            return acc;
        }, {});
        const reportContainer = document.getElementById('assistant-report-container');
        reportContainer.innerHTML = '';
        Object.keys(prefixCounts).sort().forEach(prefix => {
            const card = document.createElement('div');
            card.className = 'artist-card';
            card.innerHTML = `<span class="font-semibold text-lg text-sky-300">${prefix}</span><span class="font-bold text-xl text-green-400">${prefixCounts[prefix]}</span>`;
            reportContainer.appendChild(card);
        });
    });

    document.getElementById('all-tickets-search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase().trim();
        const filtered = allTicketsData.filter(t => 
            t.name.toLowerCase().includes(term) || (t.prefix && t.prefix.toLowerCase().includes(term))
        );
        renderAllTickets(filtered);
    });

    document.getElementById('all-tickets-list').addEventListener('click', async (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        if (target.classList.contains('manual-check-in-btn')) {
            toggleTicketStatus(target.dataset.ticketId, target.dataset.used === 'true');
        }
        if (target.classList.contains('delete-ticket-btn')) {
            if(confirm("¿Seguro que quieres eliminar esta entrada?")) {
                await deleteDoc(doc(db, `events/${eventId}/tickets`, target.dataset.ticketId));
            }
        }
    });
    document.getElementById('open-scanner-btn').addEventListener('click', startScanner);
    document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
    // --- FIN DE LA SECCIÓN SIN CAMBIOS ---

</script>