<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Completo del Certamen - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none; }
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .podium-gold { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #1f2937; }
        .podium-silver { background: linear-gradient(135deg, #c0c0c0, #e5e7eb); color: #1f2937; }
        .podium-bronze { background: linear-gradient(135deg, #cd7f32, #d97706); color: white; }
        .crown-icon { font-size: 2rem; }
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
                                        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-6xl p-4 sm:p-6">
        <header class="text-center mb-8">
            <a href="reportes.html" class="no-print text-sky-400 hover:underline mb-4 inline-block">&larr; Volver a Reportes</a>
            <h1 class="text-4xl font-bold text-sky-400 mb-2">üèÜ Reporte Completo del Certamen</h1>
            <p class="text-lg text-gray-300 mb-2">Selecciona las galas que quieres incluir en el reporte final</p>
            <div class="bg-blue-900 bg-opacity-50 p-3 rounded-lg mb-4 border border-blue-400">
                <p class="text-sm text-blue-200">
                    üìä <strong>Importante:</strong> Este reporte se basa en las <strong>evaluaciones de los jurados</strong>, 
                    no en los votos del p√∫blico. Los puntajes se suman entre galas para determinar el ranking final.
                </p>
            </div>
            
            <div class="bg-yellow-900 bg-opacity-50 p-3 rounded-lg mb-6 border border-yellow-400">
                <p class="text-sm text-yellow-200">
                    ‚öñÔ∏è <strong>Sistema de Compensaci√≥n Manual:</strong> Despu√©s de generar el reporte inicial, 
                    podr√°s seleccionar manualmente a qu√© participantes aplicar un descuento de <strong>0.5 puntos</strong> 
                    por haber faltado a alguna gala. Esto garantiza control total sobre las penalizaciones.
                </p>
            </div>
        </header>

        <!-- SELECTOR DE GALAS PARA EL CERTAMEN -->
        <section id="gala-selector-section" class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">üéØ Configurar Reporte del Certamen</h2>
                

                
                <!-- FILTROS POR FECHA -->
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-bold mb-4">üìÖ Filtrar por Per√≠odo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">Desde:</label>
                            <input type="date" id="date-from" class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Hasta:</label>
                            <input type="date" id="date-to" class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600">
                        </div>
                        <div class="flex items-end">
                            <button id="apply-date-filter" class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">
                                üîç Filtrar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SELECTOR DE GALAS -->
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-bold mb-4">‚úÖ Seleccionar Galas para Incluir</h3>
                    <div id="galas-checkbox-container" class="space-y-3">
                        <p class="text-gray-400 text-center">Cargando galas disponibles...</p>
                    </div>
                </div>

                <!-- SELECTOR DE BONUS POR PARTICIPACI√ìN COMPLETA -->
                <div class="bg-green-800 bg-opacity-20 p-4 rounded-lg mb-6 border border-green-400" id="penalty-selector-section" style="display: none;">
                    <h3 class="text-lg font-bold text-green-300 mb-3">‚öñÔ∏è Selector de Bonus y Duplicaciones</h3>
                    <div class="bg-blue-900/30 border border-blue-500 rounded-lg p-4 mb-4">
                        <p class="text-blue-200 text-sm mb-2">
                            üìù <strong>Instrucciones:</strong>
                        </p>
                        <ul class="text-blue-200 text-sm space-y-1 ml-4">
                            <li>‚úÖ <strong class="text-green-400">Verde:</strong> Vino a todas las galas ‚Üí BONUS +0.5 puntos (pre-seleccionado)</li>
                            <li>üîÑ <strong class="text-yellow-400">Amarillo:</strong> Falt√≥ a 1 gala ‚Üí DUPLICAR promedio (t√∫ decides)</li>
                            <li>‚ùå <strong class="text-red-400">Rojo:</strong> Falt√≥ a 2+ galas ‚Üí NO ELEGIBLE</li>
                        </ul>
                    </div>
                    <div id="penalty-participants-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                    <div class="mt-4 text-center">
                        <button id="apply-bonuses-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                            ‚≠ê Aplicar Selecci√≥n y Generar Reporte
                        </button>
                        <button id="skip-bonus-btn" class="ml-3 px-6 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700">
                            ‚è≠Ô∏è Continuar Sin Modificaciones
                        </button>
                    </div>
                </div>

                <!-- BOTONES DE ACCI√ìN -->
                <div class="flex flex-wrap gap-4 justify-center">
                    <button id="select-all-galas" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                        ‚úÖ Seleccionar Todas
                    </button>
                    <button id="clear-all-galas" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                        ‚ùå Deseleccionar Todas
                    </button>
                    <button id="generate-report-btn" class="px-8 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        üìä Generar Reporte del Certamen
                    </button>
                </div>

                <div class="mt-4 text-center text-sm text-gray-400">
                    üí° Selecciona solo las galas del mismo certamen para obtener un reporte preciso
                </div>
            </div>
        </section>

        <!-- REPORTE GENERADO -->
        <div id="report-content" class="hidden">
            <!-- Informaci√≥n del Reporte -->
            <section class="mb-8">
                <div class="glass-effect p-6 rounded-lg text-center">
                    <h2 class="text-2xl font-bold mb-4">üìã Informaci√≥n del Reporte</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-400">Galas Incluidas</p>
                            <p id="included-galas-count" class="text-2xl font-bold text-sky-400">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Participantes</p>
                            <p id="total-participants" class="text-2xl font-bold text-green-400">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Per√≠odo</p>
                            <p id="report-period" class="text-sm font-bold text-yellow-400">-</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PODIUM FINAL DEL CERTAMEN -->
            <section class="mb-8">
                <div class="glass-effect p-6 rounded-lg">
                    <h2 id="podium-title" class="text-3xl font-bold mb-6 text-center text-yellow-400">üèÜ GANADORES OFICIALES</h2>
                    <p id="podium-subtitle" class="text-center text-gray-300 mb-8 text-lg">¬°Los campeones del certamen!</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="final-podium-container">
                        <!-- El podium final se llenar√° aqu√≠ -->
                    </div>
                </div>
            </section>

            <!-- BOTONES DE COMPARTIR Y ACCIONES -->
            <section class="mb-8">
                <div class="glass-effect p-6 rounded-lg text-center">
                    <h3 class="text-xl font-bold mb-6 text-green-400">üì± Compartir Resultados</h3>
                    <div class="mb-6">
                        <button onclick="generatePublicLink()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-8 rounded-xl text-lg mb-4" id="public-link-btn">
                            üîó GENERAR ENLACE P√öBLICO PARA ARTISTAS
                        </button>
                        <p class="text-sm text-gray-400 mb-6">üëÜ Crea un enlace directo solo con los resultados para compartir con los participantes</p>
                    </div>
                    
                    <div class="flex flex-wrap gap-4 justify-center mb-6">
                        <button onclick="shareResults()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2">
                            üì± Compartir en WhatsApp
                        </button>
                        <button onclick="copyResults()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2">
                            üìã Copiar Texto
                        </button>
                        <button onclick="printResults()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                    
                    <!-- RESUMEN SIMPLE PARA COMPARTIR -->
                    <div class="bg-gray-800 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-white mb-2">üìù Texto para Compartir:</h4>
                        <div id="share-text" class="text-left text-gray-300 text-sm whitespace-pre-wrap bg-gray-900 p-3 rounded">
                            <!-- Se llenar√° autom√°ticamente -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- RANKING COMPLETO DEL CERTAMEN -->
            <section class="mb-8">
                <div class="glass-effect p-6 rounded-lg">
                    <h2 id="ranking-title" class="text-2xl font-bold mb-6 text-center">üìä Ranking Completo del Certamen</h2>
                    <div id="final-ranking-container" class="space-y-4">
                        <!-- El ranking se llenar√° aqu√≠ -->
                    </div>
                </div>
            </section>

            <!-- ESTAD√çSTICAS DEL CERTAMEN -->
            <section class="mb-8">
                <div class="glass-effect p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6 text-center">üìà Estad√≠sticas del Certamen</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-lg text-center">
                            <div class="text-3xl mb-2">üé§</div>
                            <h3 class="text-lg font-semibold mb-2">Total Participantes</h3>
                            <p id="stats-participants" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-800 p-6 rounded-lg text-center">
                            <div class="text-3xl mb-2">üó≥Ô∏è</div>
                            <h3 class="text-lg font-semibold mb-2">Total Evaluaciones</h3>
                            <p id="stats-votes" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-6 rounded-lg text-center">
                            <div class="text-3xl mb-2">üé≠</div>
                            <h3 class="text-lg font-semibold mb-2">Galas Realizadas</h3>
                            <p id="stats-galas" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-600 to-yellow-800 p-6 rounded-lg text-center">
                            <div class="text-3xl mb-2">üìä</div>
                            <h3 class="text-lg font-semibold mb-2">Puntaje Promedio</h3>
                            <p id="stats-average" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AN√ÅLISIS POR GALA -->
            <section class="mb-8">
                <div class="glass-effect p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6 text-center">üìã Desglose por Gala</h2>
                    <div id="gala-breakdown-container" class="space-y-4">
                        <!-- El desglose se llenar√° aqu√≠ -->
                    </div>
                </div>
            </section>

            <!-- ACCIONES DEL REPORTE -->
            <section class="no-print mb-8">
                <div class="glass-effect p-6 rounded-lg text-center">
                    <h3 class="text-xl font-bold mb-4">ÔøΩ Acciones del Reporte</h3>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button id="export-final-pdf" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                            üìÑ Exportar PDF
                        </button>
                        <button id="export-final-excel" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                            ÔøΩ Exportar Excel
                        </button>
                        <button id="share-final-report" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                            üîó Compartir Reporte
                        </button>
                        <button id="new-report-btn" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700">
                            ÔøΩ Nuevo Reporte
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

        <!-- Estad√≠sticas Globales del Certamen -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">üìà Estad√≠sticas Globales del Certamen</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">üé™</div>
                        <h3 class="text-lg font-semibold mb-2">Total de Galas</h3>
                        <p id="total-galas" class="text-4xl font-bold">Cargando...</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-600 to-green-800 p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">üé§</div>
                        <h3 class="text-lg font-semibold mb-2">Artistas Participantes</h3>
                        <p id="total-unique-artists" class="text-4xl font-bold">Cargando...</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">üó≥Ô∏è</div>
                        <h3 class="text-lg font-semibold mb-2">Total de Votos</h3>
                        <p id="total-all-votes" class="text-4xl font-bold">Cargando...</p>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-600 to-yellow-800 p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">üë®‚Äç‚öñÔ∏è</div>
                        <h3 class="text-lg font-semibold mb-2">Jurados Participantes</h3>
                        <p id="total-jurors" class="text-4xl font-bold">Cargando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Campe√≥n y Finalistas -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">üëë GANADORES DEL CERTAMEN</h2>
                
                <!-- Campe√≥n -->
                <div class="mb-8">
                    <div id="champion-card" class="champion-card p-8 rounded-lg text-center shadow-2xl">
                        <div class="text-6xl mb-4">üëë</div>
                        <h3 class="text-3xl font-bold mb-2">CAMPE√ìN DEL CERTAMEN</h3>
                        <p id="champion-name" class="text-2xl font-bold mb-4">Cargando datos...</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-lg">
                            <div>
                                <span class="font-semibold">Puntaje Total:</span>
                                <div id="champion-score" class="text-2xl font-bold">--</div>
                            </div>
                            <div>
                                <span class="font-semibold">Galas Ganadas:</span>
                                <div id="champion-wins" class="text-2xl font-bold">--</div>
                            </div>
                            <div>
                                <span class="font-semibold">Participaciones:</span>
                                <div id="champion-participations" class="text-2xl font-bold">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finalistas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="second-place-card" class="finalist-card p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">ü•à</div>
                        <h4 class="text-xl font-bold mb-2">2do Lugar</h4>
                        <p id="second-place-name" class="text-lg font-semibold mb-2">Cargando...</p>
                        <p id="second-place-score" class="text-lg">Puntaje: --</p>
                    </div>
                    <div id="third-place-card" class="semifinalist-card p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">ü•â</div>
                        <h4 class="text-xl font-bold mb-2">3er Lugar</h4>
                        <p id="third-place-name" class="text-lg font-semibold mb-2">Cargando...</p>
                        <p id="third-place-score" class="text-lg">Puntaje: --</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- RANKING FINAL COMPLETO - MOVIDO AQU√ç PARA MEJOR ORDEN -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">üìã Ranking Final Completo</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="text-left py-4 px-4 font-bold">Posici√≥n</th>
                                <th class="text-left py-4 px-4 font-bold">Artista</th>
                                <th class="text-center py-4 px-4 font-bold">Puntaje Final</th>
                                <th class="text-center py-4 px-4 font-bold">Galas Participadas</th>
                                <th class="text-center py-4 px-4 font-bold">Galas Ganadas</th>
                                <th class="text-center py-4 px-4 font-bold">Promedio por Gala</th>
                                <th class="text-center py-4 px-4 font-bold">Mejor Posici√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="final-ranking-table">
                            <!-- Tabla se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Evoluci√≥n por Galas -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">üìä Evoluci√≥n de Artistas por Gala</h2>
                <div id="artist-evolution-container" class="space-y-6">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </section>

        <!-- Resumen por Galas -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">üé™ Resumen por Galas</h2>
                <div id="galas-summary-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </section>

        <!-- Estad√≠sticas Especiales -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">‚≠ê Estad√≠sticas Especiales</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 p-6 rounded-lg text-center">
                        <h4 class="text-lg font-bold mb-3">üî• M√°s Consistente</h4>
                        <p id="most-consistent" class="text-xl font-semibold">Calculando...</p>
                        <p class="text-sm opacity-80">Menor variaci√≥n entre posiciones</p>
                    </div>
                    <div class="bg-gradient-to-br from-pink-600 to-pink-800 p-6 rounded-lg text-center">
                        <h4 class="text-lg font-bold mb-3">üöÄ Mayor Progresi√≥n</h4>
                        <p id="most-improved" class="text-xl font-semibold">Calculando...</p>
                        <p class="text-sm opacity-80">Mejor evoluci√≥n entre galas</p>
                    </div>
                    <div class="bg-gradient-to-br from-teal-600 to-teal-800 p-6 rounded-lg text-center">
                        <h4 class="text-lg font-bold mb-3">üë®‚Äç‚öñÔ∏è M√°s Evaluado</h4>
                        <p id="public-favorite" class="text-xl font-semibold">Calculando...</p>
                        <p class="text-sm opacity-80">Mayor cantidad de evaluaciones de jurados</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-6 rounded-lg text-center relative">
                        <button onclick="editPublicFavorite()" class="absolute top-2 right-2 bg-white/20 hover:bg-white/30 rounded-lg px-3 py-1 text-xs" title="Editar manualmente">
                            ‚úèÔ∏è Editar
                        </button>
                        <h4 class="text-lg font-bold mb-3">üë• Favorito del P√∫blico</h4>
                        <p id="public-votes-favorite" class="text-xl font-semibold">Calculando...</p>
                        <p class="text-sm opacity-80">Mayor promedio de votos p√∫blicos</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-600 to-orange-800 p-6 rounded-lg text-center relative">
                        <button onclick="editTopSeller()" class="absolute top-2 right-2 bg-white/20 hover:bg-white/30 rounded-lg px-3 py-1 text-xs" title="Editar manualmente">
                            ‚úèÔ∏è Editar
                        </button>
                        <h4 class="text-lg font-bold mb-3">üéüÔ∏è M√°s Entradas Vendidas</h4>
                        <p id="top-seller" class="text-xl font-semibold">Calculando...</p>
                        <p class="text-sm opacity-80">Mayor cantidad de QR generados</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Certificaci√≥n Oficial -->
        <section class="mb-8 no-print">
            <div class="glass-effect p-6 rounded-lg text-center">
                <h2 class="text-2xl font-bold mb-4">üìú Certificaci√≥n Oficial</h2>
                <p class="text-gray-300 mb-6">Genera el certificado oficial con los resultados finales del certamen</p>
                <button id="generate-certificate-btn" class="px-8 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all text-lg">
                    üìú Generar Certificado Oficial
                </button>
            </div>
        </section>
    </div>

    <!-- Modal para Compartir Resultados -->
    <div id="share-results-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full mx-4">
            <h3 class="text-xl font-bold mb-4">üîó Compartir Resultados Finales</h3>
            <p class="mb-4 text-gray-300">Comparte los resultados oficiales del certamen:</p>
            <input type="text" id="share-results-url" class="w-full p-3 bg-gray-900 rounded-lg text-white mb-4" readonly>
            <div class="flex justify-end gap-4">
                <button id="copy-results-url-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">üìã Copiar</button>
                <button id="close-share-results-modal" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let allGalas = [];
        let selectedGalas = [];
        let reportData = {};

        // Elementos del DOM
        const galasCheckboxContainer = document.getElementById('galas-checkbox-container');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const selectAllBtn = document.getElementById('select-all-galas');
        const clearAllBtn = document.getElementById('clear-all-galas');
        const applyDateFilterBtn = document.getElementById('apply-date-filter');
        const dateFromInput = document.getElementById('date-from');
        const dateToInput = document.getElementById('date-to');
        const galaSelectorSection = document.getElementById('gala-selector-section');
        const reportContent = document.getElementById('report-content');
        const newReportBtn = document.getElementById('new-report-btn');

        // Cargar todas las galas disponibles
        async function loadAllGalas() {
            try {
                console.log('üîÑ Iniciando carga de galas...');
                
                // Verificar que Firebase est√© disponible
                if (!db) {
                    throw new Error('Firebase no est√° inicializado correctamente');
                }
                
                // Test de conectividad
                console.log('üîó Probando conexi√≥n a Firebase...');
                const testQuery = collection(db, 'events');
                if (!testQuery) {
                    throw new Error('No se puede crear consulta a Firebase');
                }
                
                console.log('üì° Consultando colecci√≥n events...');
                
                // Crear consulta con timeout
                const eventsPromise = getDocs(collection(db, 'events'));
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout: La consulta a Firebase tard√≥ m√°s de 15 segundos')), 15000)
                );
                
                const eventsSnapshot = await Promise.race([eventsPromise, timeoutPromise]);
                console.log(`üìä Encontrados ${eventsSnapshot.size} eventos en total`);
                
                allGalas = [];

                for (const eventDoc of eventsSnapshot.docs) {
                    const eventData = eventDoc.data();
                    console.log(`üé≠ Procesando evento: ${eventData.name} (ID: ${eventDoc.id})`);
                    
                    // Verificar si tiene artistas y votos
                    const artistsSnapshot = await getDocs(collection(db, `events/${eventDoc.id}/artists`));
                    console.log(`üë• Artistas encontrados: ${artistsSnapshot.size}`);
                    
                    if (artistsSnapshot.size > 0) {
                        // Calcular total de votos
                        let totalVotes = 0;
                        let totalScore = 0;
                        artistsSnapshot.docs.forEach(artistDoc => {
                            const artistData = artistDoc.data();
                            totalVotes += artistData.totalRatingsCount || 0;
                            totalScore += artistData.totalScore || 0;
                        });

                        // Verificar tambi√©n si hay evaluaciones de jurados
                        const jurySnapshot = await getDocs(collection(db, `events/${eventDoc.id}/jury_evaluations`));
                        const hasJuryEvaluations = jurySnapshot.size > 0;
                        
                        console.log(`üìä Evento ${eventData.name}: ${totalVotes} votos p√∫blicos, ${jurySnapshot.size} evaluaciones de jurados, ${artistsSnapshot.size} artistas`);
                        
                        // CRITERIO MODIFICADO: incluir cualquier gala que tenga artistas (pueden tener evaluaciones o no)
                        if (artistsSnapshot.size > 0) { // Incluir todas las galas que tengan artistas
                            
                            // üîç VERIFICAR QUE NO SEA DUPLICADA (por ID o nombre)
                            const isDuplicateById = allGalas.some(existingGala => existingGala.id === eventDoc.id);
                            const isDuplicateByName = allGalas.some(existingGala => 
                                existingGala.name.toLowerCase().trim() === eventData.name.toLowerCase().trim()
                            );
                            
                            if (isDuplicateById || isDuplicateByName) {
                                console.log(`‚ö†Ô∏è Gala duplicada ignorada: ${eventData.name} (ID: ${eventDoc.id})`);
                            } else {
                                allGalas.push({
                                    id: eventDoc.id,
                                    name: eventData.name,
                                    date: eventData.date,
                                    artistCount: artistsSnapshot.size,
                                    totalVotes: totalVotes,
                                    totalScore: totalScore,
                                    juryEvaluations: jurySnapshot.size,
                                    avgScore: totalVotes > 0 ? (totalScore / totalVotes).toFixed(1) : 0,
                                    hasData: true
                                });
                                console.log(`‚úÖ Gala incluida: ${eventData.name} (${artistsSnapshot.size} artistas, ${totalVotes} votos, ${jurySnapshot.size} evaluaciones)`);
                            }
                        } else {
                            console.log(`‚ö†Ô∏è Gala excluida (sin artistas): ${eventData.name}`);
                        }
                    }
                }

                // Ordenar por fecha m√°s reciente
                allGalas.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log(`‚úÖ Total de galas v√°lidas cargadas: ${allGalas.length}`);
                console.log('üìã Galas cargadas:', allGalas.map(g => `${g.name} (${g.artistCount} artistas, ${g.totalVotes} votos)`));
                
                if (allGalas.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontraron galas con datos v√°lidos');
                    galasCheckboxContainer.innerHTML = '<div class="text-center p-6"><p class="text-yellow-400 text-lg mb-2">‚ö†Ô∏è No se encontraron galas</p><p class="text-gray-400">Verifica que existan eventos con artistas y evaluaciones de jurados.</p></div>';
                    return;
                }
                
                renderGalasCheckboxes();
                
            } catch (error) {
                console.error('‚ùå Error cargando galas:', error);
                console.error('Stack trace:', error.stack);
                galasCheckboxContainer.innerHTML = `<div class="text-center p-6"><p class="text-red-400 text-lg mb-2">‚ùå Error al cargar galas</p><p class="text-gray-400">${error.message}</p></div>`;
                alert(`‚ùå Error cargando las galas: ${error.message}\n\nRevisa la consola del navegador para m√°s detalles.`);
            }
        }

        function renderGalasCheckboxes(filteredGalas = null) {
            console.log('üé® Renderizando galas...');
            
            // Verificar que el contenedor existe
            if (!galasCheckboxContainer) {
                console.error('‚ùå No se encontr√≥ el contenedor de galas');
                return;
            }
            
            const galasToShow = filteredGalas || allGalas;
            console.log(`üìã Galas a mostrar: ${galasToShow.length}`);
            console.log('üîç Array de galas:', galasToShow);
            
            // Limpiar contenedor
            galasCheckboxContainer.innerHTML = '';

            if (!galasToShow || galasToShow.length === 0) {
                console.warn('‚ö†Ô∏è No hay galas para mostrar');
                galasCheckboxContainer.innerHTML = '<p class="text-gray-400 text-center">No hay galas disponibles con los filtros aplicados</p>';
                return;
            }

            console.log('üîÑ Procesando cada gala...');
            galasToShow.forEach((gala, index) => {
                console.log(`üìù Renderizando gala ${index + 1}: ${gala.name}`);
                try {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    
                    // Validar datos de la gala
                    const galaName = gala.name || 'Gala Sin Nombre';
                    const galaDate = gala.date || 'Fecha no disponible';
                    const artistCount = gala.artistCount || 0;
                    const totalVotes = gala.totalVotes || 0;
                    const juryEvaluations = gala.juryEvaluations || 0;
                    const avgScore = gala.avgScore || '0.0';
                    
                    checkboxDiv.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" id="gala-${gala.id}" value="${gala.id}" class="mr-3 w-4 h-4">
                            <label for="gala-${gala.id}" class="cursor-pointer">
                                <div class="font-bold text-white">${galaName}</div>
                                <div class="text-sm text-gray-300">üìÖ ${galaDate} ‚Ä¢ üé§ ${artistCount} artistas</div>
                            </label>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-green-400 font-bold">${juryEvaluations > 0 ? juryEvaluations + ' evaluaciones jurados' : totalVotes + ' votos p√∫blicos'}</div>
                            <div class="text-gray-400">Promedio: ${avgScore}/10</div>
                        </div>
                    `;

                    const checkbox = checkboxDiv.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.addEventListener('change', updateSelectedGalas);
                    }

                    galasCheckboxContainer.appendChild(checkboxDiv);
                    console.log(`‚úÖ Gala ${galaName} renderizada correctamente`);
                    
                } catch (error) {
                    console.error(`‚ùå Error renderizando gala ${gala.name}:`, error);
                }
            });
            
            console.log(`‚úÖ Renderizado completo: ${galasToShow.length} galas procesadas`);
        }

        function updateSelectedGalas() {
            const checkboxes = galasCheckboxContainer.querySelectorAll('input[type="checkbox"]:checked');
            selectedGalas = Array.from(checkboxes).map(cb => cb.value);
            generateReportBtn.disabled = selectedGalas.length === 0;
            
            console.log(`Seleccionadas ${selectedGalas.length} galas`);
        }

        // Filtrar por fecha
        applyDateFilterBtn.addEventListener('click', function() {
            const dateFrom = dateFromInput.value;
            const dateTo = dateToInput.value;

            if (!dateFrom && !dateTo) {
                renderGalasCheckboxes(); // Mostrar todas
                return;
            }

            const filtered = allGalas.filter(gala => {
                const galaDate = new Date(gala.date);
                const fromDate = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
                const toDate = dateTo ? new Date(dateTo) : new Date('2099-12-31');
                
                return galaDate >= fromDate && galaDate <= toDate;
            });

            renderGalasCheckboxes(filtered);
            console.log(`Filtradas ${filtered.length} galas por fecha`);
        });

        // Botones de selecci√≥n
        selectAllBtn.addEventListener('click', function() {
            const checkboxes = galasCheckboxContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedGalas();
        });

        clearAllBtn.addEventListener('click', function() {
            const checkboxes = galasCheckboxContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedGalas();
        });

        // Generar reporte - Ahora muestra selector de bonus primero
        generateReportBtn.addEventListener('click', async function() {
            if (selectedGalas.length === 0) return;

            console.log('Mostrando selector de bonus antes del reporte...');
            
            try {
                // Primero cargar los datos para saber qui√©nes participaron
                await loadParticipantsForBonus();
                
                // Mostrar el selector de bonus
                showBonusSelector();
                
                // Deshabilitar bot√≥n hasta que se maneje el bonus
                generateReportBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Error cargando participantes:', error);
                alert('Error al cargar los participantes para el bonus');
            }
        });

        // üîß FUNCIONES PARA NORMALIZAR NOMBRES Y DETECTAR SIMILITUDES
        function normalizeArtistName(name) {
            if (!name) return '';
            return name
                .toLowerCase()
                .trim()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remover acentos
                .replace(/[^\w\s]/g, '') // Remover signos de puntuaci√≥n
                .replace(/\s+/g, ' '); // Normalizar espacios
        }

        function findSimilarName(targetName, existingNames, targetPhoto = null) {
            const normalized = normalizeArtistName(targetName);
            
            for (const existingName of existingNames) {
                const normalizedExisting = normalizeArtistName(existingName);
                
                // Coincidencia exacta despu√©s de normalizar (solo diferencias de capitalizaci√≥n/acentos)
                if (normalized === normalizedExisting) {
                    console.log(`‚úÖ Coincidencia exacta (capitalizaci√≥n): "${targetName}" ‚Üí "${existingName}"`);
                    return existingName;
                }
                
                // Para nombres muy similares, ser m√°s conservador
                const distance = levenshteinDistance(normalized, normalizedExisting);
                const lengthDiff = Math.abs(normalized.length - normalizedExisting.length);
                
                // Solo auto-unificar si es muy probable que sean iguales (1 car√°cter de diferencia m√°ximo)
                if (distance <= 1 && lengthDiff <= 1 && normalized.length > 3) {
                    console.log(`‚ö†Ô∏è Similitud muy alta: "${targetName}" ‚âà "${existingName}" (distancia: ${distance})`);
                    
                    // Agregar a la cola de confirmaciones
                    addToConfirmationQueue(targetName, existingName, targetPhoto);
                    return null; // No auto-unificar, esperar confirmaci√≥n
                }
            }
            
            return null;
        }

        // Cola de nombres similares que necesitan confirmaci√≥n
        let confirmationQueue = [];
        
        function addToConfirmationQueue(name1, name2, photo1 = null) {
            // Evitar duplicados en la cola
            const exists = confirmationQueue.find(item => 
                (item.name1 === name1 && item.name2 === name2) ||
                (item.name1 === name2 && item.name2 === name1)
            );
            
            if (!exists) {
                confirmationQueue.push({
                    name1: name1,
                    name2: name2,
                    photo1: photo1,
                    photo2: null // Se llenar√° cuando se procese
                });
            }
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // Nueva funci√≥n para cargar TODOS los participantes antes del selector de bonus
        async function loadParticipantsForBonus() {
            try {
                console.log('üöÄ Iniciando loadParticipantsForBonus...');
                
                reportData = {
                    galas: [],
                    allParticipants: new Map(),
                    totalVotes: 0,
                };

                console.log(`üîÑ Cargando TODOS los participantes de ${selectedGalas.length} galas para selector de bonus...`);

            // Cargar datos de todas las galas seleccionadas
            for (const galaId of selectedGalas) {
                try {
                    const gala = allGalas.find(g => g.id === galaId);
                    if (!gala) {
                        console.error(`‚ùå Gala no encontrada: ${galaId}`);
                        continue;
                    }
                    console.log(`üìä Procesando gala: ${gala.name} (${galaId})`);

                // üéØ CARGAR EVALUACIONES DE JURADOS
                const jurySnapshot = await getDocs(collection(db, `events/${galaId}/jury_evaluations`));
                const juryScores = {};
                
                // Procesar evaluaciones de jurados
                jurySnapshot.docs.forEach(juryDoc => {
                    const juryData = juryDoc.data();
                    const artistId = juryData.artistId;
                    const juryScore = juryData.average || juryData.score || 0;
                    
                    if (!juryScores[artistId]) {
                        juryScores[artistId] = [];
                    }
                    juryScores[artistId].push(juryScore);
                });

                // Cargar TODOS los artistas de esta gala
                const artistsSnapshot = await getDocs(collection(db, `events/${galaId}/artists`));
                
                const galaData = {
                    name: gala.name,
                    participants: []
                };

                // üî• PROCESAR TODOS LOS ARTISTAS (sin filtros)
                artistsSnapshot.docs.forEach(artistDoc => {
                    const artistData = artistDoc.data();
                    const artistJuryScores = juryScores[artistDoc.id] || [];
                    
                    // Calcular promedio de jurados (ser√° 0 si no tiene evaluaciones)
                    let juryAverage = 0;
                    if (artistJuryScores.length > 0) {
                        juryAverage = artistJuryScores.reduce((sum, score) => sum + score, 0) / artistJuryScores.length;
                    }
                    
                    // ‚úÖ INCLUIR TODOS LOS ARTISTAS
                    galaData.participants.push({
                        name: artistData.name,
                        score: juryAverage,
                        hasJuryVotes: artistJuryScores.length > 0,
                        juryDetails: artistJuryScores, // üìã DETALLES DE CADA JURADO
                        publicScore: artistData.totalScore || 0,
                        publicVotes: artistData.totalRatingsCount || 0
                    });

                    // üîç BUSCAR NOMBRE SIMILAR PARA UNIFICAR (EVITAR DUPLICADOS)
                    const existingNames = Array.from(reportData.allParticipants.keys());
                    const similarName = findSimilarName(artistData.name, existingNames, artistData.photoURL);
                    const finalName = similarName || artistData.name;
                    
                    if (similarName) {
                        console.log(`üîó Unificando: "${artistData.name}" con "${similarName}"`);
                    }

                    // ‚úÖ AGREGAR/ACTUALIZAR TODOS LOS ARTISTAS
                    if (reportData.allParticipants.has(finalName)) {
                        const existing = reportData.allParticipants.get(finalName);
                        existing.galas.push(gala.name);
                        existing.galaDetails[gala.name] = {
                            score: juryAverage,
                            juryCount: artistJuryScores.length,
                            juryDetails: artistJuryScores,
                            publicScore: artistData.totalScore || 0,
                            publicVotes: artistData.totalRatingsCount || 0,
                            participated: true, // ‚úÖ MARCADO COMO PARTICIPADO
                            votes: artistJuryScores.length
                        };
                        existing.totalScore += juryAverage;
                        existing.totalVotes++;
                        existing.hasJuryVotes = existing.hasJuryVotes || (artistJuryScores.length > 0);
                        // üë• SUMAR VOTOS DEL P√öBLICO
                        existing.totalPublicScore = (existing.totalPublicScore || 0) + (artistData.totalScore || 0);
                        existing.totalPublicVotes = (existing.totalPublicVotes || 0) + (artistData.totalRatingsCount || 0);
                    } else {
                        reportData.allParticipants.set(finalName, {
                            name: finalName,
                            galas: [gala.name],
                            galaDetails: {
                                [gala.name]: {
                                    score: juryAverage,
                                    juryCount: artistJuryScores.length,
                                    juryDetails: artistJuryScores,
                                    publicScore: artistData.totalScore || 0,
                                    publicVotes: artistData.totalRatingsCount || 0,
                                    participated: true, // ‚úÖ MARCADO COMO PARTICIPADO
                                    votes: artistJuryScores.length
                                }
                            },
                            totalScore: juryAverage,
                            totalVotes: 1,
                            finalScore: juryAverage,
                            bonus: 0,
                            bonusApplied: false,
                            hasJuryVotes: artistJuryScores.length > 0,
                            attendedAllGalas: false, // Se calcular√° despu√©s
                            // üë• VOTOS DEL P√öBLICO
                            totalPublicScore: artistData.totalScore || 0,
                            totalPublicVotes: artistData.totalRatingsCount || 0
                        });
                    }
                });

                reportData.galas.push(galaData);
                console.log(`‚úÖ ${gala.name}: Procesados ${galaData.participants.length} artistas`);
                
                } catch (galaError) {
                    console.error(`‚ùå Error procesando gala ${galaId}:`, galaError);
                    throw new Error(`Error en gala ${galaId}: ${galaError.message}`);
                }
            }

            // ‚ö†Ô∏è NO COMPENSAR GALAS FALTANTES TODAV√çA - Primero unificar nombres similares
            console.log(`üìä Artistas cargados: ${reportData.allParticipants.size}`);
            
            // üîç DEBUG: Mostrar lista completa de nombres ANTES de unificar
            const allNames = Array.from(reportData.allParticipants.keys()).sort();
            console.log('üîç LISTA de artistas ANTES de unificar:', allNames);
            
            console.log('‚úÖ Carga completada, verificando nombres similares...');
            
            // üîó PRIMERO: Mostrar confirmaciones y unificar nombres similares
            if (confirmationQueue.length > 0) {
                try {
                    console.log(`‚ö†Ô∏è Hay ${confirmationQueue.length} similitudes detectadas`);
                    await showSimilarNamesConfirmation();
                } catch (confirmError) {
                    console.error('‚ùå Error en confirmaci√≥n de nombres:', confirmError);
                    console.log('‚ö†Ô∏è Continuando sin unificar nombres similares');
                }
            }
            
            // üéØ DESPU√âS: Compensar galas faltantes (ahora que los nombres est√°n unificados)
            console.log('üéØ Iniciando compensaci√≥n de galas faltantes...');
            await compensateMissingGalas();
            
            console.log('‚úÖ loadParticipantsForBonus completado exitosamente');
            
        } catch (error) {
            console.error('‚ùå Error fatal en loadParticipantsForBonus:', error);
            alert(`Error al cargar los participantes para el bonus:\n\n${error.message}\n\nRevisa la consola para m√°s detalles.`);
            throw error; // Re-lanzar el error para que se muestre el alert
        }
    }

    // üÜï FUNCI√ìN SEPARADA PARA COMPENSAR GALAS FALTANTES
    async function compensateMissingGalas() {
        console.log(`üîß Iniciando compensaci√≥n para ${reportData.allParticipants.size} participantes...`);
        const totalGalas = selectedGalas.length;
        
        try {
            reportData.allParticipants.forEach((participant, participantName) => {
                try {
                    // üîß Verificar integridad de datos del participante
                    if (!participant.galas) participant.galas = [];
                    if (!participant.galaDetails) participant.galaDetails = {};
                    if (typeof participant.totalScore !== 'number') participant.totalScore = 0;
                    if (typeof participant.totalVotes !== 'number') participant.totalVotes = 0;
                    
                    const galasParticipadas = participant.galas.length;
                    const galasFaltantes = totalGalas - galasParticipadas;
                    
                    // Marcar si vino a todas las galas
                    participant.attendedAllGalas = (galasParticipadas === totalGalas);
                    
                    // Guardar cu√°ntas galas le faltaron (para el selector manual)
                    participant.missedGalas = galasFaltantes;
                    
                    if (galasFaltantes > 0) {
                        console.log(`üìä ${participantName}: Falt√≥ a ${galasFaltantes} galas. Esperando selecci√≥n manual.`);
                        
                        // Marcar galas faltantes sin duplicar nada
                        selectedGalas.forEach(galaId => {
                            const gala = allGalas.find(g => g.id === galaId);
                            if (!gala) return;
                            
                            if (!participant.galaDetails) {
                                participant.galaDetails = {};
                            }
                            if (!participant.galaDetails[gala.name]) {
                                participant.galaDetails[gala.name] = {
                                    score: 0,
                                    juryCount: 0,
                                    juryDetails: [],
                                    publicScore: 0,
                                    publicVotes: 0,
                                    missed: true,
                                    participated: false,
                                    repeated: false,
                                    votes: 0
                                };
                            }
                        });
                    }
                    
                    // üìä CALCULAR PROMEDIO INICIAL (sin duplicar nada autom√°ticamente)
                    // Dividir entre TOTAL de galas para que sea equitativo
                    participant.finalScore = totalGalas > 0 ? 
                        (participant.totalScore / totalGalas) : 0;
                    
                    // Guardar el promedio base para duplicar despu√©s si el usuario lo elige
                    participant.baseAverage = participant.totalVotes > 0 ?
                        (participant.totalScore / participant.totalVotes) : 0;
                        
                    console.log(`‚úÖ ${participantName}: Final=${participant.finalScore.toFixed(1)}, Galas=${participant.galas.length}/${totalGalas}`);
                    
                } catch (participantError) {
                    console.error(`‚ùå Error procesando participante ${participantName}:`, participantError);
                    // Continuar con el siguiente participante en lugar de fallar todo
                }
            });
            
            } catch (compensationError) {
                console.error('‚ùå Error en compensaci√≥n de galas:', compensationError);
                throw new Error(`Error compensando galas faltantes: ${compensationError.message}`);
            }

            console.log(`üìä Compensaci√≥n completada:`);
            console.log(`   - Total participantes: ${reportData.allParticipants.size}`);
            console.log(`   - Vinieron a todas las galas: ${Array.from(reportData.allParticipants.values()).filter(p => p.attendedAllGalas).length}`);
            console.log(`   - Faltaron a alguna gala: ${Array.from(reportData.allParticipants.values()).filter(p => !p.attendedAllGalas).length}`);
        }

        // Funci√≥n para mostrar di√°logo de confirmaci√≥n de nombres similares
        async function showSimilarNamesConfirmation() {
            if (confirmationQueue.length === 0) return;
            
            console.log(`ü§î Hay ${confirmationQueue.length} similitudes que requieren confirmaci√≥n`);
            
            for (const similarity of confirmationQueue) {
                const selectedName = await askUserAboutSimilarity(similarity);
                
                if (selectedName) {
                    // selectedName contiene el nombre que el usuario eligi√≥ mantener
                    const otherName = selectedName === similarity.name1 ? similarity.name2 : similarity.name1;
                    console.log(`‚úÖ Usuario seleccion√≥ mantener: "${selectedName}", unificando con: "${otherName}"`);
                    
                    // Unificar: mantener selectedName, eliminar otherName
                    unifyParticipantNames(selectedName, otherName);
                }
            }
            
            // Limpiar la cola despu√©s de procesar
            confirmationQueue = [];
        }

        function askUserAboutSimilarity(similarity) {
            return new Promise((resolve) => {
                // Obtener fotos si est√°n disponibles
                const participant1 = reportData.allParticipants.get(similarity.name1);
                const participant2 = reportData.allParticipants.get(similarity.name2);
                
                const photo1 = participant1?.photoURL || '';
                const photo2 = participant2?.photoURL || '';
                
                // Crear el di√°logo HTML MEJORADO con selecci√≥n de nombre
                const modalHTML = `
                    <div id="similarity-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                        <div style="background: #1f2937; padding: 30px; rounded: 15px; max-width: 700px; color: white; 
                             border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
                            <h3 style="color: #fbbf24; margin-bottom: 20px; text-align: center; font-size: 20px;">
                                ü§î ¬øSon la misma persona?
                            </h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                                <!-- OPCI√ìN 1 -->
                                <div id="option1" onclick="selectOption(1)" style="text-align: center; border: 3px solid #374151; border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                                    <div style="font-weight: bold; color: #60a5fa; margin-bottom: 10px; font-size: 18px;">${similarity.name1}</div>
                                    ${photo1 ? `<img src="${photo1}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: block;" onerror="this.style.display='none'">` : ''}
                                    <div style="font-size: 13px; color: #9ca3af; margin-top: 10px;">
                                        <strong>Galas:</strong> ${participant1?.galas?.join(', ') || 'N/A'}
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 8px; font-weight: bold; display: none;" id="selected1">
                                        ‚úÖ Nombre seleccionado
                                    </div>
                                </div>
                                
                                <!-- OPCI√ìN 2 -->
                                <div id="option2" onclick="selectOption(2)" style="text-align: center; border: 3px solid #374151; border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                                    <div style="font-weight: bold; color: #60a5fa; margin-bottom: 10px; font-size: 18px;">${similarity.name2}</div>
                                    ${photo2 ? `<img src="${photo2}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: block;" onerror="this.style.display='none'">` : ''}
                                    <div style="font-size: 13px; color: #9ca3af; margin-top: 10px;">
                                        <strong>Galas:</strong> ${participant2?.galas?.join(', ') || 'N/A'}
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 8px; font-weight: bold; display: none;" id="selected2">
                                        ‚úÖ Nombre seleccionado
                                    </div>
                                </div>
                            </div>
                            
                            <p style="text-align: center; margin-bottom: 20px; color: #d1d5db; font-size: 15px;">
                                üëÜ <strong>Si son la misma persona, haz clic en el nombre que quieres mantener</strong>
                            </p>
                            
                            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <button id="confirmBtn" onclick="confirmUnification()" disabled
                                        style="background: #6b7280; color: white; padding: 14px 28px; border: none; 
                                               border-radius: 8px; cursor: not-allowed; font-weight: bold; font-size: 15px; transition: all 0.3s;">
                                    ‚úÖ Confirmar Unificaci√≥n
                                </button>
                                <button onclick="respondSimilarity(null)" 
                                        style="background: #ef4444; color: white; padding: 14px 28px; border: none; 
                                               border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px;">
                                    ‚ùå No, son personas diferentes
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Variable para guardar la selecci√≥n
                let selectedOption = null;
                
                // Funci√≥n para seleccionar opci√≥n
                window.selectOption = (option) => {
                    selectedOption = option;
                    
                    // Resetear estilos
                    document.getElementById('option1').style.border = '3px solid #374151';
                    document.getElementById('option2').style.border = '3px solid #374151';
                    document.getElementById('selected1').style.display = 'none';
                    document.getElementById('selected2').style.display = 'none';
                    
                    // Marcar seleccionado
                    if (option === 1) {
                        document.getElementById('option1').style.border = '3px solid #10b981';
                        document.getElementById('selected1').style.display = 'block';
                    } else {
                        document.getElementById('option2').style.border = '3px solid #10b981';
                        document.getElementById('selected2').style.display = 'block';
                    }
                    
                    // Habilitar bot√≥n de confirmaci√≥n
                    const confirmBtn = document.getElementById('confirmBtn');
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#10b981';
                    confirmBtn.style.cursor = 'pointer';
                };
                
                // Funci√≥n para confirmar unificaci√≥n
                window.confirmUnification = () => {
                    if (selectedOption) {
                        const selectedName = selectedOption === 1 ? similarity.name1 : similarity.name2;
                        respondSimilarity(selectedName);
                    }
                };
                
                // Funci√≥n global para responder
                window.respondSimilarity = (selectedName) => {
                    document.getElementById('similarity-modal').remove();
                    delete window.respondSimilarity;
                    delete window.selectOption;
                    delete window.confirmUnification;
                    resolve(selectedName); // Devuelve el nombre seleccionado o null
                };
            });
        }

        function unifyParticipantNames(name1, name2) {
            console.log(`üîó Unificando manualmente: "${name1}" con "${name2}"`);
            
            const participant1 = reportData.allParticipants.get(name1);
            const participant2 = reportData.allParticipants.get(name2);
            
            if (participant1 && participant2) {
                console.log(`üìä Antes de unificar:`);
                console.log(`   ${name1}: ${participant1.galas.length} galas, score=${participant1.totalScore.toFixed(1)}`);
                console.log(`   ${name2}: ${participant2.galas.length} galas, score=${participant2.totalScore.toFixed(1)}`);
                
                // üîó COMBINAR DATOS DEL SEGUNDO PARTICIPANTE EN EL PRIMERO
                participant1.totalScore += participant2.totalScore;
                participant1.totalVotes += participant2.totalVotes;
                
                // Combinar galas (sin duplicados)
                const combinedGalas = [...new Set([...participant1.galas, ...participant2.galas])];
                participant1.galas = combinedGalas;
                
                // Combinar detalles de galas
                if (participant2.galaDetails) {
                    participant1.galaDetails = participant1.galaDetails || {};
                    Object.assign(participant1.galaDetails, participant2.galaDetails);
                }
                
                // Combinar flags
                participant1.hasJuryVotes = participant1.hasJuryVotes || participant2.hasJuryVotes;
                
                // üìä RECALCULAR PROMEDIO FINAL
                participant1.finalScore = participant1.totalVotes > 0 ? 
                    (participant1.totalScore / participant1.totalVotes) : 0;
                
                // ‚úÖ VERIFICAR SI AHORA TIENE PARTICIPACI√ìN COMPLETA
                const totalGalas = selectedGalas.length;
                participant1.attendedAllGalas = (participant1.galas.length === totalGalas);
                
                console.log(`üìä Despu√©s de unificar:`);
                console.log(`   ${name1}: ${participant1.galas.length} galas, score=${participant1.finalScore.toFixed(1)}`);
                console.log(`   Participaci√≥n completa: ${participant1.attendedAllGalas ? 'S√ç ‚úÖ' : 'NO ‚ùå'}`);
                console.log(`   Galas: ${participant1.galas.join(', ')}`);
                
                // Eliminar el segundo participante
                reportData.allParticipants.delete(name2);
                
                console.log(`‚úÖ Unificaci√≥n completada: "${name2}" ‚Üí "${name1}"`);
            } else {
                console.error(`‚ùå Error: No se encontraron los participantes para unificar`);
                if (!participant1) console.error(`   No se encontr√≥: ${name1}`);
                if (!participant2) console.error(`   No se encontr√≥: ${name2}`);
            }
        }

        async function generateCertamenReport() {
            reportData = {
                galas: [],
                allParticipants: new Map(),
                totalVotes: 0,
                totalScore: 0,
                period: { from: null, to: null }
            };

            console.log(`Procesando ${selectedGalas.length} galas seleccionadas`);

            // Procesar cada gala seleccionada
            for (const galaId of selectedGalas) {
                const gala = allGalas.find(g => g.id === galaId);
                console.log(`Procesando gala: ${gala.name}`);

                // Cargar artistas de esta gala
                const artistsSnapshot = await getDocs(collection(db, `events/${galaId}/artists`));
                const galaData = {
                    id: galaId,
                    name: gala.name,
                    date: gala.date,
                    participants: []
                };

                // üéØ CARGAR EVALUACIONES DE JURADOS (NO VOTOS DEL P√öBLICO)
                const jurySnapshot = await getDocs(collection(db, `events/${galaId}/jury_evaluations`));
                const juryScores = {};
                
                // Procesar evaluaciones de jurados
                jurySnapshot.docs.forEach(juryDoc => {
                    const juryData = juryDoc.data();
                    const artistId = juryData.artistId;
                    const juryScore = juryData.average || juryData.score || 0;
                    
                    if (!juryScores[artistId]) {
                        juryScores[artistId] = [];
                    }
                    juryScores[artistId].push(juryScore);
                });

                // üéüÔ∏è CARGAR QR GENERADOS (ENTRADAS VENDIDAS)
                const ticketsSnapshot = await getDocs(collection(db, `events/${galaId}/tickets`));
                const qrCounts = {};
                
                ticketsSnapshot.docs.forEach(ticketDoc => {
                    const ticketData = ticketDoc.data();
                    // Buscar el ID del artista en varios campos posibles
                    const artistId = ticketData.artistId || ticketData.selectedArtist;
                    
                    if (artistId) {
                        if (!qrCounts[artistId]) {
                            qrCounts[artistId] = 0;
                        }
                        qrCounts[artistId]++;
                    }
                });

                console.log(`üéüÔ∏è QR generados en ${gala.name}:`, qrCounts);

                artistsSnapshot.docs.forEach(artistDoc => {
                    const artistData = artistDoc.data();
                    
                    // üéØ CALCULAR PROMEDIO DE JURADOS PARA ESTE ARTISTA
                    const artistJuryScores = juryScores[artistDoc.id] || [];
                    const juryAverage = artistJuryScores.length > 0 
                        ? artistJuryScores.reduce((sum, score) => sum + score, 0) / artistJuryScores.length 
                        : 0;
                    
                    // üéüÔ∏è OBTENER CANTIDAD DE QR GENERADOS
                    const qrGenerated = qrCounts[artistDoc.id] || 0;
                    
                    const participantData = {
                        id: artistDoc.id,
                        name: artistData.name,
                        photoURL: artistData.photoURL,
                        score: juryAverage, // ‚úÖ USAR PROMEDIO DE JURADOS
                        votes: artistJuryScores.length, // ‚úÖ CANTIDAD DE JURADOS QUE EVALUARON
                        galaName: gala.name,
                        juryScores: artistJuryScores, // Para debugging
                        publicScore: artistData.totalScore || 0, // Mantener score p√∫blico por referencia
                        publicVotes: artistData.totalRatingsCount || 0,
                        qrCodesGenerated: qrGenerated // üéüÔ∏è Cantidad de entradas vendidas
                    };

                    console.log(`üé≠ ${artistData.name} en ${gala.name}: Jurados: ${juryAverage.toFixed(1)}/10 (${artistJuryScores.length} evaluaciones) | P√∫blico: ${participantData.publicScore} | QR: ${qrGenerated}`);

                    galaData.participants.push(participantData);
                    reportData.totalVotes += participantData.votes;
                    reportData.totalScore += participantData.score;

                    // üîç BUSCAR NOMBRE SIMILAR (normalizaci√≥n para evitar duplicados)
                    const existingNames = Array.from(reportData.allParticipants.keys());
                    const similarName = findSimilarName(artistData.name, existingNames, artistData.photoURL);
                    
                    // Usar el nombre similar si se encuentra, o el original si no
                    const finalName = similarName || artistData.name;
                    
                    if (similarName) {
                        console.log(`üîó Unificando "${artistData.name}" con "${similarName}"`);
                    }

                    // Acumular en el ranking general CON DETALLES POR GALA
                    if (reportData.allParticipants.has(finalName)) {
                        const existing = reportData.allParticipants.get(finalName);
                        existing.totalScore += participantData.score;
                        existing.totalVotes += participantData.votes;
                        existing.galas.push(gala.name);
                        // üéüÔ∏è ACUMULAR QR GENERADOS
                        existing.qrCodesGenerated = (existing.qrCodesGenerated || 0) + participantData.qrCodesGenerated;
                        // üìä GUARDAR DETALLES DE CADA GALA
                        existing.galaDetails = existing.galaDetails || {};
                        existing.galaDetails[gala.name] = {
                            score: participantData.score,
                            votes: participantData.votes,
                            participated: true
                        };
                        
                        // Actualizar el nombre a la versi√≥n m√°s com√∫n (mantener consistencia)
                        if (!similarName) {
                            existing.name = artistData.name; // Mantener formato original si no hay conflicto
                        }
                    } else {
                        reportData.allParticipants.set(finalName, {
                            name: finalName, // Usar el nombre unificado
                            photoURL: artistData.photoURL,
                            totalScore: participantData.score,
                            totalVotes: participantData.votes,
                            galas: [gala.name],
                            avgScore: 0,
                            qrCodesGenerated: participantData.qrCodesGenerated || 0, // üéüÔ∏è Inicializar contador de QR
                            // üìä GUARDAR DETALLES DE CADA GALA
                            galaDetails: {
                                [gala.name]: {
                                    score: participantData.score,
                                    votes: participantData.votes,
                                    participated: true
                                }
                            }
                        });
                    }
                });

                reportData.galas.push(galaData);
            }

            // üéØ COMPENSAR GALAS FALTANTES Y PREPARAR DATOS
            console.log(`üìä Total de galas seleccionadas: ${selectedGalas.length}`);
            
            reportData.allParticipants.forEach(participant => {
                // üîÑ COMPENSAR GALAS FALTANTES CON PROMEDIO REPETIDO
                const galasParticipadas = participant.galas.length;
                const galasFaltantes = selectedGalas.length - galasParticipadas;
                
                if (galasFaltantes > 0) {
                    const promedioActual = participant.totalVotes > 0 ? 
                        (participant.totalScore / participant.totalVotes) : 0;
                    
                    // Agregar score repetido por cada gala faltante
                    participant.totalScore += promedioActual * galasFaltantes;
                    participant.totalVotes += galasFaltantes;
                    
                    // Marcar galas faltantes en los detalles
                    selectedGalas.forEach(gala => {
                        if (!participant.galaDetails[gala.name]) {
                            participant.galaDetails[gala.name] = {
                                score: promedioActual,
                                votes: 1,
                                participated: false, // Marca que no particip√≥ realmente
                                repeated: true
                            };
                        }
                    });
                    
                    console.log(`üîÑ ${participant.name}: Compensado ${galasFaltantes} galas con promedio ${promedioActual.toFixed(1)}`);
                }
                
                // ‚úÖ INICIALIZAR CON SISTEMA DE BONUS
                participant.finalScore = participant.totalVotes > 0 ? 
                    (participant.totalScore / participant.totalVotes) : 0;
                participant.bonus = participant.bonus || 0;
                participant.bonusApplied = participant.bonusApplied || false;
                participant.avgScore = participant.finalScore;
                
                console.log(`üë§ ${participant.name}: Promedio final: ${participant.finalScore.toFixed(1)}/10`);
            });
            
            // Completar el procesamiento se hace despu√©s del bonus
            await completeReportGeneration();
        }

        // Funci√≥n para completar la generaci√≥n despu√©s del bonus
        async function completeReportGeneration() {
            console.log('üîÑ Completando generaci√≥n del reporte con los bonus aplicados...');

            // üìä INICIALIZAR ESTAD√çSTICAS GLOBALES
            reportData.totalVotes = 0;
            reportData.totalScore = 0;

            // üîÑ PROCESAR COMPENSACI√ìN PARA GALAS FALTANTES Y CALCULAR ESTAD√çSTICAS
            let totalVotesGlobal = 0;
            let totalScoreGlobal = 0;
            
            // Ordenar galas por fecha para proceso secuencial
            const galasOrdenadas = selectedGalas.map(galaId => ({
                id: galaId,
                name: allGalas.find(g => g.id === galaId)?.name,
                date: allGalas.find(g => g.id === galaId)?.date
            })).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            reportData.allParticipants.forEach(participant => {
                console.log(`üéØ Procesando compensaci√≥n para: ${participant.name}`);
                
                let ultimaPuntuacion = 0;
                let ultimaVotacion = 0;
                
                // Procesar cada gala en orden cronol√≥gico
                galasOrdenadas.forEach((gala, index) => {
                    const galaDetail = participant.galaDetails?.[gala.name];
                    
                    if (galaDetail && galaDetail.participated) {
                        // Particip√≥ en esta gala - usar su puntuaci√≥n real
                        ultimaPuntuacion = galaDetail.score;
                        ultimaVotacion = galaDetail.votes;
                        console.log(`‚úÖ ${participant.name} particip√≥ en ${gala.name}: ${ultimaPuntuacion.toFixed(1)}`);
                    } else {
                        // No particip√≥ - usar puntuaci√≥n de la gala anterior
                        if (index > 0 && ultimaPuntuacion > 0) {
                            participant.totalScore += ultimaPuntuacion;
                            participant.totalVotes += 1;
                            
                            if (!participant.galas.includes(gala.name)) {
                                participant.galas.push(gala.name);
                            }
                            
                            // Agregar detalles de compensaci√≥n
                            participant.galaDetails = participant.galaDetails || {};
                            participant.galaDetails[gala.name] = {
                                score: ultimaPuntuacion,
                                votes: 1,
                                participated: false,
                                repeated: true,
                                source: `Repetida de gala anterior`
                            };
                            
                            console.log(`üîÑ ${participant.name} falt√≥ a ${gala.name}: usando ${ultimaPuntuacion.toFixed(1)} (repetida)`);
                        } else if (index === 0) {
                            console.log(`‚ö†Ô∏è ${participant.name} falt√≥ a la primera gala ${gala.name} - sin puntuaci√≥n previa`);
                        }
                    }
                });

                // Calcular puntuaci√≥n final con bonus
                participant.finalScore = participant.totalVotes > 0 ? 
                    (participant.totalScore / participant.totalVotes) : 0;
                
                // Aplicar bonus si corresponde
                if (participant.bonusApplied) {
                    participant.finalScore += participant.bonus;
                }
                
                participant.avgScore = participant.finalScore;
                
                // üìä ACUMULAR PARA ESTAD√çSTICAS GLOBALES
                totalVotesGlobal += participant.totalVotes;
                totalScoreGlobal += participant.totalScore;
                
                console.log(`üë§ ${participant.name}: Final score ${participant.finalScore.toFixed(1)}/10 (Bonus: ${participant.bonusApplied ? '+' + participant.bonus : 'No'})`);
            });

            // üìä ACTUALIZAR ESTAD√çSTICAS GLOBALES
            reportData.totalVotes = totalVotesGlobal;
            reportData.totalScore = totalScoreGlobal;
            
            console.log(`üî¢ ESTAD√çSTICAS FINALES:`, {
                totalVotes: reportData.totalVotes,
                totalScore: reportData.totalScore,
                promedio: reportData.totalVotes > 0 ? (reportData.totalScore / reportData.totalVotes).toFixed(2) : 'N/A'
            });

            // Calcular per√≠odo
            const dates = selectedGalas.map(galaId => {
                const gala = allGalas.find(g => g.id === galaId);
                return new Date(gala.date);
            }).sort((a, b) => a - b);
            
            reportData.period = reportData.period || {};
            reportData.period.from = dates[0].toLocaleDateString('es-ES');
            reportData.period.to = dates[dates.length - 1].toLocaleDateString('es-ES');

            console.log(`‚úÖ Reporte completado con ${reportData.allParticipants.size} participantes`);
            
            // Generar la visualizaci√≥n final
            renderFinalReport();
        }

        function renderFinalReport() {
            // Detectar si es una sola gala o m√∫ltiples galas
            const isSingleGala = reportData.galas.length === 1;
            const galaName = isSingleGala ? reportData.galas[0].name : '';

            // Actualizar t√≠tulos seg√∫n el contexto
            if (isSingleGala) {
                document.getElementById('podium-title').textContent = `üèÜ PODIUM DE LA GALA: ${galaName}`;
                document.getElementById('podium-subtitle').textContent = '¬°Los ganadores de esta gala espec√≠fica!';
                document.getElementById('ranking-title').textContent = `üìä Ranking Completo de: ${galaName}`;
            } else {
                document.getElementById('podium-title').textContent = 'üèÜ PODIUM FINAL DEL CERTAMEN';
                document.getElementById('podium-subtitle').textContent = '¬°Los ganadores oficiales del certamen!';
                document.getElementById('ranking-title').textContent = 'üìä Ranking Completo del Certamen';
            }

            // Informaci√≥n general
            document.getElementById('included-galas-count').textContent = reportData.galas.length;
            document.getElementById('total-participants').textContent = reportData.allParticipants.size;
            document.getElementById('report-period').textContent = 
                reportData.period.from === reportData.period.to ? 
                reportData.period.from : 
                `${reportData.period.from} - ${reportData.period.to}`;

            // üìä ACTUALIZAR ESTAD√çSTICAS GLOBALES EN EL HTML
            const totalGalasEl = document.getElementById('total-galas');
            const totalArtistsEl = document.getElementById('total-unique-artists');
            const totalVotesEl = document.getElementById('total-all-votes');
            const totalJurorsEl = document.getElementById('total-jurors');
            
            if (totalGalasEl) totalGalasEl.textContent = reportData.galas.length || 0;
            if (totalArtistsEl) totalArtistsEl.textContent = reportData.allParticipants.size || 0;
            if (totalVotesEl) totalVotesEl.textContent = reportData.totalVotes || 0;
            
            // Calcular total de jurados √∫nicos (MEJORADO)
            const uniqueJurors = new Set();
            reportData.galas.forEach(gala => {
                selectedGalas.forEach(galaId => {
                    // Contar jurados por cada evaluaci√≥n registrada
                    reportData.allParticipants.forEach(participant => {
                        if (participant.galaDetails) {
                            Object.values(participant.galaDetails).forEach(detail => {
                                if (detail.juryCount > 0) {
                                    // Cada evaluaci√≥n cuenta como un jurado
                                    for (let i = 0; i < detail.juryCount; i++) {
                                        uniqueJurors.add(`jurado-${Math.random()}`); // Contar cada evaluaci√≥n
                                    }
                                }
                            });
                        }
                    });
                });
            });
            
            // Total de evaluaciones de jurados
            let totalJuryEvaluations = 0;
            reportData.allParticipants.forEach(participant => {
                if (participant.galaDetails) {
                    Object.values(participant.galaDetails).forEach(detail => {
                        totalJuryEvaluations += detail.juryCount || 0;
                    });
                }
            });
            
            if (totalJurorsEl) totalJurorsEl.textContent = totalJuryEvaluations || 0;
            
            console.log(`üìä Estad√≠sticas Globales actualizadas:`, {
                galas: reportData.galas.length,
                artistas: reportData.allParticipants.size,
                evaluaciones: reportData.totalVotes,
                jurados: uniqueJurors.size
            });

            // Estad√≠sticas con validaci√≥n (IDs antiguos por compatibilidad)
            const statsParticipants = document.getElementById('stats-participants');
            const statsVotes = document.getElementById('stats-votes');
            const statsGalas = document.getElementById('stats-galas');
            const statsAverage = document.getElementById('stats-average');
            
            if (statsParticipants) statsParticipants.textContent = reportData.allParticipants.size || 0;
            if (statsVotes) statsVotes.textContent = reportData.totalVotes || 0;
            if (statsGalas) statsGalas.textContent = reportData.galas.length || 0;
            if (statsAverage) {
                const average = reportData.totalVotes > 0 ? (reportData.totalScore / reportData.totalVotes).toFixed(1) : '0.0';
                statsAverage.textContent = average;
            }
            
            console.log(`üìä Estad√≠sticas actualizadas:`, {
                participantes: reportData.allParticipants.size,
                evaluaciones: reportData.totalVotes,
                galas: reportData.galas.length,
                promedio: reportData.totalVotes > 0 ? (reportData.totalScore / reportData.totalVotes).toFixed(1) : '0.0'
            });

            // Ranking final (convertir Map a Array y ordenar por finalScore)
            const finalRanking = Array.from(reportData.allParticipants.values())
                .sort((a, b) => b.finalScore - a.finalScore);

            console.log('üèÜ Generando ranking final con', finalRanking.length, 'participantes');
            console.log('ü•á Campe√≥n:', finalRanking[0]?.name, 'con', finalRanking[0]?.finalScore?.toFixed(1));

            try {
                renderFinalPodium(finalRanking);
                console.log('‚úÖ Podio renderizado correctamente');
            } catch (error) {
                console.error('‚ùå Error renderizando podio:', error);
            }
            
            try {
                renderFinalRanking(finalRanking);
                console.log('‚úÖ Ranking completo renderizado correctamente');
            } catch (error) {
                console.error('‚ùå Error renderizando ranking:', error);
            }
            
            try {
                renderGalaBreakdown();
                console.log('‚úÖ Desglose por gala renderizado correctamente');
            } catch (error) {
                console.error('‚ùå Error renderizando desglose por gala:', error);
            }
            
            try {
                calculateSpecialStats(finalRanking);
                console.log('‚úÖ Estad√≠sticas especiales calculadas correctamente');
            } catch (error) {
                console.error('‚ùå Error calculando estad√≠sticas especiales:', error);
            }
        }

        function renderFinalPodium(ranking) {
            // üèÜ ACTUALIZAR ELEMENTOS ANTIGUOS DEL CAMPE√ìN
            if (ranking.length > 0) {
                const champion = ranking[0];
                const second = ranking[1];
                const third = ranking[2];
                
                // Actualizar campe√≥n
                document.getElementById('champion-name').textContent = champion.name;
                document.getElementById('champion-score').textContent = champion.finalScore.toFixed(1);
                document.getElementById('champion-wins').textContent = champion.galas.length;
                document.getElementById('champion-participations').textContent = champion.galas.length;
                
                // Actualizar segundo lugar
                if (second) {
                    document.getElementById('second-place-name').textContent = second.name;
                    document.getElementById('second-place-score').textContent = `Puntaje: ${second.finalScore.toFixed(1)}`;
                }
                
                // Actualizar tercer lugar
                if (third) {
                    document.getElementById('third-place-name').textContent = third.name;
                    document.getElementById('third-place-score').textContent = `Puntaje: ${third.finalScore.toFixed(1)}`;
                }
            }
            
            // üèÜ RENDERIZAR NUEVO PODIO EN EL CONTENEDOR
            const container = document.getElementById('final-podium-container');
            container.innerHTML = '';

            const podiumColors = ['bg-gradient-to-b from-yellow-400 to-yellow-600', 'bg-gradient-to-b from-gray-300 to-gray-500', 'bg-gradient-to-b from-orange-400 to-orange-600'];
            const crowns = ['üëë', 'ü•à', 'ü•â'];
            const positions = ['1ER LUGAR', '2DO LUGAR', '3ER LUGAR'];
            const textColors = ['text-yellow-900', 'text-gray-900', 'text-orange-900'];

            for (let i = 0; i < Math.min(3, ranking.length); i++) {
                const participant = ranking[i];
                const podiumCard = document.createElement('div');
                podiumCard.className = `${podiumColors[i]} p-8 rounded-2xl text-center shadow-2xl transform hover:scale-105 transition-transform`;
                
                podiumCard.innerHTML = `
                    <div class="text-6xl mb-4">${crowns[i]}</div>
                    <h3 class="text-2xl font-bold mb-4 ${textColors[i]}">${positions[i]}</h3>
                    <div class="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden border-4 border-white shadow-lg">
                        <img src="${participant.photoURL || 'https://placehold.co/96x96/1f2937/f9fafb?text=ART'}" 
                             alt="${participant.name}" class="w-full h-full object-cover">
                    </div>
                    <h4 class="text-xl font-bold mb-2 ${textColors[i]}">${participant.name}</h4>
                    <div class="text-3xl font-bold mb-2 ${textColors[i]}">${participant.finalScore.toFixed(1)}/10</div>
                    ${participant.bonusApplied ? 
                        `<p class="text-sm font-semibold ${textColors[i]}">‚≠ê Con bonus de participaci√≥n</p>` : 
                        `<p class="text-sm ${textColors[i]} opacity-70">Sin bonus</p>`
                    }
                `;
                
                container.appendChild(podiumCard);
            }
            
            // Generar texto para compartir
            generateShareText(ranking);
        }

        function renderFinalRanking(ranking) {
            const container = document.getElementById('final-ranking-container');
            if (!container) {
                console.error('‚ùå Contenedor final-ranking-container no encontrado');
                return;
            }
            container.innerHTML = '';

            // Verificar que tenemos datos
            if (!reportData.galas || reportData.galas.length === 0) {
                container.innerHTML = '<p class="text-red-400 text-center p-4">‚ö†Ô∏è No hay datos de galas disponibles</p>';
                return;
            }

            // üèÜ TABLA SIMPLIFICADA Y CLARA
            const tableHTML = `
                <div class="mb-6 text-center">
                    <h3 class="text-xl font-bold text-green-400 mb-2">üìã Posiciones Oficiales</h3>
                    <p class="text-gray-400 text-sm">Todos los participantes ordenados por puntuaci√≥n final</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full bg-gray-800 rounded-xl overflow-hidden shadow-2xl">
                        <thead class="bg-gradient-to-r from-purple-700 to-blue-700">
                            <tr>
                                <th class="px-4 py-4 text-left text-white font-bold">üèÖ Pos</th>
                                <th class="px-4 py-4 text-left text-white font-bold">üé§ Artista</th>
                                ${reportData.galas.map(gala => `
                                    <th class="px-2 py-4 text-center text-white font-bold text-sm bg-blue-800/50">${gala.name.substring(0, 20)}</th>
                                `).join('')}
                                <th class="px-3 py-4 text-center text-white font-bold bg-purple-800">üìä Jurados</th>
                                <th class="px-3 py-4 text-center text-white font-bold bg-green-800">üèÜ Final</th>
                                <th class="px-3 py-4 text-center text-white font-bold">‚≠ê</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ranking.map((participant, index) => {
                                const position = index + 1;
                                const positionBadge = index < 3 ? 
                                    ['ü•á 1¬∞', 'ü•à 2¬∞', 'ü•â 3¬∞'][index] : 
                                    `${position}¬∞`;
                                
                                const positionColor = index === 0 ? 'text-yellow-400 bg-yellow-900/30' : 
                                                     index === 1 ? 'text-gray-300 bg-gray-700/30' : 
                                                     index === 2 ? 'text-orange-400 bg-orange-900/30' : 
                                                     index < 10 ? 'text-blue-300 bg-blue-900/20' : 'text-white';
                                
                                // Calcular total de evaluaciones de jurados
                                let totalJuryEvaluations = 0;
                                if (participant.galaDetails) {
                                    Object.values(participant.galaDetails).forEach(gala => {
                                        totalJuryEvaluations += gala.juryCount || 0;
                                    });
                                }
                                
                                // Generar columnas por gala
                                const galaScores = reportData.galas.map(gala => {
                                    const galaDetail = participant.galaDetails?.[gala.name];
                                    if (galaDetail) {
                                        // üéØ MOSTRAR SCORE CORRECTO SEG√öN SI PARTICIP√ì O NO
                                        let scoreToShow, scoreClass, badge, votesInfo;
                                        
                                        if (galaDetail.participated) {
                                            // ‚úÖ PARTICIP√ì: Mostrar score real
                                            scoreToShow = galaDetail.score;
                                            scoreClass = 'text-green-400';
                                            badge = '‚úÖ';
                                            votesInfo = `${galaDetail.juryCount || 0} jur.`;
                                        } else if (participant.duplicated && galaDetail.repeated) {
                                            // üîÑ DUPLICADO: Falt√≥ pero se le duplic√≥ (usuario lo seleccion√≥)
                                            scoreToShow = galaDetail.score;
                                            scoreClass = 'text-yellow-400';
                                            badge = 'üîÑ';
                                            votesInfo = 'dup.';
                                        } else {
                                            // ‚ùå FALT√ì SIN DUPLICAR: Mostrar 0
                                            scoreToShow = 0;
                                            scoreClass = 'text-red-400';
                                            badge = '‚ùå';
                                            votesInfo = 'FALTA';
                                        }
                                        
                                        return `
                                            <td class="px-2 py-4 text-center">
                                                <div class="${scoreClass} font-bold">${scoreToShow.toFixed(1)}</div>
                                                <div class="text-xs text-gray-400">${badge} ${votesInfo}</div>
                                            </td>
                                        `;
                                    }
                                    return '<td class="px-2 py-4 text-center text-gray-500">-</td>';
                                }).join('');

                                return `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50 transition-colors ${index < 3 ? 'bg-gray-700/30' : ''}">
                                        <td class="px-4 py-4">
                                            <span class="font-bold text-lg ${positionColor} px-2 py-1 rounded">${positionBadge}</span>
                                        </td>
                                        <td class="px-4 py-4">
                                            <div class="flex items-center">
                                                <img src="${participant.photoURL || 'https://placehold.co/50x50/1f2937/f9fafb?text=ART'}" 
                                                     alt="${participant.name}" class="w-10 h-10 rounded-full mr-3 border border-gray-600">
                                                <div>
                                                    <div class="text-white font-bold">${participant.name}</div>
                                                    <div class="text-xs text-gray-400">${participant.galas.length}/${reportData.galas.length} galas</div>
                                                </div>
                                            </div>
                                        </td>
                                        ${galaScores}
                                        <td class="px-3 py-4 text-center bg-purple-800/50">
                                            <div class="text-purple-200 font-bold text-lg">${totalJuryEvaluations}</div>
                                            <div class="text-purple-300 text-xs">eval.</div>
                                        </td>
                                        <td class="px-3 py-4 text-center bg-green-800/50">
                                            <div class="text-green-300 font-bold text-xl">${participant.finalScore.toFixed(1)}</div>
                                            <div class="text-green-400 text-xs">promedio</div>
                                        </td>
                                        <td class="px-3 py-4 text-center">
                                            ${participant.bonusApplied ? 
                                                `<span class="text-green-400 font-bold">+${participant.bonus}</span>` : 
                                                `<span class="text-gray-400">-</span>`
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- LEYENDA Y EXPLICACI√ìN -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
                        <h5 class="text-lg font-bold text-blue-400 mb-3">üìñ Leyenda</h5>
                        <div class="text-sm text-gray-300 space-y-1">
                            <p><span class="text-green-400">‚úÖ Verde:</span> Particip√≥ en la gala</p>
                            <p><span class="text-yellow-400">üîÑ Amarillo:</span> Duplicado (falt√≥ a 1 gala)</p>
                            <p><span class="text-red-400">‚ùå Rojo:</span> Falt√≥ (sin duplicar)</p>
                            <p><span class="text-green-400">‚≠ê Bonus:</span> +0.5 por participaci√≥n completa</p>
                        </div>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
                        <h5 class="text-lg font-bold text-green-400 mb-3">üèÜ Sistema de Puntuaci√≥n</h5>
                        <div class="text-sm text-gray-300 space-y-1">
                            <p>‚Ä¢ <span class="text-purple-300">üìä Evaluaciones:</span> Total de jurados</p>
                            <p>‚Ä¢ <span class="text-green-400">üèÜ Final:</span> Promedio final calculado</p>
                            <p>‚Ä¢ <span class="text-yellow-400">Duplicado:</span> Falt√≥ a 1 gala (se duplic√≥)</p>
                            <p>‚Ä¢ <span class="text-red-400">Falta:</span> 2+ galas (penalizado)</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 bg-gradient-to-r from-green-900/30 to-blue-900/30 p-6 rounded-xl border border-green-500/30 text-center">
                    <h4 class="text-xl font-bold text-green-400 mb-2">‚ú® ¬°Resultados Oficiales VYT-MUSIC!</h4>
                    <p class="text-green-400 font-semibold">¬°Felicitaciones a todos los participantes! üéµ</p>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function renderGalaBreakdown() {
            const container = document.getElementById('gala-breakdown-container');
            if (!container) {
                console.error('‚ùå Contenedor gala-breakdown-container no encontrado');
                return;
            }
            container.innerHTML = '';

            // Verificar que tenemos datos
            if (!reportData.galas || reportData.galas.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center p-4">No hay datos de galas disponibles</p>';
                return;
            }

            // Usar directamente reportData.galas
            const galasOrdenadas = reportData.galas.map(gala => {
                // Buscar informaci√≥n adicional si est√° disponible
                const galaInfo = allGalas.find(g => g.name === gala.name);
                return {
                    name: gala.name,
                    date: galaInfo?.date || 'Fecha no disponible',
                    participants: gala.participants || []
                };
            });

            galasOrdenadas.forEach(galaInfo => {
                const galaCard = document.createElement('div');
                galaCard.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700';
                
                // Recolectar todos los participantes con sus puntuaciones para esta gala
                const participantesGala = [];
                
                reportData.allParticipants.forEach(participant => {
                    const galaDetail = participant.galaDetails?.[galaInfo.name];
                    if (galaDetail) {
                        participantesGala.push({
                            name: participant.name,
                            score: galaDetail.score,
                            votes: galaDetail.juryCount || 0,
                            participated: galaDetail.participated,
                            repeated: galaDetail.repeated || false,
                            bonus: participant.bonusApplied && participant.bonus ? participant.bonus : 0
                        });
                    }
                });

                // Ordenar por puntuaci√≥n
                participantesGala.sort((a, b) => b.score - a.score);
                const top5 = participantesGala.slice(0, 5);
                
                const participados = participantesGala.filter(p => p.participated).length;
                const repetidos = participantesGala.filter(p => p.repeated).length;

                galaCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-bold text-white">${galaInfo.name}</h4>
                            <p class="text-sm text-gray-400">üìÖ ${galaInfo.date}</p>
                            <p class="text-xs text-blue-300">
                                üé§ ${participados} participaron | üîÑ ${repetidos} repetidas | üìä ${participantesGala.length} total
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-green-400">
                                ${participantesGala.reduce((sum, p) => sum + p.votes, 0)} evaluaciones
                            </p>
                            <p class="text-xs text-gray-400">
                                Promedio: ${participantesGala.length > 0 ? 
                                    (participantesGala.reduce((sum, p) => sum + p.score, 0) / participantesGala.length).toFixed(1) 
                                    : '0.0'}
                            </p>
                        </div>
                    </div>
                    <div class="bg-gray-900 p-3 rounded">
                        <p class="text-xs text-gray-400 mb-2">Top 5 de esta gala:</p>
                        ${top5.map((p, i) => `
                            <div class="flex justify-between items-center text-sm ${i < top5.length - 1 ? 'mb-1' : ''}">
                                <div class="flex items-center gap-2">
                                    <span>${i + 1}. ${p.name}</span>
                                    ${!p.participated ? '<span class="text-xs bg-orange-600 px-1 rounded">REPETIDA</span>' : ''}
                                    ${p.bonus > 0 ? `<span class="text-xs bg-green-600 px-1 rounded">+${p.bonus}</span>` : ''}
                                </div>
                                <span class="font-bold">${p.score.toFixed(1)} pts</span>
                            </div>
                        `).join('')}
                        ${participantesGala.length > 5 ? `
                            <p class="text-xs text-gray-500 mt-2">... y ${participantesGala.length - 5} participantes m√°s</p>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(galaCard);
            });
        }

        function calculateSpecialStats(ranking) {
            console.log('üìä Calculando estad√≠sticas especiales...');
            
            // üî• M√ÅS CONSISTENTE: Menor variaci√≥n en puntuaciones entre galas
            let mostConsistent = null;
            let lowestVariation = Infinity;
            
            // üöÄ MAYOR PROGRESI√ìN: Mejor mejora desde primera a √∫ltima gala
            let mostImproved = null;
            let biggestImprovement = -Infinity;
            
            // üë®‚Äç‚öñÔ∏è M√ÅS EVALUADO: Mayor cantidad de evaluaciones de jurados (NO votos p√∫blico)
            let publicFavorite = null;
            let mostVotes = 0;
            
            // FAVORITO DEL PUBLICO REAL: Mayor promedio de votos publicos
            let realPublicFavorite = null;
            let highestPublicAverage = 0;
            
            // üéüÔ∏è M√ÅS ENTRADAS VENDIDAS: Mayor cantidad de QR generados
            let topSeller = null;
            let maxTicketsSold = 0;
            
            ranking.forEach(participant => {
                // Solo analizar participantes que participaron en m√∫ltiples galas
                const realParticipations = Object.values(participant.galaDetails || {})
                    .filter(detail => detail.participated);
                
                if (realParticipations.length >= 2) {
                    // CONSISTENCIA: Calcular desviaci√≥n est√°ndar de puntuaciones
                    const scores = realParticipations.map(detail => detail.score);
                    const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                    const variance = scores.reduce((sum, score) => sum + Math.pow(score - average, 2), 0) / scores.length;
                    const stdDeviation = Math.sqrt(variance);
                    
                    if (stdDeviation < lowestVariation) {
                        lowestVariation = stdDeviation;
                        mostConsistent = {
                            name: participant.name,
                            variation: stdDeviation,
                            avgScore: average,
                            participations: realParticipations.length
                        };
                    }
                    
                    // PROGRESI√ìN: Comparar primera vs √∫ltima gala real
                    if (realParticipations.length >= 2) {
                        const galasOrdenadas = selectedGalas.map(galaId => allGalas.find(g => g.id === galaId))
                            .sort((a, b) => new Date(a.date) - new Date(b.date));
                        
                        let firstScore = null;
                        let lastScore = null;
                        
                        // Encontrar primera y √∫ltima puntuaci√≥n real
                        galasOrdenadas.forEach(gala => {
                            const detail = participant.galaDetails?.[gala.name];
                            if (detail && detail.participated) {
                                if (firstScore === null) firstScore = detail.score;
                                lastScore = detail.score;
                            }
                        });
                        
                        if (firstScore !== null && lastScore !== null && firstScore !== lastScore) {
                            const improvement = lastScore - firstScore;
                            if (improvement > biggestImprovement) {
                                biggestImprovement = improvement;
                                mostImproved = {
                                    name: participant.name,
                                    improvement: improvement,
                                    firstScore: firstScore,
                                    lastScore: lastScore,
                                    participations: realParticipations.length
                                };
                            }
                        }
                    }
                }
                
                // üë®‚Äç‚öñÔ∏è M√ÅS EVALUADO: Solo contar evaluaciones REALES (no duplicadas)
                let realJuryEvaluations = 0;
                if (participant.galaDetails) {
                    Object.values(participant.galaDetails).forEach(galaDetail => {
                        if (galaDetail.participated && !galaDetail.repeated) {
                            realJuryEvaluations += galaDetail.juryCount || 0;
                        }
                    });
                }
                
                if (realJuryEvaluations > mostVotes) {
                    mostVotes = realJuryEvaluations;
                    publicFavorite = {
                        name: participant.name,
                        totalVotes: realJuryEvaluations,
                        avgScore: participant.finalScore,
                        galas: participant.galas.length,
                        realParticipations: Object.values(participant.galaDetails || {}).filter(g => g.participated).length
                    };
                }
                
                // üë• FAVORITO DEL P√öBLICO REAL: Votos del p√∫blico
                if (participant.totalPublicVotes > 0) {
                    const publicAverage = participant.totalPublicScore / participant.totalPublicVotes;
                    if (publicAverage > highestPublicAverage) {
                        highestPublicAverage = publicAverage;
                        realPublicFavorite = {
                            name: participant.name,
                            totalPublicVotes: participant.totalPublicVotes,
                            avgPublicScore: publicAverage,
                            totalPublicScore: participant.totalPublicScore
                        };
                    }
                }
                
                // üéüÔ∏è M√ÅS ENTRADAS VENDIDAS: Contar QR generados (si existe el dato)
                const ticketsSold = participant.qrCodesGenerated || participant.ticketsSold || participant.totalInvitados || 0;
                if (ticketsSold > maxTicketsSold) {
                    maxTicketsSold = ticketsSold;
                    topSeller = {
                        name: participant.name,
                        ticketsSold: ticketsSold,
                        avgScore: participant.finalScore
                    };
                }
            });
            
            // Actualizar los elementos DOM
            updateSpecialStatsUI(mostConsistent, mostImproved, publicFavorite, realPublicFavorite, topSeller);
        }
        
        function updateSpecialStatsUI(mostConsistent, mostImproved, publicFavorite, realPublicFavorite, topSeller) {
            // üî• M√ÅS CONSISTENTE
            const consistentElement = document.getElementById('most-consistent');
            if (mostConsistent && consistentElement) {
                consistentElement.innerHTML = `
                    <div class="font-bold text-lg">${mostConsistent.name}</div>
                    <div class="text-sm">Promedio: ${mostConsistent.avgScore.toFixed(1)} ‚Ä¢ Variaci√≥n: ¬±${mostConsistent.variation.toFixed(1)}</div>
                `;
            }
            
            // üöÄ MAYOR PROGRESI√ìN
            const improvedElement = document.getElementById('most-improved');
            if (mostImproved && improvedElement) {
                const improvementSign = mostImproved.improvement > 0 ? '+' : '';
                improvedElement.innerHTML = `
                    <div class="font-bold text-lg">${mostImproved.name}</div>
                    <div class="text-sm">${mostImproved.firstScore.toFixed(1)} ‚Üí ${mostImproved.lastScore.toFixed(1)} (${improvementSign}${mostImproved.improvement.toFixed(1)})</div>
                `;
            }
            
            // üë®‚Äç‚öñÔ∏è M√ÅS EVALUADO (Mayor cantidad de evaluaciones de jurados)
            const favoriteElement = document.getElementById('public-favorite');
            if (publicFavorite && favoriteElement) {
                favoriteElement.innerHTML = `
                    <div class="font-bold text-lg">${publicFavorite.name}</div>
                    <div class="text-sm">${publicFavorite.totalVotes} eval. de jurados ‚Ä¢ Promedio: ${publicFavorite.avgScore.toFixed(1)}/10</div>
                `;
            }
            
            // üë• FAVORITO DEL P√öBLICO REAL (Votos del p√∫blico)
            const realFavoriteElement = document.getElementById('public-votes-favorite');
            if (realPublicFavorite && realFavoriteElement) {
                realFavoriteElement.innerHTML = `
                    <div class="font-bold text-lg">${realPublicFavorite.name}</div>
                    <div class="text-sm">${realPublicFavorite.totalPublicVotes} votos ‚Ä¢ Promedio: ${realPublicFavorite.avgPublicScore.toFixed(1)}/10</div>
                `;
            } else if (realFavoriteElement) {
                realFavoriteElement.innerHTML = `<div class="text-gray-400">Sin votos p√∫blicos</div>`;
            }
            
            // üéüÔ∏è M√ÅS ENTRADAS VENDIDAS (QR generados)
            const topSellerElement = document.getElementById('top-seller');
            if (topSeller && topSellerElement) {
                topSellerElement.innerHTML = `
                    <div class="font-bold text-lg">${topSeller.name}</div>
                    <div class="text-sm">${topSeller.ticketsSold} entradas vendidas ‚Ä¢ Promedio: ${topSeller.avgScore.toFixed(1)}/10</div>
                `;
            } else if (topSellerElement) {
                topSellerElement.innerHTML = `<div class="text-gray-400">No hay datos de ventas</div>`;
            }
            
            console.log('‚úÖ Estad√≠sticas especiales actualizadas:', { mostConsistent, mostImproved, publicFavorite, realPublicFavorite, topSeller });
        }

        // Bot√≥n para nuevo reporte
        newReportBtn.addEventListener('click', function() {
            // Limpiar selecciones
            selectedGalas = [];
            const checkboxes = galasCheckboxContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            generateReportBtn.disabled = true;
            
            // Mostrar selector y ocultar reporte
            galaSelectorSection.classList.remove('hidden');
            reportContent.classList.add('hidden');
        });

        // Botones de exportaci√≥n (funcionalidad b√°sica)
        document.getElementById('export-final-pdf').addEventListener('click', () => window.print());
        
        document.getElementById('export-final-excel').addEventListener('click', function() {
            // Generar CSV b√°sico
            const ranking = Array.from(reportData.allParticipants.values())
                .sort((a, b) => b.finalScore - a.finalScore);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Posici√≥n,Nombre,Promedio Final,Penalizaci√≥n,Ausencias,Galas Participadas\r\n";
            
            ranking.forEach((participant, index) => {
                csvContent += `${index + 1},"${participant.name}",${participant.finalScore.toFixed(1)},${participant.penalizacion},${participant.ausencias},"${participant.galas.join(', ')}"\r\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reporte_certamen_completo.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('share-final-report').addEventListener('click', function() {
            // Generar enlace p√∫blico que funcione desde cualquier dispositivo
            generatePublicLink();
        });

        // Detectar si viene desde una gala espec√≠fica
        function detectSourceAndPreselect() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eventId');
            const eventName = urlParams.get('eventName');
            
            if (eventId && eventName) {
                // Viene desde una gala espec√≠fica
                console.log(`üéØ Acceso desde gala espec√≠fica: ${eventName} (${eventId})`);
                return { eventId, eventName };
            }
            
            return null;
        }

        // Preseleccionar gala espec√≠fica si viene desde una gala
        function preselectSpecificGala(galaInfo) {
            // Buscar la gala en la lista
            const galaCheckbox = document.querySelector(`#gala-${galaInfo.eventId}`);
            if (galaCheckbox) {
                galaCheckbox.checked = true;
                updateSelectedGalas();
                
                // Cambiar el t√≠tulo para mostrar que es para una gala espec√≠fica
                const titulo = document.querySelector('h1');
                titulo.textContent = `üéØ Reporte de: ${galaInfo.eventName}`;
                
                const subtitulo = document.querySelector('header p');
                subtitulo.textContent = 'Se ha preseleccionado esta gala. Puedes agregar m√°s galas si deseas hacer un reporte conjunto.';
                
                console.log(`‚úÖ Gala "${galaInfo.eventName}" preseleccionada autom√°ticamente`);
            }
        }

        // Inicializar con detecci√≥n inteligente
        async function initializeReport() {
            console.log('üöÄ Inicializando sistema de reportes...');
            
            // Mostrar indicador de carga
            galasCheckboxContainer.innerHTML = `
                <div class="text-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                    <p class="text-blue-400 font-bold">Cargando galas disponibles...</p>
                    <p class="text-gray-500 text-sm mt-2">Verificando eventos con evaluaciones</p>
                </div>
            `;
            
            const specificGala = detectSourceAndPreselect();
            await loadAllGalas();
            
            if (specificGala) {
                // Esperar un poco para que se rendericen los checkboxes
                setTimeout(() => {
                    preselectSpecificGala(specificGala);
                }, 500);
            }
            
            console.log('‚úÖ Inicializaci√≥n completada');
        }
        
        // Wrapper con manejo de errores para la inicializaci√≥n
        async function safeInitialize() {
            try {
                // Esperar a que Firebase est√© completamente cargado
                console.log('üîÑ Esperando inicializaci√≥n de Firebase...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await initializeReport();
            } catch (error) {
                console.error('üí• Error en la inicializaci√≥n:', error);
                galasCheckboxContainer.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-400 text-lg mb-4">üí• Error de Inicializaci√≥n</p>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üîÑ Recargar P√°gina
                        </button>
                    </div>
                `;
            }
        }

        // üèÜ FUNCIONES PARA SELECTOR DE BONUS POR PARTICIPACI√ìN
        // üÜï FUNCI√ìN MEJORADA PARA MOSTRAR SELECTOR CON TODOS LOS ARTISTAS
        function showBonusSelector() {
            const participantsList = document.getElementById('penalty-participants-list');
            const participantsArray = Array.from(reportData.allParticipants.values());
            
            // üîç DEBUG: Ver exactamente qu√© artistas llegaron aqu√≠
            console.log(`üîç DEBUG showBonusSelector: Total artistas cargados: ${participantsArray.length}`);
            console.log('üîç Lista de artistas:', participantsArray.map(p => p.name).sort());
            
            // Ordenar por promedio final (descendente)
            participantsArray.sort((a, b) => b.finalScore - a.finalScore);
            
            participantsList.innerHTML = participantsArray.map(participant => {
                // ‚úÖ Elegible para BONUS (+0.5): Vino a todas las galas
                const isEligibleForBonus = participant.attendedAllGalas;
                // üîÑ Elegible para DUPLICAR: Falt√≥ a 1 SOLA gala
                const isEligibleForDuplicate = participant.missedGalas === 1;
                // ‚ùå NO elegible: Falt√≥ a 2+ galas
                const isDisqualified = participant.missedGalas >= 2;
                
                let galasText, borderColor, bgColor, checkboxState;
                
                if (isEligibleForBonus) {
                    galasText = '‚úÖ Participaci√≥n completa - BONUS +0.5';
                    borderColor = 'border-green-500';
                    bgColor = 'bg-green-900/20';
                    checkboxState = 'checked';
                } else if (isEligibleForDuplicate) {
                    galasText = 'üîÑ Falt√≥ a 1 gala - DUPLICAR promedio';
                    borderColor = 'border-yellow-500';
                    bgColor = 'bg-yellow-900/20';
                    checkboxState = ''; // No checked por defecto
                } else {
                    galasText = '‚ùå Falt√≥ a 2+ galas - NO ELEGIBLE';
                    borderColor = 'border-red-500';
                    bgColor = 'bg-red-900/20';
                    checkboxState = 'disabled';
                }
                
                // üìã DETALLES DE CADA GALA
                const galaDetailsHtml = participant.galaDetails ? 
                    Object.entries(participant.galaDetails)
                        .map(([galaName, details]) => {
                            const missedClass = details.missed ? 'text-yellow-400' : 'text-green-400';
                            const missedIcon = details.missed ? (details.repeated ? 'üîÑ' : '‚ùå') : '‚úÖ';
                            const scoreText = details.missed ? 
                                (details.repeated ? `${details.score.toFixed(1)}/10 (DUPLICADO)` : '0.0/10 (FALTA)') : 
                                `${details.score.toFixed(1)}/10 (${details.juryCount} jurados)`;
                            return `
                                <div class="${missedClass} text-xs">
                                    ${missedIcon} ${galaName}: ${scoreText}
                                </div>
                            `;
                        }).join('') : '';
                
                return `
                    <div class="participant-card p-4 rounded-lg border-2 ${borderColor} ${bgColor}">
                        <div class="flex items-center justify-between mb-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" 
                                       ${checkboxState}
                                       data-participant="${participant.name}"
                                       data-type="${isEligibleForBonus ? 'bonus' : isEligibleForDuplicate ? 'duplicate' : 'none'}" 
                                       class="mr-3 w-5 h-5 text-green-600">
                                <div>
                                    <div class="font-bold text-white">${participant.name}</div>
                                    <div class="text-sm font-semibold">
                                        ${galasText}
                                    </div>
                                </div>
                            </label>
                            <div class="text-right">
                                <div class="text-lg font-bold text-white">
                                    ${participant.finalScore.toFixed(1)}/10
                                </div>
                                <div class="text-xs text-gray-400">
                                    Promedio actual: ${participant.finalScore.toFixed(1)}
                                </div>
                            </div>
                        </div>
                        
                        <!-- üìã DETALLES POR GALA -->
                        <div class="mt-2 p-2 bg-gray-800/50 rounded text-xs">
                            <div class="font-semibold text-gray-300 mb-1">Detalles por gala:</div>
                            ${galaDetailsHtml}
                        </div>
                        
                        ${!isEligibleForBonus ? `
                            <div class="mt-2 text-xs text-yellow-300">
                                ‚ö†Ô∏è No elegible para bonus (falt√≥ a ${selectedGalas.length - participant.galas.length} gala(s))
                            </div>
                        ` : `
                            <div class="mt-2 text-xs text-green-300">
                                ‚≠ê Elegible para bonus (+0.5 puntos)
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            
            // Mostrar el selector
            document.getElementById('penalty-selector-section').style.display = 'block';
            
            // Configurar evento del bot√≥n
            document.getElementById('apply-bonuses-btn').onclick = applyManualBonuses;
            
            console.log(`üèÜ Selector de bonus mostrado con ${allParticipants.length} participantes √∫nicos`);
            
            // Configurar evento del bot√≥n para saltar bonus
            document.getElementById('skip-bonus-btn').onclick = skipBonusAndGenerate;
        }
        
        // Funci√≥n para generar reporte sin bonus
        async function skipBonusAndGenerate() {
            console.log('‚è≠Ô∏è Saltando bonus y generando reporte...');
            
            // Ocultar selector
            document.getElementById('penalty-selector-section').style.display = 'none';
            
            // Generar reporte sin bonus
            await generateCertamenReportWithBonus();
            
            console.log('‚úÖ Reporte generado sin bonus');
        }
        
        // Funci√≥n para generar reporte completo con los bonus ya aplicados
        async function generateCertamenReportWithBonus() {
            console.log('üìä Generando reporte del certamen con bonus aplicados...');
            
            try {
                // ‚ö†Ô∏è NO volver a completar la generaci√≥n porque ya aplicamos bonus manuales
                // Solo inicializar datos b√°sicos que faltan y renderizar
                
                // Inicializar reportData.galas si no existe
                if (!reportData.galas || reportData.galas.length === 0) {
                    reportData.galas = selectedGalas.map(galaId => {
                        const gala = allGalas.find(g => g.id === galaId);
                        return {
                            id: gala.id,
                            name: gala.name,
                            date: gala.date
                        };
                    });
                }
                
                // Inicializar per√≠odo si no existe
                if (!reportData.period) {
                    const dates = selectedGalas.map(galaId => {
                        const gala = allGalas.find(g => g.id === galaId);
                        return new Date(gala.date);
                    }).sort((a, b) => a - b);
                    
                    reportData.period = {
                        from: dates[0].toLocaleDateString('es-ES'),
                        to: dates[dates.length - 1].toLocaleDateString('es-ES')
                    };
                }
                
                // Ordenar participantes por finalScore
                const ranking = Array.from(reportData.allParticipants.values())
                    .sort((a, b) => b.finalScore - a.finalScore);
                
                console.log('üèÜ Ranking final calculado:', ranking.map(p => `${p.name}: ${p.finalScore.toFixed(1)}`));
                
                // Renderizar todo usando la funci√≥n completa
                renderFinalReport();
                
                // Renderizar podio
                renderFinalPodium(ranking);
                
                // Renderizar ranking final
                renderFinalRanking(ranking);
                
                // Mostrar reporte y ocultar selector
                const galaSelectorSection = document.getElementById('gala-selector-section');
                const reportContent = document.getElementById('report-content');
                
                galaSelectorSection.classList.add('hidden');
                reportContent.classList.remove('hidden');
                
                console.log('‚úÖ Reporte del certamen generado exitosamente');
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                alert('Error al generar el reporte del certamen: ' + error.message);
            }
        }
        
        async function applyManualBonuses() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-participant]');
            let bonusesApplied = 0;
            let duplicationsApplied = 0;
            
            const totalGalas = selectedGalas.length;
            
            // Resetear todos los c√°lculos primero MANTENIENDO las penalizaciones
            for (let participant of reportData.allParticipants.values()) {
                // üéØ IMPORTANTE: Mantener la penalizaci√≥n base
                // - Si falt√≥ a 2+ galas: promedio penalizado (totalScore / totalGalas)
                // - Si falt√≥ a 1 gala: promedio penalizado (hasta que el usuario elija duplicar)
                // - Si vino a todas: promedio normal (totalScore / totalVotes)
                
                participant.finalScore = totalGalas > 0 ? 
                    (participant.totalScore / totalGalas) : 0;
                participant.bonus = 0;
                participant.bonusApplied = false;
                participant.duplicated = false;
            }
            
            // Aplicar selecciones del usuario
            checkboxes.forEach(checkbox => {
                if (checkbox.checked && !checkbox.disabled) {
                    const participantName = checkbox.getAttribute('data-participant');
                    const actionType = checkbox.getAttribute('data-type');
                    const participant = reportData.allParticipants.get(participantName);
                    
                    if (participant) {
                        if (actionType === 'bonus') {
                            // ‚≠ê BONUS +0.5 (vino a todas las galas)
                            // Primero calcular el promedio normal (sin penalizaci√≥n)
                            participant.finalScore = participant.totalVotes > 0 ? 
                                (participant.totalScore / participant.totalVotes) : 0;
                            // Luego agregar el bonus
                            participant.bonus = 0.5;
                            participant.finalScore = participant.finalScore + participant.bonus;
                            participant.bonusApplied = true;
                            bonusesApplied++;
                            console.log(`‚≠ê Bonus aplicado a ${participantName}: ${participant.finalScore.toFixed(1)}/10 (+0.5)`);
                            
                        } else if (actionType === 'duplicate') {
                            // üîÑ DUPLICAR (falt√≥ a 1 sola gala)
                            // Calcular con duplicaci√≥n: (totalScore + promedio) / totalGalas
                            participant.finalScore = participant.totalVotes > 0 ? 
                                ((participant.totalScore + participant.baseAverage) / totalGalas) : 0;
                            participant.duplicated = true;
                            duplicationsApplied++;
                            
                            // Marcar la gala faltante como duplicada en los detalles
                            if (participant.galaDetails) {
                                for (let [galaName, details] of Object.entries(participant.galaDetails)) {
                                    if (details.missed) {
                                        details.score = participant.baseAverage;
                                        details.repeated = true;
                                    }
                                }
                            }
                            
                            console.log(`üîÑ Duplicaci√≥n aplicada a ${participantName}: ${participant.finalScore.toFixed(1)}/10`);
                        }
                    }
                }
            });
            
            // Ocultar selector
            document.getElementById('penalty-selector-section').style.display = 'none';
            
            console.log(`üéâ ${bonusesApplied} bonus y ${duplicationsApplied} duplicaciones aplicadas`);
            
            // Generar el reporte completo
            await generateCertamenReportWithBonus();
            
            alert(`üéâ ¬°Aplicaciones exitosas!\n\n‚≠ê ${bonusesApplied} bonus (+0.5) aplicados\nüîÑ ${duplicationsApplied} duplicaciones aplicadas\n\nReporte generado con √©xito.`);
        }

        // üì± FUNCIONES PARA COMPARTIR RESULTADOS
        function generateShareText(ranking) {
            const topParticipants = ranking.slice(0, Math.min(10, ranking.length));
            const certamenName = reportData.galas.length > 1 ? 
                'CERTAMEN VYT-MUSIC' : 
                `GALA: ${reportData.galas[0].name}`;
            
            let shareText = `üèÜ RESULTADOS OFICIALES ${certamenName} üèÜ\n`;
            shareText += `üìÖ Per√≠odo: ${reportData.period.from}${reportData.period.from !== reportData.period.to ? ` - ${reportData.period.to}` : ''}\n`;
            shareText += `üé§ ${reportData.allParticipants.size} participantes\n\n`;
            
            shareText += `üëë PODIUM OFICIAL:\n`;
            shareText += `ü•á 1er Lugar: ${ranking[0]?.name} - ${ranking[0]?.finalScore.toFixed(1)}/10\n`;
            if (ranking[1]) shareText += `ü•à 2do Lugar: ${ranking[1].name} - ${ranking[1].finalScore.toFixed(1)}/10\n`;
            if (ranking[2]) shareText += `ü•â 3er Lugar: ${ranking[2].name} - ${ranking[2].finalScore.toFixed(1)}/10\n\n`;
            
            shareText += `üìä RANKING COMPLETO (Top ${topParticipants.length}):\n`;
            topParticipants.forEach((participant, index) => {
                const position = index + 1;
                const emoji = position <= 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `${position}.`;
                shareText += `${emoji} ${participant.name}: ${participant.finalScore.toFixed(1)}/10\n`;
            });
            
            shareText += `\nüéµ ¬°Felicitaciones a todos los participantes! üéµ`;
            
            document.getElementById('share-text').textContent = shareText;
        }

        function shareResults() {
            const shareText = document.getElementById('share-text').textContent;
            const reportUrl = generateReportUrl();
            const fullMessage = `${shareText}\n\nüîó Ver resultados completos:\n${reportUrl}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(fullMessage)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function generatePublicLink() {
            console.log('üîó Iniciando generatePublicLink()...');
            console.log('üìä Estado de reportData:', reportData);
            
            // Verificar que reportData existe y tiene los datos necesarios
            if (!reportData || Object.keys(reportData).length === 0) {
                alert('‚ùå Error: No hay datos del reporte disponibles.\n\nüîÑ Debes generar primero el reporte del certamen.');
                return;
            }

            if (!reportData.allParticipants || reportData.allParticipants.size === 0) {
                alert('‚ùå Error: No hay participantes en el reporte.\n\nüîÑ Aseg√∫rate de que el reporte se haya generado correctamente.');
                return;
            }

            // Generar ranking ordenado
            const ranking = Array.from(reportData.allParticipants.values())
                .sort((a, b) => b.finalScore - a.finalScore);
            
            console.log('üìà Ranking generado:', ranking.length, 'participantes');

            // Crear ID √∫nico para este reporte
            const reportId = Date.now().toString(36);
            
            // Preparar datos para guardar
            const publicReportData = {
                id: reportId,
                timestamp: new Date().toISOString(),
                title: reportData.galas && reportData.galas.length > 1 ? 'CERTAMEN VYT-MUSIC' : 
                       reportData.galas && reportData.galas[0] ? `GALA: ${reportData.galas[0].name}` : 'CERTAMEN VYT-MUSIC',
                period: reportData.period || { from: 'N/A', to: 'N/A' },
                podium: ranking.slice(0, 3).map(p => ({
                    name: p.name,
                    photoURL: p.photoURL || null,
                    finalScore: p.finalScore,
                    galas: p.galas
                })),
                ranking: ranking.map(p => ({
                    name: p.name,
                    photoURL: p.photoURL || null,
                    finalScore: p.finalScore,
                    galas: p.galas,
                    totalPublicVotes: p.totalPublicVotes || 0,
                    totalPublicScore: p.totalPublicScore || 0
                }))
            };

            console.log('üì¶ Datos p√∫blicos preparados:', publicReportData);

            try {
                // Guardar en Firebase en lugar de localStorage
                console.log('üíæ Guardando en Firebase...');
                await setDoc(doc(db, 'public_reports', reportId), publicReportData);
                console.log('‚úÖ Datos guardados en Firebase con ID:', reportId);

                // Tambi√©n guardar en localStorage como respaldo
                localStorage.setItem(`report_${reportId}`, JSON.stringify(publicReportData));
                console.log('üíæ Respaldo guardado en localStorage');

            } catch (error) {
                console.error('‚ùå Error guardando en Firebase:', error);
                alert('‚ùå Error: No se pudo guardar el reporte.\n\n' + error.message);
                return;
            }

            // Generar URL del reporte p√∫blico
            const currentUrl = window.location.origin + window.location.pathname;
            const publicUrl = currentUrl.replace('reporte_certamen_completo.html', `resultados.html?id=${reportId}`);
            
            console.log(`üîó URL generada:`, {
                reportId: reportId,
                currentUrl: currentUrl,
                publicUrl: publicUrl,
                participantes: ranking.length
            });
            
            // Mostrar modal con el enlace
            showPublicLinkModal(publicUrl, publicReportData.title);
        }

        function showPublicLinkModal(url, title) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-2xl max-w-2xl mx-4 text-white">
                    <h3 class="text-2xl font-bold mb-6 text-center text-green-400">‚úÖ Enlace P√∫blico Generado</h3>
                    <p class="text-center text-gray-300 mb-6">
                        Este enlace muestra SOLO los resultados oficiales. Perfecto para compartir con los artistas:
                    </p>
                    
                    <div class="bg-gray-900 p-4 rounded-lg mb-6 border-2 border-green-500">
                        <p class="text-sm text-gray-400 mb-2">üîó Enlace del reporte:</p>
                        <p class="text-green-400 font-mono text-sm break-all select-all" id="public-url">${url}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <button onclick="copyPublicUrl('${url}')" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                            üìã Copiar Enlace
                        </button>
                        <button onclick="sharePublicUrl('${url}', '${title}')" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                            üì± WhatsApp
                        </button>
                    </div>
                    
                    <div class="bg-blue-900/50 border border-blue-500 rounded-lg p-4 mb-4">
                        <p class="text-blue-200 text-sm">
                            üí° <strong>Consejo:</strong> Copia el enlace y env√≠alo por WhatsApp, Telegram, Facebook o email.
                            Los artistas podr√°n ver los resultados completos en una p√°gina especial.
                        </p>
                    </div>
                    
                    <div class="flex justify-center gap-4">
                        <a href="${url}" target="_blank" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-bold inline-flex items-center gap-2">
                            üëÄ Ver P√°gina
                        </a>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-bold">
                            ‚úï Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function copyPublicUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ ¬°Enlace copiado!\n\nYa puedes enviarlo a los artistas por WhatsApp, Telegram o cualquier aplicaci√≥n.');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Enlace copiado!');
            });
        }

        function sharePublicUrl(url, title) {
            const message = `üèÜ ${title.toUpperCase()} üèÜ\n\n¬°Ya est√°n los resultados oficiales del certamen!\n\nüëâ Ver resultados completos:\n${url}\n\nüéµ ¬°Felicitaciones a todos los participantes! üéµ\n\nVYT-MUSIC 2024`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Variables para almacenar ediciones manuales
        let manualPublicFavorite = null;
        let manualTopSeller = null;

        function editPublicFavorite() {
            const artistNames = Array.from(reportData.allParticipants.values())
                .map(p => p.name)
                .sort()
                .join('\n');
            
            const currentName = document.getElementById('public-votes-favorite').textContent.split('\n')[0];
            
            const newName = prompt(
                `‚úèÔ∏è EDITAR FAVORITO DEL P√öBLICO\n\n` +
                `Artistas disponibles:\n${artistNames}\n\n` +
                `Ingresa el nombre del artista que quieres mostrar como "Favorito del P√∫blico":\n\n` +
                `(Actual: ${currentName})`,
                currentName
            );
            
            if (newName && newName.trim()) {
                // Buscar el artista en los datos
                const artist = Array.from(reportData.allParticipants.values())
                    .find(p => p.name.toLowerCase() === newName.trim().toLowerCase());
                
                if (artist) {
                    manualPublicFavorite = artist;
                    const element = document.getElementById('public-votes-favorite');
                    element.innerHTML = `
                        <div class="flex items-center justify-center gap-2">
                            <img src="${artist.photoURL || 'https://placehold.co/40x40/9333ea/ffffff?text=ART'}" 
                                 class="w-10 h-10 rounded-full border-2 border-white">
                            <div>${artist.name}</div>
                        </div>
                        <div class="text-sm mt-2">‚úèÔ∏è Editado manualmente</div>
                    `;
                    alert('‚úÖ Favorito del P√∫blico actualizado!\n\n' + artist.name);
                } else {
                    alert('‚ùå No se encontr√≥ el artista.\n\nVerifica que el nombre est√© escrito exactamente igual.');
                }
            }
        }

        function editTopSeller() {
            const artistNames = Array.from(reportData.allParticipants.values())
                .map(p => p.name)
                .sort()
                .join('\n');
            
            const currentName = document.getElementById('top-seller').textContent.split('\n')[0];
            
            const newName = prompt(
                `‚úèÔ∏è EDITAR M√ÅS ENTRADAS VENDIDAS\n\n` +
                `Artistas disponibles:\n${artistNames}\n\n` +
                `Ingresa el nombre del artista que quieres mostrar como "M√°s Entradas Vendidas":\n\n` +
                `(Actual: ${currentName})`,
                currentName
            );
            
            if (newName && newName.trim()) {
                // Buscar el artista en los datos
                const artist = Array.from(reportData.allParticipants.values())
                    .find(p => p.name.toLowerCase() === newName.trim().toLowerCase());
                
                if (artist) {
                    manualTopSeller = artist;
                    const element = document.getElementById('top-seller');
                    element.innerHTML = `
                        <div class="flex items-center justify-center gap-2">
                            <img src="${artist.photoURL || 'https://placehold.co/40x40/ea580c/ffffff?text=ART'}" 
                                 class="w-10 h-10 rounded-full border-2 border-white">
                            <div>${artist.name}</div>
                        </div>
                        <div class="text-sm mt-2">‚úèÔ∏è Editado manualmente</div>
                    `;
                    alert('‚úÖ M√°s Entradas Vendidas actualizado!\n\n' + artist.name);
                } else {
                    alert('‚ùå No se encontr√≥ el artista.\n\nVerifica que el nombre est√© escrito exactamente igual.');
                }
            }
        }

        function copyResults() {
            const shareText = document.getElementById('share-text').textContent;
            navigator.clipboard.writeText(shareText).then(() => {
                alert('‚úÖ Texto copiado al portapapeles!\n\nYa puedes pegarlo en cualquier aplicaci√≥n.');
            }).catch(() => {
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Texto copiado al portapapeles!');
            });
        }

        function downloadPDF() {
            alert('üìÑ Funci√≥n de PDF en desarrollo.\n\nPor ahora puedes usar "Imprimir" y seleccionar "Guardar como PDF".');
        }

        function printResults() {
            // Ocultar elementos que no se deben imprimir
            const hideElements = document.querySelectorAll('#gala-selector-section, .share-buttons, nav');
            hideElements.forEach(el => el.style.display = 'none');
            
            // Imprimir
            window.print();
            
            // Restaurar elementos
            hideElements.forEach(el => el.style.display = '');
        }

        // INICIALIZACI√ìN Y ESTADO DEL SISTEMA
        function checkSystemStatus() {
            console.log('üîç VERIFICANDO ESTADO DEL SISTEMA VYT-MUSIC');
            console.log('üìä Estado actual de reportData:', reportData);
            console.log('üìã Galas cargadas:', allGalas.length);
            console.log('‚úÖ Galas seleccionadas:', selectedGalas.length);
            
            // Verificar si hay reportes guardados en localStorage
            const savedReports = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('report_')) {
                    savedReports.push(key);
                }
            }
            console.log('üíæ Reportes p√∫blicos guardados:', savedReports);

            // Actualizar bot√≥n seg√∫n el estado
            updatePublicLinkButtonState();
        }

        function updatePublicLinkButtonState() {
            const btn = document.getElementById('public-link-btn');
            if (!btn) return;

            if (!reportData || Object.keys(reportData).length === 0) {
                btn.innerHTML = '‚ö†Ô∏è PRIMERO GENERA UN REPORTE';
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
            } else {
                btn.innerHTML = 'üîó GENERAR ENLACE P√öBLICO PARA ARTISTAS';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
            }
        }

        // Ejecutar verificaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina cargada - Inicializando sistema VYT-MUSIC');
            safeInitialize();
            
            setTimeout(() => {
                checkSystemStatus();
            }, 3000);
        });

        // Exponer funciones de edici√≥n al scope global
        window.editPublicFavorite = editPublicFavorite;
        window.editTopSeller = editTopSeller;

        // Verificar estado cada vez que se genera un reporte
        const originalCompleteReportGeneration = completeReportGeneration;
        completeReportGeneration = function() {
            originalCompleteReportGeneration();
            setTimeout(() => {
                updatePublicLinkButtonState();
                console.log('‚úÖ Reporte generado - Enlace p√∫blico ahora disponible');
            }, 500);
        };

        // Inicializar con manejo de errores
        safeInitialize();
    </script>
</body>
</html>