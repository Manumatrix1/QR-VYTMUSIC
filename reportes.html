<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Contabilidad - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none; }
    </style>
</head>
<body>
     <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <a id="back-to-events-link" href="eventos.html" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Gestor de Eventos</a>
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Reportes y Contabilidad</h1>
            <p id="event-name-display" class="text-xl text-gray-300 mt-2"></p>
        </header>

        <main class="space-y-8">
            <a id="back-to-panel-btn" href="#" class="hidden w-full text-center px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">
                Ir al Panel de Control de este Evento
            </a>

            <!-- Navegaci√≥n de Reportes -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">üîç Tipos de Reportes Disponibles</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <a href="reporte_certamen_completo.html" class="bg-gradient-to-br from-purple-600 to-purple-800 p-6 rounded-lg hover:from-purple-700 hover:to-purple-900 transition-all transform hover:scale-105 text-center">
                        <div class="text-4xl mb-3">üèÜ</div>
                        <h3 class="text-xl font-bold mb-2">Reporte General del Certamen</h3>
                        <p class="text-sm opacity-90">Ranking acumulado de todas las galas, ganadores finales y estad√≠sticas completas</p>
                    </a>
                    <div id="gala-reports-access" class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">üìä</div>
                        <h3 class="text-xl font-bold mb-2">Reportes por Gala Individual</h3>
                        <p class="text-sm opacity-90 mb-4">An√°lisis detallado de cada gala con rankings, votos y comparativas</p>
                        <div id="gala-links-container" class="space-y-2">
                            <!-- Los enlaces a galas individuales se llenar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </section>

            <section id="general-report-section" class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-center">Reporte General de Todas las Galas</h2>
                    <button id="export-general-report-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 text-sm">
                        Descargar Excel (.csv)
                    </button>
                </div>
                <div id="general-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 text-center">
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-green-400">Ingresos Totales</h3><p id="general-total-income" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-red-400">Gastos Totales</h3><p id="general-total-expenses" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-sky-400">Balance General</h3><p id="general-net-balance" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-yellow-400">Total de Entradas</h3><p id="general-total-tickets" class="text-xl md:text-2xl font-bold mt-2">Cargando...</p></div>
                </div>
            </section>
            
            <section id="accounting-section" class="hidden bg-gray-800 p-6 rounded-lg shadow-xl space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-6 text-center">Contabilidad de la Gala</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-green-400">Ingresos</h3><p id="total-income" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-red-400">Gastos</h3><p id="total-expenses" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-sky-400">Balance</h3><p id="net-balance" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-yellow-400">Entradas</h3><p id="total-tickets" class="text-xl md:text-2xl font-bold mt-2">Cargando...</p></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Desglose de Ingresos por Tipo de Entrada</h3>
                    <div id="income-breakdown-list" class="space-y-2 text-white"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">Registrar Gasto</h3>
                        <form id="expense-form" class="space-y-4">
                            <input type="text" id="expense-description" placeholder="Ej: Pago a Jurados" required class="w-full p-2 rounded-md bg-gray-900">
                            <input type="number" id="expense-amount" placeholder="Ej: 50000" required class="w-full p-2 rounded-md bg-gray-900">
                            <button type="submit" class="w-full px-4 py-2 bg-indigo-600 font-bold rounded-lg">Agregar Gasto</button>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Lista de Gastos</h3>
                        <ul id="expenses-list" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-gray-900 rounded-md"></ul>
                    </div>
                </div>
                <div class="pt-8 border-t border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Ajuste Manual de Entradas</h3>
                    <p class="text-gray-400 text-sm mb-4">Usa esta opci√≥n si necesitas corregir el total de entradas por ventas realizadas fuera de este sistema.</p>
                    <div class="flex items-center gap-4">
                        <input type="number" id="manual-adjustment-input" placeholder="Ej: 22" class="w-full p-2 rounded-md bg-gray-900">
                        <button id="save-adjustment-btn" class="px-6 py-2 bg-green-600 font-bold rounded-lg">Guardar Ajuste</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, onSnapshot, query, addDoc, deleteDoc, doc, getDocs, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        const eventName = urlParams.get('eventName');

        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
        
        async function exportGeneralReportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Nombre del Evento", "Fecha del Evento", "Artista/Grupo", "Total de Entradas por Artista", "Asistencia por Artista", "Ingresos del Evento", "Gastos del Evento", "Balance del Evento"];
            csvContent += headers.join(",") + "\r\n";
            const eventsQuery = query(collection(db, 'events'));
            const eventsSnapshot = await getDocs(eventsQuery);
            for (const eventDoc of eventsSnapshot.docs) {
                const eventData = eventDoc.data();
                const eventId = eventDoc.id;
                let eventTotalIncome = 0; let eventTotalExpenses = 0;
                const ticketsSnapshot = await getDocs(query(collection(db, `events/${eventId}/tickets`)));
                const tickets = ticketsSnapshot.docs.map(d => d.data());
                eventTotalIncome = tickets.reduce((sum, t) => sum + (t.price || 0), 0);
                const expensesSnapshot = await getDocs(query(collection(db, `events/${eventId}/expenses`)));
                eventTotalExpenses = expensesSnapshot.docs.reduce((sum, d) => sum + (d.data().amount || 0), 0);
                const artistData = tickets.reduce((acc, ticket) => {
                    const prefix = ticket.prefix || "Sin Grupo";
                    if (!acc[prefix]) acc[prefix] = { totalTickets: 0, attendance: 0 };
                    acc[prefix].totalTickets++;
                    if (ticket.used) acc[prefix].attendance++;
                    return acc;
                }, {});
                Object.keys(artistData).forEach(artist => {
                    const data = artistData[artist];
                    const row = [`"${eventData.name}"`, `"${eventData.date}"`, `"${artist}"`, data.totalTickets, data.attendance, eventTotalIncome, eventTotalExpenses, (eventTotalIncome - eventTotalExpenses)];
                    csvContent += row.join(",") + "\r\n";
                });
            }
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "reporte_general_vytmusic.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function loadGeneralReport() {
            let totalIncome = 0, totalExpenses = 0, totalTickets = 0;
            const eventsQuery = query(collection(db, 'events'));
            const eventsSnapshot = await getDocs(eventsQuery);
            for (const eventDoc of eventsSnapshot.docs) {
                const eventData = eventDoc.data();
                if (eventData.manualTicketAdjustment) totalTickets += eventData.manualTicketAdjustment;
                const ticketsSnapshot = await getDocs(query(collection(db, `events/${eventDoc.id}/tickets`)));
                ticketsSnapshot.forEach(doc => {
                    totalIncome += (doc.data().price || 0);
                    totalTickets++;
                });
                const expensesSnapshot = await getDocs(query(collection(db, `events/${eventDoc.id}/expenses`)));
                expensesSnapshot.forEach(doc => totalExpenses += (doc.data().amount || 0));
            }
            const balance = totalIncome - totalExpenses;
            document.getElementById('general-total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('general-total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('general-total-tickets').textContent = totalTickets;
            const generalNetBalanceEl = document.getElementById('general-net-balance');
            generalNetBalanceEl.textContent = formatCurrency(balance);
            generalNetBalanceEl.className = 'text-xl md:text-2xl font-bold mt-2 break-words ' + (balance >= 0 ? 'text-sky-400' : 'text-red-400');
        }

        if (eventId && eventName) {
            document.getElementById('general-report-section').classList.add('hidden');
            document.getElementById('accounting-section').classList.remove('hidden');
            document.getElementById('event-name-display').textContent = `Gala: ${eventName}`;
            const backToPanelBtn = document.getElementById('back-to-panel-btn');
            const backToEventsLink = document.getElementById('back-to-events-link');
            const panelUrl = `panel_evento.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;
            backToEventsLink.href = panelUrl;
            backToEventsLink.textContent = '‚Üê Volver al Panel del Evento';
            backToPanelBtn.href = panelUrl;
            backToPanelBtn.classList.remove('hidden');
            const eventRef = doc(db, 'events', eventId);
            const ticketsQuery = query(collection(db, `events/${eventId}/tickets`));
            const expensesQuery = query(collection(db, `events/${eventId}/expenses`));
            const state = { income: 0, expenses: 0, ticketsInSystem: 0, manualAdjustment: 0 };
            function updateUI() {
                const { income, expenses, ticketsInSystem, manualAdjustment } = state;
                const balance = income - expenses;
                const totalTickets = ticketsInSystem + manualAdjustment;
                document.getElementById('total-income').textContent = formatCurrency(income);
                document.getElementById('total-expenses').textContent = formatCurrency(expenses);
                document.getElementById('total-tickets').textContent = totalTickets;
                const netBalanceEl = document.getElementById('net-balance');
                netBalanceEl.textContent = formatCurrency(balance);
                netBalanceEl.className = 'text-xl md:text-2xl font-bold mt-2 break-words ' + (balance >= 0 ? 'text-sky-400' : 'text-red-400');
            }
            getDoc(eventRef).then(docSnap => {
                if (docSnap.exists() && docSnap.data().manualTicketAdjustment) {
                    state.manualAdjustment = docSnap.data().manualTicketAdjustment;
                    document.getElementById('manual-adjustment-input').value = state.manualAdjustment;
                    updateUI();
                }
            });
            onSnapshot(ticketsQuery, (snapshot) => {
                const tickets = snapshot.docs.map(doc => doc.data());
                state.ticketsInSystem = tickets.length;
                state.income = tickets.reduce((sum, ticket) => sum + (ticket.price || 0), 0);
                const incomeBreakdown = tickets.reduce((acc, ticket) => {
                    const tier = ticket.tierName || 'Sin Tipo';
                    if (!acc[tier]) acc[tier] = { count: 0, total: 0, price: ticket.price || 0 };
                    acc[tier].count++;
                    acc[tier].total += (ticket.price || 0);
                    return acc;
                }, {});
                const incomeBreakdownList = document.getElementById('income-breakdown-list');
                incomeBreakdownList.innerHTML = '';
                Object.keys(incomeBreakdown).sort().forEach(tier => {
                    const item = incomeBreakdown[tier];
                    const li = document.createElement('div');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${item.count} x ${tier} (${formatCurrency(item.price)})</span><span class="font-semibold">${formatCurrency(item.total)}</span>`;
                    incomeBreakdownList.appendChild(li);
                });
                updateUI();
            });
            onSnapshot(expensesQuery, (snapshot) => {
                const expensesList = document.getElementById('expenses-list');
                expensesList.innerHTML = '';
                state.expenses = 0;
                snapshot.forEach(doc => {
                    const expense = { id: doc.id, ...doc.data() };
                    state.expenses += expense.amount;
                    const li = document.createElement('div');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${expense.description}</span><span class="font-semibold">${formatCurrency(expense.amount)} <button data-id="${expense.id}" class="delete-expense-btn text-red-500 ml-2">X</button></span>`;
                    expensesList.appendChild(li);
                });
                updateUI();
            });
            document.getElementById('expense-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                if (description && amount > 0) await addDoc(collection(db, `events/${eventId}/expenses`), { description, amount }); e.target.reset();
            });
            document.getElementById('expenses-list').addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-expense-btn')) {
                    if(confirm("¬øSeguro que quieres eliminar este gasto?")) await deleteDoc(doc(db, `events/${eventId}/expenses`, e.target.dataset.id));
                }
            });
            document.getElementById('save-adjustment-btn').addEventListener('click', async () => {
                const adjustmentValue = parseInt(document.getElementById('manual-adjustment-input').value) || 0;
                await updateDoc(eventRef, { manualTicketAdjustment: adjustmentValue });
                state.manualAdjustment = adjustmentValue;
                updateUI();
                alert("Ajuste guardado con √©xito.");
            });
        } else {
            document.getElementById('event-name-display').textContent = "Reporte General";
            document.getElementById('general-report-section').classList.remove('hidden');
            document.getElementById('accounting-section').classList.add('hidden');
            loadGeneralReport();
            loadGalaLinks(); // Cargar enlaces a galas individuales
            document.getElementById('export-general-report-btn').addEventListener('click', exportGeneralReportToCSV);
        }

        async function loadGalaLinks() {
            try {
                const eventsQuery = query(collection(db, 'events'));
                const eventsSnapshot = await getDocs(eventsQuery);
                const galaLinksContainer = document.getElementById('gala-links-container');
                
                if (eventsSnapshot.empty) {
                    galaLinksContainer.innerHTML = '<p class="text-gray-400 text-sm">No hay galas registradas a√∫n</p>';
                    return;
                }

                galaLinksContainer.innerHTML = '';
                eventsSnapshot.docs.forEach(doc => {
                    const eventData = doc.data();
                    const link = document.createElement('a');
                    link.href = `reporte_por_gala.html?eventId=${doc.id}&eventName=${encodeURIComponent(eventData.name)}`;
                    link.className = 'block w-full px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors text-sm';
                    link.innerHTML = `üìä ${eventData.name} <span class="text-xs opacity-75">(${eventData.date || 'Sin fecha'})</span>`;
                    galaLinksContainer.appendChild(link);
                });
            } catch (error) {
                console.error('Error cargando enlaces de galas:', error);
                document.getElementById('gala-links-container').innerHTML = '<p class="text-red-400 text-sm">Error cargando galas</p>';
            }
        }
    </script>
</body>
</html>