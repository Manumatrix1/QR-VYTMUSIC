<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Contabilidad - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none; }
    </style>
</head>
<body>
     <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <a id="back-to-events-link" href="eventos.html" class="text-sky-400 hover:underline mb-4 inline-block">&larr; Volver al Gestor de Eventos</a>
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Reportes y Contabilidad</h1>
            <p id="event-name-display" class="text-xl text-gray-300 mt-2"></p>
        </header>

        <main class="space-y-8">
            <a id="back-to-panel-btn" href="#" class="hidden w-full text-center px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">
                Ir al Panel de Control de este Evento
            </a>

            <!-- Navegación de Reportes -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">🔍 Tipos de Reportes Disponibles</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <a href="reporte_certamen_completo.html" class="bg-gradient-to-br from-purple-600 to-purple-800 p-6 rounded-lg hover:from-purple-700 hover:to-purple-900 transition-all transform hover:scale-105 text-center">
                        <div class="text-4xl mb-3">🏆</div>
                        <h3 class="text-xl font-bold mb-2">Reporte General del Certamen</h3>
                        <p class="text-sm opacity-90">Ranking acumulado de todas las galas, ganadores finales y estadísticas completas</p>
                    </a>
                    <div id="gala-reports-access" class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-lg text-center">
                        <div class="text-4xl mb-3">📊</div>
                        <h3 class="text-xl font-bold mb-2">Reportes por Gala Individual</h3>
                        <p class="text-sm opacity-90 mb-4">Análisis detallado de cada gala con rankings, votos y comparativas</p>
                        <div id="gala-links-container" class="space-y-2">
                            <!-- Los enlaces a galas individuales se llenarán dinámicamente -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Nueva sección de administración -->
            <section id="admin-section" class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center text-red-400">⚙️ Administración del Sistema</h2>
                <div class="bg-red-900 bg-opacity-30 border-2 border-red-600 rounded-lg p-6">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">⚠️</div>
                        <h3 class="text-xl font-bold text-red-300">Zona de Administración</h3>
                        <p class="text-sm text-red-200">Herramientas avanzadas para gestionar votos y datos del certamen</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <a href="admin_votos.html" class="bg-red-600 hover:bg-red-700 p-4 rounded-lg text-center transition-colors">
                            <div class="text-2xl mb-2">🗑️</div>
                            <h4 class="font-bold mb-1">Administrar Votos</h4>
                            <p class="text-xs opacity-90">Eliminar votos de prueba, duplicados o incorrectos</p>
                        </a>
                        
                        <a id="progress-analytics-link" href="analisis_progreso_artistas.html" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 p-4 rounded-lg text-center transition-all transform hover:scale-105">
                            <div class="text-2xl mb-2">📈</div>
                            <h4 class="font-bold mb-1">Análisis de Progreso</h4>
                            <p class="text-xs opacity-90">Evolución y progreso de cada artista por gala</p>
                        </a>
                        
                        <div class="bg-gray-600 hover:bg-gray-700 p-4 rounded-lg text-center transition-colors opacity-50 cursor-not-allowed">
                            <div class="text-2xl mb-2">🔧</div>
                            <h4 class="font-bold mb-1">Herramientas Avanzadas</h4>
                            <p class="text-xs opacity-90">Próximamente: Backup, migración de datos</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-xs text-red-300 text-center">
                        <p>⚠️ Estas herramientas son solo para administradores. Los cambios son permanentes.</p>
                    </div>
                </div>
            </section>

            <section id="general-report-section" class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-center">Reportes Económicos</h2>
                    <button id="export-general-report-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 text-sm">
                        Descargar Excel (.csv)
                    </button>
                </div>

                <!-- Selector de Modo de Reporte -->
                <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-bold text-sky-300 mb-3">🎯 Seleccionar Alcance del Reporte</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="show-all-galas-btn" class="p-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition-all transform hover:scale-105">
                            📊 Ver Todo el Certamen
                            <div class="text-xs text-indigo-200 mt-1">Todas las galas y eventos</div>
                        </button>
                        <button id="show-gala-selector-btn" class="p-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold transition-all transform hover:scale-105">
                            🎭 Seleccionar Galas Específicas
                            <div class="text-xs text-green-200 mt-1">Elegir eventos particulares</div>
                        </button>
                    </div>
                </div>

                <!-- Selector de Galas Específicas (Oculto inicialmente) -->
                <div id="economic-gala-selector-container" class="hidden mb-6">
                    <div class="p-4 bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-bold text-green-300 mb-3">🎪 Seleccionar Galas para Análisis Económico</h3>
                        <p class="text-gray-400 text-sm mb-4">Selecciona las galas que deseas incluir en el reporte económico. Esto te permite comparar diferentes períodos o separar certámenes.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Eventos Disponibles:</label>
                            <div id="economic-events-checkboxes" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        
                        <div class="flex gap-4">
                            <button id="load-selected-galas-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>
                                💰 Generar Reporte Económico
                            </button>
                            <button id="select-all-galas-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">
                                ✅ Seleccionar Todas
                            </button>
                            <button id="clear-gala-selection-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">
                                ❌ Limpiar Selección
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Generales -->
                <div id="general-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 text-center">
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-green-400">Ingresos Totales</h3><p id="general-total-income" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-red-400">Gastos Totales</h3><p id="general-total-expenses" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-sky-400">Balance General</h3><p id="general-net-balance" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-yellow-400">Total de Entradas</h3><p id="general-total-tickets" class="text-xl md:text-2xl font-bold mt-2">Cargando...</p></div>
                </div>

                <!-- Detalles por Gala (nuevo) -->
                <div id="economic-details-container" class="hidden space-y-4">
                    <h3 class="text-xl font-bold text-sky-300">📈 Detalles por Gala Seleccionada</h3>
                    <div id="gala-economic-breakdown" class="space-y-4"></div>
                </div>
            </section>
            
            <section id="accounting-section" class="hidden bg-gray-800 p-6 rounded-lg shadow-xl space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-6 text-center">Contabilidad de la Gala</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-green-400">Ingresos</h3><p id="total-income" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-red-400">Gastos</h3><p id="total-expenses" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-sky-400">Balance</h3><p id="net-balance" class="text-xl md:text-2xl font-bold mt-2 break-words">Cargando...</p></div>
                        <div class="bg-gray-700 p-4 rounded-lg"><h3 class="text-lg font-semibold text-yellow-400">Entradas</h3><p id="total-tickets" class="text-xl md:text-2xl font-bold mt-2">Cargando...</p></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Desglose de Ingresos por Tipo de Entrada</h3>
                    <div id="income-breakdown-list" class="space-y-2 text-white"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">Registrar Gasto</h3>
                        <form id="expense-form" class="space-y-4">
                            <input type="text" id="expense-description" placeholder="Ej: Pago a Jurados" required class="w-full p-2 rounded-md bg-gray-900">
                            <input type="number" id="expense-amount" placeholder="Ej: 50000" required class="w-full p-2 rounded-md bg-gray-900">
                            <button type="submit" class="w-full px-4 py-2 bg-indigo-600 font-bold rounded-lg">Agregar Gasto</button>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Lista de Gastos</h3>
                        <ul id="expenses-list" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-gray-900 rounded-md"></ul>
                    </div>
                </div>
                <div class="pt-8 border-t border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Ajuste Manual de Entradas</h3>
                    <p class="text-gray-400 text-sm mb-4">Usa esta opción si necesitas corregir el total de entradas por ventas realizadas fuera de este sistema.</p>
                    <div class="flex items-center gap-4">
                        <input type="number" id="manual-adjustment-input" placeholder="Ej: 22" class="w-full p-2 rounded-md bg-gray-900">
                        <button id="save-adjustment-btn" class="px-6 py-2 bg-green-600 font-bold rounded-lg">Guardar Ajuste</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, onSnapshot, query, addDoc, deleteDoc, doc, getDocs, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configurar enlaces con eventId
        function setupEventLinks() {
            const progressLink = document.getElementById('progress-analytics-link');
            if (progressLink && eventId && eventName) {
                const url = new URL(progressLink.href, window.location.origin);
                url.searchParams.set('eventId', eventId);
                url.searchParams.set('eventName', eventName);
                progressLink.href = url.toString();
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        const eventName = urlParams.get('eventName');

        // Configurar enlaces al cargar la página
        setupEventLinks();

        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
        
        async function exportGeneralReportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Nombre del Evento", "Fecha del Evento", "Artista/Grupo", "Total de Entradas por Artista", "Asistencia por Artista", "Ingresos del Evento", "Gastos del Evento", "Balance del Evento"];
            csvContent += headers.join(",") + "\r\n";
            const eventsQuery = query(collection(db, 'events'));
            const eventsSnapshot = await getDocs(eventsQuery);
            for (const eventDoc of eventsSnapshot.docs) {
                const eventData = eventDoc.data();
                const eventId = eventDoc.id;
                let eventTotalIncome = 0; let eventTotalExpenses = 0;
                const ticketsSnapshot = await getDocs(query(collection(db, `events/${eventId}/tickets`)));
                const tickets = ticketsSnapshot.docs.map(d => d.data());
                eventTotalIncome = tickets.reduce((sum, t) => sum + (t.price || 0), 0);
                const expensesSnapshot = await getDocs(query(collection(db, `events/${eventId}/expenses`)));
                eventTotalExpenses = expensesSnapshot.docs.reduce((sum, d) => sum + (d.data().amount || 0), 0);
                const artistData = tickets.reduce((acc, ticket) => {
                    const prefix = ticket.prefix || "Sin Grupo";
                    if (!acc[prefix]) acc[prefix] = { totalTickets: 0, attendance: 0 };
                    acc[prefix].totalTickets++;
                    if (ticket.used) acc[prefix].attendance++;
                    return acc;
                }, {});
                Object.keys(artistData).forEach(artist => {
                    const data = artistData[artist];
                    const row = [`"${eventData.name}"`, `"${eventData.date}"`, `"${artist}"`, data.totalTickets, data.attendance, eventTotalIncome, eventTotalExpenses, (eventTotalIncome - eventTotalExpenses)];
                    csvContent += row.join(",") + "\r\n";
                });
            }
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "reporte_general_vytmusic.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function loadGeneralReport() {
            let totalIncome = 0, totalExpenses = 0, totalTickets = 0;
            const eventsQuery = query(collection(db, 'events'));
            const eventsSnapshot = await getDocs(eventsQuery);
            for (const eventDoc of eventsSnapshot.docs) {
                const eventData = eventDoc.data();
                if (eventData.manualTicketAdjustment) totalTickets += eventData.manualTicketAdjustment;
                const ticketsSnapshot = await getDocs(query(collection(db, `events/${eventDoc.id}/tickets`)));
                ticketsSnapshot.forEach(doc => {
                    totalIncome += (doc.data().price || 0);
                    totalTickets++;
                });
                const expensesSnapshot = await getDocs(query(collection(db, `events/${eventDoc.id}/expenses`)));
                expensesSnapshot.forEach(doc => totalExpenses += (doc.data().amount || 0));
            }
            const balance = totalIncome - totalExpenses;
            document.getElementById('general-total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('general-total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('general-total-tickets').textContent = totalTickets;
            const generalNetBalanceEl = document.getElementById('general-net-balance');
            generalNetBalanceEl.textContent = formatCurrency(balance);
            generalNetBalanceEl.className = 'text-xl md:text-2xl font-bold mt-2 break-words ' + (balance >= 0 ? 'text-sky-400' : 'text-red-400');
        }

        if (eventId && eventName) {
            document.getElementById('general-report-section').classList.add('hidden');
            document.getElementById('accounting-section').classList.remove('hidden');
            document.getElementById('event-name-display').textContent = `Gala: ${eventName}`;
            const backToPanelBtn = document.getElementById('back-to-panel-btn');
            const backToEventsLink = document.getElementById('back-to-events-link');
            const panelUrl = `panel_evento.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;
            backToEventsLink.href = panelUrl;
            backToEventsLink.textContent = '← Volver al Panel del Evento';
            backToPanelBtn.href = panelUrl;
            backToPanelBtn.classList.remove('hidden');
            const eventRef = doc(db, 'events', eventId);
            const ticketsQuery = query(collection(db, `events/${eventId}/tickets`));
            const expensesQuery = query(collection(db, `events/${eventId}/expenses`));
            const state = { income: 0, expenses: 0, ticketsInSystem: 0, manualAdjustment: 0 };
            function updateUI() {
                const { income, expenses, ticketsInSystem, manualAdjustment } = state;
                const balance = income - expenses;
                const totalTickets = ticketsInSystem + manualAdjustment;
                document.getElementById('total-income').textContent = formatCurrency(income);
                document.getElementById('total-expenses').textContent = formatCurrency(expenses);
                document.getElementById('total-tickets').textContent = totalTickets;
                const netBalanceEl = document.getElementById('net-balance');
                netBalanceEl.textContent = formatCurrency(balance);
                netBalanceEl.className = 'text-xl md:text-2xl font-bold mt-2 break-words ' + (balance >= 0 ? 'text-sky-400' : 'text-red-400');
            }
            getDoc(eventRef).then(docSnap => {
                if (docSnap.exists() && docSnap.data().manualTicketAdjustment) {
                    state.manualAdjustment = docSnap.data().manualTicketAdjustment;
                    document.getElementById('manual-adjustment-input').value = state.manualAdjustment;
                    updateUI();
                }
            });
            onSnapshot(ticketsQuery, (snapshot) => {
                const tickets = snapshot.docs.map(doc => doc.data());
                state.ticketsInSystem = tickets.length;
                state.income = tickets.reduce((sum, ticket) => sum + (ticket.price || 0), 0);
                const incomeBreakdown = tickets.reduce((acc, ticket) => {
                    const tier = ticket.tierName || 'Sin Tipo';
                    if (!acc[tier]) acc[tier] = { count: 0, total: 0, price: ticket.price || 0 };
                    acc[tier].count++;
                    acc[tier].total += (ticket.price || 0);
                    return acc;
                }, {});
                const incomeBreakdownList = document.getElementById('income-breakdown-list');
                incomeBreakdownList.innerHTML = '';
                Object.keys(incomeBreakdown).sort().forEach(tier => {
                    const item = incomeBreakdown[tier];
                    const li = document.createElement('div');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${item.count} x ${tier} (${formatCurrency(item.price)})</span><span class="font-semibold">${formatCurrency(item.total)}</span>`;
                    incomeBreakdownList.appendChild(li);
                });
                updateUI();
            });
            onSnapshot(expensesQuery, (snapshot) => {
                const expensesList = document.getElementById('expenses-list');
                expensesList.innerHTML = '';
                state.expenses = 0;
                snapshot.forEach(doc => {
                    const expense = { id: doc.id, ...doc.data() };
                    state.expenses += expense.amount;
                    const li = document.createElement('div');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${expense.description}</span><span class="font-semibold">${formatCurrency(expense.amount)} <button data-id="${expense.id}" class="delete-expense-btn text-red-500 ml-2">X</button></span>`;
                    expensesList.appendChild(li);
                });
                updateUI();
            });
            document.getElementById('expense-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                if (description && amount > 0) await addDoc(collection(db, `events/${eventId}/expenses`), { description, amount }); e.target.reset();
            });
            document.getElementById('expenses-list').addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-expense-btn')) {
                    if(confirm("¿Seguro que quieres eliminar este gasto?")) await deleteDoc(doc(db, `events/${eventId}/expenses`, e.target.dataset.id));
                }
            });
            document.getElementById('save-adjustment-btn').addEventListener('click', async () => {
                const adjustmentValue = parseInt(document.getElementById('manual-adjustment-input').value) || 0;
                await updateDoc(eventRef, { manualTicketAdjustment: adjustmentValue });
                state.manualAdjustment = adjustmentValue;
                updateUI();
                alert("Ajuste guardado con éxito.");
            });
        } else {
            document.getElementById('event-name-display').textContent = "Reporte General";
            document.getElementById('general-report-section').classList.remove('hidden');
            document.getElementById('accounting-section').classList.add('hidden');
            loadGeneralReport();
            loadGalaLinks(); // Cargar enlaces a galas individuales
            setupEconomicGalaSelector(); // Configurar selector de galas económicas
            document.getElementById('export-general-report-btn').addEventListener('click', exportGeneralReportToCSV);
        }

        async function loadGalaLinks() {
            try {
                const eventsQuery = query(collection(db, 'events'));
                const eventsSnapshot = await getDocs(eventsQuery);
                const galaLinksContainer = document.getElementById('gala-links-container');
                
                if (eventsSnapshot.empty) {
                    galaLinksContainer.innerHTML = '<p class="text-gray-400 text-sm">No hay galas registradas aún</p>';
                    return;
                }

                galaLinksContainer.innerHTML = '';
                eventsSnapshot.docs.forEach(doc => {
                    const eventData = doc.data();
                    const link = document.createElement('a');
                    link.href = `reporte_por_gala.html?eventId=${doc.id}&eventName=${encodeURIComponent(eventData.name)}`;
                    link.className = 'block w-full px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors text-sm';
                    link.innerHTML = `📊 ${eventData.name} <span class="text-xs opacity-75">(${eventData.date || 'Sin fecha'})</span>`;
                    galaLinksContainer.appendChild(link);
                });
            } catch (error) {
                console.error('Error cargando enlaces de galas:', error);
                document.getElementById('gala-links-container').innerHTML = '<p class="text-red-400 text-sm">Error cargando galas</p>';
            }
        }

        // 💰 NUEVO SISTEMA DE SELECTOR DE GALAS ECONÓMICAS
        let economicSelectedEvents = new Set();
        let allEventsData = [];

        async function setupEconomicGalaSelector() {
            // Event listeners para los botones principales
            document.getElementById('show-all-galas-btn').addEventListener('click', () => {
                document.getElementById('economic-gala-selector-container').classList.add('hidden');
                document.getElementById('economic-details-container').classList.add('hidden');
                loadGeneralReport(); // Cargar reporte de todas las galas
            });

            document.getElementById('show-gala-selector-btn').addEventListener('click', async () => {
                document.getElementById('economic-gala-selector-container').classList.remove('hidden');
                await loadEventsForEconomicSelector();
            });

            // Event listeners para el selector de galas
            document.getElementById('load-selected-galas-btn').addEventListener('click', loadSelectedGalasEconomic);
            document.getElementById('select-all-galas-btn').addEventListener('click', selectAllEconomicGalas);
            document.getElementById('clear-gala-selection-btn').addEventListener('click', clearEconomicGalaSelection);
        }

        async function loadEventsForEconomicSelector() {
            try {
                const eventsQuery = query(collection(db, 'events'));
                const eventsSnapshot = await getDocs(eventsQuery);
                allEventsData = eventsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const container = document.getElementById('economic-events-checkboxes');
                container.innerHTML = '';

                if (allEventsData.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No hay eventos registrados</p>';
                    return;
                }

                allEventsData.forEach(event => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center space-x-3 p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `econ-event-${event.id}`;
                    checkbox.value = event.id;
                    checkbox.className = 'w-4 h-4 text-green-600 bg-gray-900 border-gray-600 rounded focus:ring-green-500';
                    checkbox.addEventListener('change', updateEconomicGalasSelection);

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.className = 'flex-1 text-sm font-medium text-gray-300 cursor-pointer';
                    label.innerHTML = `
                        <span class="text-green-400">🎭 ${event.name}</span>
                        <br>
                        <span class="text-xs text-gray-400">📅 ${event.date || 'Sin fecha'} • 🆔 ${event.id.substring(0, 8)}...</span>
                    `;

                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    container.appendChild(checkboxDiv);
                });

            } catch (error) {
                console.error('Error cargando eventos:', error);
                document.getElementById('economic-events-checkboxes').innerHTML = '<p class="text-red-400">Error al cargar eventos</p>';
            }
        }

        function updateEconomicGalasSelection() {
            const checkboxes = document.querySelectorAll('#economic-events-checkboxes input[type="checkbox"]');
            economicSelectedEvents.clear();
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    economicSelectedEvents.add(checkbox.value);
                }
            });

            const loadBtn = document.getElementById('load-selected-galas-btn');
            loadBtn.disabled = economicSelectedEvents.size === 0;
            
            const count = economicSelectedEvents.size;
            loadBtn.textContent = count > 0 ? 
                `💰 Generar Reporte (${count} gala${count > 1 ? 's' : ''})` : 
                '💰 Generar Reporte Económico';
        }

        function selectAllEconomicGalas() {
            const checkboxes = document.querySelectorAll('#economic-events-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateEconomicGalasSelection();
        }

        function clearEconomicGalaSelection() {
            const checkboxes = document.querySelectorAll('#economic-events-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateEconomicGalasSelection();
        }

        async function loadSelectedGalasEconomic() {
            if (economicSelectedEvents.size === 0) {
                alert('Por favor, selecciona al menos una gala para generar el reporte económico.');
                return;
            }

            try {
                document.getElementById('economic-details-container').classList.remove('hidden');
                
                let totalIncome = 0;
                let totalExpenses = 0;
                let totalTickets = 0;
                const galaBreakdown = [];

                // Procesar cada gala seleccionada
                for (const eventId of economicSelectedEvents) {
                    const eventData = allEventsData.find(e => e.id === eventId);
                    
                    // Obtener tickets de esta gala
                    const ticketsSnapshot = await getDocs(collection(db, `events/${eventId}/tickets`));
                    const tickets = ticketsSnapshot.docs.map(doc => doc.data());
                    
                    // Obtener gastos de esta gala
                    const expensesSnapshot = await getDocs(collection(db, `events/${eventId}/expenses`));
                    const expenses = expensesSnapshot.docs.map(doc => doc.data());
                    
                    // Obtener ajuste manual si existe
                    const eventDoc = await getDoc(doc(db, 'events', eventId));
                    const manualAdjustment = eventDoc.exists() ? (eventDoc.data().manualTicketAdjustment || 0) : 0;
                    
                    // Calcular totales de esta gala
                    const galaIncome = tickets.reduce((sum, ticket) => sum + (ticket.price || 0), 0);
                    const galaExpenses = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                    const galaTicketsCount = tickets.length + manualAdjustment;
                    const galaBalance = galaIncome - galaExpenses;
                    
                    // Acumular totales generales
                    totalIncome += galaIncome;
                    totalExpenses += galaExpenses;
                    totalTickets += galaTicketsCount;
                    
                    // Guardar detalles de esta gala
                    galaBreakdown.push({
                        name: eventData.name,
                        date: eventData.date || 'Sin fecha',
                        income: galaIncome,
                        expenses: galaExpenses,
                        tickets: galaTicketsCount,
                        balance: galaBalance,
                        ticketBreakdown: tickets.reduce((acc, ticket) => {
                            const tier = ticket.tierName || 'Sin Tipo';
                            if (!acc[tier]) acc[tier] = { count: 0, total: 0 };
                            acc[tier].count++;
                            acc[tier].total += (ticket.price || 0);
                            return acc;
                        }, {}),
                        expensesList: expenses
                    });
                }

                // Actualizar totales generales
                const totalBalance = totalIncome - totalExpenses;
                
                document.getElementById('general-total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('general-total-expenses').textContent = formatCurrency(totalExpenses);
                document.getElementById('general-total-tickets').textContent = totalTickets;
                
                const balanceEl = document.getElementById('general-net-balance');
                balanceEl.textContent = formatCurrency(totalBalance);
                balanceEl.className = 'text-xl md:text-2xl font-bold mt-2 break-words ' + 
                    (totalBalance >= 0 ? 'text-sky-400' : 'text-red-400');

                // Mostrar detalles por gala
                renderGalaEconomicBreakdown(galaBreakdown);

            } catch (error) {
                console.error('Error cargando reportes económicos:', error);
                alert('Error al cargar los datos económicos: ' + error.message);
            }
        }

        function renderGalaEconomicBreakdown(galaBreakdown) {
            const container = document.getElementById('gala-economic-breakdown');
            container.innerHTML = '';

            galaBreakdown.forEach(gala => {
                const galaCard = document.createElement('div');
                galaCard.className = 'bg-gray-700 p-6 rounded-lg border-l-4 border-green-500';
                
                const ticketBreakdownHtml = Object.entries(gala.ticketBreakdown).map(([tier, data]) => 
                    `<div class="flex justify-between text-sm">
                        <span>${data.count} x ${tier}</span>
                        <span class="font-semibold">${formatCurrency(data.total)}</span>
                    </div>`
                ).join('');

                const expensesHtml = gala.expensesList.length > 0 ? 
                    gala.expensesList.map(expense => 
                        `<div class="flex justify-between text-sm">
                            <span>${expense.description}</span>
                            <span class="text-red-400">-${formatCurrency(expense.amount)}</span>
                        </div>`
                    ).join('') : 
                    '<div class="text-sm text-gray-400">Sin gastos registrados</div>';

                galaCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-green-300">🎭 ${gala.name}</h4>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">📅 ${gala.date}</div>
                            <div class="text-lg font-bold ${gala.balance >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${formatCurrency(gala.balance)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-800 p-4 rounded">
                            <h5 class="text-sm font-bold text-green-400 mb-2">💰 Ingresos (${gala.tickets} entradas)</h5>
                            <div class="space-y-1">
                                ${ticketBreakdownHtml}
                            </div>
                            <div class="border-t border-gray-600 mt-2 pt-2">
                                <div class="flex justify-between font-bold">
                                    <span>Total:</span>
                                    <span class="text-green-400">${formatCurrency(gala.income)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded">
                            <h5 class="text-sm font-bold text-red-400 mb-2">💸 Gastos</h5>
                            <div class="space-y-1">
                                ${expensesHtml}
                            </div>
                            <div class="border-t border-gray-600 mt-2 pt-2">
                                <div class="flex justify-between font-bold">
                                    <span>Total:</span>
                                    <span class="text-red-400">${formatCurrency(gala.expenses)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded">
                            <h5 class="text-sm font-bold text-sky-400 mb-2">📊 Resumen</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Ingresos:</span>
                                    <span class="text-green-400">${formatCurrency(gala.income)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Gastos:</span>
                                    <span class="text-red-400">${formatCurrency(gala.expenses)}</span>
                                </div>
                                <div class="border-t border-gray-600 pt-2">
                                    <div class="flex justify-between font-bold">
                                        <span>Balance:</span>
                                        <span class="${gala.balance >= 0 ? 'text-green-400' : 'text-red-400'}">
                                            ${formatCurrency(gala.balance)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(galaCard);
            });
        }
    </script>
</body>
</html>