<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestiÃ³n de Jurados - VYT Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">ğŸ­ GestiÃ³n de Jurados</h1>
            <p id="event-title" class="text-xl text-gray-300 mb-4">Cargando evento...</p>
            <a href="#" id="back-link" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">
                â† Volver al Panel
            </a>
        </div>

        <!-- Contenedor de Mensajes -->
        <div id="message-container" class="mb-6"></div>

        <!-- Crear Jurado -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">â• Crear Nuevo Jurado</h2>
            <form id="jury-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">ğŸ‘¤ Nombre del Jurado</label>
                        <input type="text" id="jury-name" required 
                               class="w-full p-3 bg-gray-700 text-white rounded border border-gray-600"
                               placeholder="Ej: Juan PÃ©rez">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">ğŸ¯ Tipo de Jurado</label>
                        <select id="jury-type" required 
                                class="w-full p-3 bg-gray-700 text-white rounded border border-gray-600">
                            <option value="individual">ğŸ§‘ Individual</option>
                            <option value="grupal">ğŸ‘¥ Grupal</option>
                            <option value="secreto">ğŸ¤ Secreto</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-bold">
                    âœ… Crear Jurado
                </button>
            </form>
        </div>

        <!-- Lista de Jurados -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">ğŸ“‹ Jurados Registrados</h2>
            <div id="loading" class="text-center py-8">
                <p class="text-gray-400">Cargando jurados...</p>
            </div>
            <div id="jury-list"></div>
        </div>

        <!-- Acciones -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4">ğŸš€ Acciones</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="test-voting-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded font-bold">
                    ğŸ§ª Probar Sistema de VotaciÃ³n
                </button>
                <button id="view-results-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded font-bold">
                    ğŸ“Š Ver Resultados
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);

        // âœ… FUNCIONES DE MENSAJE MEJORADAS
        function showMessage(message, type = 'success') {
            const messageContainer = document.getElementById('message-container');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600', 
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            messageContainer.innerHTML = `
                <div class="p-4 rounded-lg ${colors[type]} text-white mb-4 flex items-center gap-3">
                    <span class="text-xl">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
                    </span>
                    <span>${message}</span>
                </div>
            `;
            
            // Auto-ocultar despuÃ©s de 5 segundos
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }
        const eventId = urlParams.get('eventId');
        const eventName = urlParams.get('eventName');

        if (!eventId || !eventName) {
            alert('Error: Falta informaciÃ³n del evento');
            window.location.href = 'eventos.html';
        }

        document.getElementById('event-title').textContent = eventName;
        document.getElementById('back-link').href = `panel_evento_mejorado.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;

        let currentJuries = [];

        // FunciÃ³n para obtener etiqueta del tipo de jurado
        function getJurorTypeLabel(type) {
            const labels = {
                'individual': 'Jurado Individual',
                'grupal': 'Jurado Grupal',
                'secreto': 'Jurado Secreto',
                'principal': 'Jurado Principal',
                'invitado': 'Jurado Invitado'
            };
            return labels[type] || 'Jurado';
        }

        loadJuries();

        document.getElementById('jury-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('jury-name').value.trim();
            const type = document.getElementById('jury-type').value;

            // âœ… VALIDACIONES MEJORADAS
            if (!name) {
                showMessage('El nombre es obligatorio', 'error');
                return;
            }

            if (name.length < 3) {
                showMessage('El nombre debe tener al menos 3 caracteres', 'error');
                return;
            }

            if (name.length > 50) {
                showMessage('El nombre no puede exceder 50 caracteres', 'error');
                return;
            }

            // Verificar si ya existe un jurado con ese nombre
            if (currentJuries.some(jury => (jury.displayName || jury.name).toLowerCase() === name.toLowerCase())) {
                showMessage('Ya existe un jurado con ese nombre', 'error');
                return;
            }

                try {
                const jurorId = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                
                await setDoc(doc(db, `jury_users`, jurorId), {
                    id: jurorId,
                    name: name,
                    username: name.toLowerCase(),
                    displayName: name,
                    type: type,
                    typeLabel: getJurorTypeLabel(type),
                    password: jurorId, // Password simple basado en el ID
                    isActive: true,
                    createdAt: new Date().toISOString()
                });                alert(`âœ… Jurado "${name}" creado exitosamente`);
                document.getElementById('jury-form').reset();
                loadJuries();

            } catch (error) {
                console.error('Error:', error);
                alert('âŒ Error: ' + error.message);
            }
        });

        async function loadJuries() {
            const loading = document.getElementById('loading');
            const juryList = document.getElementById('jury-list');
            
            try {
                const snapshot = await getDocs(collection(db, `jury_users`));
                currentJuries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                loading.style.display = 'none';

                if (currentJuries.length === 0) {
                    juryList.innerHTML = '<p class="text-center text-gray-400 py-8">No hay jurados registrados</p>';
                    return;
                }

                juryList.innerHTML = '';
                currentJuries.forEach(jury => {
                    const typeEmoji = { individual: 'ğŸ§‘', grupal: 'ğŸ‘¥', secreto: 'ğŸ¤' }[jury.type] || 'ğŸ­';
                    
                    const juryDiv = document.createElement('div');
                    juryDiv.className = 'bg-gray-700 rounded p-4 mb-3 flex justify-between items-center';
                    juryDiv.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${typeEmoji}</span>
                            <div>
                                <h3 class="font-bold">${jury.displayName || jury.name}</h3>
                                <p class="text-sm text-gray-300">ID: ${jury.id}</p>
                                <p class="text-sm text-gray-300">ContraseÃ±a: ${jury.password}</p>
                                <p class="text-sm text-gray-400">Tipo: ${jury.typeLabel || jury.type}</p>
                                <p class="text-sm ${jury.isActive ? 'text-green-400' : 'text-red-400'}">${jury.isActive ? 'ğŸŸ¢ Activo' : 'ğŸ”´ Inactivo'}</p>
                            </div>
                        </div>
                        <button onclick="deleteJury('${jury.id}', '${jury.displayName || jury.name}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                            ğŸ—‘ï¸ Eliminar
                        </button>
                    `;
                    juryList.appendChild(juryDiv);
                });

            } catch (error) {
                loading.style.display = 'none';
                juryList.innerHTML = `<p class="text-center text-red-400 py-8">Error: ${error.message}</p>`;
            }
        }

        window.deleteJury = async (juryId, juryName) => {
            if (confirm(`Â¿Eliminar jurado "${juryName}"?`)) {
                try {
                    await deleteDoc(doc(db, `jury_users`, juryId));
                    loadJuries();
                } catch (error) {
                    alert('Error al eliminar: ' + error.message);
                }
            }
        };

        document.getElementById('test-voting-btn').addEventListener('click', () => {
            window.open(`votacion_jurados_FINAL.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`, '_blank');
        });

        document.getElementById('view-results-btn').addEventListener('click', () => {
            window.open(`resultados_votacion.html?eventId=${eventId}`, '_blank');
        });
    </script>
</body>
</html>