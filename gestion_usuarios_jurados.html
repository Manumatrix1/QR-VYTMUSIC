<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios Jurados - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }
        .glass-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="glass-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- HEADER -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">üë®‚Äç‚öñÔ∏è Gesti√≥n de Usuarios Jurados</h1>
            <p class="text-lg opacity-90">Crear y administrar cuentas permanentes para jurados</p>
            <a href="panel_evento.html" class="inline-block mt-4 bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                ‚Üê Volver al Panel Principal
            </a>
        </div>

        <!-- CREAR NUEVO USUARIO -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-8 max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-4">‚ûï Crear Nuevo Usuario Jurado</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Nombre del Jurado:</label>
                    <input type="text" id="new-juror-name" placeholder="Ej: Lisandro Garc√≠a" 
                           class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60">
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Tipo de Jurado:</label>
                    <select id="new-juror-type" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white">
                        <option value="">-- Seleccionar tipo --</option>
                        <option value="principal">üèÜ Jurado Principal</option>
                        <option value="individual">üßë Jurado Individual</option>
                        <option value="grupal">üë• Jurado Grupal</option>
                        <option value="invitado">üé≠ Jurado Invitado</option>
                        <option value="secreto">ü§ê Jurado Secreto</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Informaci√≥n Adicional (Opcional):</label>
                    <input type="text" id="new-juror-additional" placeholder="Ej: Profesor de Canto, M√∫sico Profesional" 
                           class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60">
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Contrase√±a/PIN:</label>
                    <input type="text" id="new-juror-password" placeholder="Ej: 1234 o nombre123" 
                           class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60">
                    <p class="text-xs opacity-70 mt-1">Contrase√±a simple que el jurado usar√° para acceder</p>
                </div>

                <button onclick="createJuror()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    ‚ú® Crear Usuario Jurado
                </button>
            </div>
        </div>

        <!-- LISTA DE USUARIOS EXISTENTES -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6">
            <h2 class="text-2xl font-bold mb-4">üìã Usuarios Jurados Existentes</h2>
            <div id="jurors-list" class="space-y-3">
                <div class="text-center py-8 opacity-60">
                    <div class="text-4xl mb-2">üë•</div>
                    <p>Cargando usuarios...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, doc, setDoc, getDocs, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Variables globales
        window.db = db;

        // Funci√≥n para crear nuevo jurado
        window.createJuror = async function() {
            const name = document.getElementById('new-juror-name').value.trim();
            const type = document.getElementById('new-juror-type').value;
            const additional = document.getElementById('new-juror-additional').value.trim();
            const password = document.getElementById('new-juror-password').value.trim();

            if (!name) {
                alert('‚ùå El nombre es obligatorio');
                return;
            }

            if (!type) {
                alert('‚ùå El tipo de jurado es obligatorio');
                return;
            }

            if (!password) {
                alert('‚ùå La contrase√±a/PIN es obligatoria');
                return;
            }

            try {
                const jurorId = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                
                const jurorData = {
                    id: jurorId,
                    name: name,
                    type: type,
                    typeLabel: getJurorTypeLabel(type),
                    additional: additional,
                    password: password,
                    createdAt: new Date().toISOString(),
                    isActive: true
                };

                // ‚úÖ JURADOS GLOBALES - Pueden acceder a todos los eventos
                await setDoc(doc(db, `jury_users`, jurorId), jurorData);
                
                alert(`‚úÖ Usuario "${name}" creado exitosamente!\n\nID: ${jurorId}\nContrase√±a: ${password}`);
                
                // Limpiar formulario
                document.getElementById('new-juror-name').value = '';
                document.getElementById('new-juror-type').value = '';
                document.getElementById('new-juror-additional').value = '';
                document.getElementById('new-juror-password').value = '';
                
                loadJurors();
                
            } catch (error) {
                console.error('Error creando jurado:', error);
                alert('‚ùå Error al crear el usuario: ' + error.message);
            }
        };

        // Funci√≥n para cargar jurados existentes
        window.loadJurors = async function() {
            try {
                const jurorsQuery = query(
                    collection(db, `jury_users`),
                    orderBy('createdAt', 'desc')
                );
                
                const snapshot = await getDocs(jurorsQuery);
                const container = document.getElementById('jurors-list');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 opacity-60">
                            <div class="text-4xl mb-2">üë•</div>
                            <p>No hay usuarios jurados creados</p>
                            <p class="text-sm">Crea el primer usuario usando el formulario de arriba</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const juror = doc.data();
                    const typeColor = getTypeColor(juror.type);
                    
                    html += `
                        <div class="bg-white/10 p-4 rounded-lg border border-white/20">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold">${juror.name}</h3>
                                        <span class="px-2 py-1 text-xs rounded-full ${typeColor}">${juror.typeLabel}</span>
                                        ${juror.isActive ? '<span class="text-green-400">üü¢ Activo</span>' : '<span class="text-red-400">üî¥ Inactivo</span>'}
                                    </div>
                                    <div class="text-sm opacity-75">
                                        <p><strong>ID:</strong> ${juror.id}</p>
                                        <p><strong>Contrase√±a:</strong> ${juror.password}</p>
                                        ${juror.additional ? `<p><strong>Info:</strong> ${juror.additional}</p>` : ''}
                                        <p><strong>Creado:</strong> ${new Date(juror.createdAt).toLocaleDateString()}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="toggleJurorStatus('${juror.id}', ${juror.isActive})" 
                                            class="px-3 py-1 text-xs rounded ${juror.isActive ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'}">
                                        ${juror.isActive ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                                    </button>
                                    <button onclick="deleteJuror('${juror.id}', '${juror.name}')" 
                                            class="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 rounded">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando jurados:', error);
                document.getElementById('jurors-list').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <p>Error al cargar usuarios: ${error.message}</p>
                    </div>
                `;
            }
        };

        // Funci√≥n auxiliar para obtener etiqueta del tipo de jurado
        function getJurorTypeLabel(type) {
            const labels = {
                'principal': 'Jurado Principal',
                'individual': 'Jurado Individual', 
                'grupal': 'Jurado Grupal',
                'invitado': 'Jurado Invitado',
                'secreto': 'Jurado Secreto'
            };
            return labels[type] || 'Jurado';
        }

        // Funci√≥n auxiliar para obtener color del tipo
        function getTypeColor(type) {
            const colors = {
                'principal': 'bg-purple-600',
                'individual': 'bg-blue-600',
                'grupal': 'bg-green-600', 
                'invitado': 'bg-yellow-600',
                'secreto': 'bg-gray-600'
            };
            return colors[type] || 'bg-gray-600';
        }

        // Funci√≥n para cambiar estado activo/inactivo
        window.toggleJurorStatus = async function(jurorId, currentStatus) {
            try {
                await setDoc(doc(db, `jury_users`, jurorId), {
                    isActive: !currentStatus
                }, { merge: true });
                
                loadJurors();
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                alert('‚ùå Error al cambiar estado: ' + error.message);
            }
        };

        // Funci√≥n para eliminar jurado
        window.deleteJuror = async function(jurorId, jurorName) {
            if (!confirm(`¬øEst√°s seguro de eliminar al usuario "${jurorName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, `jury_users`, jurorId));
                
                alert(`‚úÖ Usuario "${jurorName}" eliminado exitosamente`);
                loadJurors();
                
            } catch (error) {
                console.error('Error eliminando jurado:', error);
                alert('‚ùå Error al eliminar usuario: ' + error.message);
            }
        };

        // Cargar jurados al iniciar
        loadJurors();
    </script>
</body>
</html>