<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Votaci√≥n - Jurado VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #38bdf8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .artist-card { background-color: #1f2937; border: 2px solid #374151; border-radius: 0.5rem; padding: 1rem; transition: all 0.2s; margin-bottom: 1rem; }
        .artist-card.voted { border-color: #10b981; background-color: #065f46; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        .artist-card.voted::before { content: '‚úÖ VOTADO'; position: absolute; top: 10px; right: 10px; background-color: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: bold; }
        .artist-card { position: relative; }
        
        /* NAVEGACI√ìN R√ÅPIDA */
        .quick-nav-item { 
            padding: 0.5rem 0.75rem; 
            background-color: #374151; 
            border: 2px solid #4b5563; 
            border-radius: 0.5rem; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-size: 0.85rem;
            font-weight: 600;
        }
        .quick-nav-item:hover { 
            background-color: #4b5563; 
            border-color: #38bdf8; 
            transform: scale(1.02);
        }
        .quick-nav-item.voted { 
            background-color: #065f46; 
            border-color: #10b981; 
            color: #d1fae5;
        }
        .quick-nav-item.voted::after { 
            content: ' ‚úì'; 
            color: #10b981; 
            font-weight: bold;
        }
        
        /* OPTIMIZACI√ìN M√ìVIL */
        .artist-header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background-color: #374151; border-radius: 0.5rem; }
        .artist-header-content { display: flex; align-items: center; gap: 1rem; }
        .artist-image-large { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #38bdf8; flex-shrink: 0; }
        .artist-info { flex-grow: 1; }
        .artist-name { font-size: 1.25rem; font-weight: bold; color: #38bdf8; margin-bottom: 0.5rem; }
        .artist-details { color: #d1d5db; font-size: 0.8rem; line-height: 1.3; }
        .artist-evolution { margin-top: 0.5rem; text-align: center; }
        .evolution-trend { display: inline-block; margin: 0 0.25rem; font-size: 0.75rem; padding: 0.25rem 0.5rem; background-color: #4b5563; border-radius: 0.25rem; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-same { color: #6b7280; }
        
        /* CRITERIOS M√ìVIL */
        .criteria-voting { margin-bottom: 1rem; padding: 0.75rem; background-color: #4b5563; border-radius: 0.5rem; }
        .criteria-voting h4 { font-size: 0.9rem; margin-bottom: 0.5rem; text-align: center; }
        .rating-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .rating-btn { padding: 0.5rem 0.25rem; border-radius: 0.5rem; font-weight: 600; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; font-size: 0.75rem; position: relative; }
        .rating-btn:hover { transform: scale(1.02); }
        .rating-btn.selected { 
            border-color: #ffffff !important; 
            box-shadow: 0 0 20px rgba(59, 130, 246, 1) !important; 
            transform: scale(1.1) !important;
            background-color: #6b7280 !important; /* Gris m√°s visible */
            color: #ffffff !important;
            position: relative !important;
            z-index: 10 !important;
        }
        .rating-btn.selected::before {
            content: '‚úì SELECCIONADO' !important;
            position: absolute !important;
            top: -25px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background-color: #10b981 !important;
            color: white !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            font-size: 0.6rem !important;
            font-weight: bold !important;
            white-space: nowrap !important;
            z-index: 15 !important;
        }
        .rating-btn.selected::after {
            content: '‚úì' !important;
            position: absolute !important;
            top: -8px !important;
            right: -8px !important;
            background-color: #10b981 !important;
            color: white !important;
            border-radius: 50% !important;
            width: 20px !important;
            height: 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 0.7rem !important;
            font-weight: bold !important;
            z-index: 15 !important;
        }
        
        .rating-malo { background-color: #dc2626; color: white; }
        .rating-mediocre { background-color: #ea580c; color: white; }
        .rating-bueno { background-color: #eab308; color: white; }
        .rating-muy-bueno { background-color: #16a34a; color: white; }
        .rating-excelente { background-color: #059669; color: white; }
        
        /* RESPONSIVE MEJORAS */
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .artist-image-large { width: 60px; height: 60px; }
            .artist-name { font-size: 1.1rem; }
            .criteria-voting { padding: 0.5rem; }
            .rating-buttons { grid-template-columns: 1fr; gap: 0.5rem; }
            .rating-btn { padding: 0.75rem; font-size: 0.8rem; }
        }
        
        .criteria-section { background-color: #374151; padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 900; display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; max-width: 90%; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="loading-overlay hidden"><div class="spinner"></div></div>

    <!-- Modal de autenticaci√≥n -->
    <div id="auth-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center text-sky-400">Panel de Jurado - VYTMUSIC</h3>
            <p class="mb-4 text-gray-300 text-center">Ingresa tus credenciales de jurado para acceder al sistema de votaci√≥n.</p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="juror-name" class="block mb-1 font-semibold text-gray-300">Nombre</label>
                    <input type="text" id="juror-name" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                </div>
                <div>
                    <label for="juror-password" class="block mb-1 font-semibold text-gray-300">Contrase√±a</label>
                    <input type="password" id="juror-password" required class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white">
                </div>
                <button type="submit" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">
                    Acceder al Panel
                </button>
            </form>
            <div id="auth-error" class="mt-4 text-red-400 text-center hidden"></div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div id="confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Confirmar Votaci√≥n</h3>
            <p id="confirm-message" class="mb-4 text-gray-300"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-vote-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="confirm-vote-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden container mx-auto max-w-6xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <img src="https://i.imgur.com/rqkZi9P.png" alt="VYTMUSIC Logo" class="mx-auto mb-4 bg-white rounded-full" style="max-width: 100px;">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Panel de Votaci√≥n - Jurado</h1>
            <p id="event-name-display" class="text-xl text-gray-300 mt-2"></p>
            <p id="juror-info" class="text-lg text-gray-400 mt-1"></p>
            <p id="gala-info" class="text-sm text-gray-500"></p>
        </header>

        <div id="message-container" class="mb-4"></div>

        <!-- Informaci√≥n de criterios de evaluaci√≥n -->
        <section class="bg-gray-800 p-4 rounded-lg shadow-xl mb-6">
            <h2 class="text-xl font-bold mb-3 text-center">Criterios de Evaluaci√≥n Profesional</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-center text-sm">
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Afinaci√≥n</h3>
                    <p class="text-xs text-gray-400">Precisi√≥n tonal</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Ritmo</h3>
                    <p class="text-xs text-gray-400">Pulso musical</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">T√©cnica</h3>
                    <p class="text-xs text-gray-400">Control vocal</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Expresi√≥n</h3>
                    <p class="text-xs text-gray-400">Transmisi√≥n</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Presencia</h3>
                    <p class="text-xs text-gray-400">Escenario</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Original.</h3>
                    <p class="text-xs text-gray-400">Estilo propio</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Dicci√≥n</h3>
                    <p class="text-xs text-gray-400">Claridad</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Conexi√≥n</h3>
                    <p class="text-xs text-gray-400">Con p√∫blico</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Actitud</h3>
                    <p class="text-xs text-gray-400">Compromiso</p>
                </div>
                <div class="criteria-section">
                    <h3 class="font-bold text-sky-300 text-xs">Evoluci√≥n</h3>
                    <p class="text-xs text-gray-400">Crecimiento</p>
                </div>
            </div>
            <div class="mt-3 text-center">
                <h3 class="font-bold text-lg text-yellow-300 mb-2">Escala de Calificaci√≥n:</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-1 max-w-2xl mx-auto text-xs">
                    <div class="rating-btn rating-malo">Malo (20pts)</div>
                    <div class="rating-btn rating-mediocre">Mediocre (40pts)</div>
                    <div class="rating-btn rating-bueno">Bueno (60pts)</div>
                    <div class="rating-btn rating-muy-bueno">Muy Bueno (80pts)</div>
                    <div class="rating-btn rating-excelente">Excelente (100pts)</div>
                </div>
                <div class="mt-3">
                    <a href="guia_evaluacion_jurados.html" target="_blank" 
                       class="inline-block px-3 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700">
                        üìã Ver Gu√≠a Detallada
                    </a>
                </div>
            </div>
        </section>

        <!-- Lista de navegaci√≥n r√°pida -->
        <section class="bg-gray-800 p-4 rounded-lg shadow-xl mb-6">
            <h2 class="text-lg font-bold mb-3 text-center">üé§ Navegaci√≥n R√°pida de Artistas</h2>
            <div id="quick-nav-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                <p class="text-center text-gray-400 col-span-full">Cargando lista...</p>
            </div>
            <p class="text-xs text-gray-400 text-center mt-2">
                Haz clic en un nombre para ir directamente al artista
            </p>
        </section>

        <!-- Lista de artistas para votar -->
        <section id="voting-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Artistas Participantes</h2>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">
                    Cerrar Sesi√≥n
                </button>
            </div>
            
            <div id="artists-list" class="space-y-6">
                <p class="text-center text-gray-400">Cargando artistas...</p>
            </div>
            
            <div id="voting-disabled-message" class="hidden text-center py-8">
                <p class="text-xl text-yellow-400">La votaci√≥n est√° temporalmente deshabilitada</p>
                <p class="text-gray-400">Contacta al administrador para m√°s informaci√≥n</p>
            </div>
        </section>

        <!-- Resumen de votos -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-xl mt-8">
            <h2 class="text-2xl font-bold mb-4">Resumen de tus Votaciones</h2>
            <div id="voting-summary" class="space-y-2">
                <p class="text-center text-gray-400">No hay votos registrados a√∫n</p>
            </div>
        </section>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, getDoc, setDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        
        if (!eventId) {
            document.body.innerHTML = '<p class="text-center text-red-500">Error: No se ha especificado un evento.</p>';
            throw new Error('Event ID missing');
        }

        // Rating system configuration
        const RATING_VALUES = {
            malo: 20,
            mediocre: 40,
            bueno: 60,
            'muy-bueno': 80,
            excelente: 100
        };

        const CRITERIA = [
            { id: 'afinacion', name: 'Afinaci√≥n' },
            { id: 'puesta-escena', name: 'Puesta en Escena' },
            { id: 'vestimenta', name: 'Vestimenta' },
            { id: 'conexion-publico', name: 'Conexi√≥n con el P√∫blico' },
            { id: 'eleccion-cancion', name: 'Elecci√≥n de Canci√≥n' }
        ];

        // UI Elements
        const ui = {
            authModal: document.getElementById('auth-modal'),
            authForm: document.getElementById('auth-form'),
            authError: document.getElementById('auth-error'),
            jurorNameInput: document.getElementById('juror-name'),
            jurorPasswordInput: document.getElementById('juror-password'),
            
            confirmModal: document.getElementById('confirm-modal'),
            confirmMessage: document.getElementById('confirm-message'),
            cancelVoteBtn: document.getElementById('cancel-vote-btn'),
            confirmVoteBtn: document.getElementById('confirm-vote-btn'),
            
            mainContent: document.getElementById('main-content'),
            messageContainer: document.getElementById('message-container'),
            loadingOverlay: document.getElementById('loading-overlay'),
            eventNameDisplay: document.getElementById('event-name-display'),
            jurorInfo: document.getElementById('juror-info'),
            galaInfo: document.getElementById('gala-info'),
            
            artistsList: document.getElementById('artists-list'),
            votingDisabledMessage: document.getElementById('voting-disabled-message'),
            votingSummary: document.getElementById('voting-summary'),
            logoutBtn: document.getElementById('logout-btn')
        };

        let currentJuror = null;
        let eventData = null;
        let artists = [];
        let jurorVotes = {};
        let currentVoteData = null;

        // Functions
        function showMessage(message, type = 'success') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            ui.messageContainer.innerHTML = `<div class="p-4 rounded-md mb-4 text-white ${colors[type]}">${message}</div>`;
            setTimeout(() => { ui.messageContainer.innerHTML = ''; }, 5000);
        }

        function showLoading(show) {
            ui.loadingOverlay.classList.toggle('hidden', !show);
        }

        function showAuthError(message) {
            // Permitir texto multilinea convirtiendo \n a <br>
            ui.authError.innerHTML = message.replace(/\n/g, '<br>');
            ui.authError.classList.remove('hidden');
        }

        // Nuevas funciones para historial y evoluci√≥n (NO AFECTAN la votaci√≥n existente)
        function getArtistHistory(artistId) {
            // Simular historial por ahora - en producci√≥n vendr√≠a de la base de datos
            const mockHistory = {
                [artistId]: [
                    { gala: 1, score: Math.floor(Math.random() * 20) + 70, song: 'Canci√≥n Gala 1' },
                    { gala: 2, score: Math.floor(Math.random() * 20) + 75, song: 'Canci√≥n Gala 2' }
                ]
            };
            return mockHistory[artistId] || [];
        }

        function calculateEvolutionTrend(history) {
            if (!history || history.length === 0) return [];
            
            return history.map((gala, index) => {
                let trend = 'trend-same';
                let arrow = '‚û°Ô∏è';
                
                if (index > 0) {
                    const prevScore = history[index - 1].score;
                    if (gala.score > prevScore) {
                        trend = 'trend-up';
                        arrow = '‚¨ÜÔ∏è';
                    } else if (gala.score < prevScore) {
                        trend = 'trend-down';
                        arrow = '‚¨áÔ∏è';
                    }
                }
                
                return {
                    number: gala.gala,
                    score: gala.score.toFixed(1),
                    trend,
                    arrow
                };
            }).slice(-2); // Solo mostrar las √∫ltimas 2 galas
        }

        async function authenticateJuror(e) {
            e.preventDefault();
            
            const name = ui.jurorNameInput.value.trim();
            const password = ui.jurorPasswordInput.value.trim();
            
            console.log('üîê Intentando autenticar:', { name, password });
            
            try {
                showLoading(true);
                
                // Cargar jurados desde localStorage (donde est√°n realmente guardados)
                const jurorsKey = `jurados_${eventId}`;
                const storedJurors = localStorage.getItem(jurorsKey);
                
                console.log('üìã Clave de b√∫squeda:', jurorsKey);
                console.log('üíæ Datos en localStorage:', storedJurors);
                
                let jurors = [];
                if (storedJurors) {
                    try {
                        jurors = JSON.parse(storedJurors);
                        console.log('‚úÖ Jurados encontrados:', jurors);
                    } catch (error) {
                        console.error('‚ùå Error parseando jurados:', error);
                    }
                } else {
                    console.log('‚ö†Ô∏è No hay jurados en localStorage');
                }

                // Buscar jurado que coincida
                const juror = jurors.find(j => 
                    j.name.toLowerCase() === name.toLowerCase() && 
                    j.password === password &&
                    j.active !== false
                );
                
                console.log('üîç Jurado encontrado:', juror);
                
                if (!juror) {
                    console.log('‚ùå Credenciales incorrectas');
                    
                    // Mostrar jurados disponibles para ayudar con debug
                    let errorMessage = 'Nombre o contrase√±a incorrectos.\n\n';
                    if (jurors.length > 0) {
                        errorMessage += 'üîç Jurados registrados:\n';
                        jurors.forEach(j => {
                            errorMessage += `‚Ä¢ ${j.name} (contrase√±a: ${j.password})\n`;
                        });
                        errorMessage += '\n‚ö†Ô∏è Verifica que escribas exactamente como aparece arriba.';
                    } else {
                        errorMessage += '‚ùå No hay jurados registrados en el sistema.\nVe a "Gesti√≥n de Jurados" primero.';
                    }
                    
                    showAuthError(errorMessage);
                    showLoading(false);
                    return;
                }
                
                currentJuror = juror;
                console.log('‚úÖ Autenticaci√≥n exitosa:', currentJuror);
                
                // Load event data and check if voting is enabled
                await loadEventData();
                
                ui.authModal.classList.add('hidden');
                ui.mainContent.classList.remove('hidden');
                
                // Update UI with juror info
                ui.jurorInfo.textContent = `Jurado: ${currentJuror.name}${currentJuror.isSecret ? ' (Secreto)' : ''}`;
                
                // Load artists and existing votes
                await loadArtists();
                await loadJurorVotes();
                
            } catch (error) {
                console.error('Authentication error:', error);
                showAuthError('Error de conexi√≥n. Intenta nuevamente.');
            } finally {
                showLoading(false);
            }
        }

        async function loadEventData() {
            try {
                // Load event info (assuming it's stored somewhere)
                ui.eventNameDisplay.textContent = 'Certamen de Canto VYTMUSIC';
                
                // Load voting configuration
                const configDoc = await getDoc(doc(db, `events/${eventId}/config/jury-voting`));
                if (configDoc.exists()) {
                    const config = configDoc.data();
                    ui.galaInfo.textContent = `Gala ${config.galaNumber || 1}`;
                    
                    if (!config.votingEnabled) {
                        ui.votingDisabledMessage.classList.remove('hidden');
                        ui.artistsList.classList.add('hidden');
                        return;
                    }
                }
                
            } catch (error) {
                console.error('Error loading event data:', error);
            }
        }

        async function loadArtists() {
            try {
                console.log('üé≠ Cargando artistas REALES desde Firebase...');
                
                // Cargar artistas directamente desde Firebase (NO datos falsos)
                const artistsSnapshot = await getDocs(query(collection(db, `events/${eventId}/artists`), orderBy('name')));
                
                artists = artistsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('üé§ Artistas REALES encontrados:', artists.length);
                artists.forEach(artist => {
                    console.log(`  - ${artist.name}`);
                });
                
                if (artists.length === 0) {
                    console.log('‚ö†Ô∏è No hay artistas registrados en Firebase');
                    ui.artistsList.innerHTML = `
                        <div class="text-center p-8">
                            <p class="text-red-400 mb-4">‚ùå No hay artistas registrados para este evento.</p>
                            <p class="text-gray-400 text-sm">Ve a "Gesti√≥n de Votaciones" para agregar artistas primero.</p>
                        </div>
                    `;
                    return;
                }
                
                generateQuickNavigation();
                renderArtists();
                
                console.log(`‚úÖ Cargados ${artists.length} artistas REALES exitosamente`);
                
            } catch (error) {
                console.error('‚ùå Error loading artists:', error);
                showMessage('Error al cargar artistas desde Firebase: ' + error.message, 'error');
                
                ui.artistsList.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-400 mb-4">‚ùå Error al cargar artistas</p>
                        <p class="text-gray-400 text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadJurorVotes() {
            try {
                const configDoc = await getDoc(doc(db, `events/${eventId}/config/jury-voting`));
                const galaNumber = configDoc.exists() ? (configDoc.data().galaNumber || 1) : 1;
                
                const votesSnapshot = await getDocs(
                    query(
                        collection(db, `events/${eventId}/jury-votes`),
                        where('jurorId', '==', currentJuror.id),
                        where('galaNumber', '==', galaNumber)
                    )
                );
                
                jurorVotes = {};
                votesSnapshot.docs.forEach(doc => {
                    const vote = doc.data();
                    jurorVotes[vote.artistId] = vote;
                });
                
                renderArtists();
                updateVotingSummary();
                updateQuickNavigation();
                
            } catch (error) {
                console.error('Error loading juror votes:', error);
            }
        }

        function renderArtists() {
            if (artists.length === 0) {
                ui.artistsList.innerHTML = '<p class="text-center text-gray-400">No hay artistas disponibles para votar</p>';
                return;
            }

            ui.artistsList.innerHTML = artists.map(artist => {
                const hasVoted = jurorVotes[artist.id];
                const artistHistory = getArtistHistory(artist.id);
                const evolutionTrend = calculateEvolutionTrend(artistHistory);
                
                return `
                    <div class="artist-card ${hasVoted ? 'voted' : ''}" data-artist-id="${artist.id}">
                        <!-- Header mejorado con informaci√≥n del artista -->
                        <div class="artist-header">
                            <div class="artist-header-content">
                                <img src="${artist.photoURL || 'https://placehold.co/80x80/1f2937/f9fafb?text=' + (artist.name ? artist.name.charAt(0) : 'A')}" 
                                     alt="${artist.name}" class="artist-image-large">
                                <div class="artist-info">
                                    <h3 class="artist-name">${artist.name}</h3>
                                    <div class="artist-details">
                                        <p>üéµ ${artist.currentSong || 'Canci√≥n no especificada'}</p>
                                        <p>üé≠ ${artist.musicalStyle || 'Estilo no especificado'}</p>
                                        ${artist.city ? `<p>üìç ${artist.city}</p>` : ''}
                                        ${artist.age ? `<p>üë§ ${artist.age} a√±os</p>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${hasVoted ? `
                                <div class="text-center bg-green-800 p-2 rounded">
                                    <p class="text-green-300 font-semibold">‚úì Votaci√≥n Completada</p>
                                    <p class="text-sm">Promedio: ${calculateAverageScore(hasVoted).toFixed(1)} pts</p>
                                    <button onclick="editVote('${artist.id}')" class="mt-1 px-3 py-1 bg-blue-600 text-white text-xs rounded">
                                        Editar Voto
                                    </button>
                                </div>
                            ` : `
                                <div class="artist-evolution">
                                    ${evolutionTrend.length > 0 ? `
                                        <p class="text-xs text-gray-400 mb-1">Evoluci√≥n:</p>
                                        <div>
                                            ${evolutionTrend.map(gala => `
                                                <span class="evolution-trend ${gala.trend}">
                                                    G${gala.number}: ${gala.score}pts ${gala.arrow}
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : '<p class="text-xs text-gray-500">Primera participaci√≥n</p>'}
                                </div>
                            `}
                        </div>
                        
                        <div class="space-y-4">
                            ${CRITERIA.map(criteria => `
                                <div class="criteria-voting" data-criteria="${criteria.id}">
                                    <h4 class="font-semibold text-gray-300 mb-2">${criteria.name}</h4>
                                    <div class="rating-buttons">
                                        ${Object.keys(RATING_VALUES).map(rating => `
                                            <button class="rating-btn rating-${rating} ${hasVoted && hasVoted.scores[criteria.id] === rating ? 'selected' : ''}"
                                                    onclick="selectRating('${artist.id}', '${criteria.id}', '${rating}')"
                                                    ${hasVoted ? 'disabled' : ''}>
                                                ${rating.charAt(0).toUpperCase() + rating.slice(1).replace('-', ' ')}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${!hasVoted ? `
                            <div class="mt-6 text-center">
                                <button onclick="submitVote('${artist.id}')" 
                                        class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50"
                                        id="submit-vote-${artist.id}" disabled>
                                    Enviar Votaci√≥n
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function generateQuickNavigation() {
            const quickNavContainer = document.getElementById('quick-nav-list');
            
            if (artists.length === 0) {
                quickNavContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No hay artistas disponibles</p>';
                return;
            }
            
            quickNavContainer.innerHTML = artists.map(artist => {
                const hasVoted = jurorVotes[artist.id];
                
                return `
                    <div class="quick-nav-item ${hasVoted ? 'voted' : ''}" 
                         onclick="scrollToArtist('${artist.id}')" 
                         data-artist-id="${artist.id}">
                        ${artist.name}
                    </div>
                `;
            }).join('');
        }

        // === FUNCIONES GLOBALES PARA onClick ===
        window.scrollToArtist = function(artistId) {
            console.log(`üîç Navegando al artista: ${artistId}`);
            const artistCard = document.querySelector(`[data-artist-id="${artistId}"]`);
            if (artistCard) {
                artistCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                // Efecto visual temporal
                artistCard.style.boxShadow = '0 0 20px rgba(56, 189, 248, 0.8)';
                artistCard.style.border = '3px solid #38bdf8';
                setTimeout(() => {
                    artistCard.style.boxShadow = '';
                    artistCard.style.border = '';
                }, 3000);
                
                console.log(`‚úÖ Navegaci√≥n completada al artista: ${artistId}`);
            } else {
                console.error(`‚ùå No se encontr√≥ la tarjeta del artista: ${artistId}`);
            }
        };

        window.selectRating = function(artistId, criteriaId, rating) {
            console.log(`üîò Seleccionando: ${rating} para criterio ${criteriaId} del artista ${artistId}`);
            
            // Encontrar la tarjeta del artista y el div del criterio
            const artistCard = document.querySelector(`[data-artist-id="${artistId}"]`);
            if (!artistCard) {
                console.error(`‚ùå No se encontr√≥ la tarjeta del artista: ${artistId}`);
                return;
            }
            
            const criteriaDiv = artistCard.querySelector(`[data-criteria="${criteriaId}"]`);
            if (!criteriaDiv) {
                console.error(`‚ùå No se encontr√≥ el div del criterio: ${criteriaId}`);
                return;
            }
            
            // Remover selecci√≥n previa de TODOS los botones de este criterio
            criteriaDiv.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
                // Resetear estilos
                btn.style.backgroundColor = '';
                btn.style.border = '2px solid transparent';
                btn.style.boxShadow = '';
                btn.style.transform = '';
                console.log(`üîÑ Removida clase 'selected' de bot√≥n:`, btn.textContent);
            });
            
            // Encontrar y seleccionar el bot√≥n correcto
            const targetButton = criteriaDiv.querySelector(`[onclick*="'${rating}'"]`);
            if (targetButton) {
                targetButton.classList.add('selected');
                console.log(`‚úÖ Agregada clase 'selected' a bot√≥n:`, targetButton.textContent);
                
                // Aplicar estilo visual FORZADO para asegurar visibilidad
                targetButton.style.backgroundColor = '#6b7280 !important'; // Gris m√°s visible
                targetButton.style.border = '3px solid #ffffff !important';
                targetButton.style.boxShadow = '0 0 20px rgba(59, 130, 246, 1) !important';
                targetButton.style.transform = 'scale(1.1) !important';
                targetButton.style.position = 'relative';
                targetButton.style.zIndex = '10';
                
                // Agregar indicador visual adicional
                targetButton.style.setProperty('background-color', '#6b7280', 'important');
                targetButton.style.setProperty('color', '#ffffff', 'important');
                
                console.log(`üé® Estilos aplicados al bot√≥n seleccionado`);
                
            } else {
                console.error(`‚ùå No se encontr√≥ el bot√≥n para rating: ${rating}`);
                // Debug: mostrar todos los botones disponibles
                const allButtons = criteriaDiv.querySelectorAll('.rating-btn');
                console.log('üîç Botones disponibles en este criterio:');
                allButtons.forEach(btn => {
                    console.log('  -', btn.textContent, btn.getAttribute('onclick'));
                });
            }
            
            // Verificar si todos los criterios est√°n seleccionados
            const allSelected = CRITERIA.every(criteria => {
                const criteriaDiv = artistCard.querySelector(`[data-criteria="${criteria.id}"]`);
                const selected = criteriaDiv.querySelector('.rating-btn.selected');
                console.log(`üîç Criterio ${criteria.id} tiene selecci√≥n:`, !!selected);
                return selected !== null;
            });
            
            console.log(`üìä Todos los criterios seleccionados: ${allSelected}`);
            
            // Habilitar/deshabilitar bot√≥n de env√≠o
            const submitBtn = document.getElementById(`submit-vote-${artistId}`);
            if (submitBtn) {
                submitBtn.disabled = !allSelected;
                submitBtn.style.opacity = allSelected ? '1' : '0.5';
                console.log(`üîò Bot√≥n de env√≠o ${allSelected ? 'habilitado' : 'deshabilitado'}`);
            }
        };

        window.submitVote = function(artistId) {
            console.log(`üì§ Enviando voto para artista: ${artistId}`);
            submitVoteInternal(artistId);
        };

        function scrollToArtist(artistId) {
            // Esta funci√≥n interna llama a la global
            window.scrollToArtist(artistId);
        }

        function selectRating(artistId, criteriaId, rating) {
            // Esta funci√≥n interna llama a la global
            window.selectRating(artistId, criteriaId, rating);
        }

        function updateQuickNavigation() {
            // Actualizar estados de votaci√≥n en la navegaci√≥n r√°pida
            artists.forEach(artist => {
                const hasVoted = jurorVotes[artist.id];
                const navItem = document.querySelector(`.quick-nav-item[data-artist-id="${artist.id}"]`);
                
                if (navItem) {
                    if (hasVoted) {
                        navItem.classList.add('voted');
                    } else {
                        navItem.classList.remove('voted');
                    }
                }
            });
        }

        function calculateAverageScore(vote) {
            const scores = Object.values(vote.scores).map(rating => RATING_VALUES[rating]);
            return scores.reduce((sum, score) => sum + score, 0) / scores.length;
        }

        function submitVoteInternal(artistId) {
            const artistCard = document.querySelector(`[data-artist-id="${artistId}"]`);
            const artist = artists.find(a => a.id === artistId);
            
            // Collect all ratings
            const scores = {};
            let isValid = true;
            
            CRITERIA.forEach(criteria => {
                const criteriaDiv = artistCard.querySelector(`[data-criteria="${criteria.id}"]`);
                const selectedBtn = criteriaDiv.querySelector('.rating-btn.selected');
                
                if (selectedBtn) {
                    const ratingClass = Array.from(selectedBtn.classList).find(cls => cls.startsWith('rating-') && cls !== 'rating-btn');
                    scores[criteria.id] = ratingClass.replace('rating-', '');
                } else {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                showMessage('Debes calificar todos los criterios', 'error');
                return;
            }
            
            // Calculate average
            const average = calculateAverageScore({ scores });
            
            currentVoteData = {
                artistId,
                artistName: artist.name,
                scores,
                average: average.toFixed(1)
            };
            
            // Show confirmation modal
            ui.confirmMessage.textContent = 
                `¬øConfirmas tu votaci√≥n para ${artist.name}? Promedio: ${average.toFixed(1)} puntos`;
            ui.confirmModal.classList.remove('hidden');
        }

        async function confirmVote() {
            if (!currentVoteData) return;
            
            try {
                showLoading(true);
                
                const configDoc = await getDoc(doc(db, `events/${eventId}/config/jury-voting`));
                const galaNumber = configDoc.exists() ? (configDoc.data().galaNumber || 1) : 1;
                
                const voteData = {
                    jurorId: currentJuror.id,
                    jurorName: currentJuror.name,
                    isSecret: currentJuror.isSecret || false,
                    artistId: currentVoteData.artistId,
                    artistName: currentVoteData.artistName,
                    scores: currentVoteData.scores,
                    averageScore: parseFloat(currentVoteData.average),
                    galaNumber: galaNumber,
                    timestamp: new Date().toISOString()
                };
                
                // Save vote
                const voteId = `${currentJuror.id}_${currentVoteData.artistId}_gala${galaNumber}`;
                await setDoc(doc(db, `events/${eventId}/jury-votes`, voteId), voteData);
                
                ui.confirmModal.classList.add('hidden');
                showMessage('Votaci√≥n registrada correctamente');
                
                // Reload votes and update UI
                await loadJurorVotes();
                renderArtists();
                updateQuickNavigation();
                
            } catch (error) {
                console.error('Error saving vote:', error);
                showMessage('Error al guardar votaci√≥n', 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateVotingSummary() {
            const votedArtists = Object.keys(jurorVotes);
            
            if (votedArtists.length === 0) {
                ui.votingSummary.innerHTML = '<p class="text-center text-gray-400">No hay votos registrados a√∫n</p>';
                return;
            }
            
            ui.votingSummary.innerHTML = `
                <div class="text-center mb-4">
                    <p class="text-lg font-semibold">Votos registrados: ${votedArtists.length} de ${artists.length}</p>
                </div>
                <div class="space-y-2">
                    ${votedArtists.map(artistId => {
                        const vote = jurorVotes[artistId];
                        const artist = artists.find(a => a.id === artistId);
                        return `
                            <div class="flex justify-between items-center p-2 bg-gray-700 rounded">
                                <span class="font-semibold">${artist?.name || vote.artistName}</span>
                                <span class="text-green-400">${vote.averageScore} pts</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Global functions
        window.selectRating = selectRating;
        window.submitVote = submitVote;
        window.editVote = (artistId) => {
            // Allow editing by removing the vote (for simplicity)
            // In a production system, you might want a more sophisticated editing interface
            if (confirm('¬øDeseas editar tu voto? Esto eliminar√° tu votaci√≥n actual y deber√°s votar nuevamente.')) {
                delete jurorVotes[artistId];
                renderArtists();
                updateVotingSummary();
            }
        };

        function logout() {
            currentJuror = null;
            ui.mainContent.classList.add('hidden');
            ui.authModal.classList.remove('hidden');
            ui.authForm.reset();
            ui.authError.classList.add('hidden');
        }

        // Event listeners
        ui.authForm.addEventListener('submit', authenticateJuror);
        ui.cancelVoteBtn.addEventListener('click', () => ui.confirmModal.classList.add('hidden'));
        ui.confirmVoteBtn.addEventListener('click', confirmVote);
        ui.logoutBtn.addEventListener('click', logout);

        // Initialize
        console.log('Jury voting panel initialized');
    </script>
</body>
</html>