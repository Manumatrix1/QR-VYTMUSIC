<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Reporte de Participaci√≥n - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        @media print { body { background-color: white; color: black; } .no-print { display: none !important; } }
        .progress-bar { background: linear-gradient(90deg, #10b981, #34d399); height: 8px; border-radius: 4px; transition: width 0.3s ease; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <!-- Header simplificado SOLO para artistas -->
        <header class="text-center mb-8">
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-sky-400 mb-2">üé§ Mi Reporte de Participaci√≥n</h1>
                <p id="gala-name" class="text-xl text-gray-300">Cargando informaci√≥n...</p>
            </div>
            <div class="no-print flex flex-wrap justify-center gap-4">
                <button onclick="window.print()" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                    üìÑ Descargar PDF
                </button>
                <button id="share-btn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                    üîó Compartir Mi Reporte
                </button>
            </div>
        </header>

        <!-- Informaci√≥n de la Gala -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg text-center">
                <h2 class="text-2xl font-bold mb-4">üìã Informaci√≥n de la Gala</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Participantes</p>
                        <p id="total-artists" class="text-2xl font-bold text-sky-400">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Votos Recibidos</p>
                        <p id="total-votes" class="text-2xl font-bold text-green-400">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Fecha</p>
                        <p id="gala-date" class="text-sm font-bold text-yellow-400">-</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Mi Posici√≥n en la Gala -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">üèÜ Mi Posici√≥n en Esta Gala</h2>
                <div id="my-position-container" class="text-center">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </section>

        <!-- Mi An√°lisis Detallado -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">üìä Mi An√°lisis Detallado</h2>
                <div id="my-analysis-container">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </section>

        <!-- Top 5 de la Gala (para contexto) -->
        <section class="mb-8">
            <div class="glass-effect p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">üé≠ Top 5 de Esta Gala</h2>
                <p class="text-center text-gray-400 mb-4">Para que veas el contexto general</p>
                <div id="top5-container" class="space-y-3">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center mt-12 no-print">
            <div class="glass-effect p-4 rounded-lg">
                <p class="text-gray-400">
                    üéµ Reporte generado por <strong class="text-sky-400">VYTMUSIC</strong>
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    Sistema de gesti√≥n de eventos musicales
                </p>
            </div>
        </footer>
    </div>

    <!-- Modal para compartir -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full mx-4">
            <h3 class="text-xl font-bold mb-4">üîó Compartir Mi Reporte</h3>
            <p class="mb-4 text-gray-300">Copia este enlace para compartir tu reporte:</p>
            <input type="text" id="share-url" class="w-full p-3 bg-gray-900 rounded-lg text-white mb-4" readonly>
            <div class="flex justify-end gap-4">
                <button onclick="copyToClipboard()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    üìã Copiar
                </button>
                <button onclick="closeShareModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase_config.js';
        import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let galaData = null;
        let artistData = null;

        // Obtener par√°metros de URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                eventId: params.get('eventId'),
                artistId: params.get('artistId'),
                eventName: params.get('eventName')
            };
        }

        // Cargar datos de la gala y el artista espec√≠fico
        async function loadArtistReport() {
            const { eventId, artistId, eventName } = getUrlParams();

            if (!eventId || !artistId) {
                document.body.innerHTML = `
                    <div class="container mx-auto max-w-4xl p-4 text-center">
                        <h1 class="text-3xl font-bold text-red-400 mb-4">‚ùå Enlace Inv√°lido</h1>
                        <p class="text-gray-300">Este enlace no contiene la informaci√≥n necesaria para mostrar el reporte.</p>
                        <p class="text-sm text-gray-500 mt-4">Contacta con la organizaci√≥n para obtener el enlace correcto.</p>
                    </div>
                `;
                return;
            }

            try {
                console.log(`Cargando reporte para artista ${artistId} en evento ${eventId}`);

                // Cargar informaci√≥n del evento
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                if (!eventDoc.exists()) {
                    throw new Error('Evento no encontrado');
                }

                galaData = { id: eventId, ...eventDoc.data() };
                document.getElementById('gala-name').textContent = galaData.name;
                document.getElementById('gala-date').textContent = galaData.date || 'Sin fecha';

                // Cargar informaci√≥n del artista espec√≠fico
                const artistDoc = await getDoc(doc(db, `events/${eventId}/artists`, artistId));
                if (!artistDoc.exists()) {
                    throw new Error('Artista no encontrado en esta gala');
                }

                artistData = { id: artistId, ...artistDoc.data() };

                // Cargar todos los artistas para contexto
                const artistsSnapshot = await getDocs(collection(db, `events/${eventId}/artists`));
                const allArtists = artistsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Actualizar estad√≠sticas generales
                document.getElementById('total-artists').textContent = allArtists.length;
                document.getElementById('total-votes').textContent = artistData.totalRatingsCount || 0;

                // Calcular posici√≥n del artista
                const sortedArtists = allArtists.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                const artistPosition = sortedArtists.findIndex(a => a.id === artistId) + 1;

                renderMyPosition(artistPosition, allArtists.length);
                renderMyAnalysis();
                renderTop5Context(sortedArtists);

            } catch (error) {
                console.error('Error cargando reporte:', error);
                document.body.innerHTML = `
                    <div class="container mx-auto max-w-4xl p-4 text-center">
                        <h1 class="text-3xl font-bold text-red-400 mb-4">‚ùå Error al Cargar</h1>
                        <p class="text-gray-300">No se pudo cargar la informaci√≥n del reporte.</p>
                        <p class="text-sm text-gray-500 mt-4">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderMyPosition(position, total) {
            const container = document.getElementById('my-position-container');
            const percentage = total > 1 ? Math.round(((total - position + 1) / total) * 100) : 100;
            
            let positionClass = 'bg-gray-600';
            let positionIcon = 'üé§';
            let positionText = `Posici√≥n ${position} de ${total}`;

            if (position === 1) {
                positionClass = 'bg-gradient-to-r from-yellow-500 to-yellow-600';
                positionIcon = 'üèÜ';
                positionText = '¬°GANADOR DE LA GALA!';
            } else if (position === 2) {
                positionClass = 'bg-gradient-to-r from-gray-400 to-gray-500';
                positionIcon = 'ü•à';
                positionText = '¬°SEGUNDO LUGAR!';
            } else if (position === 3) {
                positionClass = 'bg-gradient-to-r from-orange-500 to-orange-600';
                positionIcon = 'ü•â';
                positionText = '¬°TERCER LUGAR!';
            }

            container.innerHTML = `
                <div class="${positionClass} p-8 rounded-lg text-white">
                    <div class="text-6xl mb-4">${positionIcon}</div>
                    <h3 class="text-2xl font-bold mb-4">${positionText}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg">
                        <div>
                            <p class="opacity-90">Tu Puntaje:</p>
                            <p class="text-2xl font-bold">${artistData.totalScore || 0} pts</p>
                        </div>
                        <div>
                            <p class="opacity-90">Votos Recibidos:</p>
                            <p class="text-2xl font-bold">${artistData.totalRatingsCount || 0}</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm opacity-80">Est√°s en el top ${percentage}% de participantes</p>
                    </div>
                </div>
            `;
        }

        function renderMyAnalysis() {
            const container = document.getElementById('my-analysis-container');
            const votes = artistData.totalRatingsCount || 0;

            if (votes === 0) {
                container.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-4xl mb-4">üìä</div>
                        <h3 class="text-xl font-bold mb-2">Sin Votos Registrados</h3>
                        <p class="text-gray-400">No se registraron votos p√∫blicos para tu participaci√≥n en esta gala.</p>
                    </div>
                `;
                return;
            }

            // Calcular promedios por categor√≠a
            const categories = [
                { key: 'Singing', name: 'Canto', icon: 'üé§', total: artistData.totalSingingScore || 0 },
                { key: 'Transmission', name: 'Transmisi√≥n', icon: 'üì°', total: artistData.totalTransmissionScore || 0 },
                { key: 'Attitude', name: 'Actitud', icon: 'üòä', total: artistData.totalAttitudeScore || 0 },
                { key: 'Originality', name: 'Originalidad', icon: 'üí°', total: artistData.totalOriginalityScore || 0 },
                { key: 'Costume', name: 'Vestuario', icon: 'üëó', total: artistData.totalCostumeScore || 0 },
                { key: 'Staging', name: 'Puesta en Escena', icon: 'üé≠', total: artistData.totalStagingScore || 0 }
            ];

            let analysisHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h4 class="text-lg font-bold mb-4 text-center">üìä Mis Puntuaciones por Categor√≠a</h4>
                        <div class="space-y-3">
            `;

            categories.forEach(cat => {
                const avg = votes > 0 ? (cat.total / votes) : 0;
                const percentage = (avg / 10) * 100;
                
                analysisHtml += `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium">${cat.icon} ${cat.name}</span>
                            <span class="text-sm font-bold text-sky-400">${avg.toFixed(1)}/10</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="progress-bar h-3 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            // Encontrar fortaleza (categor√≠a con mayor puntuaci√≥n)
            const bestCategory = categories.reduce((prev, current) => 
                (current.total / votes) > (prev.total / votes) ? current : prev
            );

            analysisHtml += `
                        </div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h4 class="text-lg font-bold mb-4 text-center">‚ú® Mi An√°lisis</h4>
                        <div class="space-y-4">
                            <div class="bg-green-900 bg-opacity-30 p-3 rounded border-l-4 border-green-500">
                                <h5 class="font-bold text-green-400 mb-2">üåü Mi Mayor Fortaleza</h5>
                                <p class="text-sm">${bestCategory.icon} <strong>${bestCategory.name}</strong> - ${(bestCategory.total / votes).toFixed(1)}/10</p>
                                <p class="text-xs text-gray-400 mt-1">¬°Esta fue tu categor√≠a mejor valorada!</p>
                            </div>
                            <div class="bg-blue-900 bg-opacity-30 p-3 rounded border-l-4 border-blue-500">
                                <h5 class="font-bold text-blue-400 mb-2">üìà Estad√≠sticas</h5>
                                <ul class="text-sm space-y-1">
                                    <li>‚Ä¢ Total de votos: ${votes}</li>
                                    <li>‚Ä¢ Puntaje total: ${artistData.totalScore || 0} pts</li>
                                    <li>‚Ä¢ Promedio general: ${votes > 0 ? (artistData.totalScore / votes).toFixed(1) : '0'}/10</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = analysisHtml;
        }

        function renderTop5Context(sortedArtists) {
            const container = document.getElementById('top5-container');
            const top5 = sortedArtists.slice(0, 5);

            let top5Html = '';
            top5.forEach((artist, index) => {
                const isMe = artist.id === artistData.id;
                const borderClass = isMe ? 'border-sky-500 bg-sky-900 bg-opacity-20' : 'border-gray-700';
                const position = index + 1;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : `${position}.`;

                top5Html += `
                    <div class="bg-gray-800 border-2 ${borderClass} p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${medal}</span>
                            <div>
                                <h4 class="font-bold text-white ${isMe ? 'text-sky-400' : ''}">${artist.name} ${isMe ? '(Yo)' : ''}</h4>
                                <p class="text-sm text-gray-400">${artist.totalRatingsCount || 0} votos</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-400">${artist.totalScore || 0} pts</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = top5Html;
        }

        // Funciones para compartir
        document.getElementById('share-btn').addEventListener('click', function() {
            document.getElementById('share-url').value = window.location.href;
            document.getElementById('share-modal').classList.remove('hidden');
        });

        window.copyToClipboard = function() {
            navigator.clipboard.writeText(document.getElementById('share-url').value);
            alert('¬°Enlace copiado al portapapeles!');
        };

        window.closeShareModal = function() {
            document.getElementById('share-modal').classList.add('hidden');
        };

        // Inicializar
        loadArtistReport();
    </script>
</body>
</html>