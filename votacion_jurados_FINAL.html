<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaci√≥n Jurados REGISTRADOS - VYTMUSIC</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="background-color" content="#1e3a8a">
    
    <!-- Apple iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VYT MUSIC">
    <link rel="apple-touch-icon" href="imagenes/logo-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="imagenes/logo-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="imagenes/logo-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="imagenes/logo-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="imagenes/logo-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="imagenes/logo-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="imagenes/logo-192x192.png">
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="imagenes/logo-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="imagenes/logo-16x16.png">
    <link rel="shortcut icon" href="imagenes/favicon.ico">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-TileImage" content="imagenes/logo-144x144.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #1e3a8a, #1e40af); color: white; min-height: 100vh; }
        .card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; border: none; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: scale(1.05); }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover { background: #15803d; }
        .btn-red { background: #dc2626; color: white; }
        .btn-orange { background: #ea580c; color: white; }
        .btn-orange:hover { background: #c2410c; }
        .btn-yellow { background: #eab308; color: white; }
        .btn-selected { 
            border: 3px solid #ffffff !important; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8) !important; 
            transform: scale(1.1) !important;
        }
        .artist-card { margin: 20px 0; padding: 20px; }
        .criteria { margin: 15px 0; }
        .rating-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        
        /* Estilos para el nuevo sistema de grid y modal */
        .artist-grid-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }
        .artist-grid-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        .category-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .category-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        .hidden { display: none !important; }
        
        /* üì± RESPONSIVE DESIGN PARA M√ìVILES */
        @media (max-width: 768px) {
            /* Sliders m√°s peque√±os y mejor manejo t√°ctil */
            .category-slider {
                height: 35px !important;
                -webkit-appearance: none;
                appearance: none;
                background: linear-gradient(to right, #dc2626 0%, #f59e0b 25%, #10b981 75%, #059669 100%);
                border-radius: 12px;
                outline: none;
                touch-action: none; /* Evita scroll accidental */
            }
            
            .category-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: #ffffff;
                border: 3px solid #1f2937;
                cursor: pointer;
                box-shadow: 0 0 15px rgba(0,0,0,0.4);
                touch-action: none;
            }
            
            /* Botones m√°s peque√±os en m√≥vil */
            .btn {
                padding: 10px 18px !important;
                font-size: 14px !important;
                min-height: 44px; /* Tama√±o m√≠nimo t√°ctil recomendado */
            }
            
            /* Textos de puntuaci√≥n optimizados */
            .text-xl {
                font-size: 1.1rem !important;
            }
            
            .text-2xl {
                font-size: 1.3rem !important;
            }
            
            /* Cards m√°s compactas */
            .card {
                padding: 16px !important;
                margin-bottom: 16px !important;
            }
            
            /* Modal responsive */
            .modal-content {
                padding: 20px !important;
                margin: 10px !important;
                max-height: 85vh !important;
            }
            
            /* Comentarios m√°s compactos */
            textarea {
                font-size: 14px !important;
                padding: 8px !important;
            }
        }
        
        /* Estilos para sistema de bloqueo */
        .score-lock-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .lock-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .slider-locked {
            opacity: 0.5 !important;
            pointer-events: none !important;
            filter: grayscale(50%);
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <!-- HEADER -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <a id="back-to-panel-btn" href="panel_evento_mejorado.html" class="btn btn-primary text-sm">‚Üê Volver al Panel</a>
                <div class="flex gap-2">
                    <button id="share-jury-link-btn" class="btn btn-green text-sm">ÔøΩ Obtener Link</button>
                    <a id="feedback-btn" href="#" class="btn btn-green text-sm">üì° Feedback en Vivo</a>
                </div>
            </div>
            <h1 class="text-4xl font-bold mb-4">üé§ VOTACI√ìN DE JURADOS</h1>
            <p id="status" class="text-xl">Iniciando sistema...</p>
        </div>

        <!-- AUTENTICACI√ìN SOLO USUARIOS REGISTRADOS -->
        <div id="auth-section" class="card p-8 max-w-md mx-auto mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">üîê Login de Jurado Registrado</h2>
            
            <!-- PANEL DE LOGIN REGISTRADO -->
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 font-bold text-blue-300">üë§ Selecciona tu Usuario:</label>
                    <select id="juror-user-select" class="w-full p-3 rounded bg-gray-800 text-white border border-blue-400">
                        <option value="">üîç Cargando usuarios registrados...</option>
                    </select>
                    <p class="text-sm text-gray-400 mt-1">üí° Solo usuarios previamente registrados</p>
                </div>
                
                <button onclick="loginWithUser()" class="btn btn-primary w-full" style="margin-top: 20px;">
                    üé≠ INGRESAR COMO JURADO
                </button>
                
                <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 15px;">
                    ‚ú® Solo selecciona tu nombre y presiona ingresar<br>
                    ÔøΩ Sin contrase√±as, acceso directo y r√°pido
                </div>
            </div>
            
            <div class="mt-4 text-sm text-center opacity-75">
                <p class="text-blue-300">üõ°Ô∏è Solo usuarios registrados pueden votar</p>
                <p class="text-gray-400">Si no tienes usuario, contacta al administrador</p>
            </div>
        </div>

        <!-- GENERADOR DE LINK PARA COMPARTIR -->
        <div class="card p-6 max-w-md mx-auto mb-8" style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%); border: 2px solid #10b981;">
            <h3 class="text-xl font-bold mb-4 text-center text-green-400">üì± COMPARTIR CON JURADOS</h3>
            <p class="text-center text-gray-300 mb-4">Env√≠a este link a los jurados para que puedan votar:</p>
            
            <div class="bg-gray-800 p-4 rounded-lg border-2 border-dashed border-green-400 mb-4">
                <div class="text-sm text-green-400 font-bold text-center break-all" id="jury-link-display">
                    https://vytmusic.netlify.app/votacion_jurados_final?eventId=vIINfBwQaFsIhNOYWPtS&eventName=%20GALA%201%20CON%20PUNTUACI%C3%92N.%20G12%20VYTMUSIC&admin=true
                </div>
            </div>
            
            <button onclick="copyJuryLink()" class="btn btn-green w-full mb-2">
                üìã COPIAR LINK
            </button>
            
            <p class="text-xs text-gray-400 text-center">
                ‚úÖ Copia el link y env√≠alo por WhatsApp, email, etc.<br>
                ‚úÖ Los jurados podr√°n acceder directamente y votar
            </p>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div id="main-content" style="display: none;">
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">üë®‚Äç‚öñÔ∏è <span id="juror-display">Jurado</span></h3>
                <div class="flex gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold" id="total-artists">0</div>
                        <div class="text-sm">Artistas</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400" id="voted-count">0</div>
                        <div class="text-sm">Votados</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="pending-count">0</div>
                        <div class="text-sm">Pendientes</div>
                    </div>
                </div>
                <div class="flex gap-4 mt-4">
                    <button onclick="logout()" class="btn btn-red">Cerrar Sesi√≥n</button>
                    <button onclick="resetAllVotes()" class="btn btn-orange">üîÑ Reiniciar Todos los Votos</button>
                    <button id="install-button" onclick="installPWA()" class="btn btn-green" style="display: none;">üì± Instalar App</button>
                </div>
            </div>

            <!-- ARTISTAS -->
            <div id="artists-container">
                <h2 class="text-3xl font-bold mb-6 text-center">üé≠ ARTISTAS PARTICIPANTES</h2>
                
                <!-- FILTRO DE B√öSQUEDA -->
                <div class="card p-4 mb-6 max-w-lg mx-auto">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">üîç</div>
                        <div class="flex-1">
                            <input 
                                type="text" 
                                id="artist-search" 
                                placeholder="Buscar artista por nombre..." 
                                class="w-full p-3 rounded bg-white text-black border-2 border-gray-300 focus:border-blue-500"
                                oninput="filterArtists()"
                            >
                        </div>
                        <button onclick="clearSearch()" class="btn btn-orange">Limpiar</button>
                    </div>
                    <p class="text-sm mt-2 opacity-75 text-center">üí° Escribe el nombre para encontrar r√°pidamente al artista</p>
                </div>

                <!-- SELECTOR DE MODO DE VISTA -->
                <div class="card p-4 mb-6 max-w-lg mx-auto">
                    <div class="text-center">
                        <h3 class="text-lg font-bold mb-3">üëÅÔ∏è Modo de Vista</h3>
                        <div class="flex gap-3 justify-center">
                            <button id="btn-list-mode" onclick="switchViewMode('list')" class="btn btn-primary">
                                üìã Vista Lista
                            </button>
                            <button id="btn-grid-mode" onclick="switchViewMode('grid')" class="btn btn-yellow">
                                üéØ Vista Organizada
                            </button>
                        </div>
                        <p class="text-xs mt-2 opacity-75">Vista organizada: solo nombre y foto, clic para evaluar</p>
                    </div>
                </div>
                
                <div id="artists-list">
                    <div class="text-center">
                        <div class="text-2xl">‚è≥</div>
                        <p>Cargando artistas...</p>
                    </div>
                </div>

                <!-- BOT√ìN GLOBAL DE ENV√çO -->
                <div id="global-submit-section" class="card p-6 mt-8 text-center" style="display: none;">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold mb-2">üìä Resumen de Votaci√≥n</h3>
                        <div id="voting-summary" class="text-lg mb-4">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <button id="global-submit-btn" onclick="submitAllVotes()" 
                            class="btn btn-green text-2xl px-12 py-6 w-full max-w-md mx-auto">
                        üó≥Ô∏è ENVIAR VOTACI√ìN COMPLETA
                    </button>
                    
                    <div id="submit-info" class="text-sm text-gray-300 mt-3">
                        <!-- Informaci√≥n adicional -->
                    </div>
                    
                    <!-- BOT√ìN PARA GENERAR REPORTE DE ARTISTAS -->
                    <div class="mt-6 p-4 bg-blue-900/30 rounded-lg border border-blue-500">
                        <h4 class="text-lg font-bold text-blue-300 mb-2">üìã Compartir con Artistas</h4>
                        <p class="text-sm text-blue-200 mb-3">
                            Genera un link para que los artistas vean sus evaluaciones y comentarios de los jurados
                        </p>
                        <button id="generate-artist-report-btn" onclick="generateArtistReportLink()" 
                                class="btn text-lg px-8 py-3 w-full max-w-md mx-auto bg-blue-600 hover:bg-blue-700">
                            üîó GENERAR LINK PARA ARTISTAS
                        </button>
                        <div id="artist-report-link" class="mt-3 text-sm" style="display: none;">
                            <!-- El link aparecer√° aqu√≠ -->
                        </div>
                        
                        <!-- PANEL DE ACTIVIDAD DE JURADOS EN TIEMPO REAL -->
                        <div id="jury-activity-panel" class="bg-purple-800 bg-opacity-30 p-4 rounded-lg border border-purple-500 mt-3">
                            <h3 class="text-lg font-bold text-purple-300 mb-3">üë• Actividad de Jurados en Tiempo Real</h3>
                            
                            <!-- PANEL DE DEBUG -->
                            <div id="debug-panel" class="bg-red-800 bg-opacity-30 p-3 rounded mb-3 border border-red-500">
                                <h4 class="text-red-300 font-bold mb-2">üîç DEBUG - Info de B√∫squeda</h4>
                                <div id="debug-info" class="text-xs text-red-200">
                                    <p>EventId: <span id="debug-eventid">Cargando...</span></p>
                                    <p>Colecciones buscadas: <span id="debug-collections">0</span></p>
                                    <p>Documentos encontrados: <span id="debug-docs">0</span></p>
                                    <p>Jurados √∫nicos: <span id="debug-jurors">0</span></p>
                                </div>
                                <button onclick="forceRefreshDebug()" class="mt-2 px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded">
                                    üîÑ FORZAR B√öSQUEDA
                                </button>
                            </div>
                            
                            <div id="jury-activity-list" class="space-y-2 mb-3">
                                <p class="text-center text-gray-400">Cargando actividad de jurados...</p>
                            </div>
                            <button id="toggle-realtime-btn" onclick="toggleRealtimeAverages()" 
                                    class="btn text-sm px-6 py-2 w-full bg-green-600 hover:bg-green-700">
                                üìä MOSTRAR PROMEDIOS DETALLADOS
                            </button>
                            <div id="realtime-info" class="mt-2 text-xs text-center text-yellow-300" style="display: none;">
                                ‚è±Ô∏è Los promedios se actualizan autom√°ticamente
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GRID DE ARTISTAS (MODO ORGANIZADO) -->
                <div id="artists-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" style="display: none;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE VOTACI√ìN -->
    <div id="voting-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <!-- Header del Modal -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üé§ Evaluaci√≥n Individual</h2>
                <button onclick="closeVotingModal()" class="text-white text-3xl">&times;</button>
            </div>

            <!-- Informaci√≥n del Artista -->
            <div class="flex items-center gap-4 mb-6 p-4 card">
                <img id="modal-artist-photo" src="" alt="Foto del artista" 
                     class="w-20 h-20 object-cover rounded-full border-2 border-blue-300">
                <div>
                    <h3 id="modal-artist-name" class="text-2xl font-bold"></h3>
                    <p id="modal-artist-info" class="text-gray-300"></p>
                </div>
            </div>

            <!-- Sistema de Puntuaci√≥n por Categor√≠as -->
            <div class="mb-6">
                <h4 class="text-xl font-bold mb-4">üìä Evaluaci√≥n por Categor√≠as (25-100 puntos)</h4>
                <div id="modal-categories" class="space-y-4">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- ‚ûï NUEVOS CAMPOS ADICIONALES PARA SEGUIMIENTO COMPLETO -->
            <div class="mb-6 bg-green-800 bg-opacity-30 p-4 rounded-lg border border-green-500">
                <h4 class="text-lg font-bold mb-4 text-green-300">üìù Informaci√≥n Adicional de la Presentaci√≥n</h4>
                
                <!-- Campo Canci√≥n -->
                <div class="mb-4">
                    <label for="modal-song-performed" class="block text-sm font-semibold text-green-200 mb-2">
                        üéµ Canci√≥n interpretada:
                    </label>
                    <input type="text" id="modal-song-performed" 
                           class="w-full p-3 bg-gray-800 border border-green-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-300" 
                           placeholder="Ej: Shape of You - Ed Sheeran">
                </div>
                
                <!-- Campo Comentarios del Jurado -->
                <div class="mb-4">
                    <label for="modal-judge-comments" class="block text-sm font-semibold text-green-200 mb-2">
                        üí≠ Comentarios y observaciones del jurado:
                    </label>
                    <textarea id="modal-judge-comments" rows="3"
                              class="w-full p-3 bg-gray-800 border border-green-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-300 resize-none"
                              placeholder="Ej: Muy buena interpretaci√≥n, mejor√≥ mucho desde la gala anterior. Trabajar en proyecci√≥n de voz."></textarea>
                </div>
                
                <!-- Campo Notas Adicionales -->
                <div class="mb-4">
                    <label for="modal-additional-notes" class="block text-sm font-semibold text-green-200 mb-2">
                        üìã Notas adicionales (vestuario, actitud, evoluci√≥n):
                    </label>
                    <textarea id="modal-additional-notes" rows="2"
                              class="w-full p-3 bg-gray-800 border border-green-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-300 resize-none"
                              placeholder="Ej: Vestuario muy acorde al tema, mucha m√°s seguridad que en gala 1."></textarea>
                </div>
                
                <p class="text-xs text-green-300 text-center">
                    üí° Esta informaci√≥n se guardar√° para crear un historial completo del artista y mejorar los reportes
                </p>
            </div>

            <!-- Puntaje Total -->
            <div class="text-center mb-6">
                <div class="card p-4 inline-block">
                    <h4 class="text-lg font-bold">Puntaje Total:</h4>
                    <div id="modal-total-score" class="text-3xl font-bold text-yellow-300">0/1000</div>
                </div>
            </div>

            <!-- FEEDBACK AUTOM√ÅTICO GENERADO -->
            <div id="feedback-section-modal" class="bg-blue-800 bg-opacity-50 p-4 rounded-lg mb-6" style="display: none;">
                <h5 class="text-lg font-bold mb-3 text-center">üí¨ Sugerencias de Feedback</h5>
                <div id="auto-feedback-modal" class="space-y-2 text-sm">
                    <!-- Se generar√° autom√°ticamente -->
                </div>
                <p class="text-xs text-blue-300 mt-2 text-center">üí° Basado en tus puntuaciones - Puedes usarlas como gu√≠a</p>
            </div>

            <!-- Botones -->
            <div class="flex gap-4 justify-end">
                <button onclick="closeVotingModal()" class="btn btn-red">
                    Cancelar
                </button>
                <button id="finalizar-evaluacion-btn" onclick="finalizarEvaluacion()" 
                        class="btn bg-green-600 hover:bg-green-700 opacity-50 cursor-not-allowed" 
                        style="display: none;">
                    ‚úÖ FINALIZAR EVALUACI√ìN
                </button>
                <button onclick="saveModalVote()" class="btn btn-blue">
                    üíæ Guardar Parcial
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPT DE GESTI√ìN DE ARTISTAS GLOBALES -->
    <script src="./global-artists-manager.js"></script>

    <script type="module">
        // === CONFIGURACI√ìN FIREBASE === v2.0 (CACHE BUSTING)
        console.log('üöÄ VOTACI√ìN JURADOS v2.0 - Sistema Unificado Cargando...');
        
        // === DEBUG INMEDIATO EN CONSOLA ===
        window.debugJurados = async function() {
            console.log('üîç INICIANDO DEBUG DE JURADOS...');
            console.log('üéØ EventId actual:', eventId);
            
            const collections = [
                'jury_evaluations',
                'jury_users',
                `events/${eventId}/jury_evaluations`, 
                `events/${eventId}/jury_votes`,
                `events/${eventId}/votes`
            ];
            
            let totalDocs = 0;
            let juradosEncontrados = new Set();
            
            for (const collectionPath of collections) {
                console.log(`\nüîç === BUSCANDO EN: ${collectionPath} ===`);
                
                try {
                    const snapshot = await getDocs(collection(db, collectionPath));
                    console.log(`üìä Documentos encontrados: ${snapshot.size}`);
                    totalDocs += snapshot.size;
                    
                    if (snapshot.size > 0) {
                        snapshot.docs.forEach(doc => {
                            const data = doc.data();
                            console.log(`üìù DOC ID: ${doc.id}`);
                            console.log(`   - jurorName: ${data.jurorName || 'N/A'}`);
                            console.log(`   - name: ${data.name || 'N/A'}`);
                            console.log(`   - eventId: ${data.eventId || 'N/A'}`);
                            console.log(`   - artistId: ${data.artistId || 'N/A'}`);
                            console.log(`   - timestamp: ${data.timestamp || 'N/A'}`);
                            
                            if (data.jurorName) juradosEncontrados.add(data.jurorName);
                            if (data.name) juradosEncontrados.add(data.name);
                        });
                    } else {
                        console.log('‚ùå Colecci√≥n vac√≠a');
                    }
                    
                } catch (error) {
                    console.error(`‚ö†Ô∏è Error en ${collectionPath}:`, error.message);
                }
            }
            
            console.log('\nüéØ === RESUMEN FINAL ===');
            console.log(`üìä Total documentos: ${totalDocs}`);
            console.log(`üë• Jurados √∫nicos encontrados: ${juradosEncontrados.size}`);  
            console.log(`üìù Lista de jurados:`, Array.from(juradosEncontrados));
            
            alert(`üîç DEBUG COMPLETADO\n\nTotal docs: ${totalDocs}\nJurados encontrados: ${juradosEncontrados.size}\nLista: ${Array.from(juradosEncontrados).join(', ')}\n\nRevisa la consola para detalles`);
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, query, orderBy, doc, setDoc, deleteDoc, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_2Ukoxf_ry7QfKtou1Cz6nY-qTVw4qTU", 
            authDomain: "vyt-music.firebaseapp.com",
            projectId: "vyt-music", 
            storageBucket: "vyt-music.firebasestorage.app", 
            messagingSenderId: "574981837817", 
            appId: "1:574981837817:web:a29933a22bbfd51a086328"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Hacer disponibles globalmente para las nuevas funciones
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
        window.doc = doc;
        window.setDoc = setDoc;
        
        console.log('üî• Firebase inicializado correctamente');
        
        // INICIALIZAR GESTOR DE ARTISTAS GLOBALES (temporalmente comentado)
        // const globalArtistsManager = new GlobalArtistsManager();

        // === SISTEMA DE C√ÅLCULO EN TIEMPO REAL ===
        let allJuryVotes = new Map(); // artistId -> [votos de todos los jurados]
        let realTimeAverages = new Map(); // artistId -> promedio actual
        let allListeners = []; // Para rastrear todos los listeners activos
        let isProcessing = false; // Para evitar procesamiento m√∫ltiple
        
        // Escuchar votos en tiempo real
        import { onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // OBTENER EVENT ID DESDE URL (como en gesti√≥n de votaciones)
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId') || 'gmxINHvzSJ18Zt3SNeW7'; // Fallback al ID correcto
        const eventName = urlParams.get('eventName') || 'Evento';
        
        console.log('üåê URL completa:', window.location.href);
        console.log('üîç Par√°metros URL:', window.location.search);
        console.log('üìã EventId obtenido:', eventId);
        console.log('üìã EventId desde URL:', urlParams.get('eventId'));
        console.log('üìã Usando fallback?', !urlParams.get('eventId'));

        // Configurar enlaces de navegaci√≥n
        document.getElementById('back-to-panel-btn').href = `panel_evento_mejorado.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;
        document.getElementById('feedback-btn').href = `feedback_en_vivo.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;

        // CRITERIOS DE VOTACI√ìN
        const CRITERIA = [
            { id: 'tecnica_vocal', name: 'üéµ T√©cnica Vocal' },
            { id: 'melodia_interpretacion', name: 'üéº Afinaci√≥n' },
            { id: 'gestualidad_expresion', name: 'üé≠ Expresi√≥n e Interpretaci√≥n' },
            { id: 'diccion_articulacion', name: 'ÔøΩÔ∏è Dicci√≥n y Pronunciaci√≥n' },
            { id: 'dinamica_espacio', name: 'üèÉ Din√°mica y Uso del Espacio' },
            { id: 'repertorio_seleccion', name: 'üé∂ Repertorio y Estilo' },
            { id: 'presencia_escenica', name: 'ÔøΩ Presencia Esc√©nica' },
            { id: 'originalidad_creatividad', name: 'ÔøΩ Originalidad y Creatividad' },
            { id: 'vestuario_presentacion', name: 'üëî Vestuario y Presentaci√≥n' },
            { id: 'puntualidad_profesionalismo', name: '‚≠ê Puntualidad y Profesionalismo' }
        ];

        const RATINGS = [
            { id: 'malo', name: 'Malo', value: 20, class: 'btn-red' },
            { id: 'mediocre', name: 'Mediocre', value: 40, class: 'btn-orange' },
            { id: 'bueno', name: 'Bueno', value: 60, class: 'btn-yellow' },
            { id: 'muy_bueno', name: 'Muy Bueno', value: 80, class: 'btn-green' },
            { id: 'excelente', name: 'Excelente', value: 100, class: 'btn-primary' }
        ];

        // SISTEMA DE FEEDBACK AUTOM√ÅTICO
        const FEEDBACK_TEMPLATES = {
            'tecnica_vocal': {
                100: ['T√©cnica vocal impecable', 'Dominio total de la respiraci√≥n', 'Control vocal excepcional'],
                80: ['Muy buena t√©cnica vocal', 'Buen manejo de la respiraci√≥n', 'Control vocal s√≥lido'],
                60: ['T√©cnica vocal correcta', 'Sigue trabajando la respiraci√≥n', 'Buena base t√©cnica'],
                40: ['Necesitas mejorar t√©cnica vocal', 'Trabaja en ejercicios de respiraci√≥n', 'Considera clases de canto'],
                20: ['Requiere trabajo intenso en t√©cnica', 'Fundamental mejorar respiraci√≥n', 'Busca instructor vocal profesional']
            },
            'melodia_interpretacion': {
                100: ['Interpretaci√≥n extraordinaria', 'Conexi√≥n emocional perfecta', 'Transmite la melod√≠a magistralmente'],
                80: ['Muy buena interpretaci√≥n', 'Buena conexi√≥n emocional', 'Transmite bien la melod√≠a'],
                60: ['Interpretaci√≥n correcta', 'Trabaja m√°s la conexi√≥n emocional', 'Sigue desarrollando tu estilo'],
                40: ['Necesitas m√°s expresividad', 'Conecta m√°s con la melod√≠a', 'Trabaja la interpretaci√≥n emocional'],
                20: ['Requiere mayor interpretaci√≥n', 'Fundamental conectar con la canci√≥n', 'Practica expresi√≥n musical']
            },
            'gestualidad_expresion': {
                100: ['Expresi√≥n facial perfecta', 'Gestualidad natural y envolvente', 'Rostro muy expresivo'],
                80: ['Muy buena expresi√≥n facial', 'Gestualidad apropiada', 'Buen uso del rostro'],
                60: ['Expresi√≥n facial correcta', 'Sigue trabajando gestualidad', 'Desarrolla m√°s expresividad'],
                40: ['Necesitas m√°s expresi√≥n facial', 'Trabaja en gestualidad natural', 'Practica frente al espejo'],
                20: ['Requiere trabajo en expresi√≥n', 'Fundamental ser m√°s expresivo', 'Busca coaching en expresi√≥n']
            },
            'diccion_articulacion': {
                100: ['Dicci√≥n perfecta y clara', 'Articulaci√≥n impecable', 'Se entiende cada palabra'],
                80: ['Muy buena dicci√≥n', 'Articulaci√≥n clara', 'Buen entendimiento del texto'],
                60: ['Dicci√≥n correcta', 'Mejora algunas articulaciones', 'Buena base de dicci√≥n'],
                40: ['Necesitas mejorar dicci√≥n', 'Trabaja en articulaci√≥n', 'Practica vocalizaci√≥n'],
                20: ['Requiere trabajo en dicci√≥n', 'Fundamental mejorar articulaci√≥n', 'Considera clases de locuci√≥n']
            },
            'dinamica_espacio': {
                100: ['Uso del espacio excepcional', 'Movimiento din√°mico perfecto', 'Domina todo el escenario'],
                80: ['Muy buen uso del espacio', 'Movimiento din√°mico efectivo', 'Buen manejo esc√©nico'],
                60: ['Uso correcto del espacio', 'Sigue desarrollando movimiento', 'Buena base de desplazamiento'],
                40: ['Necesitas usar m√°s el espacio', 'Trabaja en movimiento esc√©nico', 'Desarrolla m√°s dinamismo'],
                20: ['Requiere mayor uso del espacio', 'Fundamental trabajar movimiento', 'Busca coaching esc√©nico']
            },
            'repertorio_seleccion': {
                100: ['Selecci√≥n de repertorio perfecta', 'Canci√≥n ideal para tu voz', 'Excelente elecci√≥n musical'],
                80: ['Muy buena selecci√≥n', 'Canci√≥n apropiada', 'Buen criterio musical'],
                60: ['Selecci√≥n correcta', 'Considera explorar otros estilos', 'Buena elecci√≥n base'],
                40: ['Mejora selecci√≥n de repertorio', 'Busca canciones m√°s acordes', 'Explora tu rango vocal'],
                20: ['Requiere mejor selecci√≥n', 'Fundamental conocer tu rango', 'Considera asesor√≠a musical']
            },
            'presencia_escenica': {
                100: ['Presencia esc√©nica excepcional', 'Seguridad total en escena', 'Dominio completo del escenario'],
                80: ['Muy buena presencia', 'Buena seguridad esc√©nica', 'Buen manejo de nervios'],
                60: ['Presencia correcta', 'Sigue desarrollando seguridad', 'Buena base esc√©nica'],
                40: ['Necesitas m√°s seguridad', 'Trabaja en presencia esc√©nica', 'Desarrolla m√°s confianza'],
                20: ['Requiere trabajo en presencia', 'Fundamental ganar seguridad', 'Practica m√°s en escenario']
            },
            'originalidad_creatividad': {
                100: ['Originalidad excepcional', 'Creatividad extraordinaria', 'Propuesta √∫nica y fresca'],
                80: ['Muy buena originalidad', 'Creatividad notable', 'Propuesta interesante'],
                60: ['Originalidad correcta', 'Sigue desarrollando creatividad', 'Buena base creativa'],
                40: ['Necesitas m√°s originalidad', 'Desarrolla tu creatividad', 'Busca tu sello personal'],
                20: ['Requiere mayor creatividad', 'Fundamental ser m√°s original', 'Explora tu identidad art√≠stica']
            },
            'vestuario_presentacion': {
                100: ['Vestuario y presentaci√≥n perfectos', 'Look impecable', 'Imagen profesional excepcional'],
                80: ['Muy buena presentaci√≥n', 'Vestuario apropiado', 'Buena imagen personal'],
                60: ['Presentaci√≥n correcta', 'Cuida m√°s detalles del vestuario', 'Buena base de imagen'],
                40: ['Mejora vestuario y presentaci√≥n', 'Trabaja en tu imagen personal', 'Cuida m√°s los detalles'],
                20: ['Requiere mejor presentaci√≥n', 'Fundamental cuidar la imagen', 'Considera asesor√≠a de imagen']
            },
            'puntualidad_profesionalismo': {
                100: ['Profesionalismo excepcional', 'Puntualidad perfecta', 'Actitud profesional ejemplar'],
                80: ['Muy buen profesionalismo', 'Buena puntualidad', 'Actitud profesional correcta'],
                60: ['Profesionalismo correcto', 'Mant√©n la puntualidad', 'Buena actitud base'],
                40: ['Necesitas m√°s profesionalismo', 'Mejora la puntualidad', 'Trabaja en tu actitud'],
                20: ['Requiere mayor profesionalismo', 'Fundamental ser puntual', 'Desarrolla actitud profesional']
            }
        };

        // CONFIGURACI√ìN DE GEMINI AI
        const GEMINI_API_KEY = 'AIzaSyAOwLwJFPJugk3DBvdlexUVmLVPt23c_6g';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

        // SISTEMA DE FEEDBACK CON IA GEMINI (SIMPLIFICADO)
        async function generateAutoFeedback(artistVotes) {
            console.log('ü§ñ Iniciando generaci√≥n de feedback...');
            
            // USAR SISTEMA DE RESPALDO PRIMERO
            try {
                const fallbackSuggestions = generateFallbackFeedback(artistVotes);
                if (fallbackSuggestions && fallbackSuggestions.length >= 3) {
                    console.log('‚úÖ Usando sistema de respaldo con', fallbackSuggestions.length, 'sugerencias');
                    return fallbackSuggestions;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en sistema de respaldo:', error);
            }

            const scores = Object.values(artistVotes);
            const totalScore = scores.reduce((sum, val) => sum + val, 0);
            const averageScore = totalScore / scores.length;
            
            // Preparar datos para Gemini AI
            const criteriaDetails = CRITERIA.map(criteria => {
                const score = artistVotes[criteria.id] || 0;
                return `${criteria.name}: ${score}/100 puntos`;
            }).join('\n');
            
            const prompt = `Eres un jurado profesional de un certamen de canto. Analiza estas puntuaciones y genera EXACTAMENTE 5 sugerencias espec√≠ficas y profesionales para el artista:

PUNTUACIONES DEL ARTISTA:
${criteriaDetails}

PROMEDIO GENERAL: ${averageScore.toFixed(1)}/100

INSTRUCCIONES:
- Genera exactamente 5 comentarios profesionales
- Cada comentario debe ser espec√≠fico y √∫til
- Incluye tanto fortalezas como √°reas de mejora
- Usa un tono constructivo y profesional
- Cada sugerencia debe ser de 1-2 l√≠neas m√°ximo
- Enumera del 1 al 5

Formato de respuesta:
1. [Comentario sobre t√©cnica vocal o interpretaci√≥n]
2. [Comentario sobre presencia esc√©nica o expresi√≥n]
3. [Comentario sobre aspectos t√©cnicos espec√≠ficos]
4. [Sugerencia concreta de mejora]
5. [Reconocimiento de fortalezas y consejo final]`;

            // POR AHORA DESHABILITADO GEMINI - USAR SOLO SISTEMA DE RESPALDO
            console.log('‚ÑπÔ∏è Gemini deshabilitado temporalmente, usando sistema profesional integrado');
            return generateFallbackFeedback(artistVotes);
        }

        // SISTEMA DE FEEDBACK DE RESPALDO (si falla Gemini)
        function generateFallbackFeedback(artistVotes) {
            const feedbackSuggestions = [];
            const scores = Object.values(artistVotes);
            const totalScore = scores.reduce((sum, val) => sum + val, 0);
            const averageScore = totalScore / scores.length;
            
            // AN√ÅLISIS GENERAL DE RENDIMIENTO
            let generalAnalysis = "";
            if (averageScore >= 85) {
                generalAnalysis = "üåü PRESENTACI√ìN EXCEPCIONAL: Demuestras un nivel art√≠stico sobresaliente que destaca claramente en el certamen. Tu dominio t√©cnico y presencia esc√©nica reflejan una preparaci√≥n profesional de alto calibre.";
            } else if (averageScore >= 70) {
                generalAnalysis = "‚≠ê MUY BUENA PRESENTACI√ìN: Tienes una base s√≥lida y varios aspectos destacables. Con algunos ajustes espec√≠ficos, podr√≠as alcanzar un nivel excepcional.";
            } else if (averageScore >= 55) {
                generalAnalysis = "üìà BUEN POTENCIAL: Muestras fundamentos correctos con oportunidades claras de crecimiento. El trabajo enfocado en √°reas espec√≠ficas te llevar√° al siguiente nivel.";
            } else if (averageScore >= 40) {
                generalAnalysis = "üéØ EN DESARROLLO: Tienes bases que trabajar y varios aspectos que mejorar. Con dedicaci√≥n y pr√°ctica constante, ver√°s mejoras significativas.";
            } else {
                generalAnalysis = "üöÄ PUNTO DE PARTIDA: Este es el momento perfecto para enfocarte en los fundamentos. Considera buscar orientaci√≥n profesional para acelerar tu crecimiento art√≠stico.";
            }

            // AN√ÅLISIS ESPEC√çFICO POR CATEGOR√çAS ALTAS
            const highScores = [];
            const lowScores = [];
            const mediumScores = [];
            
            CRITERIA.forEach(criteria => {
                const score = artistVotes[criteria.id];
                if (score >= 80) highScores.push({criteria, score});
                else if (score <= 50) lowScores.push({criteria, score});
                else mediumScores.push({criteria, score});
            });

            // FORTALEZAS DESTACADAS
            if (highScores.length > 0) {
                const strengthsText = highScores.map(item => {
                    const templates = FEEDBACK_TEMPLATES[item.criteria.id][100] || FEEDBACK_TEMPLATES[item.criteria.id][80];
                    return `${item.criteria.name}: ${templates[Math.floor(Math.random() * templates.length)]} (${item.score} pts)`;
                }).join(" | ");
                
                feedbackSuggestions.push({
                    category: "üèÜ FORTALEZAS PRINCIPALES",
                    score: "Destacadas",
                    suggestion: strengthsText
                });
            }

            // √ÅREAS DE MEJORA PRIORITARIAS
            if (lowScores.length > 0) {
                const improvementText = lowScores.map(item => {
                    const templates = FEEDBACK_TEMPLATES[item.criteria.id][20] || FEEDBACK_TEMPLATES[item.criteria.id][40];
                    return `${item.criteria.name}: ${templates[Math.floor(Math.random() * templates.length)]} (${item.score} pts)`;
                }).join(" | ");
                
                feedbackSuggestions.push({
                    category: "üéØ √ÅREAS DE MEJORA",
                    score: "Prioritarias",
                    suggestion: improvementText
                });
            }

            // AN√ÅLISIS T√âCNICO ESPEC√çFICO
            const tecnicaVocal = artistVotes['tecnica_vocal'] || 0;
            const interpretacion = artistVotes['melodia_interpretacion'] || 0;
            const presencia = artistVotes['presencia_escenica'] || 0;
            
            if (tecnicaVocal > interpretacion + 20) {
                feedbackSuggestions.push({
                    category: "üé§ AN√ÅLISIS T√âCNICO-ART√çSTICO",
                    score: "Espec√≠fico",
                    suggestion: "Tienes excelente t√©cnica vocal pero podr√≠as conectar m√°s emocionalmente con las canciones. Trabaja en transmitir sentimientos y contar la historia de cada tema. La t√©cnica sin emoci√≥n puede sonar mec√°nica."
                });
            } else if (interpretacion > tecnicaVocal + 20) {
                feedbackSuggestions.push({
                    category: "üéº AN√ÅLISIS ART√çSTICO-T√âCNICO",
                    score: "Espec√≠fico", 
                    suggestion: "Tienes gran capacidad interpretativa y conexi√≥n emocional, pero necesitas fortalecer tu t√©cnica vocal. Considera clases de canto para potenciar tu expresividad natural con mayor control t√©cnico."
                });
            }

            // SUGERENCIAS PROFESIONALES ESPEC√çFICAS
            const professionalTips = generateProfessionalTips(artistVotes, averageScore);
            if (professionalTips) {
                feedbackSuggestions.push({
                    category: "üíº RECOMENDACIONES PROFESIONALES",
                    score: "Espec√≠ficas",
                    suggestion: professionalTips
                });
            }

            // AN√ÅLISIS GENERAL COMO PRIMERA ENTRADA
            feedbackSuggestions.unshift({
                category: "üìä AN√ÅLISIS GENERAL",
                score: `${averageScore.toFixed(1)}/100`,
                suggestion: generalAnalysis
            });
            
            return feedbackSuggestions;
        }

        // FUNCI√ìN PARA GENERAR TIPS PROFESIONALES ESPEC√çFICOS
        function generateProfessionalTips(votes, average) {
            const tips = [];
            
            const diccion = votes['diccion_articulacion'] || 0;
            const vestuario = votes['vestuario_presentacion'] || 0;
            const originalidad = votes['originalidad_creatividad'] || 0;
            const dinamica = votes['dinamica_espacio'] || 0;
            
            if (diccion < 60) tips.push("Practica ejercicios de vocalizaci√≥n 15 minutos diarios");
            if (vestuario < 60) tips.push("Consulta con un estilista para optimizar tu imagen esc√©nica");
            if (originalidad < 60) tips.push("Desarrolla tu sello personal estudiando a artistas que admires");
            if (dinamica < 60) tips.push("Practica movimiento esc√©nico frente a un espejo");
            
            if (average >= 80) tips.push("Considera grabar un demo profesional con estos resultados");
            else if (average >= 65) tips.push("Est√°s cerca del nivel profesional, mant√©n la constancia");
            else tips.push("Enf√≥cate en 2-3 aspectos espec√≠ficos para ver mejoras r√°pidas");
            
            return tips.length > 0 ? tips.join(" | ") : null;
        }

        // VARIABLES GLOBALES
        let currentJuror = null;
        let artists = [];
        let votes = {}; // {artistId: {criteriaId: value}}

        // === CARGAR JURADOS DISPONIBLES ===
        async function loadAvailableJurors() {
            try {
                const juriesSnapshot = await getDocs(collection(db, `jury_users`));
                const activeJurors = juriesSnapshot.docs
                    .filter(doc => doc.data().isActive)
                    .map(doc => doc.data().name || doc.data().displayName);
                
                const jurorsText = activeJurors.length > 0 
                    ? `Jurados disponibles: ${activeJurors.join(', ')}`
                    : 'No hay jurados registrados';
                
                document.getElementById('available-jurors').textContent = jurorsText;
                console.log('üé≠ Jurados disponibles:', activeJurors);
            } catch (error) {
                console.error('Error cargando jurados:', error);
                document.getElementById('available-jurors').textContent = 'Error cargando jurados';
            }
        }

        // Cargar jurados al iniciar la p√°gina
        loadAvailableJurors();

        // === FUNCIONES PRINCIPALES ===

        // Funci√≥n para obtener etiqueta del tipo de jurado
        function getJurorTypeLabel(type) {
            const labels = {
                'individual': 'üéØ Individual',
                'grupal': 'üë• Grupal', 
                'secreto': 'üîí Secreto',
                'principal': '‚≠ê Principal',
                'invitado': 'üé≠ Invitado'
            };
            return labels[type] || 'üé≠ Jurado';
        }

        // ‚ùå FUNCI√ìN login() ANTIGUA ELIMINADA - Solo usuarios registrados permitidos

        window.logout = function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                currentJuror = null;
                votes = {};
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('juror-name').value = '';
            }
        };

        // üÜï NUEVAS FUNCIONES PARA USUARIOS REGISTRADOS
        window.toggleLoginMode = function() {
            const userMode = document.getElementById('user-login-mode');
            const tempMode = document.getElementById('temp-login-mode');
            
            if (userMode.classList.contains('hidden')) {
                userMode.classList.remove('hidden');
                tempMode.classList.add('hidden');
                loadRegisteredUsers();
            } else {
                userMode.classList.add('hidden');
                tempMode.classList.remove('hidden');
            }
        };

        window.loadRegisteredUsers = async function() {
            console.log('üîç v2.0 - Cargando usuarios desde jury_users global...');
            console.log('üìç Firebase DB:', db);
            console.log('üìç Colecci√≥n objetivo: jury_users');
            
            try {
                const userSelect = document.getElementById('juror-user-select');
                userSelect.innerHTML = '<option value="">üîç v2.0 - Cargando usuarios...</option>';
                
                // ‚úÖ RUTA SIMPLIFICADA - Solo busca en jury_users global
                console.log('üìÇ Ejecutando: getDocs(collection(db, "jury_users"))');
                const snapshot = await getDocs(collection(db, 'jury_users'));
                console.log(`üìä Snapshot recibido - Total documentos: ${snapshot.size}`);
                
                if (snapshot.empty) {
                    console.log('‚ùå Snapshot vac√≠o - No hay usuarios registrados');
                    userSelect.innerHTML = '<option value="">‚ùå NO HAY USUARIOS EN jury_users</option>';
                    return;
                }
                
                let html = '<option value="">üë§ Selecciona tu usuario</option>';
                let userCount = 0;
                let allUsers = [];
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    allUsers.push({id: doc.id, ...user});
                    console.log(`üìÑ Documento ${doc.id}:`, user);
                    console.log(`  - Nombre: ${user.name}`);
                    console.log(`  - Tipo: ${user.type}`);
                    console.log(`  - TypeLabel: ${user.typeLabel}`);
                    console.log(`  - Activo: ${user.isActive}`);
                    
                    if (user.isActive !== false) { // Incluir si es true o undefined
                        console.log(`‚úÖ Usuario INCLUIDO: ${user.name} - Tipo: ${user.typeLabel}`);
                        const displayName = user.name || doc.id;
                        const typeLabel = user.typeLabel || user.type || 'Usuario';
                        html += `<option value="${user.id || doc.id}">${displayName} (${typeLabel})</option>`;
                        userCount++;
                    } else {
                        console.log(`‚è∏Ô∏è Usuario INACTIVO: ${user.name}`);
                    }
                });
                
                console.log('üìã RESUMEN:');
                console.log(`  - Total documentos: ${snapshot.size}`);
                console.log(`  - Usuarios activos: ${userCount}`);
                console.log('  - Todos los usuarios:', allUsers);
                
                userSelect.innerHTML = html;
                console.log(`‚úÖ v2.0 - ${userCount} usuarios cargados en el select`);
                
            } catch (error) {
                console.error('‚ùå v2.0 - Error cargando usuarios:', error);
                console.error('‚ùå Error stack:', error.stack);
                document.getElementById('juror-user-select').innerHTML = '<option value="">‚ùå Error cargando usuarios</option>';
            }
        };

        window.loginWithUser = async function() {
            const userId = document.getElementById('juror-user-select').value;
            
            if (!userId) {
                alert('‚ùå Por favor selecciona tu usuario de la lista');
                return;
            }
            
            try {
                console.log('üîì Acceso directo sin contrase√±a para:', userId);
                
                // ‚úÖ ACCESO DIRECTO - Solo verificar que existe y est√° activo
                const userDoc = await getDoc(doc(db, `jury_users`, userId));
                
                if (!userDoc.exists()) {
                    alert('‚ùå Usuario no encontrado en la base de datos');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('üë§ Datos del usuario:', userData);
                
                if (userData.isActive === false) {
                    alert('‚ùå Usuario desactivado. Contacta al administrador.');
                    return;
                }
                
                // Configurar jurado con usuario registrado
                currentJuror = {
                    id: userData.id,
                    name: userData.name,
                    type: userData.type,
                    typeLabel: userData.typeLabel,
                    additional: userData.additional || '',
                    loginTime: new Date().toISOString(),
                    isAnonymous: userData.type === 'secreto',
                    displayName: userData.type === 'secreto' ? 'Jurado An√≥nimo' : userData.name,
                    isRegisteredUser: true
                };
                
                console.log('‚úÖ Login exitoso:', currentJuror);
                
                // Mostrar informaci√≥n del jurado
                const displayText = `${currentJuror.displayName} (${currentJuror.typeLabel})`;
                document.getElementById('juror-display').textContent = displayText;
                
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // Cargar votos anteriores del usuario
                await loadUserPreviousVotes();
                
                loadArtists();
                
            } catch (error) {
                console.error('Error en login:', error);
                alert('‚ùå Error al iniciar sesi√≥n: ' + error.message);
            }
        };

        // ‚ùå FUNCI√ìN loginWithTemp ELIMINADA - Solo usuarios registrados permitidos

        // Funci√≥n para cargar votos anteriores del usuario registrado
        window.loadUserPreviousVotes = async function() {
            if (!currentJuror || !currentJuror.isRegisteredUser) return;
            
            try {
                console.log('üîç Cargando votos anteriores para:', currentJuror.id);
                
                // ‚úÖ BUSCAR SOLO EN jury_evaluations (simplificado)
                const q = query(
                    collection(db, `events/${eventId}/jury_evaluations`),
                    where('jurorId', '==', currentJuror.id)
                );
                
                const snapshot = await getDocs(q);
                let foundVotes = {};
                
                snapshot.forEach(doc => {
                    const voteData = doc.data();
                    const artistId = voteData.artistId;
                    
                    if (artistId && voteData.scores) {
                        foundVotes[artistId] = voteData.scores;
                        console.log(`‚úÖ Voto anterior para ${voteData.artistName}:`, voteData.scores);
                    }
                });
                
                // Aplicar votos encontrados
                votes = foundVotes;
                console.log('üìä Votos cargados:', votes);
                
                if (Object.keys(votes).length > 0) {
                    alert(`‚úÖ ¬°Bienvenido de vuelta!\n\nSe cargaron tus votos anteriores para ${Object.keys(votes).length} artista(s).`);
                }
                
            } catch (error) {
                console.error('Error cargando votos anteriores:', error);
            }
        };

        // Funci√≥n simple para cambiar a modo usuario registrado
        window.showRegisteredUserLogin = function() {
            const authSection = document.getElementById('auth-section');
            authSection.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-center">üîê Login Usuario Registrado</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 font-bold">Selecciona tu Usuario:</label>
                        <select id="registered-user-select" class="w-full p-3 rounded bg-white text-black">
                            <option value="">-- Cargando usuarios... --</option>
                        </select>
                    </div>
                    
                    <button onclick="loginWithRegisteredUser()" class="btn btn-primary w-full" style="margin-top: 20px;">
                        üé≠ INGRESAR COMO JURADO
                    </button>
                    
                    <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 15px;">
                        ‚ú® Solo selecciona tu nombre y presiona ingresar<br>
                        üöÄ Sin contrase√±as, acceso directo
                    </div>
                    
                    <div class="text-center mt-4">
                        <button onclick="location.reload()" class="text-blue-400 hover:text-blue-300 text-sm underline">
                            ‚Üê Volver a login normal
                        </button>
                    </div>
                </div>
            `;
            
            loadRegisteredUsersSimple();
        };

        // Funci√≥n simplificada para cargar usuarios
        window.loadRegisteredUsersSimple = async function() {
            try {
                const userSelect = document.getElementById('registered-user-select');
                
                // ‚úÖ RUTA GLOBAL SIMPLIFICADA
                const snapshot = await getDocs(collection(db, `jury_users`));
                
                if (snapshot.empty) {
                    userSelect.innerHTML = '<option value="">-- No hay usuarios registrados --</option>';
                    return;
                }
                
                let html = '<option value="">-- Selecciona tu usuario --</option>';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.isActive) { // Solo usuarios activos
                        html += `<option value="${user.id}">${user.name} (${user.typeLabel})</option>`;
                    }
                });
                
                userSelect.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                document.getElementById('registered-user-select').innerHTML = '<option value="">-- Error cargando usuarios --</option>';
            }
        };

        // Funci√≥n simplificada de login SIN CONTRASE√ëA
        window.loginWithRegisteredUser = async function() {
            const userId = document.getElementById('registered-user-select').value;
            
            if (!userId) {
                alert('‚ùå Por favor selecciona tu usuario de la lista');
                return;
            }
            
            try {
                console.log('üîì Acceso directo sin contrase√±a para:', userId);
                
                // ‚úÖ ACCESO DIRECTO - Solo verificar que existe y est√° activo
                const userDoc = await getDoc(doc(db, `jury_users`, userId));
                
                if (!userDoc.exists()) {
                    alert('‚ùå Usuario no encontrado en la base de datos');
                    return;
                }
                
                const userData = userDoc.data();
                
                if (userData.isActive === false) {
                    alert('‚ùå Usuario desactivado. Contacta al administrador.');
                    return;
                }
                
                // Configurar jurado con usuario registrado
                currentJuror = {
                    id: userData.id,
                    name: userData.name,
                    type: userData.type,
                    typeLabel: userData.typeLabel,
                    additional: userData.additional || '',
                    loginTime: new Date().toISOString(),
                    isAnonymous: userData.type === 'secreto',
                    displayName: userData.type === 'secreto' ? 'Jurado An√≥nimo' : userData.name,
                    isRegisteredUser: true
                };
                
                console.log('‚úÖ Login con usuario registrado:', currentJuror);
                
                // Mostrar informaci√≥n del jurado
                const displayText = `${currentJuror.displayName} (${currentJuror.typeLabel}) - Registrado`;
                document.getElementById('juror-display').textContent = displayText;
                
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // Cargar votos anteriores del usuario
                await loadUserPreviousVotes();
                
                loadArtists();
                
            } catch (error) {
                console.error('Error en login con usuario:', error);
                alert('‚ùå Error al iniciar sesi√≥n: ' + error.message);
            }
        };

        async function loadArtists() {
            document.getElementById('status').textContent = 'Cargando artistas desde Firebase...';
            console.log('üé§ Cargando artistas...');
            console.log('üîç Event ID usado:', eventId);
            console.log('üîç Ruta Firebase:', `events/${eventId}/artists`);

            try {
                const artistsSnapshot = await getDocs(query(collection(db, `events/${eventId}/artists`), orderBy('name')));
                console.log('üìä Documentos encontrados:', artistsSnapshot.docs.length);
                
                // Debug: mostrar todos los documentos
                if (artistsSnapshot.docs.length === 0) {
                    console.log('‚ùå No se encontraron documentos en la colecci√≥n');
                    console.log('üîç Verificando si la colecci√≥n existe...');
                    
                    // Intentar sin orderBy por si hay problema
                    const simpleSnapshot = await getDocs(collection(db, `events/${eventId}/artists`));
                    console.log('üìä Sin orderBy:', simpleSnapshot.docs.length);
                    
                    // Listar todas las colecciones del evento
                    console.log('üîç Intentando listar estructura del evento...');
                } else {
                    artistsSnapshot.docs.forEach(doc => {
                        console.log('üìÑ Documento encontrado:', doc.id, doc.data());
                    });
                }
                
                artists = artistsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${artists.length} artistas cargados:`, artists.map(a => a.name));
                document.getElementById('status').textContent = `${artists.length} artistas cargados`;

                if (artists.length === 0) {
                    console.log('‚ùå Lista de artistas vac√≠a');
                    document.getElementById('artists-list').innerHTML = `
                        <div class="card p-8 text-center">
                            <div class="text-4xl mb-4">‚ùå</div>
                            <h3 class="text-xl font-bold mb-2">No hay artistas en Firebase</h3>
                            <p>Event ID: <code>${eventId}</code></p>
                            <p>Ruta: <code>events/${eventId}/artists</code></p>
                            <p class="mt-4">Ve a "Gesti√≥n de Votaciones" para agregar artistas.</p>
                            <button onclick="loadArtists()" class="btn btn-primary mt-4">üîÑ Reintentar</button>
                        </div>
                    `;
                    return;
                }

                renderArtists();
                updateStats();
                
                // ‚úÖ NUEVO: Restaurar bloqueos de puntuaci√≥n despu√©s de renderizar
                setTimeout(() => {
                    restoreScoreLocks();
                    console.log('üîí Bloqueos de puntuaci√≥n restaurados');
                }, 500);

            } catch (error) {
                console.error('‚ùå Error cargando artistas:', error);
                document.getElementById('status').textContent = 'Error al cargar artistas';
                document.getElementById('artists-list').innerHTML = `
                    <div class="card p-8 text-center">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold mb-2">Error de Firebase</h3>
                        <p class="mb-2">Event ID: <code>${eventId}</code></p>
                        <p class="text-sm opacity-75">${error.message}</p>
                        <button onclick="loadArtists()" class="btn btn-primary mt-4">üîÑ Reintentar</button>
                    </div>
                `;
            }
        }

        function renderArtists() {
            const html = artists.map(artist => {
                const artistVotes = votes[artist.id] || {};
                const isComplete = CRITERIA.every(c => artistVotes[c.id] !== undefined);
                const isEditing = window.editingMode && window.editingMode[artist.id];
                const average = isComplete ? 
                    Object.values(artistVotes).reduce((sum, val) => sum + val, 0) / CRITERIA.length : 0;

                return `
                    <div class="card artist-card" data-artist-id="${artist.id}">
                        <!-- HEADER DEL ARTISTA -->
                        <div class="flex items-center mb-6 p-4 bg-black bg-opacity-30 rounded-lg">
                            <img src="${artist.photoURL || 'https://placehold.co/80x80/4338ca/ffffff?text=' + artist.name.charAt(0)}" 
                                 class="w-20 h-20 rounded-full object-cover border-4 border-white mr-4">
                            <div class="flex-grow">
                                <h3 class="text-2xl font-bold">${artist.name}</h3>
                                <p class="opacity-75">üéµ Participante del certamen</p>
                                ${isComplete && !isEditing ? `
                                    <div class="mt-2 px-3 py-1 bg-green-600 rounded-full inline-block">
                                        <span class="text-sm font-bold">‚úÖ VOTADO - Promedio: ${average.toFixed(1)} pts</span>
                                    </div>
                                ` : `
                                    <div class="mt-2 px-3 py-1 bg-yellow-600 rounded-full inline-block">
                                        <span class="text-sm font-bold">${isEditing ? '‚úèÔ∏è EDITANDO' : '‚è≥ PENDIENTE DE VOTAR'}</span>
                                    </div>
                                `}
                            </div>
                        </div>

                        ${isComplete && !isEditing ? `
                            <!-- VOTACI√ìN COMPLETADA -->
                            <div class="bg-green-800 bg-opacity-50 p-6 rounded-lg">
                                <h4 class="text-xl font-bold mb-4 text-center">‚úÖ Votaci√≥n Completada</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    ${CRITERIA.map(criteria => `
                                        <div class="bg-black bg-opacity-30 p-3 rounded text-center">
                                            <div class="font-bold">${criteria.name}</div>
                                            <div class="text-2xl font-bold text-green-300">${artistVotes[criteria.id]} pts</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="text-center space-y-3">
                                    <div class="text-3xl font-bold text-green-300 mb-2">${average.toFixed(1)} puntos</div>
                                    
                                    <!-- FEEDBACK AUTOM√ÅTICO GENERADO -->
                                    <div id="feedback-section-${artist.id}" class="bg-blue-800 bg-opacity-50 p-4 rounded-lg mt-4" style="display: none;">
                                        <h5 class="text-lg font-bold mb-3 text-center">üí¨ Sugerencias de Feedback</h5>
                                        <div id="auto-feedback-${artist.id}" class="space-y-2 text-sm">
                                            <!-- Se generar√° autom√°ticamente -->
                                        </div>
                                        <p class="text-xs text-blue-300 mt-2 text-center">üí° Basado en tus puntuaciones - Puedes usarlas como gu√≠a</p>
                                    </div>
                                    
                                    <!-- COMENTARIOS ADICIONALES POST-EVALUACI√ìN -->
                                    <div id="post-comments-section-${artist.id}" class="bg-green-800 bg-opacity-30 p-4 rounded-lg mt-4 border border-green-500" style="display: none;">
                                        <h5 class="text-lg font-bold mb-3 text-green-300">üìù Tus comentarios adicionales</h5>
                                        <textarea id="post-comments-${artist.id}" 
                                                  placeholder="¬øQuieres agregar alg√∫n comentario personal despu√©s de ver el feedback? Escribe aqu√≠ tus observaciones adicionales..."
                                                  class="w-full h-20 p-3 bg-gray-700 text-white rounded-lg border border-green-500 resize-none"
                                                  onblur="savePostComments('${artist.id}', this.value)"></textarea>
                                        <p class="text-xs text-green-300 mt-2">üí° Estos comentarios se guardar√°n junto con tu evaluaci√≥n</p>
                                    </div>
                                    
                                    <div class="space-x-2 space-y-2">
                                        <button onclick="editVote('${artist.id}')" class="btn btn-primary">‚úèÔ∏è Editar Voto</button>
                                        <button onclick="clearVote('${artist.id}')" class="btn btn-red">üóëÔ∏è Borrar Voto</button>
                                        <br>
                                        <button onclick="forceSubmitVote('${artist.id}')" class="btn btn-green">üíæ GUARDAR VOTO</button>
                                    </div>
                                    <p class="text-xs text-yellow-300">üí° Si no aparece en reportes, usa "GUARDAR VOTO"</p>
                                </div>
                            </div>
                        ` : `
                            <!-- PANEL DE OTROS JURADOS PARA ESTE ARTISTA -->
                            <div class="bg-orange-800 bg-opacity-30 p-4 rounded-lg border border-orange-500 mb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-orange-300 font-bold">üë• ¬øQu√© hicieron otros jurados con este artista?</h4>
                                    <button onclick="debugArtistVotes('${artist.id}')" 
                                            class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                        ÔøΩÔ∏è Ver Votos
                                    </button>
                                </div>
                                <div id="other-jurors-${artist.id}" class="space-y-2">
                                    <p class="text-center text-gray-400">Cargando actividad de otros jurados...</p>
                                </div>
                            </div>
                            
                            <!-- FORMULARIO DE VOTACI√ìN CON SLIDERS -->
                            <div class="space-y-6">
                                ${CRITERIA.map(criteria => {
                                    const currentValue = artistVotes[criteria.id] || 50;
                                    return `
                                    <div class="criteria bg-black bg-opacity-30 p-4 rounded-lg">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="text-lg font-bold">${criteria.name}</h4>
                                            <div class="flex items-center gap-3">
                                                <!-- ‚úÖ NUEVO: Checkbox de bloqueo para m√≥viles -->
                                                <div class="flex items-center gap-2">
                                                    <input type="checkbox" 
                                                           id="lock-${artist.id}-${criteria.id}" 
                                                           class="lock-checkbox" 
                                                           onchange="toggleScoreLock('${artist.id}', '${criteria.id}')"
                                                           title="Bloquear puntuaci√≥n">
                                                    <label for="lock-${artist.id}-${criteria.id}" class="text-sm cursor-pointer">üîí</label>
                                                </div>
                                                <span id="list-${artist.id}-${criteria.id}-display" class="text-2xl font-bold text-blue-300">${currentValue}</span>
                                                <input type="number" 
                                                       id="list-${artist.id}-${criteria.id}-input" 
                                                       class="w-16 h-8 text-center bg-gray-800 text-white rounded border border-gray-600" 
                                                       min="25" 
                                                       max="100" 
                                                       value="${currentValue}"
                                                       onchange="updateListScore('${artist.id}', '${criteria.id}', this.value)">
                                            </div>
                                        </div>
                                        <input type="range" 
                                               id="list-${artist.id}-${criteria.id}-slider" 
                                               class="category-slider w-full" 
                                               min="25" 
                                               max="100" 
                                               value="${currentValue}"
                                               oninput="updateListScore('${artist.id}', '${criteria.id}', this.value)">
                                        <div class="flex justify-between text-xs text-gray-300 mt-2">
                                            <span>25 - MALO</span>
                                            <span>50 - REGULAR</span>
                                            <span>75 - BUENO</span>
                                            <span>100 - EXCELENTE</span>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                                
                                <!-- CAMPO DE COMENTARIOS EN VISTA LISTA -->
                                <div class="mt-6 p-4 bg-black bg-opacity-20 rounded-lg">
                                    <label for="list-judge-comments-${artist.id}" class="block text-sm font-semibold text-green-200 mb-2">
                                        üí≠ Comentarios y observaciones del jurado:
                                    </label>
                                    <textarea id="list-judge-comments-${artist.id}" rows="3"
                                              class="w-full p-3 border-2 border-green-400 rounded-lg bg-green-50 text-gray-800 text-sm focus:border-green-600 focus:outline-none"
                                              placeholder="Ej: Muy buena interpretaci√≥n, mejor√≥ mucho desde la gala anterior. Trabajar en proyecci√≥n de voz."
                                              onchange="saveListComments('${artist.id}', this.value)"></textarea>
                                </div>
                                
                                <div class="text-center pt-4 space-y-3">
                                    <!-- Informaci√≥n del estado del voto -->
                                    <div class="text-sm">
                                        ${isComplete 
                                            ? '‚úÖ <span class="text-green-400 font-bold">Voto Completo</span>' 
                                            : Object.keys(artistVotes).length > 0
                                                ? `‚ö†Ô∏è <span class="text-yellow-400 font-bold">Voto Parcial</span> (${Object.keys(artistVotes).length}/${CRITERIA.length} criterios)`
                                                : '‚≠ï <span class="text-gray-400">Sin votar</span>'
                                        }
                                    </div>
                                    
                                    <!-- Bot√≥n para limpiar votaci√≥n -->
                                    ${Object.keys(artistVotes).length > 0 ? `
                                        <button onclick="clearVote('${artist.id}')" class="btn btn-red px-4 py-2">
                                            üóëÔ∏è LIMPIAR VOTOS
                                        </button>
                                    ` : ''}
                                    
                                    <!-- Bot√≥n para terminar edici√≥n -->
                                    ${isEditing ? `
                                        <button onclick="exitEditMode('${artist.id}')" class="btn btn-yellow px-4 py-2">
                                            ‚úÖ TERMINAR EDICI√ìN
                                        </button>
                                    ` : ''}
                                    
                                    <div class="text-sm space-y-1 opacity-75">
                                        <p class="font-bold">${isComplete ? '‚úÖ ¬°Listo para enviar!' : '‚è≥ Votaci√≥n en progreso'}</p>
                                        <p>Criterios completados: ${Object.keys(artistVotes).length}/${CRITERIA.length}</p>
                                        <p class="text-xs">üí° Puedes guardar parcialmente y continuar despu√©s</p>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            document.getElementById('artists-list').innerHTML = html;
            
            // Generar feedback autom√°tico para artistas con votos completos
            artists.forEach(artist => {
                const artistVotes = votes[artist.id] || {};
                const isComplete = CRITERIA.every(c => artistVotes[c.id] !== undefined);
                if (isComplete) {
                    // Generar feedback autom√°tico para la Vista Lista
                    generateAndShowListFeedback(artist.id, artistVotes).catch(console.error);
                }
            });
            
            // Mantener el filtro despu√©s de renderizar
            preserveFilter();
            
            // Cargar comentarios guardados en los campos de Vista Lista
            if (currentViewMode === 'list' && window.artistComments) {
                artists.forEach(artist => {
                    const commentsField = document.getElementById(`list-judge-comments-${artist.id}`);
                    if (commentsField && window.artistComments[artist.id]) {
                        commentsField.value = window.artistComments[artist.id];
                    }
                });
            }
            
            // ‚úÖ ACTUALIZAR ESTAD√çSTICAS despu√©s de renderizar
            updateStats();
            
            // ‚úÖ ACTUALIZAR BOT√ìN GLOBAL DE ENV√çO
            updateGlobalSubmitButton();
        }

        window.selectRating = function(artistId, criteriaId, value) {
            console.log(`üîò Selecci√≥n: ${criteriaId} = ${value} para artista ${artistId}`);
            
            if (!votes[artistId]) votes[artistId] = {};
            votes[artistId][criteriaId] = value;
            
            console.log(`üìù Votos actuales para ${artistId}:`, votes[artistId]);
            console.log(`üìä Total votos registrados: ${Object.keys(votes[artistId]).length}/${CRITERIA.length}`);
            
            // Re-renderizar solo este artista para actualizar la UI
            renderArtists();
            updateStats();
        };

        window.editVote = function(artistId) {
            const artist = artists.find(a => a.id === artistId);
            
            console.log(`üîç Iniciando edici√≥n para: ${artistId}`, {
                artist: artist,
                currentVotes: votes[artistId],
                viewMode: currentViewMode
            });
            
            const confirmation = confirm(`‚úèÔ∏è EDITAR VOTACI√ìN\n\n¬øQuieres modificar los votos para "${artist?.name || artistId}"?\n\n‚Ä¢ Se mostrar√°n los sliders de edici√≥n\n‚Ä¢ Los valores actuales quedar√°n como base\n‚Ä¢ Podr√°s modificar y guardar los cambios\n\n¬øContinuar?`);
            
            if (confirmation) {
                console.log(`‚úÖ Usuario confirm√≥ edici√≥n para: ${artistId}`);
                
                // Forzar cambio a Vista Lista si estamos en Vista Organizada
                if (currentViewMode === 'grid') {
                    console.log('üîÑ Cambiando de Vista Organizada a Vista Lista para edici√≥n');
                    switchViewMode('list');
                }
                
                // Marcar como en edici√≥n
                if (!window.editingMode) window.editingMode = {};
                window.editingMode[artistId] = true;
                
                console.log('üîÑ Re-renderizando artistas en modo edici√≥n');
                
                // Re-renderizar inmediatamente
                setTimeout(() => {
                    renderArtists();
                    console.log('‚úÖ Renderizado completado en modo edici√≥n');
                    
                    // Scroll al artista
                    const artistCard = document.querySelector(`[data-artist-id="${artistId}"]`);
                    if (artistCard) {
                        artistCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
                
                alert(`‚úèÔ∏è MODO EDICI√ìN ACTIVADO\n\n‚Ä¢ Usa los sliders para modificar las puntuaciones\n‚Ä¢ Los valores actuales aparecen como base\n‚Ä¢ Cuando termines, usa "‚úÖ TERMINAR EDICI√ìN"`);
            }
        };

        // Funci√≥n para salir del modo edici√≥n
        window.exitEditMode = function(artistId) {
            console.log(`üö™ Saliendo del modo edici√≥n para: ${artistId}`);
            
            if (window.editingMode && window.editingMode[artistId]) {
                delete window.editingMode[artistId];
            }
            
            // Re-renderizar para mostrar el estado normal
            renderArtists();
            
            alert(`‚úÖ EDICI√ìN TERMINADA\n\nVolviste al modo normal. El voto se mantiene guardado con los √∫ltimos cambios.`);
        };

        // FUNCIONES PARA MANEJO DE COMENTARIOS EN VISTA LISTA - MEJORADA
        window.saveListComments = function(artistId, comments) {
            console.log(`üí¨ Guardando comentarios para ${artistId}:`, comments);
            
            // Crear objeto de comentarios si no existe
            if (!window.artistComments) {
                window.artistComments = {};
            }
            
            // Guardar comentarios para este artista
            window.artistComments[artistId] = comments;
            
            // ‚úÖ NUEVO: Guardar tambi√©n en localStorage para persistencia
            const savedComments = JSON.parse(localStorage.getItem('juror_comments') || '{}');
            savedComments[artistId] = comments;
            localStorage.setItem('juror_comments', JSON.stringify(savedComments));
            
            // ‚úÖ NUEVO: Feedback visual inmediato
            const textarea = document.getElementById(`list-judge-comments-${artistId}`);
            if (textarea) {
                textarea.style.borderColor = '#10B981';
                textarea.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.3)';
                
                setTimeout(() => {
                    textarea.style.borderColor = '#4ade80';
                    textarea.style.boxShadow = 'none';
                }, 1000);
            }
            
            console.log('üìù Comentarios guardados y persistidos:', window.artistComments);
        };

        // ‚úÖ NUEVO: SISTEMA DE BLOQUEO DE PUNTUACI√ìN PARA M√ìVILES
        window.scoreLocks = {}; // Objeto para rastrear bloqueos: {artistId_criteriaId: true/false}
        
        window.toggleScoreLock = function(artistId, criteriaId) {
            const lockKey = `${artistId}_${criteriaId}`;
            const checkbox = document.getElementById(`lock-${artistId}-${criteriaId}`);
            const slider = document.getElementById(`list-${artistId}-${criteriaId}-slider`);
            
            if (!checkbox || !slider) {
                console.warn('‚ö†Ô∏è No se encontraron elementos de bloqueo:', lockKey);
                return;
            }
            
            // Alternar estado de bloqueo
            window.scoreLocks[lockKey] = checkbox.checked;
            
            if (checkbox.checked) {
                // BLOQUEAR puntuaci√≥n
                slider.disabled = true;
                slider.classList.add('slider-locked');
                console.log(`üîí Puntuaci√≥n bloqueada: ${lockKey}`);
                
                // Feedback t√°ctil en m√≥viles
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } else {
                // DESBLOQUEAR puntuaci√≥n
                slider.disabled = false;
                slider.classList.remove('slider-locked');
                console.log(`üîì Puntuaci√≥n desbloqueada: ${lockKey}`);
                
                if (navigator.vibrate) {
                    navigator.vibrate([25, 25, 25]);
                }
            }
            
            // Guardar estado en localStorage
            localStorage.setItem('score_locks', JSON.stringify(window.scoreLocks));
        };
        
        // Restaurar bloqueos desde localStorage
        window.restoreScoreLocks = function() {
            const savedLocks = JSON.parse(localStorage.getItem('score_locks') || '{}');
            window.scoreLocks = savedLocks;
            
            Object.keys(savedLocks).forEach(lockKey => {
                if (savedLocks[lockKey]) {
                    const [artistId, criteriaId] = lockKey.split('_');
                    const checkbox = document.getElementById(`lock-${artistId}-${criteriaId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        toggleScoreLock(artistId, criteriaId);
                    }
                }
            });
        };

        // FUNCI√ìN PARA OBTENER COMENTARIOS SEG√öN LA VISTA ACTUAL - MEJORADA
        function getArtistComments(artistId) {
            if (currentViewMode === 'organizada') {
                // En vista organizada, usar el modal
                return document.getElementById('modal-judge-comments')?.value || '';
            } else {
                // En vista lista, usar m√∫ltiples fuentes con prioridad
                const fieldValue = document.getElementById(`list-judge-comments-${artistId}`)?.value || '';
                const memoryValue = window.artistComments?.[artistId] || '';
                
                // ‚úÖ NUEVO: Tambi√©n leer desde localStorage
                const savedComments = JSON.parse(localStorage.getItem('juror_comments') || '{}');
                const persistedValue = savedComments[artistId] || '';
                
                // Retornar el m√°s reciente (prioridad: campo actual, memoria, persistido)
                return fieldValue || memoryValue || persistedValue;
            }
        }

        window.submitVote = async function(artistId, silent = false) {
            console.log('üéØ Iniciando submitVote para:', artistId);
            console.log('üë§ Jurado actual completo:', JSON.stringify(currentJuror, null, 2));
            
            const artist = artists.find(a => a.id === artistId);
            const artistVotes = votes[artistId];
            
            console.log('üé≠ Artista encontrado:', artist);
            console.log('üìä Votos del artista:', artistVotes);
            console.log('üìã Estructura completa de votes:', votes);
            console.log('üî¢ CRITERIA.length:', CRITERIA.length);
            
            // Verificaci√≥n m√°s robusta del jurado
            if (!currentJuror) {
                console.error('‚ùå currentJuror es null');
                alert('‚ùå Error: No hay jurado autenticado. Por favor, recarga la p√°gina e ingresa tu nombre.');
                return;
            }
            
            if (!currentJuror.id) {
                console.error('‚ùå currentJuror.id no existe:', currentJuror);
                alert('‚ùå Error: ID de jurado no v√°lido. Por favor, recarga la p√°gina.');
                return;
            }
            
            if (!artist) {
                console.error('‚ùå Artista no encontrado:', artistId);
                alert('‚ùå Error: Artista no encontrado.');
                return;
            }
            
            // ‚úÖ NUEVA VALIDACI√ìN: Permitir votos parciales con confirmaci√≥n
            if (!artistVotes || Object.keys(artistVotes).length === 0) {
                alert('‚ùå No hay ning√∫n criterio evaluado para este artista');
                return;
            }
            
            const completedCriteria = Object.keys(artistVotes).length;
            const totalCriteria = CRITERIA.length;
            const isPartialVote = completedCriteria < totalCriteria;
            
            if (isPartialVote) {
                const missingCriteria = CRITERIA.filter(c => !artistVotes[c.id]).map(c => c.name);
                
                const confirmMessage = 
                    `‚ö†Ô∏è VOTACI√ìN PARCIAL DETECTADA\n\n` +
                    `Artista: ${artist.name}\n` +
                    `Criterios completados: ${completedCriteria}/${totalCriteria}\n\n` +
                    `Criterios faltantes:\n‚Ä¢ ${missingCriteria.join('\n‚Ä¢ ')}\n\n` +
                    `¬øDeseas enviar esta votaci√≥n parcial?\n\n` +
                    `‚úÖ S√ç - Enviar votaci√≥n parcial (recomendado si el artista no particip√≥)\n` +
                    `‚ùå NO - Continuar completando criterios`;
                
                if (!confirm(confirmMessage)) {
                    console.log('üö´ Usuario cancel√≥ env√≠o de votaci√≥n parcial');
                    return;
                }
                
                console.log('‚úÖ Usuario confirm√≥ env√≠o de votaci√≥n parcial');
            }

            // ‚úÖ PROMEDIO BASADO EN CRITERIOS COMPLETADOS (no en total de criterios)
            const completedValues = Object.values(artistVotes);
            const average = completedValues.reduce((sum, val) => sum + val, 0) / completedValues.length;

            try {
                console.log('üíæ Guardando voto en Firebase...');
                console.log('üìä Datos del voto:', { artistId, artistVotes, currentJuror });
                
                // Asegurar que tenemos nombre del jurado
                const jurorName = currentJuror.name || currentJuror.id || 'Jurado An√≥nimo';
                
                // OBTENER O CREAR GLOBAL ARTIST ID (comentado temporalmente)
                // const globalArtistId = globalArtistsManager.getOrCreateGlobalArtistId(
                //     artist.name, 
                //     eventId, 
                //     artistId
                // );
                const globalArtistId = artistId; // Usar ID local temporalmente
                console.log('üîó GlobalArtistId asignado:', globalArtistId);
                
                // ü§ñ GENERAR FEEDBACK AUTOM√ÅTICO
                console.log('ü§ñ Generando feedback autom√°tico...');
                const autoFeedback = generateFallbackFeedback(artistVotes);
                console.log('‚úÖ Feedback generado:', autoFeedback);
                
                const voteData = {
                    artistId: String(artistId),
                    artistName: String(artist.name || 'Artista'),
                    globalArtistId: String(globalArtistId), // ‚Üê NUEVO CAMPO CLAVE
                    jurorName: String(currentJuror.displayName || currentJuror.name || 'Jurado An√≥nimo'),
                    jurorId: String(currentJuror.id),
                    jurorType: String(currentJuror.type || 'individual'),
                    jurorTypeLabel: String(currentJuror.typeLabel || 'Jurado'),
                    jurorAdditional: String(currentJuror.additional || ''),
                    isAnonymous: Boolean(currentJuror.isAnonymous || false),
                    scores: artistVotes,
                    score: Number(average),
                    average: Number(average),
                    timestamp: new Date().toISOString(),
                    eventId: String(eventId || 'default-event'),
                    loginTime: String(currentJuror.loginTime || ''),
                    // ‚ûï FEEDBACK AUTOM√ÅTICO GENERADO
                    autoFeedback: autoFeedback,
                    feedbackGenerated: true,
                    feedbackTimestamp: new Date().toISOString(),
                    // ‚ûï NUEVOS CAMPOS ADICIONALES PARA SEGUIMIENTO COMPLETO
                    songPerformed: String(document.getElementById('modal-song-performed')?.value || ''),
                    judgeComments: String(getArtistComments(artistId)),
                    additionalNotes: String(document.getElementById('modal-additional-notes')?.value || '')
                };

                console.log('üíæ Guardando en Firebase con datos:', JSON.stringify(voteData, null, 2));

                // Simplificar el guardado para evitar errores
                const docId = `${currentJuror.id}_${artistId}`;
                
                // Intentar m√∫ltiples formas de guardado con las rutas correctas del evento
                let saveSuccess = false;
                
                try {
                    await setDoc(doc(db, `events/${eventId}/jury_evaluations`, docId), voteData);
                    console.log('‚úÖ Guardado en events/' + eventId + '/jury_evaluations:', docId);
                    saveSuccess = true;
                } catch (err1) {
                    console.warn('‚ö†Ô∏è Error en jury_evaluations, intentando jury_votes:', err1.message);
                    try {
                        await setDoc(doc(db, `events/${eventId}/jury_votes`, docId), voteData);
                        console.log('‚úÖ Guardado en events/' + eventId + '/jury_votes:', docId);
                        saveSuccess = true;
                    } catch (err2) {
                        console.warn('‚ö†Ô∏è Error en jury_votes, intentando votes:', err2.message);
                        try {
                            await setDoc(doc(db, `events/${eventId}/votes`, docId), voteData);
                            console.log('‚úÖ Guardado en events/' + eventId + '/votes:', docId);
                            saveSuccess = true;
                        } catch (err3) {
                            console.error('‚ùå Error en todas las colecciones:', err3.message);
                            throw new Error('No se pudo guardar en ninguna colecci√≥n: ' + err3.message);
                        }
                    }
                }
                
                if (!saveSuccess) {
                    throw new Error('Error desconocido al guardar');
                }
                
                console.log('‚úÖ Voto guardado exitosamente en Firebase');
                
                // Generar y mostrar feedback despu√©s de guardar
                const feedbackSuggestions = generateAutoFeedback(artistVotes);
                if (feedbackSuggestions.length > 0) {
                    const feedbackText = feedbackSuggestions.map(item => 
                        `${item.category}: ${item.suggestion}`
                    ).join('\n\n');
                    console.log('üí¨ Feedback generado:', feedbackText);
                }
                
                // Mostrar alerta solo si no es env√≠o silencioso
                if (!silent) {
                    const voteTypeMessage = isPartialVote 
                        ? `üìù VOTACI√ìN PARCIAL GUARDADA\n${completedCriteria}/${totalCriteria} criterios completados` 
                        : `‚úÖ VOTACI√ìN COMPLETA GUARDADA\nTodos los criterios completados`;
                    
                    alert(`${voteTypeMessage}\n\nArtista: ${artist.name}\nPromedio: ${average.toFixed(1)} puntos\n\nRevisa el feedback generado en la secci√≥n azul del modal.`);
                }
                
                renderArtists();
                preserveFilter(); // Mantener filtro
                updateStats();

            } catch (error) {
                console.error('‚ùå Error completo:', error);
                console.error('‚ùå Stack trace:', error.stack);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error code:', error.code);
                console.error('‚ùå EventId actual:', eventId);
                console.error('‚ùå CurrentJuror:', currentJuror);
                console.error('‚ùå VoteData generada:', JSON.stringify(voteData, null, 2));
                
                let errorMessage = 'Error al guardar la votaci√≥n.\n\n';
                errorMessage += `Detalles del error:\n`;
                errorMessage += `‚Ä¢ Mensaje: ${error.message || 'Error desconocido'}\n`;
                errorMessage += `‚Ä¢ C√≥digo: ${error.code || 'Sin c√≥digo'}\n`;
                errorMessage += `‚Ä¢ EventId: ${eventId}\n`;
                errorMessage += `‚Ä¢ Jurado: ${currentJuror?.name || 'Sin nombre'}\n\n`;
                errorMessage += 'Revisa la consola (F12) para m√°s detalles.\n';
                errorMessage += 'Puedes intentar usar "üíæ GUARDAR VOTO" (bot√≥n verde) como alternativa.';
                
                alert(errorMessage);
            }
        };

        function updateStats() {
            const total = artists.length;
            
            // Debug detallado
            console.log('üìä ACTUALIZANDO ESTAD√çSTICAS:');
            console.log('  - Total artistas:', total);
            console.log('  - Votes object:', votes);
            console.log('  - CRITERIA.length:', CRITERIA.length);
            
            const voted = Object.keys(votes).filter(artistId => {
                const artistVotes = votes[artistId];
                const hasVotes = artistVotes && Object.keys(artistVotes).length === CRITERIA.length;
                console.log(`  - ${artistId}: ${Object.keys(artistVotes || {}).length}/${CRITERIA.length} votos (${hasVotes ? 'COMPLETO' : 'INCOMPLETO'})`);
                return hasVotes;
            }).length;
            
            const pending = total - voted;

            console.log('  - RESULTADO: Votados =', voted, ', Pendientes =', pending);

            document.getElementById('total-artists').textContent = total;
            document.getElementById('voted-count').textContent = voted;
            document.getElementById('pending-count').textContent = pending;
            
            console.log('‚úÖ Estad√≠sticas actualizadas en UI');
        }

        // === FUNCI√ìN PARA ACTUALIZAR BOT√ìN GLOBAL ===
        function updateGlobalSubmitButton() {
            const globalSection = document.getElementById('global-submit-section');
            const globalBtn = document.getElementById('global-submit-btn');
            const votingSummary = document.getElementById('voting-summary');
            const submitInfo = document.getElementById('submit-info');
            
            if (!globalSection || !globalBtn || !votingSummary || !submitInfo) {
                console.warn('‚ö†Ô∏è Elementos del bot√≥n global no encontrados');
                return;
            }
            
            // Mostrar la secci√≥n si hay artistas
            if (artists.length > 0) {
                globalSection.style.display = 'block';
            } else {
                globalSection.style.display = 'none';
                return;
            }
            
            // Calcular estad√≠sticas con debugging
            const totalArtists = artists.length;
            console.log('üî¢ CRITERIA.length:', CRITERIA.length);
            console.log('üìä Votes completo:', votes);
            
            const votedArtists = Object.keys(votes).filter(artistId => {
                const hasVotes = votes[artistId] && Object.keys(votes[artistId]).length > 0;
                console.log(`üé≠ Artista ${artistId}: ${hasVotes ? 'tiene votos' : 'sin votos'}`);
                return hasVotes;
            }).length;
            
            const completeVotes = Object.keys(votes).filter(artistId => {
                const voteCount = votes[artistId] ? Object.keys(votes[artistId]).length : 0;
                const isComplete = voteCount === CRITERIA.length;
                console.log(`üéØ Artista ${artistId}: ${voteCount}/${CRITERIA.length} criterios - ${isComplete ? 'COMPLETO' : 'PARCIAL'}`);
                return votes[artistId] && voteCount === CRITERIA.length;
            }).length;
            
            const isCompleteVotation = completeVotes === totalArtists;
            const hasAnyVotes = votedArtists > 0;
            
            // Actualizar resumen
            votingSummary.innerHTML = `
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-blue-400">${totalArtists}</div>
                        <div class="text-sm">Total Artistas</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold ${completeVotes > 0 ? 'text-green-400' : 'text-gray-400'}">${completeVotes}</div>
                        <div class="text-sm">Votos Completos</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold ${votedArtists > completeVotes ? 'text-yellow-400' : 'text-gray-400'}">${votedArtists - completeVotes}</div>
                        <div class="text-sm">Votos Parciales</div>
                    </div>
                </div>
            `;
            
            // Actualizar bot√≥n
            if (!hasAnyVotes) {
                globalBtn.className = 'btn text-2xl px-12 py-6 w-full max-w-md mx-auto opacity-50 cursor-not-allowed';
                globalBtn.style.background = '#666';
                globalBtn.disabled = true;
                globalBtn.innerHTML = '‚≠ï SIN VOTOS PARA ENVIAR';
                submitInfo.innerHTML = 'Vota al menos un artista para poder enviar';
            } else if (isCompleteVotation) {
                globalBtn.className = 'btn btn-green text-2xl px-12 py-6 w-full max-w-md mx-auto';
                globalBtn.disabled = false;
                globalBtn.innerHTML = 'üó≥Ô∏è ENVIAR VOTACI√ìN COMPLETA';
                submitInfo.innerHTML = '‚úÖ Todos los artistas han sido votados completamente';
            } else {
                globalBtn.className = 'btn text-2xl px-12 py-6 w-full max-w-md mx-auto';
                globalBtn.style.background = '#f59e0b'; // Amarillo/naranja para parcial
                globalBtn.disabled = false;
                globalBtn.innerHTML = 'üìù ENVIAR VOTACI√ìN PARCIAL';
                
                const unvotedCount = totalArtists - votedArtists;
                const partialCount = votedArtists - completeVotes;
                let infoText = '';
                
                if (unvotedCount > 0 && partialCount > 0) {
                    infoText = `‚ö†Ô∏è ${unvotedCount} sin votar, ${partialCount} parciales - Se enviar√° votaci√≥n parcial`;
                } else if (unvotedCount > 0) {
                    infoText = `‚ö†Ô∏è ${unvotedCount} artista(s) sin votar - Se enviar√° votaci√≥n parcial`;
                } else if (partialCount > 0) {
                    infoText = `‚ö†Ô∏è ${partialCount} artista(s) con votos parciales - Se enviar√° votaci√≥n parcial`;
                }
                
                submitInfo.innerHTML = infoText;
            }
            
            console.log('üîÑ Bot√≥n global actualizado:', {
                totalArtists,
                votedArtists,
                completeVotes,
                isCompleteVotation,
                hasAnyVotes
            });
        }

        // === FUNCI√ìN PARA ENVIAR TODAS LAS VOTACIONES ===
        window.submitAllVotes = async function() {
            if (!currentJuror || !currentJuror.id) {
                alert('‚ùå Error: No hay jurado autenticado');
                return;
            }
            
            const votedArtists = Object.keys(votes).filter(artistId => 
                votes[artistId] && Object.keys(votes[artistId]).length > 0
            );
            
            if (votedArtists.length === 0) {
                alert('‚ùå No hay votos para enviar');
                return;
            }
            
            const totalArtists = artists.length;
            const completeVotes = Object.keys(votes).filter(artistId => 
                votes[artistId] && Object.keys(votes[artistId]).length === CRITERIA.length
            ).length;
            
            const isPartialSubmission = completeVotes < totalArtists;
            
            // Confirmaci√≥n para votaci√≥n parcial
            if (isPartialSubmission) {
                const unvotedArtists = artists.filter(artist => 
                    !votes[artist.id] || Object.keys(votes[artist.id]).length === 0
                ).map(artist => artist.name);
                
                const partialArtists = artists.filter(artist => 
                    votes[artist.id] && 
                    Object.keys(votes[artist.id]).length > 0 && 
                    Object.keys(votes[artist.id]).length < CRITERIA.length
                ).map(artist => artist.name);
                
                let confirmMessage = `‚ö†Ô∏è ENV√çO DE VOTACI√ìN PARCIAL\n\n`;
                confirmMessage += `üìä RESUMEN:\n`;
                confirmMessage += `‚Ä¢ Total artistas: ${totalArtists}\n`;
                confirmMessage += `‚Ä¢ Votos completos: ${completeVotes}\n`;
                confirmMessage += `‚Ä¢ Votos parciales: ${partialArtists.length}\n`;
                confirmMessage += `‚Ä¢ Sin votar: ${unvotedArtists.length}\n\n`;
                
                if (unvotedArtists.length > 0) {
                    confirmMessage += `‚ùå ARTISTAS SIN VOTAR:\n‚Ä¢ ${unvotedArtists.join('\n‚Ä¢ ')}\n\n`;
                }
                
                if (partialArtists.length > 0) {
                    confirmMessage += `‚ö†Ô∏è ARTISTAS CON VOTOS PARCIALES:\n‚Ä¢ ${partialArtists.join('\n‚Ä¢ ')}\n\n`;
                }
                
                confirmMessage += `¬øDeseas continuar con el env√≠o?`;
                
                if (!confirm(confirmMessage)) {
                    console.log('üö´ Usuario cancel√≥ env√≠o parcial');
                    return;
                }
            }
            
            // Proceder con el env√≠o
            console.log('üöÄ Iniciando env√≠o masivo de votaciones...');
            const results = [];
            
            for (const artistId of votedArtists) {
                try {
                    console.log(`üì§ Enviando voto para artista: ${artistId}`);
                    await submitVote(artistId, true); // true = env√≠o silencioso
                    results.push({ artistId, success: true });
                } catch (error) {
                    console.error(`‚ùå Error enviando voto para ${artistId}:`, error);
                    results.push({ artistId, success: false, error: error.message });
                }
            }
            
            // Mostrar resultado final
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            let resultMessage = `üìä ENV√çO COMPLETADO\n\n`;
            resultMessage += `‚úÖ Exitosos: ${successful}/${votedArtists.length}\n`;
            if (failed > 0) {
                resultMessage += `‚ùå Fallidos: ${failed}\n\n`;
                resultMessage += `Artistas con errores:\n`;
                results.filter(r => !r.success).forEach(r => {
                    const artist = artists.find(a => a.id === r.artistId);
                    resultMessage += `‚Ä¢ ${artist?.name || r.artistId}: ${r.error}\n`;
                });
            } else {
                resultMessage += `\nüéâ ¬°Todas las votaciones se enviaron correctamente!`;
            }
            
            alert(resultMessage);
            
            // Actualizar UI
            renderArtists();
        };

        // === FUNCI√ìN PARA GENERAR LINK DEL REPORTE PARA ARTISTAS ===
        window.generateArtistReportLink = function() {
            const btn = document.getElementById('generate-artist-report-btn');
            const linkContainer = document.getElementById('artist-report-link');
            
            if (!eventId) {
                alert('‚ùå Error: No se ha seleccionado un evento');
                return;
            }
            
            // Cambiar bot√≥n a estado de carga
            btn.innerHTML = '‚è≥ Generando link...';
            btn.disabled = true;
            
            // Generar URL del reporte
            const baseUrl = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
            const reportUrl = `${baseUrl}reporte_por_gala.html?evento=${encodeURIComponent(eventId)}&source=artistas`;
            
            // Crear mensaje para WhatsApp
            const whatsappMessage = encodeURIComponent(
                `üé≠ *VYT-MUSIC - Evaluaciones de Jurados*\n\n` +
                `¬°Ya est√°n disponibles las evaluaciones de los jurados profesionales! üë®‚Äç‚öñÔ∏è\n\n` +
                `Pueden ver:\n` +
                `‚Ä¢ ‚úÖ Sus calificaciones por criterio\n` +
                `‚Ä¢ üí¨ Comentarios detallados de cada jurado\n` +
                `‚Ä¢ ü§ñ Feedback autom√°tico generado\n` +
                `‚Ä¢ üìä Comparativa con otros participantes\n\n` +
                `*Link del reporte:*\n${reportUrl}\n\n` +
                `üí° *Consejo:* Revisen especialmente los comentarios para mejorar en la pr√≥xima presentaci√≥n.\n\n` +
                `¬°Sigan as√≠! üåü`
            );
            
            const whatsappUrl = `https://wa.me/?text=${whatsappMessage}`;
            
            // Mostrar el link generado
            linkContainer.innerHTML = `
                <div class="bg-green-900/30 p-4 rounded-lg border border-green-500">
                    <p class="text-green-300 font-bold mb-2">‚úÖ Link generado exitosamente:</p>
                    <div class="bg-gray-800 p-3 rounded mb-3 break-all">
                        <a href="${reportUrl}" target="_blank" class="text-blue-300 hover:underline text-sm">
                            ${reportUrl}
                        </a>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="copyToClipboard('${reportUrl}')" 
                                class="btn btn-blue text-sm px-4 py-2 flex-1">
                            üìã Copiar Link
                        </button>
                        <a href="${whatsappUrl}" target="_blank" 
                           class="btn text-sm px-4 py-2 flex-1 bg-green-600 hover:bg-green-700 text-center">
                            üì± Enviar por WhatsApp
                        </a>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">
                        üí° El reporte se actualiza autom√°ticamente conforme se agregan m√°s evaluaciones
                    </p>
                </div>
            `;
            
            linkContainer.style.display = 'block';
            
            // Restaurar bot√≥n
            btn.innerHTML = 'üîó GENERAR LINK PARA ARTISTAS';
            btn.disabled = false;
            
            console.log('üîó Link del reporte generado:', reportUrl);
        };

        // === FUNCI√ìN AUXILIAR PARA COPIAR AL PORTAPAPELES ===
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Mostrar feedback visual
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ ¬°Copiado!';
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar:', err);
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                alert('Link copiado al portapapeles');
            });
        };

        // === NUEVAS FUNCIONES PARA MEJORAS ===

        // Funci√≥n para filtrar artistas por nombre
        function filterArtists() {
            const searchTerm = document.getElementById('artist-search').value.toLowerCase();
            const artistCards = document.querySelectorAll('.artist-card');
            
            artistCards.forEach(card => {
                const artistName = card.querySelector('h3').textContent.toLowerCase();
                if (artistName.includes(searchTerm)) {
                    card.style.display = 'block';
                    card.style.order = '0'; // Los que coinciden aparecen primero
                } else {
                    card.style.display = searchTerm === '' ? 'block' : 'none';
                    card.style.order = '1'; // Los que no coinciden van al final
                }
            });
        }

        // Funci√≥n para limpiar b√∫squeda
        function clearSearch() {
            document.getElementById('artist-search').value = '';
            filterArtists();
        }

        // Funci√≥n para mantener el filtro despu√©s de renderizar
        function preserveFilter() {
            const searchTerm = document.getElementById('artist-search').value;
            if (searchTerm) {
                setTimeout(() => {
                    filterArtists();
                }, 100);
            }
        }

        // === SISTEMA DE C√ÅLCULO EN TIEMPO REAL ===
        function setupRealtimeVotingListener() {
            console.log('üîÑ Configurando escucha en tiempo real para promedios de jurados...');
            console.log('üéØ EventId actual:', eventId);
            
            // Escuchar m√∫ltiples colecciones en tiempo real
            const collections = [
                'jury_evaluations',
                `events/${eventId}/jury_evaluations`, 
                `events/${eventId}/jury_votes`,
                `events/${eventId}/votes`
            ];
            
            collections.forEach(collectionPath => {
                console.log('üëÇ Escuchando colecci√≥n:', collectionPath);
                
                try {
                    const juryQuery = eventId ? 
                        query(collection(db, collectionPath), where('eventId', '==', eventId)) :
                        collection(db, collectionPath);
                    
                    onSnapshot(juryQuery, (snapshot) => {
                        console.log(`üìä [${collectionPath}] Documentos encontrados:`, snapshot.size);
                        processRealtimeSnapshot(snapshot, collectionPath);
                    }, (error) => {
                        console.warn(`‚ö†Ô∏è Error en colecci√≥n ${collectionPath}:`, error.message);
                    });
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error configurando ${collectionPath}:`, error.message);
                }
            });
        }
        
        function processRealtimeSnapshot(snapshot, collectionPath) {
            console.log(`üìä [${collectionPath}] Procesando ${snapshot.size} documentos...`);
            
            // Actualizar stats de debug
            debugStats.docs += snapshot.size;
            debugStats.collections++;
            
            // Procesar todos los votos de esta colecci√≥n
            snapshot.docs.forEach(doc => {
                const voteData = doc.data();
                console.log(`üìù [${collectionPath}] Voto encontrado:`, {
                    id: doc.id,
                    artistId: voteData.artistId,
                    jurorName: voteData.jurorName,
                    eventId: voteData.eventId,
                    timestamp: voteData.timestamp
                });
                
                // Solo procesar si coincide el evento o no hay filtro de evento
                if (!eventId || voteData.eventId === eventId || collectionPath.includes(eventId)) {
                    const artistId = voteData.artistId;
                    const jurorName = voteData.jurorName || voteData.userName || 'Jurado An√≥nimo';
                    
                    if (!allJuryVotes.has(artistId)) {
                        allJuryVotes.set(artistId, []);
                    }
                    
                    allJuryVotes.get(artistId).push({
                        ...voteData,
                        source: collectionPath
                    });
                    
                    // Rastrear jurados para debug
                    if (voteData.jurorName) debugStats.jurors.add(voteData.jurorName);
                    if (voteData.userName) debugStats.jurors.add(voteData.userName);
                }
            });
            
            // Recalcular todo despu√©s de procesar todas las colecciones
            debounceRecalculate();
        }
        
        // Debounce para evitar c√°lculos excesivos
        let recalculateTimer;
        function debounceRecalculate() {
            if (isProcessing) return;
            
            clearTimeout(recalculateTimer);
            recalculateTimer = setTimeout(() => {
                recalculateAndUpdate();
            }, 1000);
        }
        
        function recalculateAndUpdate() {
            if (isProcessing) return;
            isProcessing = true;
            
            console.log('üîÑ Recalculando promedios y actividad...');
            console.log('üìä Total de votos acumulados:', allJuryVotes.size);
            allJuryVotes.forEach((votes, artistId) => {
                console.log(`üé≠ Artista ${artistId}: ${votes.length} votos`);
            });
            
            // Resetear datos calculados
            realTimeAverages.clear();
            const juryActivity = new Map();
            
            // Procesar todos los votos acumulados
            allJuryVotes.forEach((votes, artistId) => {
                votes.forEach(voteData => {
                    const jurorName = voteData.jurorName || voteData.userName || 'Jurado An√≥nimo';
                    
                    // Rastrear actividad del jurado
                    if (!juryActivity.has(jurorName)) {
                        juryActivity.set(jurorName, {
                            lastVote: new Date(voteData.timestamp || Date.now()),
                            artistsVoted: new Set(),
                            totalVotes: 0,
                            averageGiven: 0,
                            sources: new Set()
                        });
                    }
                    
                    const activity = juryActivity.get(jurorName);
                    activity.artistsVoted.add(artistId);
                    activity.totalVotes++;
                    activity.sources.add(voteData.source);
                    
                    if (voteData.timestamp) {
                        const voteTime = new Date(voteData.timestamp);
                        if (voteTime > activity.lastVote) {
                            activity.lastVote = voteTime;
                        }
                    }
                    
                    // Calcular promedio que da este jurado
                    if (voteData.scores) {
                        const voteScore = Object.values(voteData.scores).reduce((sum, score) => sum + score, 0) / Object.keys(voteData.scores).length;
                        activity.averageGiven = voteScore;
                    } else if (voteData.totalScore) {
                        activity.averageGiven = voteData.totalScore;
                    }
                });
                
                // Calcular promedio por artista
                const average = calculateAverageScore(votes);
                realTimeAverages.set(artistId, average);
            });
            
            // Actualizar interfaz
            updateJuryActivityDisplay(juryActivity);
            updateRealtimeAveragesDisplay();
            updateDebugInfo();
            
            console.log('‚úÖ Rec√°lculo completado:');
            console.log('üìä Promedios por artista:', Object.fromEntries(realTimeAverages));
            console.log('üë• Jurados activos:', juryActivity.size);
            console.log('üë• Detalle de jurados:', Object.fromEntries(juryActivity));
            console.log('üîç Debug stats:', debugStats);
            
            isProcessing = false;
        }
        
        function updateJuryActivityDisplay(juryActivity) {
            const activityList = document.getElementById('jury-activity-list');
            if (!activityList) return;
            
            // Actualizar t√≠tulo del panel con n√∫mero correcto
            const panelTitle = document.querySelector('#jury-activity-panel h3');
            if (panelTitle) {
                panelTitle.textContent = `üë• Actividad de Jurados en Tiempo Real (${juryActivity.size} activos)`;
            }
            
            if (juryActivity.size === 0) {
                activityList.innerHTML = '<p class="text-center text-gray-400">No hay actividad de jurados a√∫n</p>';
                return;
            }
            
            let html = '';
            juryActivity.forEach((activity, jurorName) => {
                const isCurrentUser = jurorName === currentJuror?.name;
                const timeAgo = getTimeAgo(activity.lastVote);
                const sourcesInfo = activity.sources ? Array.from(activity.sources).join(', ') : '';
                
                html += `
                    <div class="flex justify-between items-center p-2 ${isCurrentUser ? 'bg-blue-800 bg-opacity-50' : 'bg-gray-800 bg-opacity-50'} rounded">
                        <div>
                            <span class="font-bold ${isCurrentUser ? 'text-blue-300' : 'text-white'}">
                                ${jurorName} ${isCurrentUser ? '(T√∫)' : ''}
                            </span>
                            <div class="text-xs text-gray-400">
                                ${activity.artistsVoted.size} artista${activity.artistsVoted.size !== 1 ? 's' : ''} evaluado${activity.artistsVoted.size !== 1 ? 's' : ''} ‚Ä¢ ${activity.totalVotes} voto${activity.totalVotes !== 1 ? 's' : ''}
                            </div>
                            ${sourcesInfo ? `<div class="text-xs text-purple-400">Fuente: ${sourcesInfo}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-green-300">
                                ~${activity.averageGiven.toFixed(1)} pts prom.
                            </div>
                            <div class="text-xs text-gray-400">
                                ${timeAgo}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityList.innerHTML = html;
            
            console.log(`‚úÖ Panel actualizado: ${juryActivity.size} jurados activos mostrados`);
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Ahora mismo';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `Hace ${diffHours}h`;
            return 'Hace m√°s de 1 d√≠a';
        }
        
        function calculateAverageScore(votes) {
            if (votes.length === 0) return 0;
            
            let totalSum = 0;
            let totalVotes = 0;
            
            votes.forEach(vote => {
                if (vote.scores) {
                    const voteAverage = Object.values(vote.scores).reduce((sum, score) => sum + score, 0) / Object.keys(vote.scores).length;
                    totalSum += voteAverage;
                    totalVotes++;
                } else if (vote.totalScore) {
                    totalSum += vote.totalScore;
                    totalVotes++;
                }
            });
            
            return totalVotes > 0 ? (totalSum / totalVotes) : 0;
        }
        
        function updateRealtimeAveragesDisplay() {
            if (!showRealtimeAverages) return;
            
            artists.forEach(artist => {
                const average = realTimeAverages.get(artist.id) || 0;
                const juryCount = allJuryVotes.get(artist.id)?.length || 0;
                
                // Actualizar en vista lista
                const listCard = document.querySelector(`[data-artist-id="${artist.id}"]`);
                if (listCard) {
                    let averageDisplay = listCard.querySelector('.realtime-average');
                    if (!averageDisplay) {
                        averageDisplay = document.createElement('div');
                        averageDisplay.className = 'realtime-average bg-blue-800 bg-opacity-50 p-3 rounded-lg mt-3 border border-blue-500';
                        listCard.querySelector('.artist-card').appendChild(averageDisplay);
                    }
                    
                    averageDisplay.style.display = 'block';
                    
                    if (juryCount > 0) {
                        averageDisplay.innerHTML = `
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-300">üìä ${average.toFixed(1)} pts</div>
                                <div class="text-sm text-gray-300">Promedio de ${juryCount} jurado${juryCount !== 1 ? 's' : ''}</div>
                                <div class="text-xs text-yellow-300 mt-1">‚è±Ô∏è Actualizado en tiempo real</div>
                                <button onclick="showComparativeAnalysis('${artist.id}')" 
                                        class="mt-2 px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded">
                                    üîç Comparar con mi voto
                                </button>
                            </div>
                        `;
                    } else {
                        averageDisplay.innerHTML = `
                            <div class="text-center text-gray-500">
                                <div class="text-lg">üìä Sin votos a√∫n</div>
                                <div class="text-xs">Esperando evaluaciones...</div>
                            </div>
                        `;
                    }
                }
            });
        }
        
        // Funci√≥n para obtener promedio actual de un artista
        window.getCurrentAverage = function(artistId) {
            return realTimeAverages.get(artistId) || 0;
        };
        
        // Funci√≥n para obtener n√∫mero de jurados que han votado
        window.getJuryCount = function(artistId) {
            return allJuryVotes.get(artistId)?.length || 0;
        };
        
        // === FUNCI√ìN PARA FINALIZAR EVALUACI√ìN ===
        window.finalizarEvaluacion = async function() {
            if (!currentModalArtist) return;
            
            const currentVotes = votes[currentModalArtist.id] || {};
            const hasAllVotes = CRITERIA.every(criteria => 
                currentVotes[criteria.id] !== undefined && currentVotes[criteria.id] !== null
            );
            
            if (!hasAllVotes) {
                alert('‚ùå Completa todos los criterios antes de finalizar la evaluaci√≥n');
                return;
            }
            
            const confirmar = confirm(`üéØ FINALIZAR EVALUACI√ìN\n\n¬øEst√°s seguro de finalizar la evaluaci√≥n de "${currentModalArtist.name}"?\n\nEsto har√°:\n‚Ä¢ Generar feedback autom√°tico con IA\n‚Ä¢ Guardar la votaci√≥n en Firebase\n‚Ä¢ Mostrar resumen completo\n\n‚úÖ ¬øContinuar?`);
            
            if (!confirmar) return;
            
            // Generar feedback autom√°ticamente
            await generateAndShowModalFeedback(currentVotes);
        };
        
        // === FUNCI√ìN PARA VER VOTOS DE OTROS JURADOS ===
        window.debugArtistVotes = async function(artistId) {
            console.log(`ÔøΩÔ∏è === CONSULTANDO VOTOS DE OTROS JURADOS: ${artistId} ===`);
            
            if (!artistId) {
                artistId = prompt('Ingresa el ID del artista (ej: damian, juan, etc.)');
                if (!artistId) return;
            }
            
            const container = document.getElementById(`other-jurors-${artistId}`);
            if (container) {
                container.innerHTML = `
                    <div class="text-center text-blue-400">
                        <p>ÔøΩÔ∏è Consultando votos de otros jurados...</p>
                        <p class="text-xs mt-1">Un momento por favor</p>
                    </div>
                `;
            }
            
            // Ejecutar la funci√≥n de actualizaci√≥n
            await updateOtherJurorsActivity(artistId);
            
            console.log('‚úÖ Consulta de votos completada');
        };
        
        // Alias m√°s profesional
        window.verVotosJurados = window.debugArtistVotes;
        
        // === TRANSPARENCIA ENTRE JURADOS ===
        async function updateOtherJurorsActivity(artistId) {
            const container = document.getElementById(`other-jurors-${artistId}`);
            if (!container) return;
            
            console.log(`ÔøΩÔ∏è Consultando evaluaciones de otros jurados para: ${artistId}`);
            console.log(`üë§ Jurado actual (excluir): ${currentJuror?.name}`);
            
            try {
                // Buscar votos de ESTE artista espec√≠fico en TODAS las colecciones posibles
                const collections = [
                    'jury_evaluations',
                    'jury_users', 
                    `events/${eventId}/jury_evaluations`, 
                    `events/${eventId}/jury_votes`,
                    `events/${eventId}/votes`
                ];
                
                let votesForThisArtist = [];
                
                for (const collectionPath of collections) {
                    console.log(`üîç Buscando en colecci√≥n: ${collectionPath}`);
                    
                    try {
                        // Primero buscar solo por artistId (m√°s amplio)
                        const q1 = query(
                            collection(db, collectionPath),
                            where('artistId', '==', artistId)
                        );
                        const snapshot1 = await getDocs(q1);
                        
                        console.log(`üìä [${collectionPath}] Por artistId: ${snapshot1.size} docs`);
                        
                        snapshot1.docs.forEach(doc => {
                            const voteData = doc.data();
                            console.log(`üìù Voto encontrado:`, {
                                docId: doc.id,
                                jurorName: voteData.jurorName,
                                artistId: voteData.artistId,
                                eventId: voteData.eventId,
                                scores: voteData.scores ? 'S√≠' : 'No'
                            });
                            
                            if (voteData.jurorName && voteData.jurorName !== currentJuror?.name) {
                                votesForThisArtist.push({
                                    ...voteData,
                                    source: collectionPath
                                });
                            }
                        });
                        
                        // Tambi√©n buscar con eventId si est√° disponible
                        if (eventId) {
                            const q2 = query(
                                collection(db, collectionPath),
                                where('eventId', '==', eventId),
                                where('artistId', '==', artistId)
                            );
                            const snapshot2 = await getDocs(q2);
                            
                            console.log(`üìä [${collectionPath}] Por eventId+artistId: ${snapshot2.size} docs`);
                            
                            snapshot2.docs.forEach(doc => {
                                const voteData = doc.data();
                                if (voteData.jurorName && voteData.jurorName !== currentJuror?.name) {
                                    // Evitar duplicados
                                    const exists = votesForThisArtist.some(v => v.jurorName === voteData.jurorName && v.artistId === voteData.artistId);
                                    if (!exists) {
                                        votesForThisArtist.push({
                                            ...voteData,
                                            source: collectionPath
                                        });
                                    }
                                }
                            });
                        }
                        
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error buscando en ${collectionPath}:`, error.message);
                    }
                }
                
                console.log(`‚úÖ TOTAL evaluaciones encontradas para ${artistId}:`, votesForThisArtist.length);
                console.log(`üìã Detalles de evaluaciones:`, votesForThisArtist);
                
                // Mostrar informaci√≥n de otros jurados
                if (votesForThisArtist.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400">
                            <p>ü§î Ning√∫n otro jurado ha evaluado este artista a√∫n</p>
                            <p class="text-xs mt-1">Ser√°s el primero en dar tu evaluaci√≥n</p>
                        </div>
                    `;
                } else {
                    let html = `<div class="text-xs text-green-400 mb-2">‚úÖ ${votesForThisArtist.length} evaluacion${votesForThisArtist.length !== 1 ? 'es' : ''} de otros jurados</div>`;
                    
                    votesForThisArtist.forEach(vote => {
                        const totalScore = vote.totalScore || calculateScoreFromCriteria(vote.scores) || 0;
                        const timeAgo = vote.timestamp ? getTimeAgo(new Date(vote.timestamp)) : 'Tiempo desconocido';
                        
                        html += `
                            <div class="flex justify-between items-center p-3 bg-blue-800 bg-opacity-50 rounded mb-2">
                                <div>
                                    <div class="font-bold text-blue-300">${vote.jurorName}</div>
                                    <div class="text-xs text-gray-400">${timeAgo}</div>
                                    <div class="text-xs text-purple-400">Fuente: ${vote.source}</div>
                                    ${vote.judgeComments ? `<div class="text-xs text-yellow-300 mt-1">"${vote.judgeComments}"</div>` : ''}
                                    ${vote.scores ? `<div class="text-xs text-gray-300">Criterios: ${Object.keys(vote.scores).length}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-300">${totalScore.toFixed(1)} pts</div>
                                    <div class="text-xs text-gray-400">Su evaluaci√≥n</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error actualizando actividad de otros jurados:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400">
                        <p>‚ùå Error cargando actividad de otros jurados</p>
                        <p class="text-xs mt-1">${error.message}</p>
                    </div>
                `;
            }
            
            // FORZAR ACTUALIZACI√ìN DEL DOM
            if (container.innerHTML.includes('Cargando actividad')) {
                console.warn('üö® Panel sigue en "Cargando", forzando actualizaci√≥n...');
                container.innerHTML = `
                    <div class="text-center text-yellow-400">
                        <p>üîÑ Forzando actualizaci√≥n...</p>
                        <p class="text-xs mt-1">Revisa consola para logs detallados</p>
                    </div>
                `;
            }
        }
        
        function calculateScoreFromCriteria(scores) {
            if (!scores) return 0;
            const values = Object.values(scores);
            return values.reduce((sum, score) => sum + score, 0) / values.length;
        }
        
        // === FUNCIONES DE DEBUG ===
        let debugStats = {
            eventId: '',
            collections: 0,
            docs: 0,
            jurors: new Set()
        };
        
        function updateDebugInfo() {
            document.getElementById('debug-eventid').textContent = eventId || 'No definido';
            document.getElementById('debug-collections').textContent = debugStats.collections;
            document.getElementById('debug-docs').textContent = debugStats.docs;
            document.getElementById('debug-jurors').textContent = debugStats.jurors.size;
        }
        
        window.forceRefreshDebug = async function() {
            console.log('üîç FORZANDO B√öSQUEDA MANUAL DE JURADOS...');
            debugStats = {
                eventId: eventId,
                collections: 0,
                docs: 0,
                jurors: new Set()
            };
            
            const collections = [
                'jury_evaluations',
                'jury_users',
                `events/${eventId}/jury_evaluations`, 
                `events/${eventId}/jury_votes`,
                `events/${eventId}/votes`
            ];
            
            for (const collectionPath of collections) {
                debugStats.collections++;
                console.log(`üîç Buscando en: ${collectionPath}`);
                
                try {
                    const snapshot = await getDocs(collection(db, collectionPath));
                    console.log(`üìä [${collectionPath}] Encontrados: ${snapshot.size} documentos`);
                    debugStats.docs += snapshot.size;
                    
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        console.log(`üìù [${collectionPath}] Doc:`, {
                            id: doc.id,
                            jurorName: data.jurorName || data.name,
                            eventId: data.eventId,
                            artistId: data.artistId
                        });
                        
                        if (data.jurorName) debugStats.jurors.add(data.jurorName);
                        if (data.name) debugStats.jurors.add(data.name);
                    });
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error en ${collectionPath}:`, error.message);
                }
            }
            
            updateDebugInfo();
            console.log('‚úÖ B√∫squeda manual completada:', debugStats);
        };
        
        // Control de visualizaci√≥n de promedios en tiempo real
        let showRealtimeAverages = true; // Activado por defecto
        
        window.toggleRealtimeAverages = function() {
            showRealtimeAverages = !showRealtimeAverages;
            const btn = document.getElementById('toggle-realtime-btn');
            const info = document.getElementById('realtime-info');
            
            if (showRealtimeAverages) {
                btn.textContent = 'üìä OCULTAR PROMEDIOS DETALLADOS';
                btn.className = 'btn text-sm px-6 py-2 w-full bg-red-600 hover:bg-red-700';
                info.style.display = 'block';
                updateRealtimeAveragesDisplay();
            } else {
                btn.textContent = 'üìä MOSTRAR PROMEDIOS DETALLADOS';
                btn.className = 'btn text-sm px-6 py-2 w-full bg-green-600 hover:bg-green-700';
                info.style.display = 'none';
                hideRealtimeAverages();
            }
        };
        
        // Inicializar bot√≥n en el estado correcto
        window.initializeRealtimeButton = function() {
            const btn = document.getElementById('toggle-realtime-btn');
            const info = document.getElementById('realtime-info');
            
            if (showRealtimeAverages) {
                btn.textContent = 'üìä OCULTAR PROMEDIOS DETALLADOS';
                btn.className = 'btn text-sm px-6 py-2 w-full bg-red-600 hover:bg-red-700';
                info.style.display = 'block';
            }
        };
        
        function hideRealtimeAverages() {
            document.querySelectorAll('.realtime-average').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        // Funci√≥n mejorada para mostrar feedback individual vs grupal
        window.showComparativeAnalysis = function(artistId) {
            const myVote = votes[artistId];
            const groupAverage = realTimeAverages.get(artistId) || 0;
            const juryCount = allJuryVotes.get(artistId)?.length || 0;
            
            if (!myVote || Object.keys(myVote).length === 0) {
                alert('‚ö†Ô∏è Primero eval√∫a a este artista para ver el an√°lisis comparativo');
                return;
            }
            
            const myAverage = Object.values(myVote).reduce((sum, score) => sum + score, 0) / Object.keys(myVote).length;
            const difference = myAverage - groupAverage;
            
            let message = `üìä AN√ÅLISIS COMPARATIVO\n\n`;
            message += `üë§ Tu evaluaci√≥n: ${myAverage.toFixed(1)} pts\n`;
            message += `üë• Promedio grupal: ${groupAverage.toFixed(1)} pts (${juryCount} jurado${juryCount !== 1 ? 's' : ''})\n`;
            message += `üìà Diferencia: ${difference > 0 ? '+' : ''}${difference.toFixed(1)} pts\n\n`;
            
            if (Math.abs(difference) < 5) {
                message += '‚úÖ Tu evaluaci√≥n est√° alineada con el grupo';
            } else if (difference > 0) {
                message += '‚¨ÜÔ∏è Evaluaste m√°s alto que el promedio grupal';
            } else {
                message += '‚¨áÔ∏è Evaluaste m√°s bajo que el promedio grupal';
            }
            
            alert(message);
        };

        // Funci√≥n para limpiar votos de un artista (LOCAL + FIREBASE)
        window.clearVote = async function(artistId) {
            const artist = artists.find(a => a.id === artistId);
            const confirmation = confirm(`üóëÔ∏è BORRAR VOTO COMPLETO\n\n¬øEst√°s seguro de borrar TODOS los votos para "${artist?.name || artistId}"?\n\nEsto eliminar√°:\n‚Ä¢ Los votos locales\n‚Ä¢ Los votos guardados en Firebase\n\nEsta acci√≥n NO se puede deshacer.`);
            
            if (!confirmation) return;
            
            try {
                console.log(`üóëÔ∏è Borrando voto para: ${artistId}`);
                
                // Borrar localmente
                delete votes[artistId];
                console.log('‚úÖ Voto borrado localmente');
                
                // Intentar borrar de Firebase en todas las colecciones posibles
                const docId = `${currentJuror.id}_${artistId}`;
                let deletedCount = 0;
                
                const collections = [
                    `events/${eventId}/jury_evaluations`,
                    `events/${eventId}/jury_votes`, 
                    `events/${eventId}/votes`
                ];
                
                for (const collectionPath of collections) {
                    try {
                        await deleteDoc(doc(db, collectionPath, docId));
                        console.log(`‚úÖ Borrado de ${collectionPath}`);
                        deletedCount++;
                    } catch (error) {
                        console.log(`‚ö†Ô∏è No encontrado en ${collectionPath}:`, error.message);
                    }
                }
                
                // Actualizar interfaz
                renderArtists();
                preserveFilter();
                updateStats();
                
                alert(`‚úÖ VOTO BORRADO EXITOSAMENTE\n\n‚Ä¢ Borrado localmente: ‚úÖ\n‚Ä¢ Borrado de Firebase: ${deletedCount} colecciones\n\nPuedes votar nuevamente para "${artist?.name || artistId}"`);
                
            } catch (error) {
                console.error('‚ùå Error borrando voto:', error);
                alert(`‚ùå Error al borrar:\n${error.message}\n\nEl voto local se borr√≥, pero puede quedar en Firebase.`);
                
                // Actualizar interfaz aunque haya error
                renderArtists();
                preserveFilter();
                updateStats();
            }
        };

        // Funci√≥n para forzar guardado cuando hay problemas de red
        window.forceSubmitVote = async function(artistId) {
            console.log('üöÄ FORZANDO GUARDADO para:', artistId);
            
            const artist = artists.find(a => a.id === artistId);
            const artistVotes = votes[artistId];
            
            if (!currentJuror || !currentJuror.id) {
                alert('‚ùå Error: No hay jurado autenticado');
                return;
            }
            
            if (!artistVotes || Object.keys(artistVotes).length === 0) {
                alert('‚ùå No hay votos para guardar');
                return;
            }

            const average = Object.values(artistVotes).reduce((sum, val) => sum + val, 0) / CRITERIA.length;

            // ü§ñ GENERAR FEEDBACK AUTOM√ÅTICO
            const autoFeedback = generateFallbackFeedback(artistVotes);

            const voteData = {
                eventId: eventId,
                artistId: artistId,
                artistName: artist.name,
                jurorName: currentJuror.displayName || currentJuror.name,
                jurorId: currentJuror.id,
                jurorType: currentJuror.type || 'individual',
                jurorTypeLabel: currentJuror.typeLabel || 'Jurado',
                jurorAdditional: currentJuror.additional || '',
                isAnonymous: currentJuror.isAnonymous || false,
                scores: artistVotes,
                score: average,
                timestamp: new Date().toISOString(),
                forceSubmitted: true, // Marcar como forzado
                loginTime: currentJuror.loginTime || '',
                // ‚ûï FEEDBACK AUTOM√ÅTICO GENERADO
                autoFeedback: autoFeedback,
                feedbackGenerated: true,
                feedbackTimestamp: new Date().toISOString(),
                // ‚ûï NUEVOS CAMPOS ADICIONALES PARA SEGUIMIENTO COMPLETO
                songPerformed: String(document.getElementById('modal-song-performed')?.value || ''),
                judgeComments: String(getArtistComments(artistId)),
                additionalNotes: String(document.getElementById('modal-additional-notes')?.value || '')
            };

            // Intentar m√∫ltiples m√©todos de guardado con rutas correctas del evento
            let success = false;
            const attempts = [
                () => setDoc(doc(db, `events/${eventId}/jury_evaluations`, `${currentJuror.id}_${artistId}`), voteData),
                () => setDoc(doc(db, `events/${eventId}/jury_votes`, `${currentJuror.id}_${artistId}`), voteData),
                () => setDoc(doc(db, `events/${eventId}/votes`, `${currentJuror.id}_${artistId}_${Date.now()}`), voteData)
            ];

            for (let i = 0; i < attempts.length && !success; i++) {
                try {
                    console.log(`üîÑ Intento ${i + 1} de guardado...`);
                    await attempts[i]();
                    success = true;
                    console.log(`‚úÖ Guardado exitoso en intento ${i + 1}`);
                    alert(`‚úÖ ¬°VOTO FORZADO GUARDADO!\n${artist.name}: ${average.toFixed(1)} puntos\n\nüéØ Ahora deber√≠a aparecer en los reportes`);
                } catch (error) {
                    console.error(`‚ùå Intento ${i + 1} fall√≥:`, error);
                    if (i === attempts.length - 1) {
                        alert(`‚ùå Error: No se pudo guardar despu√©s de ${attempts.length} intentos\n\n${error.message}`);
                    }
                }
            }
        };

        // Funci√≥n para guardar votaci√≥n parcial
        window.savePartialVote = async function(artistId) {
            if (!currentJuror.id) {
                alert('‚ùå Error: No hay jurado autenticado');
                return;
            }

            const artist = artists.find(a => a.id === artistId);
            const artistVotes = votes[artistId] || {};
            
            if (Object.keys(artistVotes).length === 0) {
                alert('‚ùå No hay puntuaciones para guardar');
                return;
            }

            try {
                // Usar la misma estructura que submitVote pero permitir parcial
                const voteData = {
                    eventId: eventId,
                    artistId: artistId,
                    artistName: artist.name,
                    jurorName: currentJuror.name,
                    jurorId: currentJuror.id,
                    scores: artistVotes,
                    isPartial: true, // Marcar como parcial
                    completedCriteria: Object.keys(artistVotes).length,
                    totalCriteria: CRITERIA.length,
                    timestamp: new Date().toISOString()
                };

                // Usar colecci√≥n jury_evaluations en lugar de jury_votes
                await setDoc(doc(db, 'jury_evaluations', `${currentJuror.id}_${artistId}_partial`), voteData);
                
                console.log('üíæ Votaci√≥n parcial guardada exitosamente');
                alert(`üíæ Votaci√≥n parcial guardada para ${artist.name}\nCriterios completados: ${Object.keys(artistVotes).length}/${CRITERIA.length}\n\n‚ú® Puedes continuar despu√©s desde donde lo dejaste`);
                
            } catch (error) {
                console.error('‚ùå Error guardando votaci√≥n parcial:', error);
                alert('‚ùå Error al guardar votaci√≥n parcial: ' + error.message);
            }
        };

        // Hacer funci√≥n global
        window.filterArtists = filterArtists;
        window.clearSearch = clearSearch;

        // === NUEVO SISTEMA DE GRID Y MODAL ===
        let currentViewMode = 'list'; // 'list' o 'grid'
        let currentModalArtist = null;

        // Funci√≥n para cambiar modo de vista
        window.switchViewMode = function(mode) {
            currentViewMode = mode;
            
            // Actualizar botones
            const listBtn = document.getElementById('btn-list-mode');
            const gridBtn = document.getElementById('btn-grid-mode');
            
            if (listBtn && gridBtn) {
                listBtn.className = mode === 'list' ? 'btn btn-primary' : 'btn btn-yellow';
                gridBtn.className = mode === 'grid' ? 'btn btn-primary' : 'btn btn-yellow';
            }
            
            // Mostrar/ocultar vistas
            const artistsList = document.getElementById('artists-list');
            const artistsGrid = document.getElementById('artists-grid');
            
            if (mode === 'list') {
                if (artistsList) artistsList.style.display = 'block';
                if (artistsGrid) artistsGrid.style.display = 'none';
            } else {
                if (artistsList) artistsList.style.display = 'none';
                if (artistsGrid) {
                    artistsGrid.style.display = 'grid';
                    renderArtistsGrid();
                }
            }
        };

        // Funci√≥n para renderizar artistas en grid
        function renderArtistsGrid() {
            const gridContainer = document.getElementById('artists-grid');
            gridContainer.innerHTML = '';

            artists.forEach(artist => {
                const isVoted = votes[artist.id] && Object.keys(votes[artist.id]).length > 0;
                const average = isVoted ? calculateAverage(votes[artist.id]) : 0;

                const artistCard = document.createElement('div');
                artistCard.className = 'artist-grid-card p-4 text-center';
                artistCard.onclick = () => openVotingModal(artist);

                artistCard.innerHTML = `
                    <div class="relative">
                        <img src="${artist.foto || artist.photoURL || 'https://via.placeholder.com/150x150/1e3a8a/ffffff?text=' + encodeURIComponent(artist.name.charAt(0))}" 
                             alt="${artist.name}" 
                             class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-white">
                        ${isVoted ? `
                            <div class="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                ‚úì
                            </div>
                        ` : ''}
                    </div>
                    <h3 class="font-bold text-lg">${artist.name}</h3>
                    ${isVoted ? `
                        <p class="text-green-300 text-sm">Votado: ${average.toFixed(1)} pts</p>
                    ` : `
                        <p class="text-yellow-300 text-sm">Pendiente de votar</p>
                    `}
                `;

                gridContainer.appendChild(artistCard);
            });
        }

        // Funci√≥n para abrir modal de votaci√≥n
        window.openVotingModal = function(artist) {
            currentModalArtist = artist;
            
            // Asegurar que el modal tenga el data-artist-id para identificaci√≥n
            const modal = document.getElementById('voting-modal');
            if (modal) {
                modal.setAttribute('data-artist-id', artist.id);
                console.log(`üéØ Modal configurado con artist-id: ${artist.id}`);
            }
            
            // Llenar informaci√≥n del artista
            document.getElementById('modal-artist-name').textContent = artist.name;
            document.getElementById('modal-artist-info').textContent = `Participante del certamen`;
            document.getElementById('modal-artist-photo').src = artist.foto || artist.photoURL || 
                'https://via.placeholder.com/80x80/1e3a8a/ffffff?text=' + encodeURIComponent(artist.name.charAt(0));

            // Cargar datos adicionales existentes
            const existingData = votes[artist.id] || {};
            document.getElementById('modal-song-performed').value = existingData.songPerformed || '';
            document.getElementById('modal-judge-comments').value = existingData.judgeComments || '';
            document.getElementById('modal-additional-notes').value = existingData.additionalNotes || '';
            
            // === ACTUALIZAR ACTIVIDAD DE OTROS JURADOS ===
            setTimeout(() => {
                console.log(`üîç Modal abierto para ${artist.name} (ID: ${artist.id})`);
                updateOtherJurorsActivity(artist.id);
            }, 500);
            
            // Renderizar categor√≠as
            renderModalCategories(artist);
            
            // Generar feedback si ya hay votos completos
            const artistVotes = votes[artist.id] || {};
            const hasAllVotes = CRITERIA.every(criteria => 
                artistVotes[criteria.id] !== undefined && artistVotes[criteria.id] !== null
            );
            if (hasAllVotes) {
                generateAndShowModalFeedback(artistVotes).catch(console.error);
            }
            
            // Mostrar modal
            document.getElementById('voting-modal').classList.remove('hidden');
        };

        // Funci√≥n para cerrar modal
        window.closeVotingModal = function() {
            document.getElementById('voting-modal').classList.add('hidden');
            // Limpiar campos adicionales
            document.getElementById('modal-song-performed').value = '';
            document.getElementById('modal-judge-comments').value = '';
            document.getElementById('modal-additional-notes').value = '';
            currentModalArtist = null;
        };

        // Funci√≥n para renderizar categor√≠as en el modal
        function renderModalCategories(artist) {
            const container = document.getElementById('modal-categories');
            container.innerHTML = '';

            const currentVotes = votes[artist.id] || {};

            CRITERIA.forEach(criteria => {
                const currentValue = currentVotes[criteria.id] || 50;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'card p-4';
                categoryDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-bold text-white">${criteria.name}</label>
                        <div class="flex items-center gap-2">
                            <span id="modal-${criteria.id}-display" class="text-xl font-bold text-blue-300">${currentValue}</span>
                            <span id="modal-${criteria.id}-label" class="px-2 py-1 rounded text-xs font-bold"></span>
                        </div>
                    </div>
                    <input type="range" 
                           id="modal-${criteria.id}-slider" 
                           class="category-slider" 
                           min="25" 
                           max="100" 
                           value="${currentValue}"
                           oninput="updateModalScore('${criteria.id}', this.value)">
                    <div class="flex justify-between text-xs text-gray-300 mt-1">
                        <span>MALO</span>
                        <span>MEDIOCRE</span>
                        <span>BUENO</span>
                        <span>MUY BUENO</span>
                        <span>EXCELENTE</span>
                    </div>
                `;

                container.appendChild(categoryDiv);
                
                // Inicializar la etiqueta visual
                const label = getScoreLabel(currentValue);
                const labelElement = document.getElementById(`modal-${criteria.id}-label`);
                if (labelElement) {
                    labelElement.textContent = label.text;
                    labelElement.className = `px-2 py-1 rounded text-xs font-bold ${label.color} ${label.bg}`;
                }
            });

            updateModalTotal();
        }

        // FUNCI√ìN PARA CONVERTIR PUNTAJE A TEXTO VISUAL
        function getScoreLabel(score) {
            const scoreInt = parseInt(score);
            if (scoreInt >= 90) return { text: 'EXCELENTE', color: 'text-blue-300', bg: 'bg-blue-600' };
            if (scoreInt >= 70) return { text: 'MUY BUENO', color: 'text-green-300', bg: 'bg-green-600' };
            if (scoreInt >= 50) return { text: 'BUENO', color: 'text-yellow-300', bg: 'bg-yellow-600' };
            if (scoreInt >= 35) return { text: 'MEDIOCRE', color: 'text-orange-300', bg: 'bg-orange-600' };
            return { text: 'MALO', color: 'text-red-300', bg: 'bg-red-600' };
        }

        // FUNCI√ìN PARA CALCULAR PROMEDIO DE VOTOS
        function calculateAverage(artistVotes) {
            if (!artistVotes || typeof artistVotes !== 'object') {
                return 0;
            }
            
            const scores = Object.values(artistVotes).filter(score => 
                typeof score === 'number' && !isNaN(score)
            );
            
            if (scores.length === 0) {
                return 0;
            }
            
            const total = scores.reduce((sum, score) => sum + score, 0);
            return total / scores.length;
        }

        // Funci√≥n para actualizar puntaje en modal
        window.updateModalScore = async function(criteriaId, value) {
            if (!currentModalArtist) return;

            // Actualizar display con n√∫mero y texto visual
            const displayElement = document.getElementById(`modal-${criteriaId}-display`);
            const labelElement = document.getElementById(`modal-${criteriaId}-label`);
            
            if (displayElement) {
                displayElement.textContent = value;
            }
            
            if (labelElement) {
                const label = getScoreLabel(value);
                labelElement.textContent = label.text;
                labelElement.className = `px-2 py-1 rounded text-xs font-bold ${label.color} ${label.bg}`;
            }

            // Guardar en votes (temporal)
            if (!votes[currentModalArtist.id]) {
                votes[currentModalArtist.id] = {};
            }
            votes[currentModalArtist.id][criteriaId] = parseInt(value);

            await updateModalTotal();
        };

        // Funci√≥n para actualizar puntuaciones en Vista Lista
        window.updateListScore = function(artistId, criteriaId, value) {
            value = Math.max(25, Math.min(100, parseInt(value))); // Asegurar rango v√°lido
            
            // Actualizar display y sincronizar slider/input
            const displayElement = document.getElementById(`list-${artistId}-${criteriaId}-display`);
            const sliderElement = document.getElementById(`list-${artistId}-${criteriaId}-slider`);
            const inputElement = document.getElementById(`list-${artistId}-${criteriaId}-input`);
            
            if (displayElement) displayElement.textContent = value;
            if (sliderElement) sliderElement.value = value;
            if (inputElement) inputElement.value = value;

            // Guardar en votes
            if (!votes[artistId]) {
                votes[artistId] = {};
            }
            votes[artistId][criteriaId] = value;

            // Re-renderizar para actualizar estado visual
            renderArtists();
        };

        // Funci√≥n para actualizar total en modal
        async function updateModalTotal() {
            if (!currentModalArtist) return;

            const currentVotes = votes[currentModalArtist.id] || {};
            const total = Object.values(currentVotes).reduce((sum, val) => sum + val, 0);
            
            // Mostrar puntaje individual
            document.getElementById('modal-total-score').textContent = `${total}/1000`;
            
            // Obtener y mostrar promedio de todos los jurados
            try {
                const averageData = await getAverageScoresFromAllJurors(currentModalArtist.id);
                const totalScoreElement = document.getElementById('modal-total-score');
                
                if (averageData && averageData.totalJurors > 1) {
                    // Mostrar tanto el individual como el promedio
                    const averageTotal = (averageData.overallAverage * 10).toFixed(0); // Convertir a escala /1000
                    totalScoreElement.innerHTML = `
                        <div class="text-center">
                            <div class="text-lg font-bold text-purple-300">
                                üìä Promedio: ${averageTotal}/1000
                            </div>
                            <div class="text-sm text-gray-400">
                                (${averageData.totalJurors} jurados) | Tu voto: ${total}/1000
                            </div>
                        </div>
                    `;
                } else {
                    // Solo mostrar individual si no hay otros votos
                    totalScoreElement.innerHTML = `
                        <div class="text-center">
                            <div class="text-lg font-bold text-blue-300">
                                ${total}/1000
                            </div>
                            <div class="text-xs text-gray-400">
                                (Solo tu evaluaci√≥n)
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error obteniendo promedio para modal:', error);
                // Mantener solo el puntaje individual si hay error
                document.getElementById('modal-total-score').textContent = `${total}/1000`;
            }
            
            // Mostrar bot√≥n de finalizar cuando todos los criterios est√©n completos
            const hasAllVotes = CRITERIA.every(criteria => 
                currentVotes[criteria.id] !== undefined && currentVotes[criteria.id] !== null
            );
            
            const finalizarButton = document.getElementById('finalizar-evaluacion-btn');
            if (finalizarButton) {
                if (hasAllVotes) {
                    finalizarButton.style.display = 'block';
                    finalizarButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    finalizarButton.classList.add('hover:bg-green-700');
                } else {
                    finalizarButton.style.display = 'block';
                    finalizarButton.classList.add('opacity-50', 'cursor-not-allowed');
                    finalizarButton.classList.remove('hover:bg-green-700');
                }
            }
            
            // Ya NO generar feedback autom√°ticamente - esperar a que haga clic en FINALIZAR
        }

        // === FUNCI√ìN PARA CALCULAR PROMEDIO DE TODOS LOS JURADOS ===
        async function getAverageScoresFromAllJurors(artistId) {
            try {
                console.log(`üìä Calculando promedio de todos los jurados para artista: ${artistId}`);
                
                const currentEvent = localStorage.getItem('currentEvent');
                if (!currentEvent) {
                    console.error('‚ùå No hay evento actual');
                    return null;
                }
                
                // Obtener todos los votos de todos los jurados para este artista
                const evaluationsSnapshot = await db.collection('events').doc(currentEvent)
                    .collection('jury_evaluations')
                    .where('artistId', '==', artistId)
                    .get();
                
                if (evaluationsSnapshot.empty) {
                    console.warn('‚ö†Ô∏è No se encontraron evaluaciones para este artista');
                    return null;
                }
                
                console.log(`üìã Encontradas ${evaluationsSnapshot.docs.length} evaluaciones para ${artistId}`);
                
                // Agrupar votos por criterio
                const criteriaScores = {};
                CRITERIA.forEach(criteria => {
                    criteriaScores[criteria.id] = [];
                });
                
                let totalJurors = 0;
                
                evaluationsSnapshot.forEach(doc => {
                    const evaluation = doc.data();
                    totalJurors++;
                    
                    console.log(`üìù Evaluaci√≥n de ${evaluation.jurorId}:`, evaluation.scores || evaluation);
                    
                    // Procesar cada criterio
                    CRITERIA.forEach(criteria => {
                        let score = null;
                        
                        // Buscar el score en diferentes posibles estructuras
                        if (evaluation.scores && evaluation.scores[criteria.id] !== undefined) {
                            score = evaluation.scores[criteria.id];
                        } else if (evaluation[criteria.id] !== undefined) {
                            score = evaluation[criteria.id];
                        }
                        
                        if (score !== null && score !== undefined && !isNaN(score)) {
                            criteriaScores[criteria.id].push(parseFloat(score));
                        }
                    });
                });
                
                // Calcular promedios por criterio
                const averageScores = {};
                let totalSum = 0;
                let totalCriteria = 0;
                
                CRITERIA.forEach(criteria => {
                    const scores = criteriaScores[criteria.id];
                    if (scores.length > 0) {
                        const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                        averageScores[criteria.id] = Math.round(average * 10) / 10; // Redondear a 1 decimal
                        totalSum += average;
                        totalCriteria++;
                        
                        console.log(`üìä ${criteria.name}: ${scores.length} votos, promedio: ${averageScores[criteria.id]}`);
                    } else {
                        console.warn(`‚ö†Ô∏è No se encontraron votos para ${criteria.name}`);
                        averageScores[criteria.id] = 0;
                    }
                });
                
                const overallAverage = totalCriteria > 0 ? Math.round((totalSum / totalCriteria) * 10) / 10 : 0;
                
                console.log('‚úÖ Promedios calculados:', {
                    averageScores,
                    overallAverage,
                    totalJurors,
                    artistId
                });
                
                return {
                    averageScores,
                    overallAverage,
                    totalJurors,
                    artistId
                };
                
            } catch (error) {
                console.error('‚ùå Error calculando promedio de jurados:', error);
                return null;
            }
        }

        // Funci√≥n para generar y mostrar feedback autom√°tico en el modal
        async function generateAndShowModalFeedback(artistVotes) {
            console.log('üîç Generando feedback con IA para modal:', artistVotes);
            
            // PRIMERO: Obtener el promedio de todos los jurados
            const artistId = currentModalArtist ? currentModalArtist.id : null;
            console.log('üéØ Obteniendo promedio de todos los jurados para:', artistId);
            
            const averageData = await getAverageScoresFromAllJurors(artistId);
            
            // Si no hay promedio disponible, usar los votos individuales como respaldo
            const finalVotes = averageData ? averageData.averageScores : artistVotes;
            const isAverageData = !!averageData;
            
            console.log('üìä Datos para feedback:', {
                isAverageData,
                finalVotes,
                totalJurors: averageData?.totalJurors || 1,
                overallAverage: averageData?.overallAverage || 'N/A'
            });
            
            const feedbackContainer = document.getElementById('auto-feedback-modal');
            const feedbackSection = document.getElementById('feedback-section-modal');
            
            // Mostrar indicador de carga
            if (feedbackContainer && feedbackSection) {
                feedbackContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-300 mx-auto mb-2"></div>
                        <p class="text-blue-300">ü§ñ Gemini AI generando feedback profesional...</p>
                    </div>
                `;
                feedbackSection.style.display = 'block';
            }
            
            console.log('üì¶ Elementos del modal encontrados:', {
                feedbackContainer: !!feedbackContainer,
                feedbackSection: !!feedbackSection,
                containerHTML: feedbackContainer ? 'Existe' : 'No existe',
                sectionHTML: feedbackSection ? 'Existe' : 'No existe'
            });
            
            if (!feedbackContainer || !feedbackSection) {
                console.warn('‚ö†Ô∏è No se encontraron elementos de feedback en el modal');
                // Intentar crear los elementos si no existen
                const modalContent = document.querySelector('.modal-content');
                if (modalContent && !feedbackSection) {
                    const newFeedbackSection = document.createElement('div');
                    newFeedbackSection.id = 'feedback-section-modal';
                    newFeedbackSection.className = 'bg-blue-800 bg-opacity-50 p-4 rounded-lg mb-6';
                    newFeedbackSection.innerHTML = `
                        <h5 class="text-lg font-bold mb-3 text-center">üí¨ Sugerencias de Feedback</h5>
                        <div id="auto-feedback-modal" class="space-y-2 text-sm"></div>
                        <p class="text-xs text-blue-300 mt-2 text-center">üí° Basado en tus puntuaciones - Puedes usarlas como gu√≠a</p>
                    `;
                    
                    // Tambi√©n crear la secci√≥n de comentarios post-evaluaci√≥n
                    const postCommentsSection = document.createElement('div');
                    postCommentsSection.id = 'post-evaluation-comments-section';
                    postCommentsSection.className = 'bg-green-800 bg-opacity-30 border border-green-500 p-4 rounded-lg mb-6';
                    postCommentsSection.style.display = 'none';
                    postCommentsSection.innerHTML = `
                        <h5 class="text-lg font-bold mb-3 text-center text-green-400">üí≠ COMENTARIOS ADICIONALES POST-EVALUACI√ìN</h5>
                        <div class="space-y-3">
                            <textarea 
                                id="post-evaluation-comments" 
                                rows="4" 
                                class="w-full p-3 bg-gray-800 border border-green-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-vertical"
                                placeholder="¬øQuieres agregar alg√∫n comentario personal despu√©s de ver el feedback?"
                                onblur="savePostComments()"
                            ></textarea>
                            <p class="text-xs text-green-300 text-center">üí° Opcional: Agrega tus impresiones personales despu√©s del an√°lisis con IA</p>
                        </div>
                    `;
                    
                    const buttonsDiv = modalContent.querySelector('.flex.gap-4.justify-end');
                    if (buttonsDiv) {
                        modalContent.insertBefore(newFeedbackSection, buttonsDiv);
                        modalContent.insertBefore(postCommentsSection, buttonsDiv);
                        console.log('üîß Elementos de feedback y comentarios post-evaluaci√≥n creados din√°micamente');
                        // Reintentar con los nuevos elementos
                        setTimeout(() => generateAndShowModalFeedback(finalVotes), 100);
                        return;
                    }
                }
                return;
            }
            
            const feedbackSuggestions = generateAutoFeedback(finalVotes);
            console.log('üí¨ Sugerencias generadas:', feedbackSuggestions.length, 'elementos');
            
            try {
                const feedbackSuggestions = await generateAutoFeedback(finalVotes);
                
                if (feedbackSuggestions.length > 0) {
                    const feedbackHTML = feedbackSuggestions.map((item, index) => `
                        <div class="bg-gradient-to-r from-blue-900 to-purple-900 bg-opacity-50 p-3 rounded-lg mb-3 border border-blue-400">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-blue-300 text-sm">${item.category}</span>
                                <span class="text-xs text-green-400">${item.score === 'IA Generated' ? 'ü§ñ IA' : item.score}</span>
                            </div>
                            <p class="text-white text-sm leading-relaxed">${item.suggestion}</p>
                        </div>
                    `).join('');
                    
                    // Crear encabezado con informaci√≥n del promedio
                    const averageInfo = isAverageData ? 
                        `<div class="mb-3 p-3 bg-gradient-to-r from-purple-800 to-blue-800 rounded-lg border border-purple-400">
                            <div class="text-center mb-2">
                                <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                    üìä PROMEDIO DE ${averageData.totalJurors} JURADO${averageData.totalJurors > 1 ? 'S' : ''}
                                </span>
                            </div>
                            <div class="text-center">
                                <span class="text-2xl font-bold text-purple-300">${averageData.overallAverage} puntos</span>
                                <p class="text-xs text-purple-200 mt-1">Puntuaci√≥n promedio general</p>
                            </div>
                        </div>` : 
                        `<div class="mb-3 p-2 bg-yellow-800 bg-opacity-50 rounded-lg border border-yellow-500">
                            <p class="text-xs text-yellow-300 text-center">‚ö†Ô∏è Mostrando solo tu evaluaci√≥n (otros jurados a√∫n no han votado)</p>
                        </div>`;
                    
                    feedbackContainer.innerHTML = `
                        ${averageInfo}
                        <div class="mb-3 text-center">
                            <span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                ‚úÖ An√°lisis completado por Gemini AI
                            </span>
                        </div>
                        ${feedbackHTML}
                    `;
                    
                    // Mostrar la secci√≥n de feedback
                    feedbackSection.style.display = 'block';
                    feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // Mostrar tambi√©n la secci√≥n de comentarios post-evaluaci√≥n
                    const postCommentsSection = document.getElementById('post-evaluation-comments-section');
                    if (postCommentsSection) {
                        postCommentsSection.style.display = 'block';
                        console.log('‚úÖ Secci√≥n de comentarios post-evaluaci√≥n mostrada');
                    }
                    
                    console.log('‚úÖ Feedback con IA mostrado correctamente');
                    console.log('üìÑ Sugerencias generadas:', feedbackSuggestions.length);
                } else {
                    // Mostrar mensaje si no hay sugerencias
                    feedbackContainer.innerHTML = '<p class="text-gray-400 text-center">Completa todas las categor√≠as para ver sugerencias personalizadas con IA</p>';
                    feedbackSection.style.display = 'block';
                    console.log('üìù Mostrando mensaje de completar categor√≠as');
                }
            } catch (error) {
                console.error('‚ùå Error generando feedback:', error);
                feedbackContainer.innerHTML = `
                    <div class="bg-red-900 bg-opacity-50 p-3 rounded text-center">
                        <p class="text-red-300 text-sm">‚ö†Ô∏è Error generando feedback con IA</p>
                        <p class="text-red-400 text-xs mt-1">Se usar√° sistema de respaldo</p>
                    </div>
                `;
                feedbackSection.style.display = 'block';
            }
        }

        // Funci√≥n para generar y mostrar feedback autom√°tico (versi√≥n antigua para compatibilidad)
        function generateAndShowFeedback(artistId, artistVotes) {
            console.log('üîç Generando feedback para:', artistId, artistVotes);
            
            const feedbackContainer = document.getElementById(`auto-feedback-${artistId}`);
            const feedbackSection = document.getElementById(`feedback-section-${artistId}`);
            
            console.log('üì¶ Elementos encontrados:', {
                feedbackContainer: !!feedbackContainer,
                feedbackSection: !!feedbackSection
            });
            
            if (!feedbackContainer || !feedbackSection) {
                console.warn('‚ö†Ô∏è No se encontraron elementos de feedback para:', artistId);
                return;
            }
            
            const feedbackSuggestions = generateAutoFeedback(artistVotes);
            console.log('üí¨ Sugerencias generadas:', feedbackSuggestions);
            
            if (feedbackSuggestions.length > 0) {
                feedbackContainer.innerHTML = feedbackSuggestions.map(item => `
                    <div class="bg-black bg-opacity-30 p-2 rounded">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-blue-300">${item.category}</span>
                            <span class="text-xs text-gray-400">${item.score} pts</span>
                        </div>
                        <p class="text-white text-sm mt-1">"${item.suggestion}"</p>
                    </div>
                `).join('');
                
                // Mostrar la secci√≥n de feedback
                feedbackSection.style.display = 'block';
                console.log('‚úÖ Feedback mostrado correctamente');
            } else {
                // Ocultar la secci√≥n de feedback si no hay sugerencias
                feedbackSection.style.display = 'none';
                console.log('‚ùå No hay sugerencias, ocultando secci√≥n');
            }
        }

        // Funci√≥n para generar y mostrar feedback autom√°tico en Vista Lista
        async function generateAndShowListFeedback(artistId, artistVotes) {
            console.log('üîç Generando feedback para Vista Lista:', artistId, artistVotes);
            
            const feedbackContainer = document.getElementById(`auto-feedback-${artistId}`);
            const feedbackSection = document.getElementById(`feedback-section-${artistId}`);
            
            console.log('üì¶ Elementos encontrados en Vista Lista:', {
                feedbackContainer: !!feedbackContainer,
                feedbackSection: !!feedbackSection
            });
            
            if (!feedbackContainer || !feedbackSection) {
                console.warn('‚ö†Ô∏è No se encontraron elementos de feedback para Vista Lista:', artistId);
                return;
            }
            
            try {
                // Usar la funci√≥n async correctamente
                const feedbackSuggestions = await generateAutoFeedback(artistVotes);
                console.log('üí¨ Sugerencias generadas para lista:', feedbackSuggestions);
                
                if (feedbackSuggestions.length > 0) {
                    feedbackContainer.innerHTML = feedbackSuggestions.map(item => `
                        <div class="bg-black bg-opacity-30 p-2 rounded">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-blue-300">${item.category}</span>
                                <span class="text-xs text-gray-400">${item.score} pts</span>
                            </div>
                            <p class="text-white text-sm mt-1">"${item.suggestion}"</p>
                        </div>
                    `).join('');
                    
                    // Mostrar la secci√≥n de feedback
                    feedbackSection.style.display = 'block';
                    console.log('‚úÖ Feedback mostrado correctamente en Vista Lista');
                } else {
                    feedbackSection.style.display = 'none';
                    console.log('‚ùå No hay sugerencias para Vista Lista');
                }
            } catch (error) {
                console.error('‚ùå Error generando feedback en Vista Lista:', error);
                feedbackContainer.innerHTML = `
                    <div class="bg-red-900 bg-opacity-50 p-3 rounded text-center">
                        <p class="text-red-300 text-sm">‚ö†Ô∏è Error generando feedback</p>
                    </div>
                `;
                feedbackSection.style.display = 'block';
            }
        }

        // Funci√≥n para guardar votaci√≥n desde modal
        window.saveModalVote = async function() {
            console.log('üéØ INICIANDO saveModalVote');
            console.log('currentModalArtist:', currentModalArtist);
            
            if (!currentModalArtist) {
                console.log('‚ùå No hay currentModalArtist');
                return;
            }

            const artistVotes = votes[currentModalArtist.id] || {};
            console.log('üîç Votos del artista:', currentModalArtist.id, artistVotes);
            console.log('üîç Total de criterios:', CRITERIA.length);
            console.log('üîç Total de votos:', Object.keys(artistVotes).length);
            
            // Verificar que todas las categor√≠as est√©n completas
            const missingCriteria = CRITERIA.filter(criteria => 
                artistVotes[criteria.id] === undefined || artistVotes[criteria.id] === null
            );
            
            console.log('üö® Criterios faltantes:', missingCriteria.map(c => c.name));
            console.log('üîç Detalles de criterios:');
            CRITERIA.forEach(criteria => {
                console.log(`  ${criteria.id}: ${artistVotes[criteria.id]} (${artistVotes[criteria.id] === undefined ? 'UNDEFINED' : artistVotes[criteria.id] === null ? 'NULL' : 'OK'})`);
            });
            
            if (missingCriteria.length > 0) {
                alert(`Por favor completa las siguientes categor√≠as:\n${missingCriteria.map(c => c.name).join('\n')}`);
                return;
            }

            try {
                await submitVote(currentModalArtist.id);
                closeVotingModal();
                
                // Actualizar vista actual
                if (currentViewMode === 'grid') {
                    renderArtistsGrid();
                } else {
                    renderArtists();
                }
                
                updateStats();
                alert(`‚úÖ Votaci√≥n guardada para ${currentModalArtist.name}`);
            } catch (error) {
                console.error('Error guardando voto:', error);
                alert('Error guardando la votaci√≥n. Intenta de nuevo.');
            }
        };

        // Funci√≥n para reiniciar todos los votos
        window.resetAllVotes = async function() {
            const confirmation = confirm('‚ö†Ô∏è ADVERTENCIA: Esto borrar√° TODOS los votos de TODOS los jurados.\n\n¬øEst√°s SEGURO de que quieres continuar?\n\nEsta acci√≥n NO se puede deshacer.');
            
            if (!confirmation) return;
            
            const doubleConfirmation = confirm('üö® √öLTIMA CONFIRMACI√ìN:\n\nSe borrar√°n permanentemente:\n‚Ä¢ Todos los votos de jurados\n‚Ä¢ Todas las evaluaciones guardadas\n‚Ä¢ Todo el historial de votaci√≥n\n\n¬øPROCEDER con el reinicio total?');
            
            if (!doubleConfirmation) return;
            
            try {
                console.log('üîÑ Iniciando reinicio total de votos...');
                document.getElementById('status').textContent = 'Reiniciando votos...';
                
                let deletedCount = 0;
                
                // Limpiar colecci√≥n jury_evaluations
                try {
                    const juryEvaluationsRef = collection(db, `events/${eventId}/jury_evaluations`);
                    const juryEvaluationsSnapshot = await getDocs(juryEvaluationsRef);
                    console.log(`üìä Encontradas ${juryEvaluationsSnapshot.docs.length} evaluaciones de jurado`);
                    
                    for (const docRef of juryEvaluationsSnapshot.docs) {
                        await deleteDoc(doc(db, `events/${eventId}/jury_evaluations`, docRef.id));
                        deletedCount++;
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Error limpiando jury_evaluations:', error.message);
                }
                
                // Limpiar colecci√≥n jury_votes
                try {
                    const juryVotesRef = collection(db, `events/${eventId}/jury_votes`);
                    const juryVotesSnapshot = await getDocs(juryVotesRef);
                    console.log(`üìä Encontrados ${juryVotesSnapshot.docs.length} votos de jurado`);
                    
                    for (const docRef of juryVotesSnapshot.docs) {
                        await deleteDoc(doc(db, `events/${eventId}/jury_votes`, docRef.id));
                        deletedCount++;
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Error limpiando jury_votes:', error.message);
                }
                
                // Limpiar colecci√≥n votes
                try {
                    const votesRef = collection(db, `events/${eventId}/votes`);
                    const votesSnapshot = await getDocs(votesRef);
                    console.log(`üìä Encontrados ${votesSnapshot.docs.length} votos generales`);
                    
                    for (const docRef of votesSnapshot.docs) {
                        await deleteDoc(doc(db, `events/${eventId}/votes`, docRef.id));
                        deletedCount++;
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Error limpiando votes:', error.message);
                }
                
                // Limpiar localStorage
                localStorage.clear();
                console.log('üßπ LocalStorage limpiado');
                
                // Limpiar variables locales
                votes = {};
                console.log('üßπ Variables locales limpiadas');
                
                // Actualizar interfaz
                if (currentViewMode === 'grid') {
                    renderArtistsGrid();
                } else {
                    renderArtists();
                }
                updateStats();
                
                console.log(`‚úÖ Reinicio completo exitoso. ${deletedCount} documentos eliminados.`);
                document.getElementById('status').textContent = `‚úÖ Reinicio completo: ${deletedCount} votos eliminados`;
                
                alert(`üîÑ REINICIO COMPLETADO\n\n‚úÖ ${deletedCount} votos eliminados exitosamente\n‚úÖ Sistema limpio y listo para nueva votaci√≥n\n\nTodos los jurados deben volver a votar.`);
                
            } catch (error) {
                console.error('‚ùå Error durante el reinicio:', error);
                document.getElementById('status').textContent = 'Error en el reinicio';
                alert(`‚ùå Error durante el reinicio:\n${error.message}\n\nIntenta nuevamente o contacta al administrador.`);
            }
        };

        // === PWA SERVICE WORKER ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Error registrando Service Worker:', error);
                    });
            });
        }

        // === INSTALACI√ìN PWA ===
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üíæ PWA puede ser instalada');
            e.preventDefault(); // Prevenir que se muestre autom√°ticamente
            deferredPrompt = e;
            
            // Mostrar bot√≥n de instalaci√≥n
            const installButton = document.getElementById('install-button');
            if (installButton) {
                installButton.style.display = 'inline-block';
                console.log('üì± Bot√≥n de instalaci√≥n mostrado');
            }
        });

        // Funci√≥n para instalar PWA manualmente
        window.installPWA = function() {
            if (deferredPrompt) {
                console.log('üöÄ Iniciando instalaci√≥n PWA');
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ Usuario acept√≥ la instalaci√≥n');
                        alert('üéâ ¬°VYT-MUSIC instalado correctamente!\n\nBusca el icono con tu logo en la pantalla de inicio.');
                    } else {
                        console.log('‚ùå Usuario rechaz√≥ la instalaci√≥n');
                        alert('‚ÑπÔ∏è Instalaci√≥n cancelada.\n\nPuedes intentar de nuevo m√°s tarde.');
                    }
                    deferredPrompt = null;
                    
                    // Ocultar bot√≥n
                    const installButton = document.getElementById('install-button');
                    if (installButton) {
                        installButton.style.display = 'none';
                    }
                });
            } else {
                console.log('‚ö†Ô∏è No hay prompt de instalaci√≥n disponible');
                alert('üì± Instalaci√≥n no disponible\n\nPrueba:\n‚Ä¢ Usar Chrome/Edge\n‚Ä¢ Agregar a pantalla desde men√∫ del navegador\n‚Ä¢ Verificar que est√©s en HTTPS');
            }
        };

        // Detectar cuando la app ya est√° instalada
        window.addEventListener('appinstalled', (evt) => {
            console.log('üéâ PWA fue instalada');
            alert('üéµ ¬°VYT-MUSIC instalado!\n\nYa puedes encontrar la app con tu logo en la pantalla de inicio.');
            
            // Ocultar bot√≥n
            const installButton = document.getElementById('install-button');
            if (installButton) {
                installButton.style.display = 'none';
            }
        });

        // === FUNCI√ìN DE LOGIN ===
        async function login() {
            const judgeName = document.getElementById('judge-name').value.trim();
            const judgeType = document.getElementById('judge-type').value;

            if (!judgeName) {
                alert('‚ö†Ô∏è Ingresa tu nombre como jurado');
                return;
            }

            if (!judgeType) {
                alert('‚ö†Ô∏è Selecciona el tipo de jurado');
                return;
            }

            try {
                currentJuror = {
                    name: judgeName,
                    type: judgeType,
                    id: `${judgeName.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}`
                };

                console.log('‚úÖ Jurado autenticado:', currentJuror);

                // Mostrar contenido principal
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('juror-display').textContent = `${judgeName} (${judgeType})`;

                // Verificar si es organizador y mostrar secci√≥n de administraci√≥n
                checkAdminAccess(judgeName);

                // Cargar artistas
                await loadArtists();

            } catch (error) {
                console.error('‚ùå Error en login:', error);
                alert('‚ùå Error al ingresar. Intenta nuevamente.');
            }
        }

        // Verificar acceso de administrador
        function checkAdminAccess(judgeName) {
            // Lista de emails/nombres de organizadores
            const organizers = [
                'lucia',
                'organizador',
                'admin',
                'administrador'
            ];

            const isOrganizer = organizers.some(org => 
                judgeName.toLowerCase().includes(org.toLowerCase())
            );

            if (isOrganizer) {
                console.log('üîß Acceso de administrador detectado');
                document.getElementById('admin-section').classList.remove('hidden');
            } else {
                console.log('üë®‚Äç‚öñÔ∏è Acceso de jurado regular');
                document.getElementById('admin-section').classList.add('hidden');
            }
        }

        // === FUNCIONALIDADES DE ADMINISTRACI√ìN ===
        
        // Generar link compartible
        window.generateShareableLink = function() {
            console.log('üîó Iniciando generaci√≥n de link...');
            
            const selectedGala = document.getElementById('admin-gala-select').value;
            console.log('üé≠ Gala seleccionada:', selectedGala);
            
            if (!selectedGala) {
                alert('‚ö†Ô∏è Selecciona una gala para generar el link');
                return;
            }
            
            const baseUrl = window.location.origin + window.location.pathname;
            const shareableLink = `${baseUrl}?gala=${selectedGala}&mode=judge`;
            
            console.log('üåç URL base:', baseUrl);
            console.log('üîó Link completo:', shareableLink);
            
            // Mostrar el link generado
            const linkInput = document.getElementById('generated-link');
            const linkSection = document.getElementById('generated-link-section');
            
            if (linkInput && linkSection) {
                linkInput.value = shareableLink;
                linkSection.classList.remove('hidden');
                console.log('‚úÖ Link insertado en el input');
                
                // Cambiar estilo para resaltar
                linkInput.style.backgroundColor = '#22c55e';
                linkInput.style.color = 'white';
                linkInput.style.fontWeight = 'bold';
                
                setTimeout(() => {
                    linkInput.style.backgroundColor = '#374151';
                    linkInput.style.color = '#d1d5db';
                    linkInput.style.fontWeight = 'normal';
                }, 2000);
                
                alert(`‚úÖ Link generado exitosamente!\n\nüé≠ Gala: ${document.getElementById('admin-gala-select').selectedOptions[0].text}\n\nÔøΩ Link: ${shareableLink}\n\nÔøΩüì§ Ahora usa el bot√≥n "üìã Copiar" para compartirlo`);
            } else {
                console.error('‚ùå No se encontraron elementos DOM');
                alert('‚ùå Error: No se pudo mostrar el link. Revisa la consola.');
            }
        };
        
        // Copiar link generado
        window.copyGeneratedLink = function() {
            const linkInput = document.getElementById('generated-link');
            const link = linkInput.value;
            
            console.log('üìã Intentando copiar link:', link);
            
            if (!link || link === '' || link.includes('placeholder')) {
                alert('‚ö†Ô∏è No hay link para copiar. Genera uno primero seleccionando una gala.');
                return;
            }
            
            // Seleccionar el texto del input
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Para m√≥viles
            
            navigator.clipboard.writeText(link).then(() => {
                console.log('‚úÖ Link copiado exitosamente');
                alert(`üîó Link copiado al portapapeles!\n\nüì§ Comp√°rtelo con los jurados:\n\n${link}`);
                
                // Efecto visual
                linkInput.style.backgroundColor = '#22c55e';
                setTimeout(() => {
                    linkInput.style.backgroundColor = '#374151';
                }, 1000);
                
            }).catch((error) => {
                console.error('‚ùå Error copiando:', error);
                // Fallback si no funciona el clipboard
                prompt('üîó Copia este link manualmente para los jurados:', link);
            });
        };
        
        // Inicializar sistema de autocompletado
        function initializeAutocomplete() {
            const input = document.getElementById('judge-name');
            const suggestions = document.getElementById('name-suggestions');
            
            input.addEventListener('input', async function() {
                const value = this.value.trim();
                suggestions.innerHTML = '';
                
                if (value.length < 2) return;
                
                try {
                    // Buscar nombres similares en la base de datos
                    const querySnapshot = await getDocs(query(
                        collection(db, 'jury_evaluations'),
                        where('judgeName', '>=', value),
                        where('judgeName', '<=', value + '\uf8ff'),
                        limit(5)
                    ));
                    
                    const names = new Set();
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.judgeName && data.judgeName.toLowerCase().includes(value.toLowerCase())) {
                            names.add(data.judgeName);
                        }
                    });
                    
                    names.forEach(name => {
                        const suggestion = document.createElement('div');
                        suggestion.className = 'p-2 hover:bg-blue-100 cursor-pointer border-b border-gray-200';
                        suggestion.textContent = name;
                        suggestion.onclick = () => {
                            input.value = name;
                            suggestions.innerHTML = '';
                            suggestions.style.display = 'none';
                        };
                        suggestions.appendChild(suggestion);
                    });
                    
                    suggestions.style.display = names.size > 0 ? 'block' : 'none';
                } catch (error) {
                    console.error('‚ùå Error en autocompletado:', error);
                }
            });
            
            // Ocultar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }
        
        // Cargar galas en selector de administrador
        async function loadAdminGalas() {
            console.log('üé≠ Iniciando carga de galas REALES...');
            console.log('üìç EventId:', eventId);
            
            const select = document.getElementById('admin-gala-select');
            if (!select) {
                console.error('‚ùå No se encontr√≥ selector admin-gala-select');
                return;
            }
            
            select.innerHTML = '<option value="">üé≠ Cargando galas reales...</option>';
            
            try {
                // BUSCAR GALAS REALES - Directamente desde la colecci√≥n de eventos principales
                console.log('üîç Buscando eventos/galas reales...');
                
                // Buscar en la colecci√≥n principal de eventos (donde est√°n tus galas reales)
                const eventsSnapshot = await getDocs(collection(db, 'events'));
                console.log('üìä Eventos encontrados:', eventsSnapshot.docs.length);
                
                const realGalas = [];
                
                eventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    const eventId = doc.id;
                    
                    // Log para debug
                    console.log('üìÑ Evento encontrado:', {
                        id: eventId,
                        name: eventData.name || eventData.eventName || 'Sin nombre',
                        date: eventData.date || eventData.createdAt,
                        data: eventData
                    });
                    
                    // Agregar solo si tiene nombre v√°lido
                    if (eventData.name || eventData.eventName) {
                        realGalas.push({
                            id: eventId,
                            name: eventData.name || eventData.eventName,
                            date: eventData.date || eventData.createdAt
                        });
                    }
                });
                
                // Ordenar por fecha (m√°s recientes primero)
                realGalas.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA;
                });
                
                console.log('‚úÖ Galas reales encontradas:', realGalas);
                
                // Limpiar y llenar selector con galas reales
                select.innerHTML = '<option value="">üé≠ Selecciona gala para generar link...</option>';
                
                if (realGalas.length > 0) {
                    realGalas.forEach(gala => {
                        const option = document.createElement('option');
                        option.value = gala.id;
                        option.textContent = `üé≠ ${gala.name}`;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ ${realGalas.length} galas reales cargadas en selector`);
                } else {
                    console.log('‚ö†Ô∏è No se encontraron galas reales, usando fallback');
                    select.innerHTML = '<option value="">‚ùå No hay galas creadas</option>';
                    
                    // Agregar mensaje para crear galas
                    const option = document.createElement('option');
                    option.value = 'crear_gala';
                    option.textContent = '‚ûï Crear galas en "Gesti√≥n de Eventos"';
                    select.appendChild(option);
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando galas reales:', error);
                select.innerHTML = '<option value="">‚ùå Error cargando galas</option>';
                
                // Mensaje de error informativo
                alert(`‚ùå Error cargando tus galas reales:\n\n${error.message}\n\nVerifica:\n‚Ä¢ Conexi√≥n a Firebase\n‚Ä¢ Galas creadas en "Gesti√≥n de Eventos"`);
            }
        }
        
        // Detectar par√°metros de URL para acceso directo
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const galaParam = urlParams.get('gala');
            const modeParam = urlParams.get('mode');
            
            if (galaParam && modeParam === 'judge') {
                // Auto-seleccionar la gala del link
                setTimeout(() => {
                    const galaSelect = document.getElementById('gala-select');
                    if (galaSelect) {
                        galaSelect.value = galaParam;
                        currentGala = galaParam;
                        loadArtists(); // Cargar artistas autom√°ticamente
                        console.log(`üîó Acceso directo a gala: ${galaParam}`);
                    }
                }, 1000);
            }
        }

        // === INICIALIZACI√ìN ===
        console.log('üöÄ Sistema iniciado');
        document.getElementById('status').textContent = 'Sistema listo - Login de jurado registrado';
        
        // Mensaje de debug en pantalla
        setTimeout(() => {
            if (document.getElementById('jury-activity-panel')) {
                const debugMsg = document.createElement('div');
                debugMsg.className = 'bg-yellow-800 bg-opacity-50 p-3 rounded mb-3 border border-yellow-500';
                debugMsg.innerHTML = `
                    <div class="text-yellow-300 font-bold text-sm">üîç DEBUG TEMPORAL</div>
                    <div class="text-yellow-200 text-xs mt-1">
                        Para diagnosticar jurados activos:<br>
                        1. Abre consola (F12)<br>
                        2. Escribe: debugJurados()<br>
                        3. Presiona Enter
                    </div>
                `;
                document.getElementById('jury-activity-panel').prepend(debugMsg);
            }
        }, 3000);
        
        // CARGAR USUARIOS REGISTRADOS AUTOM√ÅTICAMENTE
        setTimeout(() => {
            loadRegisteredUsers();
        }, 1000);
        
        // CARGAR GALAS DE PRUEBA INMEDIATAMENTE
        setTimeout(() => {
            console.log('üé≠ Cargando galas de prueba...');
            const select = document.getElementById('admin-gala-select');
            
            if (select) {
                select.innerHTML = '<option value="">üé≠ Selecciona gala para generar link...</option>';
                
                const testGalas = [
                    { id: 'gala_1', name: 'Gala 1' },
                    { id: 'gala_2', name: 'Gala 2' },
                    { id: 'gala_3', name: 'Gala 3' },
                    { id: 'semifinal', name: 'Semifinal' },
                    { id: 'final', name: 'Final' }
                ];
                
                testGalas.forEach(gala => {
                    const option = document.createElement('option');
                    option.value = gala.id;
                    option.textContent = `üé≠ ${gala.name}`;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Galas de prueba cargadas:', testGalas.length);
            } else {
                console.error('‚ùå No se encontr√≥ el selector admin-gala-select');
            }
        }, 500);
        
        // Inicializar funcionalidades
        try {
            initializeAutocomplete();
        } catch (error) {
            console.log('‚ö†Ô∏è Error en autocompletado:', error);
        }
        
        try {
            loadAdminGalas();
        } catch (error) {
            console.log('‚ö†Ô∏è Error cargando galas Firebase:', error);
        }
        
        // === CONFIGURAR SISTEMA DE TIEMPO REAL ===
        try {
            setTimeout(() => {
                debugStats.eventId = eventId;
                updateDebugInfo();
                setupRealtimeVotingListener();
                initializeRealtimeButton();
                console.log('‚úÖ Sistema de c√°lculo en tiempo real inicializado');
            }, 2000);
        } catch (error) {
            console.log('‚ö†Ô∏è Error configurando tiempo real:', error);
        }
        
        checkUrlParameters();
        
        // Verificar si se debe mostrar el panel de admin desde el inicio
        checkInitialAdminAccess();
        
        // Funci√≥n para verificar acceso admin inicial
        function checkInitialAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminParam = urlParams.get('admin');
            
            if (adminParam === 'true') {
                console.log('üîß Modo administrador activado por URL');
                document.getElementById('admin-section').classList.remove('hidden');
            }
        }
        
        // === INICIALIZACI√ìN DE EVENTOS GLOBALES ===
        // Esperar a que el DOM est√© listo
        setTimeout(() => {
            const globalSubmitBtn = document.getElementById('global-submit-btn');
            if (globalSubmitBtn) {
                globalSubmitBtn.addEventListener('click', submitAllVotes);
                console.log('‚úÖ Event listener a√±adido al bot√≥n global de env√≠o');
            } else {
                console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n global de env√≠o');
            }
        }, 500);
        
        // === FUNCI√ìN PARA GUARDAR COMENTARIOS POST-EVALUACI√ìN ===
        async function savePostComments(providedArtistId = null, providedComments = null) {
            // Obtener el ID del artista - usar el proporcionado o buscar autom√°ticamente
            let artistId = providedArtistId;
            
            try {
                
            if (!artistId) {
                // Opci√≥n 1: Desde el modal con data-artist-id
                const votingModal = document.getElementById('voting-modal');
                if (votingModal && votingModal.getAttribute('data-artist-id')) {
                    artistId = votingModal.getAttribute('data-artist-id');
                    console.log('üéØ ID del artista obtenido desde modal:', artistId);
                }
                
                // Opci√≥n 2: Desde la variable global currentModalArtist
                if (!artistId && currentModalArtist) {
                    artistId = currentModalArtist.id;
                    console.log('üéØ ID del artista obtenido desde variable global:', artistId);
                }
            }
                
                if (!artistId) {
                    console.warn('‚ö†Ô∏è No se pudo obtener el ID del artista para guardar comentarios');
                    return;
                }
                
                // Obtener comentarios - usar los proporcionados o buscar en el textarea
                let additionalComments = providedComments;
                
                if (!additionalComments) {
                    const commentsTextarea = document.getElementById('post-evaluation-comments') || 
                                           document.getElementById(`post-comments-${artistId}`);
                    
                    if (!commentsTextarea) {
                        console.warn('‚ö†Ô∏è No se encontr√≥ textarea de comentarios');
                        return;
                    }
                    
                    additionalComments = commentsTextarea.value.trim();
                } else {
                    additionalComments = additionalComments.trim();
                }
                
                if (!additionalComments) {
                    console.log('‚ÑπÔ∏è No hay comentarios adicionales para guardar');
                    return;
                }
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const currentEvent = localStorage.getItem('currentEvent');
                
                if (!currentUser.username || !currentEvent) {
                    console.error('‚ùå Faltan datos de usuario o evento');
                    return;
                }
                
                console.log('üíæ Guardando comentarios post-evaluaci√≥n:', {
                    artist: artistId,
                    juror: currentUser.username,
                    comments: additionalComments
                });
                
                // Guardar en Firebase
                await db.collection('events').doc(currentEvent)
                    .collection('post_evaluation_comments').doc(`${artistId}_${currentUser.username}`)
                    .set({
                        artistId: artistId,
                        artistName: currentModalArtist?.name || document.getElementById('modal-artist-name')?.textContent || 'Artista desconocido',
                        jurorId: currentUser.username,
                        jurorName: currentUser.displayName || currentUser.username,
                        additionalComments: additionalComments,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        eventId: currentEvent
                    });
                
                // Mostrar confirmaci√≥n visual
                const textarea = document.getElementById('post-evaluation-comments') || 
                               document.getElementById(`post-comments-${artistId}`);
                if (textarea) {
                    const originalBorder = textarea.style.borderColor;
                    textarea.style.borderColor = '#10B981'; // Verde m√°s intenso
                    textarea.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.3)';
                
                    // Mostrar mensaje de √©xito
                    const successMessage = document.createElement('div');
                    successMessage.className = 'text-green-400 text-sm font-bold mt-2 text-center';
                    successMessage.innerHTML = '‚úÖ Comentarios guardados correctamente';
                    successMessage.id = 'comments-success-message';
                    
                    // Remover mensaje anterior si existe
                    const existingMessage = document.getElementById('comments-success-message');
                    if (existingMessage) existingMessage.remove();
                    
                    textarea.parentNode.appendChild(successMessage);
                    
                    // Restaurar estilo despu√©s de 3 segundos
                    setTimeout(() => {
                        textarea.style.borderColor = originalBorder;
                        textarea.style.boxShadow = 'none';
                        if (successMessage) successMessage.remove();
                    }, 3000);
                }
                
                console.log('‚úÖ Comentarios post-evaluaci√≥n guardados exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error guardando comentarios post-evaluaci√≥n:', error);
                
                // Mostrar mensaje de error
                const errorMessage = document.createElement('div');
                errorMessage.className = 'text-red-400 text-sm font-bold mt-2 text-center';
                errorMessage.innerHTML = '‚ùå Error guardando comentarios';
                errorMessage.id = 'comments-error-message';
                
                const textarea = document.getElementById('post-evaluation-comments') || 
                               document.getElementById(`post-comments-${artistId}`);
                if (textarea) {
                    const existingError = document.getElementById('comments-error-message');
                    if (existingError) existingError.remove();
                    textarea.parentNode.appendChild(errorMessage);
                    
                    setTimeout(() => {
                        if (errorMessage) errorMessage.remove();
                    }, 5000);
                }
            }
        }

        // Funci√≥n para mostrar el link de votaci√≥n
        function showJuryLink() {
            // Link completo de Netlify
            const juryLink = 'https://vytmusic.netlify.app/votacion_jurados_final?eventId=vIINfBwQaFsIhNOYWPtS&eventName=%20GALA%201%20CON%20PUNTUACI%C3%92N.%20G12%20VYTMUSIC&admin=true';
            
            // Crear una ventana con el link bien visible
            const linkWindow = `
                <div style="
                    position: fixed; 
                    top: 50%; 
                    left: 50%; 
                    transform: translate(-50%, -50%); 
                    background: white; 
                    padding: 30px; 
                    border: 3px solid #4CAF50; 
                    border-radius: 10px; 
                    box-shadow: 0 0 20px rgba(0,0,0,0.5); 
                    z-index: 10000;
                    max-width: 90%;
                    text-align: center;
                    font-family: Arial;
                ">
                    <h2 style="color: #4CAF50; margin-top: 0;">üì± LINK PARA LOS JURADOS</h2>
                    <p style="margin: 15px 0; font-size: 16px; color: #333;">Copia este link y env√≠alo a los jurados:</p>
                    <div style="
                        background: #f0f0f0; 
                        padding: 15px; 
                        border: 2px dashed #4CAF50; 
                        border-radius: 5px; 
                        margin: 20px 0; 
                        word-break: break-all;
                        font-size: 14px;
                        color: #000;
                        font-weight: bold;
                    ">${juryLink}</div>
                    <p style="color: #666; font-size: 14px; margin: 15px 0;">
                        ‚úÖ Selecciona el link de arriba<br>
                        ‚úÖ C√≥pialo (Ctrl+C)<br>
                        ‚úÖ Env√≠alo por WhatsApp, email, etc.
                    </p>
                    <button onclick="this.parentElement.remove()" style="
                        background: #4CAF50; 
                        color: white; 
                        border: none; 
                        padding: 10px 20px; 
                        border-radius: 5px; 
                        cursor: pointer; 
                        font-size: 16px;
                        margin-top: 10px;
                    ">‚úÖ Cerrar</button>
                </div>
            `;
            
            // Agregar al body
            const div = document.createElement('div');
            div.innerHTML = linkWindow;
            document.body.appendChild(div);
            
            // Tambi√©n mostrar en alert como backup
            setTimeout(() => {
                alert(`üì± LINK DE VOTACI√ìN:\n\n${juryLink}\n\nüìã Copia y env√≠a este link a los jurados`);
            }, 500);
        }

        // Funci√≥n simple para copiar el link de jurados
        function copyJuryLink() {
            const juryLink = 'https://vytmusic.netlify.app/votacion_jurados_final?eventId=vIINfBwQaFsIhNOYWPtS&eventName=%20GALA%201%20CON%20PUNTUACI%C3%92N.%20G12%20VYTMUSIC&admin=true';
            
            // Intentar copiar al portapapeles
            if (navigator.clipboard) {
                navigator.clipboard.writeText(juryLink).then(() => {
                    // Cambiar el bot√≥n temporalmente
                    const button = document.querySelector('button[onclick="copyJuryLink()"]');
                    const originalText = button.innerHTML;
                    button.innerHTML = '‚úÖ ¬°COPIADO!';
                    button.style.backgroundColor = '#059669';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = '';
                    }, 2000);
                    
                    alert('‚úÖ Link copiado!\n\nYa puedes pegarlo en WhatsApp, email, etc.');
                }).catch(() => {
                    // Si falla, mostrar el link para copiar manualmente
                    prompt('üìã Copia este link:', juryLink);
                });
            } else {
                // Fallback para navegadores antiguos
                prompt('üìã Copia este link:', juryLink);
            }
        }

        // Configurar el bot√≥n de manera SIMPLE
        document.addEventListener('DOMContentLoaded', function() {
            const shareButton = document.getElementById('share-jury-link-btn');
            if (shareButton) {
                shareButton.onclick = showJuryLink;
            }
        });
    </script>
</body>
</html>