<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaci√≥n Jurados SIMPLE - VYTMUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #1e3a8a, #1e40af); color: white; min-height: 100vh; }
        .card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; border: none; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: scale(1.05); }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover { background: #15803d; }
        .btn-red { background: #dc2626; color: white; }
        .btn-orange { background: #ea580c; color: white; }
        .btn-yellow { background: #eab308; color: white; }
        .btn-selected { 
            border: 3px solid #ffffff !important; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8) !important; 
            transform: scale(1.1) !important;
        }
        .artist-card { margin: 20px 0; padding: 20px; }
        .criteria { margin: 15px 0; }
        .rating-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        
        /* Estilos para el nuevo sistema de grid y modal */
        .artist-grid-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }
        .artist-grid-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        .category-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .category-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <!-- HEADER -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <a id="back-to-panel-btn" href="#" class="btn btn-primary text-sm">‚Üê Volver al Panel</a>
                <a id="feedback-btn" href="#" class="btn btn-green text-sm">üì° Feedback en Vivo</a>
            </div>
            <h1 class="text-4xl font-bold mb-4">üé§ VOTACI√ìN DE JURADOS</h1>
            <p id="status" class="text-xl">Iniciando sistema...</p>
        </div>

        <!-- AUTENTICACI√ìN SIMPLE -->
        <div id="auth-section" class="card p-8 max-w-md mx-auto mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">Ingreso de Jurado</h2>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 font-bold">Nombre del Jurado:</label>
                    <input type="text" id="juror-name" class="w-full p-3 rounded bg-white text-black" placeholder="Escribe tu nombre">
                </div>
                <button onclick="login()" class="btn btn-primary w-full">INGRESAR</button>
            </div>
            <div class="mt-4 text-sm text-center opacity-75">
                <p>üìù Solo ingresa tu nombre</p>
                <p>üé≠ <span id="available-jurors">Cargando jurados disponibles...</span></p>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div id="main-content" style="display: none;">
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">üë®‚Äç‚öñÔ∏è <span id="juror-display">Jurado</span></h3>
                <div class="flex gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold" id="total-artists">0</div>
                        <div class="text-sm">Artistas</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400" id="voted-count">0</div>
                        <div class="text-sm">Votados</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="pending-count">0</div>
                        <div class="text-sm">Pendientes</div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-red mt-4">Cerrar Sesi√≥n</button>
            </div>

            <!-- ARTISTAS -->
            <div id="artists-container">
                <h2 class="text-3xl font-bold mb-6 text-center">üé≠ ARTISTAS PARTICIPANTES</h2>
                
                <!-- FILTRO DE B√öSQUEDA -->
                <div class="card p-4 mb-6 max-w-lg mx-auto">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">üîç</div>
                        <div class="flex-1">
                            <input 
                                type="text" 
                                id="artist-search" 
                                placeholder="Buscar artista por nombre..." 
                                class="w-full p-3 rounded bg-white text-black border-2 border-gray-300 focus:border-blue-500"
                                oninput="filterArtists()"
                            >
                        </div>
                        <button onclick="clearSearch()" class="btn btn-orange">Limpiar</button>
                    </div>
                    <p class="text-sm mt-2 opacity-75 text-center">üí° Escribe el nombre para encontrar r√°pidamente al artista</p>
                </div>

                <!-- SELECTOR DE MODO DE VISTA -->
                <div class="card p-4 mb-6 max-w-lg mx-auto">
                    <div class="text-center">
                        <h3 class="text-lg font-bold mb-3">üëÅÔ∏è Modo de Vista</h3>
                        <div class="flex gap-3 justify-center">
                            <button id="btn-list-mode" onclick="switchViewMode('list')" class="btn btn-primary">
                                üìã Vista Lista
                            </button>
                            <button id="btn-grid-mode" onclick="switchViewMode('grid')" class="btn btn-yellow">
                                üéØ Vista Organizada
                            </button>
                        </div>
                        <p class="text-xs mt-2 opacity-75">Vista organizada: solo nombre y foto, clic para evaluar</p>
                    </div>
                </div>
                
                <div id="artists-list">
                    <div class="text-center">
                        <div class="text-2xl">‚è≥</div>
                        <p>Cargando artistas...</p>
                    </div>
                </div>

                <!-- GRID DE ARTISTAS (MODO ORGANIZADO) -->
                <div id="artists-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" style="display: none;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE VOTACI√ìN -->
    <div id="voting-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <!-- Header del Modal -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üé§ Evaluaci√≥n Individual</h2>
                <button onclick="closeVotingModal()" class="text-white text-3xl">&times;</button>
            </div>

            <!-- Informaci√≥n del Artista -->
            <div class="flex items-center gap-4 mb-6 p-4 card">
                <img id="modal-artist-photo" src="" alt="Foto del artista" 
                     class="w-20 h-20 object-cover rounded-full border-2 border-blue-300">
                <div>
                    <h3 id="modal-artist-name" class="text-2xl font-bold"></h3>
                    <p id="modal-artist-info" class="text-gray-300"></p>
                </div>
            </div>

            <!-- Sistema de Puntuaci√≥n por Categor√≠as -->
            <div class="mb-6">
                <h4 class="text-xl font-bold mb-4">üìä Evaluaci√≥n por Categor√≠as (25-100 puntos)</h4>
                <div id="modal-categories" class="space-y-4">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Puntaje Total -->
            <div class="text-center mb-6">
                <div class="card p-4 inline-block">
                    <h4 class="text-lg font-bold">Puntaje Total:</h4>
                    <div id="modal-total-score" class="text-3xl font-bold text-yellow-300">0/600</div>
                </div>
            </div>

            <!-- Botones -->
            <div class="flex gap-4 justify-end">
                <button onclick="closeVotingModal()" class="btn btn-red">
                    Cancelar
                </button>
                <button onclick="saveModalVote()" class="btn btn-green">
                    üíæ Guardar Votaci√≥n
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // === CONFIGURACI√ìN ===
        import { db } from './firebase_config.js';
        import { collection, getDocs, query, orderBy, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // OBTENER EVENT ID DESDE URL (como en gesti√≥n de votaciones)
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId') || 'gmxINHvzSJ18Zt3SNeW7'; // Fallback al ID correcto
        const eventName = urlParams.get('eventName') || 'Evento';
        
        console.log('üåê URL completa:', window.location.href);
        console.log('üîç Par√°metros URL:', window.location.search);
        console.log('üìã EventId obtenido:', eventId);
        console.log('üìã EventId desde URL:', urlParams.get('eventId'));
        console.log('üìã Usando fallback?', !urlParams.get('eventId'));

        // Configurar enlaces de navegaci√≥n
        document.getElementById('back-to-panel-btn').href = `panel_evento.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;
        document.getElementById('feedback-btn').href = `feedback_en_vivo.html?eventId=${eventId}&eventName=${encodeURIComponent(eventName)}`;

        // CRITERIOS DE VOTACI√ìN
        const CRITERIA = [
            { id: 'afinacion', name: 'üéµ Afinaci√≥n' },
            { id: 'puesta_escena', name: 'üé≠ Puesta en Escena' },
            { id: 'vestimenta', name: 'üëî Vestimenta' },
            { id: 'conexion_publico', name: 'üë• Conexi√≥n P√∫blico' },
            { id: 'eleccion_cancion', name: 'üé∂ Elecci√≥n Canci√≥n' }
        ];

        const RATINGS = [
            { id: 'malo', name: 'Malo', value: 20, class: 'btn-red' },
            { id: 'mediocre', name: 'Mediocre', value: 40, class: 'btn-orange' },
            { id: 'bueno', name: 'Bueno', value: 60, class: 'btn-yellow' },
            { id: 'muy_bueno', name: 'Muy Bueno', value: 80, class: 'btn-green' },
            { id: 'excelente', name: 'Excelente', value: 100, class: 'btn-primary' }
        ];

        // SISTEMA DE FEEDBACK AUTOM√ÅTICO
        const FEEDBACK_TEMPLATES = {
            'afinacion': {
                100: ['Tu afinaci√≥n fue impecable', 'Excelente precisi√≥n vocal', 'Dominio total de la t√©cnica vocal'],
                80: ['Muy buena afinaci√≥n en general', 'Buen control vocal', 'Afinaci√≥n s√≥lida y confiable'],
                60: ['Afinaci√≥n correcta con peque√±os detalles', 'Mant√©n el trabajo en t√©cnica vocal', 'Buena base, sigue practicando'],
                40: ['Trabaja m√°s en afinaci√≥n y t√©cnica vocal', 'Necesitas mayor precisi√≥n en las notas', 'Dedica tiempo a ejercicios de entonaci√≥n'],
                20: ['Requiere trabajo intenso en afinaci√≥n', 'Fundamental mejorar la t√©cnica vocal', 'Considera clases de canto para mejorar']
            },
            'puesta_escena': {
                100: ['Presencia esc√©nica excepcional', 'Dominio total del escenario', 'Movimiento y expresi√≥n perfectos'],
                80: ['Muy buena presencia en el escenario', 'Buen manejo del espacio esc√©nico', 'Expresi√≥n corporal efectiva'],
                60: ['Presencia esc√©nica correcta', 'Sigue trabajando en tu movimiento', 'Buena base de expresi√≥n'],
                40: ['Necesitas mayor seguridad en escena', 'Trabaja en tu presencia y movimiento', 'Desarrolla m√°s confianza esc√©nica'],
                20: ['Requiere trabajo en presencia esc√©nica', 'Practica movimiento y expresi√≥n corporal', 'Busca coaching esc√©nico']
            },
            'vestimenta': {
                100: ['Vestuario perfecto para la canci√≥n', 'Excelente elecci√≥n de outfit', 'Look impecable y apropiado'],
                80: ['Muy buena elecci√≥n de vestuario', 'Outfit acorde a la presentaci√≥n', 'Buen sentido del estilo'],
                60: ['Vestuario apropiado', 'Considera detalles adicionales', 'Buena base de estilo personal'],
                40: ['Mejora la elecci√≥n del vestuario', 'Busca outfit m√°s acorde al tema', 'Trabaja en tu imagen esc√©nica'],
                20: ['Requiere mayor atenci√≥n al vestuario', 'Fundamental cuidar la imagen', 'Considera asesor√≠a de imagen']
            },
            'conexion_publico': {
                100: ['Conexi√≥n excepcional con el p√∫blico', 'Carisma natural y envolvente', 'Logras emocionar a la audiencia'],
                80: ['Muy buena conexi√≥n con el p√∫blico', 'Buen carisma y presencia', 'Generas buena respuesta del p√∫blico'],
                60: ['Conexi√≥n decente con el p√∫blico', 'Sigue desarrollando tu carisma', 'Trabaja en el contacto visual'],
                40: ['Necesitas conectar m√°s con el p√∫blico', 'Desarrolla tu carisma personal', 'Practica interacci√≥n con audiencia'],
                20: ['Requiere trabajo en conexi√≥n', 'Fundamental desarrollar carisma', 'Busca t√©cnicas de comunicaci√≥n']
            },
            'eleccion_cancion': {
                100: ['Elecci√≥n de canci√≥n perfecta', 'Tema ideal para tu voz', 'Excelente selecci√≥n musical'],
                80: ['Muy buena elecci√≥n de canci√≥n', 'Tema apropiado para tu estilo', 'Buena selecci√≥n musical'],
                60: ['Canci√≥n apropiada', 'Considera explorar otros g√©neros', 'Buena elecci√≥n base'],
                40: ['Mejora la selecci√≥n de canciones', 'Busca temas m√°s acordes a tu voz', 'Explora tu rango vocal'],
                20: ['Requiere mejor elecci√≥n musical', 'Fundamental conocer tu rango', 'Considera asesor√≠a musical']
            }
        };

        // FUNCI√ìN PARA GENERAR FEEDBACK AUTOM√ÅTICO
        function generateAutoFeedback(artistVotes) {
            const feedbackSuggestions = [];
            
            CRITERIA.forEach(criteria => {
                const score = artistVotes[criteria.id];
                if (score && FEEDBACK_TEMPLATES[criteria.id] && FEEDBACK_TEMPLATES[criteria.id][score]) {
                    const templates = FEEDBACK_TEMPLATES[criteria.id][score];
                    const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
                    feedbackSuggestions.push({
                        category: criteria.name,
                        score: score,
                        suggestion: randomTemplate
                    });
                }
            });
            
            return feedbackSuggestions;
        }

        // VARIABLES GLOBALES
        let currentJuror = null;
        let artists = [];
        let votes = {}; // {artistId: {criteriaId: value}}

        // === CARGAR JURADOS DISPONIBLES ===
        async function loadAvailableJurors() {
            try {
                const juriesSnapshot = await getDocs(collection(db, `events/${eventId}/juries`));
                const activeJurors = juriesSnapshot.docs
                    .filter(doc => doc.data().active)
                    .map(doc => doc.data().displayName);
                
                const jurorsText = activeJurors.length > 0 
                    ? `Jurados disponibles: ${activeJurors.join(', ')}`
                    : 'No hay jurados registrados';
                
                document.getElementById('available-jurors').textContent = jurorsText;
                console.log('üé≠ Jurados disponibles:', activeJurors);
            } catch (error) {
                console.error('Error cargando jurados:', error);
                document.getElementById('available-jurors').textContent = 'Error cargando jurados';
            }
        }

        // Cargar jurados al iniciar la p√°gina
        loadAvailableJurors();

        // === FUNCIONES PRINCIPALES ===

        window.login = async function() {
            const name = document.getElementById('juror-name').value.trim();
            
            console.log('üîê Login SIMPLE - cualquier nombre funciona');
            console.log('üîê Nombre ingresado:', name);

            if (!name) {
                alert('‚ùå Por favor ingresa tu nombre');
                return;
            }

            // SOLUCI√ìN SIMPLE: ACEPTAR CUALQUIER NOMBRE
            currentJuror = {
                id: Date.now(),
                name: name,
                type: 'jurado'
            };
            
            console.log('‚úÖ Login exitoso autom√°tico:', currentJuror);
            document.getElementById('juror-display').textContent = currentJuror.name;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Diagn√≥stico del nuevo sistema
            setTimeout(() => {
                const listBtn = document.getElementById('btn-list-mode');
                const gridBtn = document.getElementById('btn-grid-mode');
                const modal = document.getElementById('voting-modal');
                
                console.log('üîç DIAGN√ìSTICO DEL NUEVO SISTEMA:');
                console.log('- Bot√≥n Lista:', listBtn ? '‚úÖ Presente' : '‚ùå No encontrado');
                console.log('- Bot√≥n Grid:', gridBtn ? '‚úÖ Presente' : '‚ùå No encontrado');
                console.log('- Modal:', modal ? '‚úÖ Presente' : '‚ùå No encontrado');
                console.log('- switchViewMode:', typeof switchViewMode === 'function' ? '‚úÖ Funci√≥n disponible' : '‚ùå Funci√≥n no disponible');
                
                if (listBtn && gridBtn) {
                    console.log('üéØ NUEVO SISTEMA LISTO - Busca los botones "Vista Lista" y "Vista Organizada"');
                } else {
                    console.log('‚ùå PROBLEMA: Los botones del nuevo sistema no est√°n presentes');
                }
            }, 1000);
            
            loadArtists();
        };

        window.logout = function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                currentJuror = null;
                votes = {};
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('juror-name').value = '';
            }
        };

        async function loadArtists() {
            document.getElementById('status').textContent = 'Cargando artistas desde Firebase...';
            console.log('üé§ Cargando artistas...');
            console.log('üîç Event ID usado:', eventId);
            console.log('üîç Ruta Firebase:', `events/${eventId}/artists`);

            try {
                const artistsSnapshot = await getDocs(query(collection(db, `events/${eventId}/artists`), orderBy('name')));
                console.log('üìä Documentos encontrados:', artistsSnapshot.docs.length);
                
                // Debug: mostrar todos los documentos
                if (artistsSnapshot.docs.length === 0) {
                    console.log('‚ùå No se encontraron documentos en la colecci√≥n');
                    console.log('üîç Verificando si la colecci√≥n existe...');
                    
                    // Intentar sin orderBy por si hay problema
                    const simpleSnapshot = await getDocs(collection(db, `events/${eventId}/artists`));
                    console.log('üìä Sin orderBy:', simpleSnapshot.docs.length);
                    
                    // Listar todas las colecciones del evento
                    console.log('üîç Intentando listar estructura del evento...');
                } else {
                    artistsSnapshot.docs.forEach(doc => {
                        console.log('üìÑ Documento encontrado:', doc.id, doc.data());
                    });
                }
                
                artists = artistsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${artists.length} artistas cargados:`, artists.map(a => a.name));
                document.getElementById('status').textContent = `${artists.length} artistas cargados`;

                if (artists.length === 0) {
                    console.log('‚ùå Lista de artistas vac√≠a');
                    document.getElementById('artists-list').innerHTML = `
                        <div class="card p-8 text-center">
                            <div class="text-4xl mb-4">‚ùå</div>
                            <h3 class="text-xl font-bold mb-2">No hay artistas en Firebase</h3>
                            <p>Event ID: <code>${eventId}</code></p>
                            <p>Ruta: <code>events/${eventId}/artists</code></p>
                            <p class="mt-4">Ve a "Gesti√≥n de Votaciones" para agregar artistas.</p>
                            <button onclick="loadArtists()" class="btn btn-primary mt-4">üîÑ Reintentar</button>
                        </div>
                    `;
                    return;
                }

                renderArtists();
                updateStats();

            } catch (error) {
                console.error('‚ùå Error cargando artistas:', error);
                document.getElementById('status').textContent = 'Error al cargar artistas';
                document.getElementById('artists-list').innerHTML = `
                    <div class="card p-8 text-center">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold mb-2">Error de Firebase</h3>
                        <p class="mb-2">Event ID: <code>${eventId}</code></p>
                        <p class="text-sm opacity-75">${error.message}</p>
                        <button onclick="loadArtists()" class="btn btn-primary mt-4">üîÑ Reintentar</button>
                    </div>
                `;
            }
        }

        function renderArtists() {
            const html = artists.map(artist => {
                const artistVotes = votes[artist.id] || {};
                const isComplete = CRITERIA.every(c => artistVotes[c.id] !== undefined);
                const average = isComplete ? 
                    Object.values(artistVotes).reduce((sum, val) => sum + val, 0) / CRITERIA.length : 0;

                return `
                    <div class="card artist-card">
                        <!-- HEADER DEL ARTISTA -->
                        <div class="flex items-center mb-6 p-4 bg-black bg-opacity-30 rounded-lg">
                            <img src="${artist.photoURL || 'https://placehold.co/80x80/4338ca/ffffff?text=' + artist.name.charAt(0)}" 
                                 class="w-20 h-20 rounded-full object-cover border-4 border-white mr-4">
                            <div class="flex-grow">
                                <h3 class="text-2xl font-bold">${artist.name}</h3>
                                <p class="opacity-75">üéµ Participante del certamen</p>
                                ${isComplete ? `
                                    <div class="mt-2 px-3 py-1 bg-green-600 rounded-full inline-block">
                                        <span class="text-sm font-bold">‚úÖ VOTADO - Promedio: ${average.toFixed(1)} pts</span>
                                    </div>
                                ` : `
                                    <div class="mt-2 px-3 py-1 bg-yellow-600 rounded-full inline-block">
                                        <span class="text-sm font-bold">‚è≥ PENDIENTE DE VOTAR</span>
                                    </div>
                                `}
                            </div>
                        </div>

                        ${isComplete ? `
                            <!-- VOTACI√ìN COMPLETADA -->
                            <div class="bg-green-800 bg-opacity-50 p-6 rounded-lg">
                                <h4 class="text-xl font-bold mb-4 text-center">‚úÖ Votaci√≥n Completada</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    ${CRITERIA.map(criteria => `
                                        <div class="bg-black bg-opacity-30 p-3 rounded text-center">
                                            <div class="font-bold">${criteria.name}</div>
                                            <div class="text-2xl font-bold text-green-300">${artistVotes[criteria.id]} pts</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="text-center space-y-3">
                                    <div class="text-3xl font-bold text-green-300 mb-2">${average.toFixed(1)} puntos</div>
                                    
                                    <!-- FEEDBACK AUTOM√ÅTICO GENERADO -->
                                    <div id="feedback-section-${artist.id}" class="bg-blue-800 bg-opacity-50 p-4 rounded-lg mt-4" style="display: none;">
                                        <h5 class="text-lg font-bold mb-3 text-center">üí¨ Sugerencias de Feedback</h5>
                                        <div id="auto-feedback-${artist.id}" class="space-y-2 text-sm">
                                            <!-- Se generar√° autom√°ticamente -->
                                        </div>
                                        <p class="text-xs text-blue-300 mt-2 text-center">üí° Basado en tus puntuaciones - Puedes usarlas como gu√≠a</p>
                                    </div>
                                    
                                    <div class="space-x-2 space-y-2">
                                        <button onclick="editVote('${artist.id}')" class="btn btn-primary">‚úèÔ∏è Editar Voto</button>
                                        <button onclick="clearVote('${artist.id}')" class="btn btn-red">üóëÔ∏è Borrar Voto</button>
                                        <br>
                                        <button onclick="forceSubmitVote('${artist.id}')" class="btn btn-green">üíæ GUARDAR VOTO</button>
                                    </div>
                                    <p class="text-xs text-yellow-300">üí° Si no aparece en reportes, usa "GUARDAR VOTO"</p>
                                </div>
                            </div>
                        ` : `
                            <!-- FORMULARIO DE VOTACI√ìN -->
                            <div class="space-y-6">
                                ${CRITERIA.map(criteria => `
                                    <div class="criteria">
                                        <h4 class="text-lg font-bold mb-3">${criteria.name}</h4>
                                        <div class="rating-grid">
                                            ${RATINGS.map(rating => `
                                                <button class="btn ${rating.class} ${artistVotes[criteria.id] === rating.value ? 'btn-selected' : ''}"
                                                        onclick="selectRating('${artist.id}', '${criteria.id}', ${rating.value})">
                                                    ${rating.name}<br><small>(${rating.value} pts)</small>
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <div class="text-center pt-4 space-y-3">
                                    <!-- Bot√≥n para votaci√≥n completa -->
                                    <button onclick="submitVote('${artist.id}')" 
                                            class="btn btn-green text-xl px-8 py-4 ${isComplete ? '' : 'opacity-50 cursor-not-allowed'}"
                                            ${isComplete ? '' : 'disabled'}>
                                        üó≥Ô∏è ENVIAR VOTACI√ìN COMPLETA
                                    </button>
                                    
                                    <!-- Bot√≥n para guardado parcial -->
                                    <button onclick="savePartialVote('${artist.id}')" 
                                            class="btn btn-primary px-6 py-3 ${Object.keys(artistVotes).length > 0 ? '' : 'opacity-50 cursor-not-allowed'}"
                                            ${Object.keys(artistVotes).length > 0 ? '' : 'disabled'}>
                                        üíæ GUARDAR PARCIAL
                                    </button>
                                    
                                    <!-- Bot√≥n para limpiar votaci√≥n -->
                                    ${Object.keys(artistVotes).length > 0 ? `
                                        <button onclick="clearVote('${artist.id}')" class="btn btn-red px-4 py-2">
                                            üóëÔ∏è LIMPIAR VOTOS
                                        </button>
                                    ` : ''}
                                    
                                    <div class="text-sm space-y-1 opacity-75">
                                        <p class="font-bold">${isComplete ? '‚úÖ ¬°Listo para enviar!' : '‚è≥ Votaci√≥n en progreso'}</p>
                                        <p>Criterios completados: ${Object.keys(artistVotes).length}/${CRITERIA.length}</p>
                                        <p class="text-xs">üí° Puedes guardar parcialmente y continuar despu√©s</p>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            document.getElementById('artists-list').innerHTML = html;
            
            // Mantener el filtro despu√©s de renderizar
            preserveFilter();
        }

        window.selectRating = function(artistId, criteriaId, value) {
            console.log(`üîò Selecci√≥n: ${criteriaId} = ${value} para artista ${artistId}`);
            
            if (!votes[artistId]) votes[artistId] = {};
            votes[artistId][criteriaId] = value;
            
            // Re-renderizar solo este artista para actualizar la UI
            renderArtists();
            updateStats();
        };

        window.editVote = function(artistId) {
            if (confirm('¬øEditar esta votaci√≥n?')) {
                delete votes[artistId];
                renderArtists();
                preserveFilter(); // Mantener filtro
                updateStats();
            }
        };

        window.submitVote = async function(artistId) {
            console.log('üéØ Iniciando submitVote para:', artistId);
            console.log('üë§ Jurado actual:', currentJuror);
            
            const artist = artists.find(a => a.id === artistId);
            const artistVotes = votes[artistId];
            
            if (!currentJuror || !currentJuror.id) {
                alert('‚ùå Error: No hay jurado autenticado. Por favor, vuelve a ingresar.');
                return;
            }
            
            if (!artistVotes || Object.keys(artistVotes).length !== CRITERIA.length) {
                alert('‚ùå Completa todos los criterios para enviar la votaci√≥n completa');
                return;
            }

            const average = Object.values(artistVotes).reduce((sum, val) => sum + val, 0) / CRITERIA.length;

            try {
                console.log('üíæ Guardando voto en Firebase...');
                
                const voteData = {
                    artistId: artistId,
                    artistName: artist.name,
                    jurorName: currentJuror.name, // ‚úÖ CORREGIDO: usar .name del objeto
                    jurorId: currentJuror.id,
                    scores: artistVotes,
                    score: average, // Campo principal para compatibilidad
                    average: average,
                    timestamp: new Date().toISOString()
                };

                // Guardar en jury_evaluations para consistencia con el resto del sistema
                await setDoc(doc(db, 'jury_evaluations', `${currentJuror.id}_${artistId}`), {
                    ...voteData,
                    score: average, // Puntuaci√≥n principal para compatibilidad
                    comment: `Evaluaci√≥n completa - Promedio: ${average.toFixed(1)} puntos`
                });
                
                console.log('‚úÖ Voto guardado exitosamente');
                alert(`‚úÖ Voto enviado para ${artist.name}\nPromedio: ${average.toFixed(1)} puntos`);
                
                renderArtists();
                preserveFilter(); // Mantener filtro
                updateStats();

            } catch (error) {
                console.error('‚ùå Error guardando voto:', error);
                alert('‚ùå Error al guardar: ' + error.message);
            }
        };

        function updateStats() {
            const total = artists.length;
            const voted = Object.keys(votes).filter(artistId => 
                votes[artistId] && Object.keys(votes[artistId]).length === CRITERIA.length
            ).length;
            const pending = total - voted;

            document.getElementById('total-artists').textContent = total;
            document.getElementById('voted-count').textContent = voted;
            document.getElementById('pending-count').textContent = pending;
        }

        // === NUEVAS FUNCIONES PARA MEJORAS ===

        // Funci√≥n para filtrar artistas por nombre
        function filterArtists() {
            const searchTerm = document.getElementById('artist-search').value.toLowerCase();
            const artistCards = document.querySelectorAll('.artist-card');
            
            artistCards.forEach(card => {
                const artistName = card.querySelector('h3').textContent.toLowerCase();
                if (artistName.includes(searchTerm)) {
                    card.style.display = 'block';
                    card.style.order = '0'; // Los que coinciden aparecen primero
                } else {
                    card.style.display = searchTerm === '' ? 'block' : 'none';
                    card.style.order = '1'; // Los que no coinciden van al final
                }
            });
        }

        // Funci√≥n para limpiar b√∫squeda
        function clearSearch() {
            document.getElementById('artist-search').value = '';
            filterArtists();
        }

        // Funci√≥n para mantener el filtro despu√©s de renderizar
        function preserveFilter() {
            const searchTerm = document.getElementById('artist-search').value;
            if (searchTerm) {
                setTimeout(() => {
                    filterArtists();
                }, 100);
            }
        }

        // Funci√≥n para limpiar votos de un artista
        window.clearVote = function(artistId) {
            if (confirm('¬øEst√°s seguro de que quieres borrar todos los votos de este artista?')) {
                delete votes[artistId];
                renderArtists();
                preserveFilter(); // Mantener el filtro
                updateStats();
                console.log(`üóëÔ∏è Votos borrados para artista: ${artistId}`);
            }
        };

        // Funci√≥n para forzar guardado cuando hay problemas de red
        window.forceSubmitVote = async function(artistId) {
            console.log('üöÄ FORZANDO GUARDADO para:', artistId);
            
            const artist = artists.find(a => a.id === artistId);
            const artistVotes = votes[artistId];
            
            if (!currentJuror || !currentJuror.id) {
                alert('‚ùå Error: No hay jurado autenticado');
                return;
            }
            
            if (!artistVotes || Object.keys(artistVotes).length === 0) {
                alert('‚ùå No hay votos para guardar');
                return;
            }

            const average = Object.values(artistVotes).reduce((sum, val) => sum + val, 0) / Object.keys(artistVotes).length;

            const voteData = {
                eventId: eventId,
                artistId: artistId,
                artistName: artist.name,
                jurorName: currentJuror.name,
                jurorId: currentJuror.id,
                scores: artistVotes,
                score: average,
                timestamp: new Date().toISOString(),
                forceSubmitted: true // Marcar como forzado
            };

            // Intentar m√∫ltiples m√©todos de guardado
            let success = false;
            const attempts = [
                () => setDoc(doc(db, 'jury_evaluations', `${currentJuror.id}_${artistId}`), voteData),
                () => setDoc(doc(db, 'jury_evaluations', `${currentJuror.id}_${artistId}_${Date.now()}`), voteData),
                () => setDoc(doc(db, `events/${eventId}/jury_votes`, `${currentJuror.id}_${artistId}`), voteData)
            ];

            for (let i = 0; i < attempts.length && !success; i++) {
                try {
                    console.log(`üîÑ Intento ${i + 1} de guardado...`);
                    await attempts[i]();
                    success = true;
                    console.log(`‚úÖ Guardado exitoso en intento ${i + 1}`);
                    alert(`‚úÖ ¬°VOTO FORZADO GUARDADO!\n${artist.name}: ${average.toFixed(1)} puntos\n\nüéØ Ahora deber√≠a aparecer en los reportes`);
                } catch (error) {
                    console.error(`‚ùå Intento ${i + 1} fall√≥:`, error);
                    if (i === attempts.length - 1) {
                        alert(`‚ùå Error: No se pudo guardar despu√©s de ${attempts.length} intentos\n\n${error.message}`);
                    }
                }
            }
        };

        // Funci√≥n para guardar votaci√≥n parcial
        window.savePartialVote = async function(artistId) {
            if (!currentJuror.id) {
                alert('‚ùå Error: No hay jurado autenticado');
                return;
            }

            const artist = artists.find(a => a.id === artistId);
            const artistVotes = votes[artistId] || {};
            
            if (Object.keys(artistVotes).length === 0) {
                alert('‚ùå No hay puntuaciones para guardar');
                return;
            }

            try {
                // Usar la misma estructura que submitVote pero permitir parcial
                const voteData = {
                    eventId: eventId,
                    artistId: artistId,
                    artistName: artist.name,
                    jurorName: currentJuror.name,
                    jurorId: currentJuror.id,
                    scores: artistVotes,
                    isPartial: true, // Marcar como parcial
                    completedCriteria: Object.keys(artistVotes).length,
                    totalCriteria: CRITERIA.length,
                    timestamp: new Date().toISOString()
                };

                // Usar colecci√≥n jury_evaluations en lugar de jury_votes
                await setDoc(doc(db, 'jury_evaluations', `${currentJuror.id}_${artistId}_partial`), voteData);
                
                console.log('üíæ Votaci√≥n parcial guardada exitosamente');
                alert(`üíæ Votaci√≥n parcial guardada para ${artist.name}\nCriterios completados: ${Object.keys(artistVotes).length}/${CRITERIA.length}\n\n‚ú® Puedes continuar despu√©s desde donde lo dejaste`);
                
            } catch (error) {
                console.error('‚ùå Error guardando votaci√≥n parcial:', error);
                alert('‚ùå Error al guardar votaci√≥n parcial: ' + error.message);
            }
        };

        // Hacer funci√≥n global
        window.filterArtists = filterArtists;
        window.clearSearch = clearSearch;

        // === NUEVO SISTEMA DE GRID Y MODAL ===
        let currentViewMode = 'list'; // 'list' o 'grid'
        let currentModalArtist = null;

        // Funci√≥n para cambiar modo de vista
        window.switchViewMode = function(mode) {
            currentViewMode = mode;
            
            // Actualizar botones
            const listBtn = document.getElementById('btn-list-mode');
            const gridBtn = document.getElementById('btn-grid-mode');
            
            if (listBtn && gridBtn) {
                listBtn.className = mode === 'list' ? 'btn btn-primary' : 'btn btn-yellow';
                gridBtn.className = mode === 'grid' ? 'btn btn-primary' : 'btn btn-yellow';
            }
            
            // Mostrar/ocultar vistas
            const artistsList = document.getElementById('artists-list');
            const artistsGrid = document.getElementById('artists-grid');
            
            if (mode === 'list') {
                if (artistsList) artistsList.style.display = 'block';
                if (artistsGrid) artistsGrid.style.display = 'none';
            } else {
                if (artistsList) artistsList.style.display = 'none';
                if (artistsGrid) {
                    artistsGrid.style.display = 'grid';
                    renderArtistsGrid();
                }
            }
        };

        // Funci√≥n para renderizar artistas en grid
        function renderArtistsGrid() {
            const gridContainer = document.getElementById('artists-grid');
            gridContainer.innerHTML = '';

            artists.forEach(artist => {
                const isVoted = votes[artist.id] && Object.keys(votes[artist.id]).length > 0;
                const average = isVoted ? calculateAverage(votes[artist.id]) : 0;

                const artistCard = document.createElement('div');
                artistCard.className = 'artist-grid-card p-4 text-center';
                artistCard.onclick = () => openVotingModal(artist);

                artistCard.innerHTML = `
                    <div class="relative">
                        <img src="${artist.foto || artist.photoURL || 'https://via.placeholder.com/150x150/1e3a8a/ffffff?text=' + encodeURIComponent(artist.name.charAt(0))}" 
                             alt="${artist.name}" 
                             class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-white">
                        ${isVoted ? `
                            <div class="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                ‚úì
                            </div>
                        ` : ''}
                    </div>
                    <h3 class="font-bold text-lg">${artist.name}</h3>
                    ${isVoted ? `
                        <p class="text-green-300 text-sm">Votado: ${average.toFixed(1)} pts</p>
                    ` : `
                        <p class="text-yellow-300 text-sm">Pendiente de votar</p>
                    `}
                `;

                gridContainer.appendChild(artistCard);
            });
        }

        // Funci√≥n para abrir modal de votaci√≥n
        window.openVotingModal = function(artist) {
            currentModalArtist = artist;
            
            // Llenar informaci√≥n del artista
            document.getElementById('modal-artist-name').textContent = artist.name;
            document.getElementById('modal-artist-info').textContent = `Participante del certamen`;
            document.getElementById('modal-artist-photo').src = artist.foto || artist.photoURL || 
                'https://via.placeholder.com/80x80/1e3a8a/ffffff?text=' + encodeURIComponent(artist.name.charAt(0));

            // Renderizar categor√≠as
            renderModalCategories(artist);
            
            // Generar feedback si ya hay votos completos
            const artistVotes = votes[artist.id] || {};
            const hasAllVotes = CRITERIA.every(criteria => 
                artistVotes[criteria.id] !== undefined && artistVotes[criteria.id] !== null
            );
            if (hasAllVotes) {
                generateAndShowFeedback(artist.id, artistVotes);
            }
            
            // Mostrar modal
            document.getElementById('voting-modal').classList.remove('hidden');
        };

        // Funci√≥n para cerrar modal
        window.closeVotingModal = function() {
            document.getElementById('voting-modal').classList.add('hidden');
            currentModalArtist = null;
        };

        // Funci√≥n para renderizar categor√≠as en el modal
        function renderModalCategories(artist) {
            const container = document.getElementById('modal-categories');
            container.innerHTML = '';

            const currentVotes = votes[artist.id] || {};

            CRITERIA.forEach(criteria => {
                const currentValue = currentVotes[criteria.id] || 50;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'card p-4';
                categoryDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-bold text-white">${criteria.name}</label>
                        <div class="flex items-center gap-2">
                            <span id="modal-${criteria.id}-display" class="text-xl font-bold text-blue-300">${currentValue}</span>
                            <span id="modal-${criteria.id}-label" class="px-2 py-1 rounded text-xs font-bold"></span>
                        </div>
                    </div>
                    <input type="range" 
                           id="modal-${criteria.id}-slider" 
                           class="category-slider" 
                           min="25" 
                           max="100" 
                           value="${currentValue}"
                           oninput="updateModalScore('${criteria.id}', this.value)">
                    <div class="flex justify-between text-xs text-gray-300 mt-1">
                        <span>MALO</span>
                        <span>MEDIOCRE</span>
                        <span>BUENO</span>
                        <span>MUY BUENO</span>
                        <span>EXCELENTE</span>
                    </div>
                `;

                container.appendChild(categoryDiv);
                
                // Inicializar la etiqueta visual
                const label = getScoreLabel(currentValue);
                const labelElement = document.getElementById(`modal-${criteria.id}-label`);
                if (labelElement) {
                    labelElement.textContent = label.text;
                    labelElement.className = `px-2 py-1 rounded text-xs font-bold ${label.color} ${label.bg}`;
                }
            });

            updateModalTotal();
        }

        // FUNCI√ìN PARA CONVERTIR PUNTAJE A TEXTO VISUAL
        function getScoreLabel(score) {
            const scoreInt = parseInt(score);
            if (scoreInt >= 90) return { text: 'EXCELENTE', color: 'text-blue-300', bg: 'bg-blue-600' };
            if (scoreInt >= 70) return { text: 'MUY BUENO', color: 'text-green-300', bg: 'bg-green-600' };
            if (scoreInt >= 50) return { text: 'BUENO', color: 'text-yellow-300', bg: 'bg-yellow-600' };
            if (scoreInt >= 35) return { text: 'MEDIOCRE', color: 'text-orange-300', bg: 'bg-orange-600' };
            return { text: 'MALO', color: 'text-red-300', bg: 'bg-red-600' };
        }

        // Funci√≥n para actualizar puntaje en modal
        window.updateModalScore = function(criteriaId, value) {
            if (!currentModalArtist) return;

            // Actualizar display con n√∫mero y texto visual
            const displayElement = document.getElementById(`modal-${criteriaId}-display`);
            const labelElement = document.getElementById(`modal-${criteriaId}-label`);
            
            if (displayElement) {
                displayElement.textContent = value;
            }
            
            if (labelElement) {
                const label = getScoreLabel(value);
                labelElement.textContent = label.text;
                labelElement.className = `px-2 py-1 rounded text-xs font-bold ${label.color} ${label.bg}`;
            }

            // Guardar en votes (temporal)
            if (!votes[currentModalArtist.id]) {
                votes[currentModalArtist.id] = {};
            }
            votes[currentModalArtist.id][criteriaId] = parseInt(value);

            updateModalTotal();
        };

        // Funci√≥n para actualizar total en modal
        function updateModalTotal() {
            if (!currentModalArtist) return;

            const currentVotes = votes[currentModalArtist.id] || {};
            const total = Object.values(currentVotes).reduce((sum, val) => sum + val, 0);
            
            document.getElementById('modal-total-score').textContent = `${total}/600`;
            
            // Generar y mostrar feedback autom√°tico si hay votos completos
            const hasAllVotes = CRITERIA.every(criteria => 
                currentVotes[criteria.id] !== undefined && currentVotes[criteria.id] !== null
            );
            
            if (hasAllVotes) {
                generateAndShowFeedback(currentModalArtist.id, currentVotes);
            }
        }

        // Funci√≥n para generar y mostrar feedback autom√°tico
        function generateAndShowFeedback(artistId, artistVotes) {
            const feedbackContainer = document.getElementById(`auto-feedback-${artistId}`);
            const feedbackSection = document.getElementById(`feedback-section-${artistId}`);
            
            if (!feedbackContainer || !feedbackSection) return;
            
            const feedbackSuggestions = generateAutoFeedback(artistVotes);
            
            if (feedbackSuggestions.length > 0) {
                feedbackContainer.innerHTML = feedbackSuggestions.map(item => `
                    <div class="bg-black bg-opacity-30 p-2 rounded">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-blue-300">${item.category}</span>
                            <span class="text-xs text-gray-400">${item.score} pts</span>
                        </div>
                        <p class="text-white text-sm mt-1">"${item.suggestion}"</p>
                    </div>
                `).join('');
                
                // Mostrar la secci√≥n de feedback
                feedbackSection.style.display = 'block';
            } else {
                // Ocultar la secci√≥n de feedback si no hay sugerencias
                feedbackSection.style.display = 'none';
            }
        }

        // Funci√≥n para guardar votaci√≥n desde modal
        window.saveModalVote = async function() {
            if (!currentModalArtist) return;

            const artistVotes = votes[currentModalArtist.id] || {};
            
            // Verificar que todas las categor√≠as est√©n completas
            const missingCriteria = CRITERIA.filter(criteria => 
                artistVotes[criteria.id] === undefined || artistVotes[criteria.id] === null
            );
            
            if (missingCriteria.length > 0) {
                alert(`Por favor completa las siguientes categor√≠as:\n${missingCriteria.map(c => c.name).join('\n')}`);
                return;
            }

            try {
                await submitVote(currentModalArtist.id);
                closeVotingModal();
                
                // Actualizar vista actual
                if (currentViewMode === 'grid') {
                    renderArtistsGrid();
                } else {
                    renderArtists();
                }
                
                updateStats();
                alert(`‚úÖ Votaci√≥n guardada para ${currentModalArtist.name}`);
            } catch (error) {
                console.error('Error guardando voto:', error);
                alert('Error guardando la votaci√≥n. Intenta de nuevo.');
            }
        };

        // === INICIALIZACI√ìN ===
        console.log('üöÄ Sistema iniciado');
        document.getElementById('status').textContent = 'Sistema listo - Ingresa como jurado';
    </script>
</body>
</html>