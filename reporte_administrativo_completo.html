<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Administrativo Completo - VYTMUSIC</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#06B6D4'
                    }
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Iconos -->
    <link rel="icon" type="image/png" sizes="512x512" href="imagenes/logo-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="imagenes/logo-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="imagenes/logo-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="imagenes/logo-16x16.png">
    
    <style>
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            color: white;
        }
        
        .ranking-card {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .ranking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.3);
        }
        
        .gold { border-left: 6px solid #FFD700; }
        .silver { border-left: 6px solid #C0C0C0; }
        .bronze { border-left: 6px solid #CD7F32; }
        .regular { border-left: 6px solid #6B7280; }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #8B5CF6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .score-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        @media print {
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen p-4">
    <div class="container mx-auto max-w-6xl">
        <!-- Navegaci√≥n -->
        <div class="mb-6 text-center">
            <a href="eventos.html" class="text-sky-400 hover:underline mb-2 inline-block">&larr; Volver al Gestor de Eventos</a>
            <a href="reportes.html" class="text-purple-400 hover:underline mb-2 inline-block ml-4">&larr; Volver a Reportes</a>
            <a href="panel_evento.html" class="text-cyan-400 hover:underline mb-2 inline-block ml-4">&larr; Volver al Panel</a>
        </div>
        
        <!-- Header -->
        <div class="card p-8 mb-8 text-center">
            <h1 class="text-4xl font-bold mb-2">üìä REPORTE ADMINISTRATIVO COMPLETO</h1>
            <p class="text-xl opacity-90">An√°lisis completo para determinar ganadores del certamen</p>
        </div>

        <!-- Controles -->
        <div class="card p-6 mb-8 no-print">
            <h2 class="text-2xl font-bold mb-4">üéõÔ∏è Configuraci√≥n del Reporte</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Selector de Galas -->
                <div>
                    <label class="block mb-2 font-bold">Seleccionar Galas:</label>
                    <div id="galas-selector" class="space-y-2 max-h-40 overflow-y-auto p-3 bg-white bg-opacity-20 rounded">
                        <div class="text-center opacity-75">Cargando galas disponibles...</div>
                    </div>
                    <div class="mt-2">
                        <button onclick="selectAllGalas()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mr-2">
                            ‚úÖ Seleccionar Todas
                        </button>
                        <button onclick="clearGalaSelection()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                            ‚ùå Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Opciones de Reporte -->
                <div>
                    <label class="block mb-2 font-bold">Opciones de An√°lisis:</label>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="include-secret" checked class="mr-2">
                            <span>Incluir voto secreto en c√°lculos</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="show-details" checked class="mr-2">
                            <span>Mostrar detalles por gala</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="show-public-votes" checked class="mr-2">
                            <span>Incluir an√°lisis de votos del p√∫blico</span>
                        </label>
                    </div>
                    <button onclick="generateReport()" class="btn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-bold mt-4">
                        üìä Generar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading-section" class="text-center py-8" style="display: none;">
            <div class="card p-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold mb-2">Procesando datos...</h2>
                <p class="opacity-90">Analizando todas las evaluaciones</p>
            </div>
        </div>

        <!-- Resultados -->
        <div id="results-section" style="display: none;">
            <!-- Resumen Ejecutivo -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-center">üèÜ RESUMEN EJECUTIVO</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div>
                        <h3 class="text-lg font-bold mb-2">ü•á Ganador por Jurado</h3>
                        <div id="winner-jury" class="text-xl font-bold"></div>
                        <div id="winner-jury-score" class="text-sm opacity-75"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2">‚ù§Ô∏è Favorito del P√∫blico</h3>
                        <div id="winner-public" class="text-xl font-bold"></div>
                        <div id="winner-public-score" class="text-sm opacity-75"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2">üí∞ M√°s Entradas Vendidas</h3>
                        <div id="winner-sales" class="text-xl font-bold"></div>
                        <div id="winner-sales-score" class="text-sm opacity-75"></div>
                    </div>
                </div>
            </div>

            <!-- Ranking del Jurado -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-center">üé≠ RANKING FINAL DEL JURADO</h2>
                <p class="text-center opacity-90 mb-4">Incluye evaluaciones de todos los tipos de jurado (incluyendo voto secreto)</p>
                <div id="jury-ranking" class="space-y-4">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Ranking del P√∫blico -->
            <div id="public-ranking-section" class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-center">‚ù§Ô∏è RANKING DEL P√öBLICO</h2>
                <div id="public-ranking" class="space-y-4">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Ranking de Ventas -->
            <div id="sales-ranking-section" class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-center">üí∞ RANKING DE VENTAS</h2>
                <div id="sales-ranking" class="space-y-4">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Gr√°ficos Comparativos -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-center">üìà AN√ÅLISIS COMPARATIVO</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white bg-opacity-90 p-4 rounded">
                        <canvas id="juryChart" width="400" height="300"></canvas>
                    </div>
                    <div class="bg-white bg-opacity-90 p-4 rounded">
                        <canvas id="comparisonChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detalles por Gala -->
            <div id="gala-details-section" class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-center">üìÖ DETALLES POR GALA</h2>
                <div id="gala-details">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Acciones -->
            <div class="card p-6 text-center no-print">
                <h3 class="text-xl font-bold mb-4">üì§ Exportar Reporte</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="window.print()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded font-bold">
                        üñ®Ô∏è Imprimir/PDF
                    </button>
                    <button onclick="exportToCSV()" class="btn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-bold">
                        üìä Exportar CSV
                    </button>
                    <button onclick="shareReport()" class="btn bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded font-bold">
                        üì§ Compartir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDUKQ0F1PJ8v2SudfKyQvHK8G7OL-sLwb0",
            authDomain: "vyt-music.firebaseapp.com",
            projectId: "vyt-music",
            storageBucket: "vyt-music.appspot.com",
            messagingSenderId: "147059879896",
            appId: "1:147059879896:web:e3f0b11f38fdbc6b997fef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Variables globales
        let allEvents = [];
        let selectedGalas = [];
        let allJuryData = {};
        let allPublicData = {};
        let allSalesData = {};

        // Cargar datos al iniciar
        window.addEventListener('load', loadAvailableGalas);

        // Cargar galas disponibles
        async function loadAvailableGalas() {
            try {
                console.log('üîç Cargando galas disponibles...');
                const eventsSnapshot = await getDocs(collection(db, 'events'));
                allEvents = [];
                
                eventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    allEvents.push({
                        id: doc.id,
                        name: eventData.name || doc.id,
                        date: eventData.date || ''
                    });
                });

                console.log('‚úÖ Galas cargadas:', allEvents.length);
                displayGalasSelector();
            } catch (error) {
                console.error('‚ùå Error cargando galas:', error);
                document.getElementById('galas-selector').innerHTML = 
                    '<div class="text-center text-red-300">Error cargando galas</div>';
            }
        }

        // Mostrar selector de galas
        function displayGalasSelector() {
            const container = document.getElementById('galas-selector');
            container.innerHTML = '';
            
            if (allEvents.length === 0) {
                container.innerHTML = '<div class="text-center opacity-75">No se encontraron galas</div>';
                return;
            }
            
            allEvents.forEach(event => {
                const label = document.createElement('label');
                label.className = 'flex items-center cursor-pointer p-2 hover:bg-white hover:bg-opacity-10 rounded';
                label.innerHTML = `
                    <input type="checkbox" value="${event.id}" class="gala-checkbox mr-3">
                    <span>${event.name} ${event.date ? '(' + event.date + ')' : ''}</span>
                `;
                container.appendChild(label);
            });
        }

        // Seleccionar todas las galas
        window.selectAllGalas = function() {
            const checkboxes = document.querySelectorAll('.gala-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        };

        // Limpiar selecci√≥n
        window.clearGalaSelection = function() {
            const checkboxes = document.querySelectorAll('.gala-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        };

        // Generar reporte
        window.generateReport = async function() {
            // Obtener galas seleccionadas
            const checkboxes = document.querySelectorAll('.gala-checkbox:checked');
            selectedGalas = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedGalas.length === 0) {
                alert('‚ùå Por favor selecciona al menos una gala');
                return;
            }
            
            console.log('üìä Generando reporte para galas:', selectedGalas);
            
            // Mostrar loading
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';
            
            try {
                // Cargar todos los datos
                await loadAllData();
                
                // Procesar y mostrar resultados
                processAndDisplayResults();
                
                // Mostrar resultados
                document.getElementById('loading-section').style.display = 'none';
                document.getElementById('results-section').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Error generando reporte:', error);
                alert('Error al generar el reporte: ' + error.message);
                document.getElementById('loading-section').style.display = 'none';
            }
        };

        // Cargar todos los datos necesarios
        async function loadAllData() {
            allJuryData = {};
            allPublicData = {};
            allSalesData = {};
            
            for (const galaId of selectedGalas) {
                console.log(`üîç Procesando gala: ${galaId}`);
                
                // Cargar datos del jurado
                await loadJuryData(galaId);
                
                // Cargar datos del p√∫blico
                await loadPublicData(galaId);
                
                // Cargar datos de ventas
                await loadSalesData(galaId);
            }
        }

        // Cargar datos del jurado para una gala
        async function loadJuryData(galaId) {
            const collections = ['jury_evaluations', 'jury_votes', 'votes'];
            
            for (const collectionName of collections) {
                try {
                    const snapshot = await getDocs(collection(db, `events/${galaId}/${collectionName}`));
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const artistId = data.artistId;
                        const artistName = data.artistName || 'Artista sin nombre';
                        
                        if (!allJuryData[artistId]) {
                            allJuryData[artistId] = {
                                name: artistName,
                                galas: {},
                                totalScore: 0,
                                totalEvaluations: 0,
                                averageScore: 0
                            };
                        }
                        
                        if (!allJuryData[artistId].galas[galaId]) {
                            allJuryData[artistId].galas[galaId] = {
                                scores: [],
                                evaluations: []
                            };
                        }
                        
                        const score = data.score || data.average || 0;
                        allJuryData[artistId].galas[galaId].scores.push(score);
                        allJuryData[artistId].galas[galaId].evaluations.push(data);
                        
                        allJuryData[artistId].totalScore += score;
                        allJuryData[artistId].totalEvaluations++;
                    });
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error cargando ${collectionName} para gala ${galaId}:`, error);
                }
            }
        }

        // Cargar datos del p√∫blico para una gala
        async function loadPublicData(galaId) {
            try {
                console.log(`‚ù§Ô∏è Cargando votos del p√∫blico para gala: ${galaId}`);
                
                // Buscar en m√∫ltiples colecciones que podr√≠an contener votos del p√∫blico
                const collectionsToCheck = ['votes', 'public_votes', 'votacion', 'votaciones'];
                
                for (const collectionName of collectionsToCheck) {
                    try {
                        const snapshot = await getDocs(collection(db, `events/${galaId}/${collectionName}`));
                        console.log(`üìä Documentos en ${collectionName}:`, snapshot.size);
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            
                            // Determinar si es voto del p√∫blico (m√∫ltiples criterios)
                            const isPublicVote = (
                                // Tiene voterName pero no jurorId/jurorName
                                (data.voterName && !data.jurorId && !data.jurorName) ||
                                // No tiene campos de jurado
                                (!data.jurorId && !data.jurorName && !data.jurorType) ||
                                // Tiene tipo espec√≠fico de p√∫blico
                                (data.voteType === 'public' || data.type === 'public') ||
                                // Cualquier voto que no sea espec√≠ficamente de jurado
                                (!data.jurorId && data.artistId)
                            );
                            
                            if (isPublicVote) {
                                const artistId = data.artistId || data.artist_id || data.artistReference;
                                const artistName = data.artistName || data.artist_name || 'Artista sin nombre';
                                const score = data.score || data.points || data.rating || 1;
                                
                                if (artistId) {
                                    console.log(`üë§ Voto p√∫blico encontrado para: ${artistName}`);
                                    
                                    if (!allPublicData[artistId]) {
                                        allPublicData[artistId] = {
                                            name: artistName,
                                            galas: {},
                                            totalVotes: 0,
                                            totalPoints: 0
                                        };
                                    }
                                    
                                    if (!allPublicData[artistId].galas[galaId]) {
                                        allPublicData[artistId].galas[galaId] = {
                                            votes: 0,
                                            points: 0
                                        };
                                    }
                                    
                                    allPublicData[artistId].galas[galaId].votes++;
                                    allPublicData[artistId].galas[galaId].points += score;
                                    
                                    allPublicData[artistId].totalVotes++;
                                    allPublicData[artistId].totalPoints += score;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è No se pudo cargar ${collectionName}:`, error);
                    }
                }
                
                const publicCount = Object.keys(allPublicData).length;
                console.log(`‚úÖ Total artistas con votos del p√∫blico: ${publicCount}`);
                
            } catch (error) {
                console.warn(`‚ö†Ô∏è Error cargando votos p√∫blicos para gala ${galaId}:`, error);
            }
        }

        // Cargar datos de ventas para una gala
        async function loadSalesData(galaId) {
            try {
                console.log(`üí∞ Cargando datos de ventas para gala: ${galaId}`);
                
                // Buscar en m√∫ltiples colecciones que podr√≠an contener datos de ventas
                const collectionsToCheck = [
                    'entries', 'ticket_sales', 'sales', 'entradas', 
                    'tickets', 'participants', 'artists'
                ];
                
                for (const collectionName of collectionsToCheck) {
                    try {
                        const snapshot = await getDocs(collection(db, `events/${galaId}/${collectionName}`));
                        console.log(`üé´ Documentos en ${collectionName}:`, snapshot.size);
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            let artistId, artistName, quantity = 1;
                            
                            // Diferentes formas de encontrar datos de ventas
                            if (collectionName === 'participants' || collectionName === 'artists') {
                                // Para artistas registrados, asumir al menos 1 entrada
                                artistId = doc.id;
                                artistName = data.name || data.artistName || 'Artista sin nombre';
                                quantity = data.ticketsSold || data.entradas || 1;
                            } else {
                                // Para datos espec√≠ficos de ventas
                                artistId = data.artistId || data.artistReference || data.artist_id || doc.id;
                                artistName = data.artistName || data.artist_name || data.name || 'Artista sin nombre';
                                quantity = data.quantity || data.ticketCount || data.amount || data.entradas || 1;
                            }
                            
                            if (artistId && artistName) {
                                console.log(`üé™ Entrada encontrada para: ${artistName} (${quantity} entradas)`);
                                
                                if (!allSalesData[artistId]) {
                                    allSalesData[artistId] = {
                                        name: artistName,
                                        galas: {},
                                        totalSales: 0
                                    };
                                }
                                
                                if (!allSalesData[artistId].galas[galaId]) {
                                    allSalesData[artistId].galas[galaId] = 0;
                                }
                                
                                // Solo agregar si no hemos contado este artista en esta colecci√≥n
                                if (collectionName === 'participants' || collectionName === 'artists') {
                                    // Para participantes, solo contar una vez por gala
                                    if (allSalesData[artistId].galas[galaId] === 0) {
                                        allSalesData[artistId].galas[galaId] += quantity;
                                        allSalesData[artistId].totalSales += quantity;
                                    }
                                } else {
                                    // Para datos espec√≠ficos de ventas, sumar todo
                                    allSalesData[artistId].galas[galaId] += quantity;
                                    allSalesData[artistId].totalSales += quantity;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è No se pudo cargar ${collectionName}:`, error);
                    }
                }
                
                const salesCount = Object.keys(allSalesData).length;
                console.log(`‚úÖ Total artistas con datos de ventas: ${salesCount}`);
                
            } catch (error) {
                console.warn(`‚ö†Ô∏è Error cargando ventas para gala ${galaId}:`, error);
            }
        }

        // Procesar y mostrar resultados
        function processAndDisplayResults() {
            // Calcular promedios finales
            Object.values(allJuryData).forEach(artist => {
                artist.averageScore = artist.totalEvaluations > 0 ? 
                    artist.totalScore / artist.totalEvaluations : 0;
            });
            
            // Mostrar estad√≠sticas en consola
            console.log('üìä RESUMEN DE DATOS CARGADOS:');
            console.log(`üé≠ Datos del jurado: ${Object.keys(allJuryData).length} artistas`);
            console.log(`‚ù§Ô∏è Datos del p√∫blico: ${Object.keys(allPublicData).length} artistas`);
            console.log(`üí∞ Datos de ventas: ${Object.keys(allSalesData).length} artistas`);
            
            // Mostrar resumen ejecutivo
            displayExecutiveSummary();
            
            // Mostrar rankings
            displayJuryRanking();
            
            if (document.getElementById('show-public-votes').checked) {
                displayPublicRanking();
            }
            
            displaySalesRanking();
            
            // Mostrar gr√°ficos
            displayCharts();
            
            // Mostrar detalles por gala si est√° activado
            if (document.getElementById('show-details').checked) {
                displayGalaDetails();
            }
        }

        // Mostrar resumen ejecutivo
        function displayExecutiveSummary() {
            // Ganador por jurado
            const juryWinner = Object.values(allJuryData)
                .sort((a, b) => b.averageScore - a.averageScore)[0];
            
            if (juryWinner) {
                document.getElementById('winner-jury').textContent = juryWinner.name;
                document.getElementById('winner-jury-score').textContent = 
                    `${juryWinner.averageScore.toFixed(1)} puntos promedio`;
            } else {
                document.getElementById('winner-jury').textContent = 'Sin datos';
                document.getElementById('winner-jury-score').textContent = 'No hay evaluaciones';
            }
            
            // Favorito del p√∫blico
            const publicWinner = Object.values(allPublicData)
                .sort((a, b) => b.totalVotes - a.totalVotes)[0];
            
            if (publicWinner) {
                document.getElementById('winner-public').textContent = publicWinner.name;
                document.getElementById('winner-public-score').textContent = 
                    `${publicWinner.totalVotes} votos`;
            } else {
                document.getElementById('winner-public').textContent = 'Sin datos';
                document.getElementById('winner-public-score').textContent = 'No hay votos del p√∫blico';
            }
            
            // M√°s ventas
            const salesWinner = Object.values(allSalesData)
                .sort((a, b) => b.totalSales - a.totalSales)[0];
            
            if (salesWinner) {
                document.getElementById('winner-sales').textContent = salesWinner.name;
                document.getElementById('winner-sales-score').textContent = 
                    `${salesWinner.totalSales} entradas`;
            } else {
                document.getElementById('winner-sales').textContent = 'Sin datos';
                document.getElementById('winner-sales-score').textContent = 'No hay datos de ventas';
            }
        }

        // Mostrar ranking del jurado
        function displayJuryRanking() {
            const container = document.getElementById('jury-ranking');
            container.innerHTML = '';
            
            const sortedArtists = Object.values(allJuryData)
                .sort((a, b) => b.averageScore - a.averageScore);
            
            sortedArtists.forEach((artist, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'regular';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                const card = document.createElement('div');
                card.className = `ranking-card ${rankClass} p-4 text-white`;
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold mr-4">${medal} #${index + 1}</div>
                            <div>
                                <h3 class="text-xl font-bold">${artist.name}</h3>
                                <p class="text-sm opacity-75">${artist.totalEvaluations} evaluaciones</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="score-display">${artist.averageScore.toFixed(1)}</div>
                            <div class="text-sm opacity-75">puntos promedio</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Mostrar ranking del p√∫blico
        function displayPublicRanking() {
            const container = document.getElementById('public-ranking');
            container.innerHTML = '';
            
            const sortedArtists = Object.values(allPublicData)
                .sort((a, b) => b.totalVotes - a.totalVotes);
            
            sortedArtists.forEach((artist, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'regular';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                const card = document.createElement('div');
                card.className = `ranking-card ${rankClass} p-4 text-white`;
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold mr-4">${medal} #${index + 1}</div>
                            <div>
                                <h3 class="text-xl font-bold">${artist.name}</h3>
                                <p class="text-sm opacity-75">${artist.totalPoints} puntos totales</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="score-display">${artist.totalVotes}</div>
                            <div class="text-sm opacity-75">votos</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Mostrar ranking de ventas
        function displaySalesRanking() {
            const container = document.getElementById('sales-ranking');
            container.innerHTML = '';
            
            const sortedArtists = Object.values(allSalesData)
                .sort((a, b) => b.totalSales - a.totalSales);
            
            if (sortedArtists.length === 0) {
                container.innerHTML = '<div class="text-center opacity-75">No hay datos de ventas disponibles</div>';
                return;
            }
            
            sortedArtists.forEach((artist, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'regular';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                const card = document.createElement('div');
                card.className = `ranking-card ${rankClass} p-4 text-white`;
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold mr-4">${medal} #${index + 1}</div>
                            <div>
                                <h3 class="text-xl font-bold">${artist.name}</h3>
                                <p class="text-sm opacity-75">Ventas por gala</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="score-display">${artist.totalSales}</div>
                            <div class="text-sm opacity-75">entradas</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Mostrar gr√°ficos
        function displayCharts() {
            // Gr√°fico del jurado
            const juryCtx = document.getElementById('juryChart').getContext('2d');
            const topJuryArtists = Object.values(allJuryData)
                .sort((a, b) => b.averageScore - a.averageScore)
                .slice(0, 10);
            
            new Chart(juryCtx, {
                type: 'bar',
                data: {
                    labels: topJuryArtists.map(a => a.name),
                    datasets: [{
                        label: 'Puntuaci√≥n Promedio del Jurado',
                        data: topJuryArtists.map(a => a.averageScore),
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 - Evaluaci√≥n del Jurado'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Gr√°fico comparativo
            const compCtx = document.getElementById('comparisonChart').getContext('2d');
            const artistsForComparison = Object.keys(allJuryData).slice(0, 5);
            
            new Chart(compCtx, {
                type: 'radar',
                data: {
                    labels: ['Jurado', 'P√∫blico', 'Ventas'],
                    datasets: artistsForComparison.map((artistId, index) => {
                        const artist = allJuryData[artistId];
                        const publicData = allPublicData[artistId] || { totalVotes: 0 };
                        const salesData = allSalesData[artistId] || { totalSales: 0 };
                        
                        const colors = [
                            'rgba(139, 92, 246, 0.6)',
                            'rgba(6, 182, 212, 0.6)',
                            'rgba(34, 197, 94, 0.6)',
                            'rgba(245, 158, 11, 0.6)',
                            'rgba(239, 68, 68, 0.6)'
                        ];
                        
                        return {
                            label: artist.name,
                            data: [
                                artist.averageScore,
                                Math.min(publicData.totalVotes * 10, 100), // Normalizar a 100
                                Math.min(salesData.totalSales * 20, 100)   // Normalizar a 100
                            ],
                            backgroundColor: colors[index],
                            borderColor: colors[index].replace('0.6', '1'),
                            borderWidth: 2
                        };
                    })
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Comparaci√≥n Multi-criterio'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Mostrar detalles por gala
        function displayGalaDetails() {
            const container = document.getElementById('gala-details');
            container.innerHTML = '';
            
            selectedGalas.forEach(galaId => {
                const gala = allEvents.find(e => e.id === galaId);
                
                const galaCard = document.createElement('div');
                galaCard.className = 'bg-white bg-opacity-10 p-4 rounded-lg mb-4';
                galaCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-3">${gala?.name || galaId}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <h4 class="font-bold mb-2">üé≠ Evaluaciones del Jurado</h4>
                            <div id="gala-jury-${galaId}"></div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-2">‚ù§Ô∏è Votos del P√∫blico</h4>
                            <div id="gala-public-${galaId}"></div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-2">üí∞ Ventas de Entradas</h4>
                            <div id="gala-sales-${galaId}"></div>
                        </div>
                    </div>
                `;
                container.appendChild(galaCard);
                
                // Llenar datos de cada secci√≥n
                fillGalaJuryDetails(galaId);
                fillGalaPublicDetails(galaId);
                fillGalaSalesDetails(galaId);
            });
        }

        // Llenar detalles del jurado por gala
        function fillGalaJuryDetails(galaId) {
            const container = document.getElementById(`gala-jury-${galaId}`);
            let juryCount = 0;
            
            Object.values(allJuryData).forEach(artist => {
                if (artist.galas[galaId]) {
                    juryCount += artist.galas[galaId].evaluations.length;
                }
            });
            
            container.innerHTML = `<p>${juryCount} evaluaciones registradas</p>`;
        }

        // Llenar detalles del p√∫blico por gala
        function fillGalaPublicDetails(galaId) {
            const container = document.getElementById(`gala-public-${galaId}`);
            let publicCount = 0;
            
            Object.values(allPublicData).forEach(artist => {
                if (artist.galas[galaId]) {
                    publicCount += artist.galas[galaId].votes;
                }
            });
            
            container.innerHTML = `<p>${publicCount} votos del p√∫blico</p>`;
        }

        // Llenar detalles de ventas por gala
        function fillGalaSalesDetails(galaId) {
            const container = document.getElementById(`gala-sales-${galaId}`);
            let salesCount = 0;
            
            Object.values(allSalesData).forEach(artist => {
                if (artist.galas[galaId]) {
                    salesCount += artist.galas[galaId];
                }
            });
            
            container.innerHTML = `<p>${salesCount} entradas vendidas</p>`;
        }

        // Exportar a CSV
        window.exportToCSV = function() {
            let csv = 'Artista,Puntuaci√≥n Jurado,Votos P√∫blico,Entradas Vendidas\n';
            
            const allArtistIds = new Set([
                ...Object.keys(allJuryData),
                ...Object.keys(allPublicData),
                ...Object.keys(allSalesData)
            ]);
            
            allArtistIds.forEach(artistId => {
                const jury = allJuryData[artistId] || { name: 'Desconocido', averageScore: 0 };
                const publicData = allPublicData[artistId] || { totalVotes: 0 };
                const sales = allSalesData[artistId] || { totalSales: 0 };
                
                csv += `"${jury.name}",${jury.averageScore.toFixed(1)},${publicData.totalVotes},${sales.totalSales}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_certamen_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        // Compartir reporte
        window.shareReport = function() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Reporte Administrativo Completo - VYTMUSIC',
                    text: 'An√°lisis completo del certamen con todos los rankings',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('‚úÖ Enlace copiado al portapapeles');
                }).catch(() => {
                    prompt('Copia este enlace:', url);
                });
            }
        };
    </script>
</body>
</html>